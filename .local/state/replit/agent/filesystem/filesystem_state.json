{"file_contents":{"src/app/(app)/projects/[projectId]/mass-list/page.tsx":{"content":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback } from \"react\";\r\nimport { AppShell } from \"@/components/layout/app-shell\";\r\nimport { ProjectSidebar } from \"@/components/pages/project/project-sidebar\";\r\nimport { MassListUpload } from \"@/components/pages/project/mass-list/mass-list-upload\";\r\nimport { MassListTable } from \"@/components/pages/project/mass-list/mass-list-table\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { use } from \"react\";\r\n\r\nexport default function MassListPage({ params }: { params: Promise<{ projectId: string }> }) {\r\n    const { projectId } = use(params);\r\n    const [data, setData] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    const loadData = useCallback(async () => {\r\n        setLoading(true);\r\n        try {\r\n            const res = await fetch(`/api/projects/${projectId}/mass-list`);\r\n            if (res.ok) {\r\n                const json = await res.json();\r\n                setData(json);\r\n            }\r\n        } catch (err) {\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [projectId]);\r\n\r\n    useEffect(() => {\r\n        loadData();\r\n    }, [loadData]);\r\n\r\n    const handleDelete = async (id: string) => {\r\n        try {\r\n            const res = await fetch(`/api/projects/${projectId}/mass-list?id=${id}`, {\r\n                method: \"DELETE\",\r\n            });\r\n            if (res.ok) {\r\n                setData((prev) => prev.filter((item) => item.id !== id));\r\n            }\r\n        } catch (err) {\r\n            console.error(err);\r\n        }\r\n    };\r\n\r\n    const handleDeleteAll = async () => {\r\n        if (!confirm(\"Er du sikker p√• at du vil slette HELE masselisten?\")) return;\r\n        try {\r\n            const res = await fetch(`/api/projects/${projectId}/mass-list?all=true`, {\r\n                method: \"DELETE\",\r\n            });\r\n            if (res.ok) {\r\n                setData([]);\r\n            }\r\n        } catch (err) {\r\n            console.error(err);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <AppShell sidebar={<ProjectSidebar projectId={projectId} />}>\r\n            <div className=\"space-y-6\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold tracking-tight\">Masseliste</h1>\r\n                    <p className=\"text-muted-foreground\">\r\n                        Last opp og administrer masselister for prosjektet.\r\n                    </p>\r\n                </div>\r\n\r\n                <MassListUpload projectId={projectId} onUploadComplete={loadData} />\r\n\r\n                <Separator />\r\n\r\n                <MassListTable data={data} onDelete={handleDelete} onDeleteAll={handleDeleteAll} />\r\n            </div>\r\n        </AppShell>\r\n    );\r\n}\r\n","path":null,"size_bytes":2753,"size_tokens":null},"src/app/api/annotations/[annotationId]/comments/route.ts":{"content":"import prisma from \"@/lib/db\";\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { requireAuth, canAnnotateDocuments } from \"@/lib/auth-helpers\";\n\ntype Context = { params: Promise<{ annotationId: string }> };\n\nexport async function POST(req: NextRequest, context: Context) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const body = await req.json();\n  const { content, mentions = [] } = body || {};\n  \n  if (!content || typeof content !== \"string\" || content.trim().length === 0) {\n    return NextResponse.json({ error: \"Innhold mangler\" }, { status: 400 });\n  }\n\n  const { annotationId } = await context.params;\n\n  const annotation = await prisma.annotation.findUnique({\n    where: { id: annotationId },\n    include: { document: true },\n  });\n\n  if (!annotation) {\n    return NextResponse.json({ error: \"Annotering ikke funnet\" }, { status: 404 });\n  }\n\n  const membership = await prisma.projectMember.findFirst({\n    where: { \n      projectId: annotation.document.projectId, \n      userId: authResult.user.id \n    },\n  });\n\n  if (!membership && authResult.user.role !== \"ADMIN\") {\n    return NextResponse.json({ error: \"Ingen tilgang til dette prosjektet\" }, { status: 403 });\n  }\n\n  if (!canAnnotateDocuments(authResult.user.role, membership?.role)) {\n    return NextResponse.json({ error: \"Ingen tilgang til √• kommentere\" }, { status: 403 });\n  }\n\n  const comment = await prisma.comment.create({\n    data: {\n      content: content.trim(),\n      annotationId: annotation.id,\n      authorId: authResult.user.id,\n      projectId: annotation.document.projectId,\n    },\n    include: { author: true },\n  });\n\n  if (Array.isArray(mentions) && mentions.length > 0) {\n    const validMentions = mentions.filter(\n      (userId: unknown) => typeof userId === \"string\" && userId.length > 0\n    );\n\n    if (validMentions.length > 0) {\n      await prisma.notification.createMany({\n        data: validMentions.map((userId: string) => ({\n          userId,\n          type: \"mention\",\n          commentId: comment.id,\n          annotationId: annotation.id,\n          metadata: { from: authResult.user.id, annotationId: annotation.id },\n        })),\n      });\n    }\n  }\n\n  return NextResponse.json(comment);\n}\n","path":null,"size_bytes":2272,"size_tokens":null},"src/app/api/auth/reset/request/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport prisma from \"@/lib/db\";\nimport { sendResetEmail } from \"@/lib/email\";\nimport crypto from \"crypto\";\n\nconst schema = z.object({ email: z.string().email() });\n\nexport async function POST(req: NextRequest) {\n  try {\n    const json = await req.json();\n    const parsed = schema.safeParse(json);\n    if (!parsed.success) return NextResponse.json({ error: \"Ugyldig e-post\" }, { status: 400 });\n\n    const email = parsed.data.email.toLowerCase();\n    const user = await prisma.user.findUnique({ where: { email } });\n    if (!user) {\n      // Do not reveal existence\n      return NextResponse.json({ ok: true });\n    }\n\n    const token = crypto.randomBytes(32).toString(\"hex\");\n    const expires = new Date(Date.now() + 60 * 60 * 1000);\n\n    await prisma.verificationToken.deleteMany({ where: { identifier: email } });\n    await prisma.verificationToken.create({\n      data: {\n        identifier: email,\n        token,\n        expires,\n      },\n    });\n\n    const baseUrl = process.env.NEXTAUTH_URL || \"http://localhost:3000\";\n    const resetUrl = `${baseUrl}/reset?token=${token}`;\n    await sendResetEmail(email, resetUrl);\n\n    return NextResponse.json({ ok: true });\n  } catch (error) {\n    console.error(\"Reset password error:\", error);\n    return NextResponse.json({ error: \"Kunne ikke sende e-post. Pr√∏v igjen senere.\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":1434,"size_tokens":null},"middleware.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getToken } from \"next-auth/jwt\";\n\nconst protectedPaths = [\"/dashboard\", \"/projects\", \"/admin\", \"/profile\"];\nconst apiProtected = [\"/api/projects\", \"/api/admin\", \"/api/documents\"];\n\nexport async function middleware(req: NextRequest) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n\n  const isProtected =\n    protectedPaths.some((p) => path.startsWith(p)) ||\n    apiProtected.some((p) => path.startsWith(p));\n\n  if (!isProtected) {\n    return NextResponse.next();\n  }\n\n  const token = await getToken({\n    req,\n    secret: process.env.NEXTAUTH_SECRET,\n  });\n\n  if (!token) {\n    if (path.startsWith(\"/api\")) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n    return NextResponse.redirect(new URL(\"/login\", req.url));\n  }\n\n  if (token.status === \"SUSPENDED\") {\n    if (path.startsWith(\"/api\")) {\n      return NextResponse.json({ error: \"Kontoen er suspendert\" }, { status: 403 });\n    }\n    return NextResponse.redirect(new URL(\"/login?error=suspended\", req.url));\n  }\n\n  if (token.status === \"PENDING\" && path !== \"/pending\") {\n    if (path.startsWith(\"/api\")) {\n      return NextResponse.json({ error: \"Kontoen venter p√• godkjenning\" }, { status: 403 });\n    }\n    return NextResponse.redirect(new URL(\"/pending\", req.url));\n  }\n\n  if (token.status !== \"ACTIVE\" && path !== \"/pending\") {\n    if (path.startsWith(\"/api\")) {\n      return NextResponse.json({ error: \"Kontoen er ikke aktiv\" }, { status: 403 });\n    }\n    return NextResponse.redirect(new URL(\"/login\", req.url));\n  }\n\n  if (path.startsWith(\"/admin\") && token.role !== \"ADMIN\") {\n    return NextResponse.redirect(new URL(\"/dashboard\", req.url));\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: [\"/dashboard/:path*\", \"/projects/:path*\", \"/admin/:path*\", \"/profile\", \"/api/:path*\"],\n};\n","path":null,"size_bytes":1889,"size_tokens":null},"src/app/api/auth/reset/confirm/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport prisma from \"@/lib/db\";\nimport bcrypt from \"bcryptjs\";\n\nconst schema = z.object({\n  token: z.string().min(10),\n  password: z.string().min(8),\n});\n\nexport async function POST(req: NextRequest) {\n  const json = await req.json();\n  const parsed = schema.safeParse(json);\n  if (!parsed.success) return NextResponse.json({ error: \"Ugyldig data\" }, { status: 400 });\n\n  const { token, password } = parsed.data;\n\n  const record = await prisma.verificationToken.findUnique({ where: { token } });\n  if (!record || record.expires < new Date()) {\n    return NextResponse.json({ error: \"Token er utl√∏pt eller ugyldig\" }, { status: 400 });\n  }\n\n  const user = await prisma.user.findUnique({ where: { email: record.identifier } });\n  if (!user) return NextResponse.json({ error: \"Bruker finnes ikke\" }, { status: 404 });\n\n  const passwordHash = await bcrypt.hash(password, 10);\n  await prisma.user.update({ where: { id: user.id }, data: { passwordHash } });\n  await prisma.verificationToken.delete({ where: { token } });\n\n  return NextResponse.json({ ok: true });\n}\n","path":null,"size_bytes":1142,"size_tokens":null},"src/app/api/admin/users/route.ts":{"content":"import prisma from \"@/lib/db\";\nimport { NextResponse } from \"next/server\";\nimport { Role, UserStatus } from \"@prisma/client\";\nimport { requireAdmin } from \"@/lib/auth-helpers\";\n\nconst TOTP_DEADLINE_DAYS = 14;\n\nexport async function GET() {\n  const authResult = await requireAdmin();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const pending = await prisma.user.findMany({\n    where: { status: UserStatus.PENDING },\n    orderBy: { createdAt: \"asc\" },\n    select: {\n      id: true,\n      firstName: true,\n      lastName: true,\n      email: true,\n      company: true,\n      title: true,\n      role: true,\n      status: true,\n      createdAt: true,\n    },\n  });\n\n  return NextResponse.json(pending);\n}\n\nexport async function PATCH(req: Request) {\n  const authResult = await requireAdmin();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const body = await req.json();\n  const { userId, status, role } = body || {};\n  \n  if (!userId || typeof userId !== \"string\") {\n    return NextResponse.json({ error: \"userId mangler\" }, { status: 400 });\n  }\n\n  if (role && !Object.values(Role).includes(role)) {\n    return NextResponse.json({ error: \"Ugyldig rolle\" }, { status: 400 });\n  }\n  \n  if (status && !Object.values(UserStatus).includes(status)) {\n    return NextResponse.json({ error: \"Ugyldig status\" }, { status: 400 });\n  }\n\n  const targetUser = await prisma.user.findUnique({\n    where: { id: userId },\n  });\n\n  if (!targetUser) {\n    return NextResponse.json({ error: \"Bruker ikke funnet\" }, { status: 404 });\n  }\n\n  if (targetUser.id === authResult.user.id && status === UserStatus.SUSPENDED) {\n    return NextResponse.json(\n      { error: \"Du kan ikke suspendere din egen konto\" },\n      { status: 400 }\n    );\n  }\n\n  const updateData: Record<string, unknown> = {};\n  \n  if (status) {\n    updateData.status = status;\n  }\n  \n  if (role) {\n    updateData.role = role;\n  }\n  \n  if (status === UserStatus.ACTIVE && targetUser.status === UserStatus.PENDING) {\n    const totpDeadline = new Date();\n    totpDeadline.setDate(totpDeadline.getDate() + TOTP_DEADLINE_DAYS);\n    updateData.totpDeadline = totpDeadline;\n  }\n\n  const updated = await prisma.user.update({\n    where: { id: userId },\n    data: updateData,\n    select: {\n      id: true,\n      email: true,\n      role: true,\n      status: true,\n    },\n  });\n\n  return NextResponse.json(updated);\n}\n","path":null,"size_bytes":2385,"size_tokens":null},"src/app/(auth)/register/page.tsx":{"content":"\"use client\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { useState } from \"react\";\nimport { signIn } from \"next-auth/react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\n\ntype FormState = {\n  firstName: string;\n  lastName: string;\n  email: string;\n  phone: string;\n  company: string;\n  title: string;\n  discipline: string;\n  password: string;\n  confirmPassword: string;\n};\n\nconst initialState: FormState = {\n  firstName: \"\",\n  lastName: \"\",\n  email: \"\",\n  phone: \"\",\n  company: \"\",\n  title: \"\",\n  discipline: \"\",\n  password: \"\",\n  confirmPassword: \"\",\n};\n\nexport default function RegisterPage() {\n  const [form, setForm] = useState<FormState>(initialState);\n  const [error, setError] = useState<string | null>(null);\n  const [loading, setLoading] = useState(false);\n  const router = useRouter();\n\n  const update = (key: keyof FormState, value: string) => setForm((s) => ({ ...s, [key]: value }));\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    setError(null);\n    if (form.password !== form.confirmPassword) {\n      setError(\"Passordene matcher ikke\");\n      return;\n    }\n    setLoading(true);\n    const res = await fetch(\"/api/auth/register\", {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(form),\n    });\n    const json = await res.json();\n    if (!res.ok) {\n      setError(json.error || \"Kunne ikke registrere bruker\");\n      setLoading(false);\n      return;\n    }\n    await signIn(\"credentials\", { redirect: false, email: form.email, password: form.password });\n    setLoading(false);\n    router.replace(\"/pending\");\n  }\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      <div>\n        <p className=\"text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground\">Opprett konto</p>\n        <h2 className=\"text-2xl font-semibold text-foreground\">Velkommen til SysLink</h2>\n      </div>\n      <form onSubmit={handleSubmit} className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n        <Input label=\"Fornavn\" value={form.firstName} onChange={(e) => update(\"firstName\", e.target.value)} required />\n        <Input label=\"Etternavn\" value={form.lastName} onChange={(e) => update(\"lastName\", e.target.value)} required />\n        <Input\n          label=\"E-post\"\n          type=\"email\"\n          className=\"md:col-span-2\"\n          value={form.email}\n          onChange={(e) => update(\"email\", e.target.value)}\n          required\n        />\n        <Input label=\"Telefon\" value={form.phone} onChange={(e) => update(\"phone\", e.target.value)} />\n        <Input label=\"Firma\" value={form.company} onChange={(e) => update(\"company\", e.target.value)} />\n        <Input label=\"Tittel\" value={form.title} onChange={(e) => update(\"title\", e.target.value)} />\n        <div className=\"flex flex-col gap-1.5\">\n          <label className=\"text-sm font-medium text-foreground\">Fag</label>\n          <select\n            value={form.discipline}\n            onChange={(e) => update(\"discipline\", e.target.value)}\n            className=\"rounded-xl border border-border bg-card px-3 py-2 text-sm text-foreground outline-none focus:border-info focus:ring-1 focus:ring-info\"\n          >\n            <option value=\"\">Velg fag...</option>\n            <option value=\"Elektro\">Elektro</option>\n            <option value=\"Ventilasjon\">Ventilasjon</option>\n            <option value=\"Kulde\">Kulde</option>\n            <option value=\"Byggautomasjon\">Byggautomasjon</option>\n            <option value=\"R√∏rlegger\">R√∏rlegger</option>\n            <option value=\"Administrasjon\">Administrasjon</option>\n            <option value=\"Totalentrepren√∏r\">Totalentrepren√∏r</option>\n            <option value=\"Byggherre\">Byggherre</option>\n            <option value=\"Annet\">Annet</option>\n          </select>\n        </div>\n        <Input\n          label=\"Passord\"\n          type=\"password\"\n          value={form.password}\n          onChange={(e) => update(\"password\", e.target.value)}\n          required\n          hint=\"Minst 8 tegn. Admin-e-poster aktiveres automatisk.\"\n        />\n        <Input\n          label=\"Gjenta passord\"\n          type=\"password\"\n          value={form.confirmPassword}\n          onChange={(e) => update(\"confirmPassword\", e.target.value)}\n          required\n        />\n        {error && <p className=\"md:col-span-2 text-sm text-danger\">{error}</p>}\n        <div className=\"md:col-span-2 flex flex-col gap-3\">\n          <Button type=\"submit\" loading={loading}>\n            Opprett og logg inn\n          </Button>\n          <p className=\"text-sm text-muted-foreground\">\n            Har du allerede konto?{\" \"}\n            <Link href=\"/login\" className=\"font-semibold text-info underline-offset-4 hover:underline\">\n              Logg inn\n            </Link>\n          </p>\n        </div>\n      </form>\n    </div>\n  );\n}\n","path":null,"size_bytes":4903,"size_tokens":null},"src/app/(app)/projects/[projectId]/page.tsx":{"content":"import { ProjectHeader } from \"@/components/pages/project/project-header\";\nimport { ProjectContentSwitcher } from \"@/components/pages/project/project-content-switcher\";\nimport prisma from \"@/lib/db\";\nimport { authOptions } from \"@/lib/auth\";\nimport { getServerSession } from \"next-auth\";\nimport { redirect } from \"next/navigation\";\nimport { Role } from \"@prisma/client\";\n\nexport default async function ProjectPage({ params }: { params: Promise<{ projectId: string }> }) {\n  const session = await getServerSession(authOptions);\n  if (!session?.user?.id) redirect(\"/login\");\n\n  const { projectId } = await params;\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    include: {\n      members: { include: { user: true } },\n      documents: { \n        include: { \n          tags: { include: { systemTag: true } },\n          annotations: { select: { id: true, status: true } },\n        } \n      },\n      massList: true,\n      comments: { include: { author: true }, orderBy: { createdAt: \"desc\" }, take: 10 },\n    },\n  });\n\n  if (!project) redirect(\"/dashboard\");\n\n  const isMember = project.members.some((m) => m.userId === session.user.id) || session.user.role === Role.ADMIN;\n  if (!isMember) redirect(\"/dashboard\");\n\n  const canEdit = session.user.role === Role.ADMIN || session.user.role === Role.PROJECT_LEADER;\n\n  return (\n    <div className=\"space-y-6\">\n      <ProjectHeader project={project} canEdit={canEdit} currentUserId={session.user.id} />\n      <ProjectContentSwitcher project={project} canEdit={canEdit} />\n    </div>\n  );\n}\n","path":null,"size_bytes":1569,"size_tokens":null},"check-projects.ts":{"content":"import { PrismaClient } from '@prisma/client'\r\n\r\nconst prisma = new PrismaClient()\r\n\r\nasync function main() {\r\n    const projects = await prisma.project.findMany({\r\n        include: {\r\n            createdBy: {\r\n                select: { email: true, firstName: true, lastName: true }\r\n            },\r\n            members: {\r\n                include: {\r\n                    user: {\r\n                        select: { email: true }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    })\r\n\r\n    console.log('Projects in DB:', projects.length)\r\n    projects.forEach(p => {\r\n        console.log(`- Project: \"${p.name}\" (ID: ${p.id})`)\r\n        console.log(`  Owner: ${p.createdBy?.email || 'Unknown'}`)\r\n        console.log(`  Members: ${p.members.map(m => m.user.email).join(', ')}`)\r\n    })\r\n}\r\n\r\nmain()\r\n    .catch((e) => {\r\n        console.error(e)\r\n        process.exit(1)\r\n    })\r\n    .finally(async () => {\r\n        await prisma.$disconnect()\r\n    })\r\n","path":null,"size_bytes":975,"size_tokens":null},"src/app/(auth)/pending/page.tsx":{"content":"\"use client\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { useRouter } from \"next/navigation\";\nimport { signOut } from \"next-auth/react\";\n\nexport default function PendingPage() {\n  const router = useRouter();\n  return (\n    <div className=\"flex flex-col items-start gap-6\">\n      <div>\n        <p className=\"text-xs uppercase tracking-[0.3em] text-warning\">Venter p√• godkjenning</p>\n        <h2 className=\"mt-2 text-3xl font-semibold text-foreground\">Kontakten din ser bra ut</h2>\n        <p className=\"mt-3 max-w-xl text-muted-foreground\">\n          Vi har registrert kontoen din som <strong>PENDING</strong>. En administrator m√• godkjenne deg f√∏r du f√•r full tilgang.\n          Du f√•r fortsatt logget inn, men vil se denne siden til status endres.\n        </p>\n      </div>\n      <div className=\"flex gap-3\">\n        <Button variant=\"primary\" onClick={() => router.refresh()}>\n          Sjekk status p√• nytt\n        </Button>\n        <Button variant=\"ghost\" onClick={() => signOut({ callbackUrl: \"/login\" })}>\n          Logg ut\n        </Button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1099,"size_tokens":null},"prisma/seed.ts":{"content":"import {\n  DocumentType,\n  PrismaClient,\n  ProjectStatus,\n  Role,\n  UserStatus,\n} from \"@prisma/client\";\nimport bcrypt from \"bcryptjs\";\n\nconst prisma = new PrismaClient();\n\nconst adminEmails = [\"tm5479@gk.no\", \"flytlink.app@gmail.com\"];\nconst defaultAdminPassword = process.env.DEFAULT_ADMIN_PASSWORD || \"Admin123!\";\n\nasync function ensureAdmin(email: string) {\n  const existing = await prisma.user.findUnique({ where: { email } });\n  const passwordHash = await bcrypt.hash(defaultAdminPassword, 10);\n\n  if (existing) {\n    if (existing.role !== Role.ADMIN || existing.status !== UserStatus.ACTIVE) {\n      await prisma.user.update({\n        where: { email },\n        data: { role: Role.ADMIN, status: UserStatus.ACTIVE, passwordHash },\n      });\n    }\n    return existing;\n  }\n\n  return prisma.user.create({\n    data: {\n      email,\n      firstName: email.split(\"@\")[0] || \"Admin\",\n      lastName: \"User\",\n      passwordHash,\n      role: Role.ADMIN,\n      status: UserStatus.ACTIVE,\n      title: \"System Administrator\",\n    },\n  });\n}\n\nasync function main() {\n  const admins = [];\n  for (const email of adminEmails) {\n    admins.push(await ensureAdmin(email));\n  }\n\n  const demoLeader = await prisma.user.upsert({\n    where: { email: \"prosjektleder@example.com\" },\n    update: {},\n    create: {\n      email: \"prosjektleder@example.com\",\n      firstName: \"Prosjekt\",\n      lastName: \"Leder\",\n      passwordHash: await bcrypt.hash(\"Leader123!\", 10),\n      role: Role.PROJECT_LEADER,\n      status: UserStatus.ACTIVE,\n      title: \"Prosjektleder\",\n      company: \"SysLink AS\",\n      phone: \"+47 999 99 999\",\n    },\n  });\n\n  const systemTags = await prisma.$transaction(\n    [\"360\", \"420\"].map((code) =>\n      prisma.systemTag.upsert({\n        where: { code },\n        update: {},\n        create: { code, description: `System ${code}` },\n      })\n    )\n  );\n\n  await prisma.project.upsert({\n    where: { id: \"demo-project\" },\n    update: {},\n    create: {\n      id: \"demo-project\",\n      name: \"Fjord Tower U1\",\n      description: \"Pilotprosjekt for dokumenth√•ndtering og QA.\",\n      status: ProjectStatus.ACTIVE,\n      createdBy: { connect: { id: demoLeader.id } },\n      members: {\n        create: [\n          { user: { connect: { id: demoLeader.id } }, role: Role.PROJECT_LEADER },\n          { user: { connect: { id: admins[0].id } }, role: Role.ADMIN },\n        ],\n      },\n      documents: {\n        create: [\n          {\n            title: \"Riggplan 360\",\n            url: \"/demo/riggplan-360.pdf\",\n            type: DocumentType.DRAWING,\n            systemTags: [\"360\"],\n            tags: {\n              create: systemTags\n                .filter((t) => t.code === \"360\")\n                .map((tag) => ({ systemTag: { connect: { id: tag.id } } })),\n            },\n          },\n        ],\n      },\n      massList: {\n        create: [\n          { tfm: \"+12453601RTA4001RTA0001\", description: \"Ventilasjonsaggregat\", system: \"360\" },\n          { tfm: \"+12453601RTA5001RTA0002\", description: \"Kanalpakke\", system: \"360\" },\n        ],\n      },\n    },\n  });\n\n  console.log(\"Seed complete. Admins:\", adminEmails.join(\", \"));\n}\n\nmain()\n  .catch((e) => {\n    console.error(e);\n    process.exit(1);\n  })\n  .finally(async () => {\n    await prisma.$disconnect();\n  });\n","path":null,"size_bytes":3262,"size_tokens":null},"src/app/(auth)/login/page.tsx":{"content":"\"use client\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { signIn } from \"next-auth/react\";\nimport Link from \"next/link\";\nimport { useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Shield } from \"lucide-react\";\n\nexport default function LoginPage() {\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [totpCode, setTotpCode] = useState(\"\");\n  const [showTotp, setShowTotp] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [loading, setLoading] = useState(false);\n  const router = useRouter();\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    setLoading(true);\n    setError(null);\n    \n    try {\n      const checkRes = await fetch(\"/api/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          email,\n          password,\n          totpCode: showTotp ? totpCode : undefined,\n        }),\n      });\n      \n      const checkData = await checkRes.json();\n      \n      if (checkData.requiresTotp) {\n        setShowTotp(true);\n        setLoading(false);\n        return;\n      }\n      \n      if (checkData.error) {\n        setError(checkData.error);\n        if (checkData.error.includes(\"verifiseringskode\")) {\n          setTotpCode(\"\");\n        }\n        setLoading(false);\n        return;\n      }\n      \n      if (checkData.success) {\n        const res = await signIn(\"credentials\", { \n          redirect: false, \n          email, \n          password,\n          totpCode: showTotp ? totpCode : undefined,\n        });\n        \n        if (res?.error) {\n          setError(\"Innlogging feilet. Pr√∏v igjen.\");\n        } else {\n          router.replace(\"/dashboard\");\n        }\n      }\n    } catch (err) {\n      console.error(\"Login error:\", err);\n      setError(\"Nettverksfeil - pr√∏v igjen\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      <div>\n        <p className=\"text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground\">Velkommen tilbake</p>\n        <h2 className=\"text-2xl font-semibold text-foreground\">Logg inn</h2>\n      </div>\n      <form onSubmit={handleSubmit} className=\"flex flex-col gap-4\">\n        {!showTotp ? (\n          <>\n            <Input \n              label=\"E-post\" \n              type=\"email\" \n              value={email} \n              onChange={(e) => setEmail(e.target.value)} \n              required \n            />\n            <Input\n              label=\"Passord\"\n              type=\"password\"\n              value={password}\n              onChange={(e) => setPassword(e.target.value)}\n              required\n              hint=\"Minimum 8 tegn\"\n            />\n          </>\n        ) : (\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center gap-3 rounded-lg bg-muted/50 p-4\">\n              <Shield className=\"h-6 w-6 text-info\" />\n              <div>\n                <p className=\"font-medium text-foreground\">Tofaktor-autentisering</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  Skriv inn koden fra din authenticator-app\n                </p>\n              </div>\n            </div>\n            <Input\n              label=\"Verifiseringskode\"\n              type=\"text\"\n              inputMode=\"numeric\"\n              pattern=\"[0-9]*\"\n              maxLength={6}\n              value={totpCode}\n              onChange={(e) => setTotpCode(e.target.value.replace(/\\D/g, \"\"))}\n              placeholder=\"000000\"\n              required\n              autoFocus\n            />\n            <button\n              type=\"button\"\n              onClick={() => {\n                setShowTotp(false);\n                setTotpCode(\"\");\n                setError(null);\n              }}\n              className=\"text-sm text-info hover:underline\"\n            >\n              Tilbake til innlogging\n            </button>\n          </div>\n        )}\n        {error && <p className=\"text-sm text-danger\">{error}</p>}\n        <Button type=\"submit\" loading={loading}>\n          {showTotp ? \"Verifiser\" : \"Logg inn\"}\n        </Button>\n      </form>\n      {!showTotp && (\n        <p className=\"text-sm text-muted-foreground\">\n          Har du ikke bruker?{\" \"}\n          <Link href=\"/register\" className=\"font-semibold text-info underline-offset-4 hover:underline\">\n            Opprett konto\n          </Link>\n          {\" ‚Ä¢ \"}\n          <Link href=\"/reset\" className=\"font-semibold text-info underline-offset-4 hover:underline\">\n            Glemt passord?\n          </Link>\n        </p>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4742,"size_tokens":null},"check-users.ts":{"content":"import { PrismaClient } from '@prisma/client'\r\n\r\nconst prisma = new PrismaClient()\r\n\r\nasync function main() {\r\n    const users = await prisma.user.findMany()\r\n    console.log('Users in DB:', users.map(u => ({ email: u.email, role: u.role })))\r\n}\r\n\r\nmain()\r\n    .catch((e) => {\r\n        console.error(e)\r\n        process.exit(1)\r\n    })\r\n    .finally(async () => {\r\n        await prisma.$disconnect()\r\n    })\r\n","path":null,"size_bytes":409,"size_tokens":null},"README.md":{"content":"# SLUTTFASE\n\nNext.js (App Router) + Prisma/PostgreSQL + NextAuth-basert plattform med RBAC, prosjektoversikt, dokumenth√•ndtering, annotasjoner og mock-backup for DigitalOcean deploy.\n\n## Kjapp oversikt\n- Autentisering/registrering med PENDING-flow, hardkodet admin-e-post (tm5479@gk.no, flytlink.app@gmail.com) settes automatisk til ACTIVE/ADMIN.\n- Roller: ADMIN, PROJECT_LEADER, USER, READER. PENDING kan logge inn men ser egen venteside.\n- Dashboard: grid/list-visning, live-s√∏k, mine/inviterte prosjekter, backup-knapp (mock).\n- Prosjektside: sidebar-navigasjon, fremdriftswidgets, dokumentliste med system-tagging, skanne/verifisere mot masseliste (regex {byggnr}{system}{komponent}{typekode}), annoteringer med pins og @mentions, meldingssentral-stub.\n- Database: Prisma med entiteter for User/Project/ProjectMember/Document/SystemTag/MassList/Annotation/Comment/Notification + NextAuth-tabeller.\n\n## Komme i gang (lokalt)\n```bash\nnpm install\nnpx prisma db push\nnpx prisma db seed   # oppretter admin-brukere og demo-data\nnpm run dev\n```\nMilj√∏variabler finnes i `.env.example` (kopier til `.env`). `DEFAULT_ADMIN_PASSWORD` brukes i seeding.\n\n## Docker\n- Dev: `docker compose -f docker-compose.dev.yml up --build`\n- Prod: `docker compose -f docker-compose.prod.yml up --build`\nBegge starter Postgres og kj√∏rer `npm run db:push` f√∏r appen (`NEXTAUTH_URL` settes fra .env i prod).\n\n## Viktige filer/mapper\n- `prisma/schema.prisma` ‚Äì datamodell inkl. enums for roller/status.\n- `prisma/seed.ts` ‚Äì admin-seeding, demo-prosjekt, system-tagger 360/420, masselisteeksempler.\n- `src/lib/id-pattern.ts` ‚Äì regex for komponent-ID `{byggnr}{system}{komponent}{typekode}`.\n- `src/app/(auth)/*` ‚Äì login, register, pending.\n- `src/app/(app)/dashboard` ‚Äì hoveddashboard med prosjektgrid/list.\n- `src/app/(app)/admin/approvals` ‚Äì adminpanel for PENDING-brukere.\n- `src/app/(app)/projects/[id]` ‚Äì prosjektlayout med sidebar, widgets, dokument-/annotasjonsflyt.\n- `docker-compose.dev.yml` / `docker-compose.prod.yml`, `Dockerfile`, `.env.example`.\n\n## ID-/QA-logikk\n- Regex matcher ID-m√∏nsteret (+1245=3601.0001RTA4001RTA0001 osv).\n- `scanDocumentForComponents` og `verifyAgainstMassList` brukes i API og UI for √• telle komponenter og markere avvik.\n\n## Sikkerhet/RBAC\n- Middleware beskytter `/dashboard`, `/projects`, `/admin`, `/profile` og relevante API-ruter; PENDING omdirigeres til `/pending`.\n- ADMIN kan godkjenne/rolle-sette brukere, trigge backup (mock), arkivere/slette prosjekter.\n\n## Deploy-notater\n- Prod kj√∏rer `npm run db:push && npm run start` i containeren. Legg inn `NEXTAUTH_SECRET`, `NEXTAUTH_URL` og `DATABASE_URL` i `.env`.\n- Appen bruker `node:20-alpine` i Dockerfile. Volumer i compose holder Postgres-data persistente.\n","path":null,"size_bytes":2752,"size_tokens":null},"src/app/api/annotations/[annotationId]/route.ts":{"content":"import prisma from \"@/lib/db\";\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { requireAuth, canAnnotateDocuments } from \"@/lib/auth-helpers\";\n\nexport async function DELETE(\n    req: NextRequest,\n    { params }: { params: Promise<{ annotationId: string }> }\n) {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n        return authResult.error;\n    }\n\n    const { annotationId } = await params;\n\n    const annotation = await prisma.systemAnnotation.findUnique({\n        where: { id: annotationId },\n        include: { document: true },\n    });\n\n    if (!annotation) {\n        return NextResponse.json({ error: \"Annotering ikke funnet\" }, { status: 404 });\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n        where: { \n            projectId: annotation.document.projectId, \n            userId: authResult.user.id \n        },\n    });\n\n    if (!membership && authResult.user.role !== \"ADMIN\") {\n        return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    if (!canAnnotateDocuments(authResult.user.role, membership?.role)) {\n        return NextResponse.json({ error: \"Ingen tilgang til √• slette annoteringer\" }, { status: 403 });\n    }\n\n    await prisma.systemAnnotation.delete({\n        where: { id: annotationId },\n    });\n\n    return NextResponse.json({ success: true });\n}\n","path":null,"size_bytes":1371,"size_tokens":null},"logg.md":{"content":"","path":null,"size_bytes":0,"size_tokens":null},"src/app/api/auth/register/route.ts":{"content":"import { Role, UserStatus } from \"@prisma/client\";\nimport bcrypt from \"bcryptjs\";\nimport { NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport prisma from \"@/lib/db\";\nimport { adminEmails, titleCase } from \"@/lib/utils\";\n\nconst TOTP_DEADLINE_DAYS = 14;\n\nconst registerSchema = z.object({\n  firstName: z.string().min(1, \"Fornavn er p√•krevd\"),\n  lastName: z.string().min(1, \"Etternavn er p√•krevd\"),\n  email: z.string().email(\"Ugyldig e-post\"),\n  phone: z.string().optional(),\n  company: z.string().optional(),\n  title: z.string().optional(),\n  discipline: z.string().optional(),\n  other: z.string().optional(),\n  password: z.string().min(8, \"Passord m√• ha minst 8 tegn\"),\n});\n\nexport async function POST(req: Request) {\n  try {\n    const json = await req.json();\n    const parsed = registerSchema.safeParse(json);\n    if (!parsed.success) {\n      return NextResponse.json({ errors: parsed.error.flatten() }, { status: 400 });\n    }\n\n    const data = parsed.data;\n    const existing = await prisma.user.findUnique({ where: { email: data.email.toLowerCase() } });\n    if (existing) {\n      return NextResponse.json({ error: \"Bruker finnes allerede\" }, { status: 400 });\n    }\n\n    const isAdmin = adminEmails.includes(data.email.toLowerCase());\n    const role = isAdmin ? Role.ADMIN : Role.READER;\n    const status = isAdmin ? UserStatus.ACTIVE : UserStatus.PENDING;\n\n    const passwordHash = await bcrypt.hash(data.password, 10);\n\n    const totpDeadline = new Date();\n    totpDeadline.setDate(totpDeadline.getDate() + TOTP_DEADLINE_DAYS);\n\n    const user = await prisma.user.create({\n      data: {\n        firstName: titleCase(data.firstName),\n        lastName: titleCase(data.lastName),\n        email: data.email.toLowerCase(),\n        phone: data.phone,\n        company: data.company,\n        title: data.title,\n        discipline: data.discipline,\n        other: data.other,\n        passwordHash,\n        role,\n        status,\n        totpDeadline: isAdmin ? totpDeadline : null,\n      },\n    });\n\n    return NextResponse.json({\n      id: user.id,\n      status,\n      role,\n    });\n  } catch (error) {\n    console.error(\"Registration error:\", error);\n    return NextResponse.json({ error: \"Kunne ikke opprette bruker. Vennligst pr√∏v igjen senere.\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":2294,"size_tokens":null},"analyze-pdf.ts":{"content":"import * as fs from 'fs';\r\n// import pdf from 'pdf-parse';\r\nconst pdf = require('pdf-parse');\r\nimport { parseSystemTags } from './src/lib/tag-parser';\r\n\r\nasync function main() {\r\n    const dataBuffer = fs.readFileSync('test.pdf');\r\n\r\n    try {\r\n        const data = await pdf(dataBuffer);\r\n        console.log(\"üìÑ PDF Text Length:\", data.text.length);\r\n        console.log(\"üìÑ First 500 chars:\", data.text.substring(0, 500));\r\n\r\n        const tags = parseSystemTags(data.text);\r\n        console.log(\"üè∑Ô∏è Found Tags:\", tags);\r\n\r\n    } catch (error) {\r\n        console.error(\"‚ùå Error parsing PDF:\", error);\r\n    }\r\n}\r\n\r\nmain();\r\n","path":null,"size_bytes":637,"size_tokens":null},"src/app/(app)/projects/[projectId]/documents/[documentId]/page.tsx":{"content":"import prisma from \"@/lib/db\";\nimport { notFound } from \"next/navigation\";\nimport PDFViewerWrapper from \"@/components/pdf-viewer/pdf-viewer-wrapper\";\nimport SaveAndCloseButton from \"@/components/pdf-viewer/save-and-close-button\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\nimport { Role } from \"@prisma/client\";\n\ninterface DeepLinkParams {\n  annotationId?: string;\n  component?: string;\n  x?: number;\n  y?: number;\n  page?: number;\n}\n\nexport default async function DocumentPage({\n  params,\n  searchParams,\n}: {\n  params: Promise<{ projectId: string; documentId: string }>;\n  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;\n}) {\n  const session = await getServerSession(authOptions);\n  if (!session?.user?.email) {\n    notFound();\n  }\n\n  const { projectId, documentId } = await params;\n\n  const user = await prisma.user.findUnique({\n    where: { email: session.user.email },\n  });\n\n  if (!user) {\n    notFound();\n  }\n\n  const document = await prisma.document.findUnique({\n    where: { \n      id: documentId,\n      projectId,\n    },\n    include: {\n      annotations: {\n        include: {\n          author: {\n            select: {\n              id: true,\n              firstName: true,\n              lastName: true,\n              email: true,\n            },\n          },\n          comments: {\n            include: {\n              author: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                },\n              },\n            },\n            orderBy: { createdAt: \"asc\" },\n          },\n        },\n        orderBy: { createdAt: \"asc\" },\n      },\n    },\n  });\n\n  if (!document) return notFound();\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    include: {\n      members: {\n        include: {\n          user: true,\n        },\n      },\n    },\n  });\n\n  if (!project) return notFound();\n\n  const membership = project.members.find((m) => m.userId === user.id);\n  const isMember = !!membership || user.role === Role.ADMIN;\n\n  if (!isMember) {\n    notFound();\n  }\n\n  const canEdit =\n    user.role === Role.ADMIN ||\n    user.role === Role.PROJECT_LEADER ||\n    membership?.role === Role.PROJECT_LEADER ||\n    membership?.role === Role.USER;\n\n  const members = project.members.map((m) => ({\n    id: m.user.id,\n    name: `${m.user.firstName} ${m.user.lastName}`,\n    email: m.user.email,\n  }));\n\n  const formattedAnnotations = document.annotations.map((a) => ({\n    id: a.id,\n    x: a.x,\n    y: a.y,\n    status: a.status,\n    author: a.author,\n    comments: a.comments.map((c) => ({\n      id: c.id,\n      content: c.content,\n      author: c.author,\n      createdAt: c.createdAt.toISOString(),\n    })),\n  }));\n\n  const resolvedSearchParams = await searchParams;\n  const deepLink: DeepLinkParams = {\n    annotationId: typeof resolvedSearchParams.annotationId === \"string\" \n      ? resolvedSearchParams.annotationId \n      : undefined,\n    component: typeof resolvedSearchParams.component === \"string\" \n      ? resolvedSearchParams.component \n      : undefined,\n    x: resolvedSearchParams.x \n      ? parseFloat(resolvedSearchParams.x as string) \n      : undefined,\n    y: resolvedSearchParams.y \n      ? parseFloat(resolvedSearchParams.y as string) \n      : undefined,\n    page: resolvedSearchParams.page \n      ? parseInt(resolvedSearchParams.page as string, 10) \n      : undefined,\n  };\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      <div className=\"flex justify-between items-center p-4 border-b border-border/60 bg-card/80 backdrop-blur-xl\">\n        <h1 className=\"text-xl font-bold text-foreground\">{document.title}</h1>\n        <SaveAndCloseButton\n          projectId={projectId}\n          documentId={documentId}\n          systemTags={document.systemTags}\n        />\n      </div>\n      <div className=\"flex-1 relative overflow-hidden\">\n        <PDFViewerWrapper\n          url={document.url}\n          systemTags={document.systemTags}\n          documentId={documentId}\n          initialAnnotations={formattedAnnotations}\n          projectMembers={members}\n          currentUserEmail={session?.user?.email || undefined}\n          canEdit={canEdit}\n          initialAnnotationId={deepLink.annotationId}\n          initialPage={deepLink.page}\n        />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":4349,"size_tokens":null},"AGENTS.md":{"content":"Du opptrer n√• som en Senior Full-Stack Arkitekt og Lead UI/UX Designer. Ditt oppdrag er √• bygge fundamentet for applikasjonen \"SLUTTFASE\".\n\nL√∏sningen skal kunne deployes p√• en DigitalOcean Droplet. All kode skal v√¶re produksjonsklar, containerisert (Docker) og f√∏lge gode sikkerhets- og arkitekturprinsipper.\n\nGENERELLE TEKNISKE F√òRINGER (UTEN √Ö L√ÖSE TECH STACK)\n\nVelg selv programmeringsspr√•k, rammeverk og UI-verkt√∏y som passer godt sammen og er egnet for en moderne, sikker, web-basert applikasjon.\n\nL√∏sningen skal ha:\n\nEn web-frontend med profesjonell UI/UX.\n\nEn backend med tydelig struktur for API/endepunkter.\n\nEn relasjonsdatabase, der PostgreSQL skal brukes som database-motor (kj√∏res via Docker Compose).\n\nEt egnet ORM- eller migreringsverkt√∏y for valgt spr√•k/rammeverk.\n\nEt modent autentiserings- og autorisasjonsoppsett (RBAC).\n\nStyling og interaksjon:\n\nUI skal v√¶re responsivt, st√∏tte lys/m√∏rk modus, og ha et uttrykk som kan beskrives som:\n\"Construction Tech m√∏ter Apple\" ‚Äì rent, moderne, profesjonelt.\n\nBruk et passende komponentbibliotek og eventuelt animasjons-/overgangsbibliotek for valgt stack.\n\nDeployment:\n\nGenerer en docker-compose.yml for b√•de dev og prod.\n\nGenerer en Dockerfile basert p√• valgt runtime (spr√•k/rammeverk), optimalisert for produksjon.\n\nInkluder en .env.example med n√∏dvendige milj√∏variabler.\n\nVIKTIG: Du skal bruke dine evner til √• skrive filer direkte til disk og lage en komplett mappestruktur for prosjektet (/sluttfase).\n\nHvis du ser en mappe som heter Base, analyser kodestilen der, men prioriter moderne \"best practices\" for denne nye applikasjonen.\n\nFASE 1 ‚Äì AUTENTISERING, RBAC OG DASHBOARD-GRUNNSTRUCTUR\n1. Autentisering & Registrering\n\nRegistreringsfelter:\n\nFornavn\n\nEtternavn\n\nE-post\n\nTelefon\n\nFirma\n\nTittel\n\nAlle nye brukere skal f√• status: PENDING.\n\nBrukere med status PENDING:\n\nSkal kunne logge inn, men ledes til en egen visning:\n\"Venter p√• godkjenning\".\n\nHardkodet admin-logikk:\n\nE-postene tm5479@gk.no og flytlink.app@gmail.com skal automatisk f√•:\n\nRolle: ADMIN\n\nStatus: ACTIVE\n\nDette kan l√∏ses med seeding av databasen eller logikk i autentiseringsflyten (f.eks. callback/after-register).\n\n2. Rollemodell (RBAC)\n\nDefiner f√∏lgende roller og tillatelser:\n\nADMIN\n\nKan godkjenne brukere.\n\nKan tildele roller.\n\nKan slette alt (brukere, prosjekter, innhold).\n\nPROSJEKTLEDER\n\nKan opprette prosjekter.\n\nKan endre prosjektstatus.\n\nKan kommentere.\n\nKan invitere brukere til prosjekter.\n\nBRUKER\n\nKan endre status i prosjekter de er invitert til.\n\nKan kommentere.\n\nLESER\n\nRead-only tilgang til prosjekter de er invitert til.\n\n3. Hoved-Dashboard (UI/UX)\n\nDesign:\n\nSkal st√∏tte lys/m√∏rk modus.\n\nUttrykk: Construction Tech + Apple (rent, detaljfokusert, intuitivt).\n\nVisning:\n\nGrid- og listevisning av prosjekter.\n\nDel inn i:\n\n\"Mine prosjekter\"\n\n\"Inviterte prosjekter\"\n\nS√∏k:\n\nGlobalt s√∏kefelt som filtrerer i sanntid p√• prosjektkort (navn, beskrivelse, status osv.).\n\nInteraksjon:\n\nBruk et egnet animasjons-/overgangsbibliotek i valgt stack for smidige overganger n√•r:\n\nKort √•pnes/lukkes.\n\nFaner byttes.\n\nFilter/s√∏k endres.\n\n4. Prosjekt-funksjoner (CRUD)\n\nFor entiteten Project:\n\nOpprett prosjekt.\n\nArkiver prosjekt (flyttes til egen Arkiv-visning).\n\nSlett prosjekt:\n\nKUN tillatt fra Arkiv-visning.\n\nInviter medlemmer:\n\nS√∏kefelt for √• finne andre aktive brukere i systemet.\n\nLegg til brukere med valgt rolle i prosjektet.\n\nBackup (mock i f√∏rste omgang):\n\nEn knapp i Admin-panelet eller Dashboard:\n\nTrigger en (forel√∏pig simulert) database-dump.\n\nLag UI rundt dette (f.eks. modal/progress).\n\n5. Instruksjoner for generering (Fase 1)\n\nSett opp prosjektstrukturen i en mappe: /sluttfase.\n\nGenerer:\n\ndocker-compose.yml\n\n.env.example\n\nDefiner databasen (f.eks. via ORM/migreringer) med entiteter som minst dekker:\n\nUser\n\nRole (enum/felt)\n\nProject\n\nProjectMember\n\nComment\n\nImplementer autentiseringsflyt med:\n\nRegistrering\n\nLogin\n\nH√•ndtering av PENDING‚Äì> \"venter p√• godkjenning\"-visning\n\nHardkodet admin-logikk for spesifikke e-poster\n\nLag kjernekomponenter for UI:\n\nGlobal layout\n\nNavbar\n\nDashboard-grid/list for prosjekter\n\nImplementer et Godkjennings-panel for ADMIN:\n\nListe over PENDING-brukere.\n\nMulighet til √• sette status til ACTIVE.\n\nMulighet til √• sette rolle.\n\nN√•r fundamentet (auth, database-schema, dashboard) er p√• plass:\nStopp og be om instruksjoner for \"Fase 2: Prosjektinnhold\".\n\nFASE 2 ‚Äì PROSJEKT-INNHOLD (\"INNMATEN\")\n\nDu fortsetter i rollen som Senior Full-Stack Arkitekt og Lead UI/UX Designer for applikasjonen \"SLUTTFASE\".\n\nVIKTIG KONTEKST FRA BASE-MAPPEN (ID-STRUKTUR)\n\nI mappen \"Base\" (kunnskapsgrunnlaget ditt) ligger logikken for ID-struktur.\n\nID-m√∏nsteret er strengt:\n\n{byggnr}{system}{komponent}{typekode}\n\nEksempel (delt opp):\n\n+1245 = bygg\n\n=3601.0001 = system\n\nRTA4001 = komponent\n\nRTA0001 = type\n\nDette m√∏nsteret er kjernen i applikasjonen, og skal brukes til regex-matching og videre logikk.\n\nSTEG 1 ‚Äì Oppdatering av Fase 1 (User Profile)\n\nF√∏r vi g√•r inn i prosjektene, m√• vi legge til en funksjon i hovedvisningen (prosjekt-oversikten):\n\nProfil-meny\n\nLegg til en dropdown-meny ved brukerens avatar/navn.\n\nRediger profil\n\nLag en /profile-side eller modal hvor innlogget bruker kan redigere:\n\nTelefon\n\nTittel\n\nFirma\n\nPassord\n\nFeltene E-post og rolle skal v√¶re read-only.\n\nSTEG 2 ‚Äì Prosjekt-Dashboard (Layout & Navigasjon)\n\nN√•r en bruker klikker seg inn p√• et prosjekt /projects/[projectId], skal layouten endres til et prosjekt-dashboard.\n\nSidebar/Meny (venstrestilt):\n\nMenyen skal minst inneholde:\n\nHovedside (Dashboard)\n\nArbeidstegninger\n\nSystemskjema\n\nMasseliste\n\nProtokoller MC\n\nFremdrift\n\nInnhold p√• \"Hovedside\" (Dashboard Widgets):\n\nBruk et egnet graf-/visualiseringsbibliotek i valgt stack, samt animasjoner der det gir mening.\n\nDynamisk Fremdrift\n\n4 cards med tall/status:\n\n\"Utf√∏rte\"\n\n\"Avvik\"\n\n\"P√•g√•r\"\n\n\"Kommende\"\n\nTotal Fremdrift\n\nEn visuell fremdriftsindikator:\n\nF.eks. progresjonsbar eller \"donut chart\".\n\nSplittet i: Fullf√∏rt vs Ikke fullf√∏rt.\n\nSiste Aktivitet\n\nEn feed som viser de siste kommentarene/aktivitetene p√• tvers av tegninger/dokumenter.\n\nNylige Dokumenter\n\nListe over de 5 sist opplastede/endrede filene med hurtiglenke.\n\nMeldingssentral\n\nSeksjon som viser om brukeren har uleste mentions (@Navn) fra tegninger/dokumenter.\n\nSTEG 3 ‚Äì Dokumenth√•ndtering & \"The Brain\" (Arbeidstegninger/Systemskjema)\n\nDette er kjernen i applikasjonen og krever strukturert logikk.\n\n3.1 Opplasting & System-tagging\n\nLag et opplastingsomr√•de (helst med Drag & Drop).\n\nVed opplasting/redigering skal brukeren kunne angi hvilke {system} tegningen tilh√∏rer:\n\nF.eks. 360, 420.\n\nDet skal v√¶re mulig √•:\n\nVelge flere systemer per dokument.\n\nOpprette nye tilpassede systemflagg.\n\nLagre metadata i databasen, f.eks. via entiteter/tabeller:\n\nDocument\n\nSystemTag\n\nRelasjon mellom disse.\n\n3.2 QA Skanner-Motor (Logikk)\n\nLag en funksjon, f.eks.:\n\nscanDocumentForComponents(content, systemTag)\n\nForm√•l:\n\nFinne komponenter i tekstinnhold (OCR-resultat eller PDF-tekst) som matcher m√∏nsteret\n{byggnr}{system}{komponent}{typekode}.\n\nFiltrering:\n\nSkanneren skal prioritere ID-er som matcher den/de {system}-taggene som er satt p√• dokumentet.\n\n3.3 \"Verifiser mot Masseliste\" (Matrise-funksjon)\n\nP√• dokument-visningen:\n\nLegg inn en knapp \"Verifiser komponenter\".\n\nLogikk:\n\nHent alle ID-er funnet i dokumentet.\n\nSjekk disse mot tabellen MassList i databasen.\n\nUI-resultat (Matrise):\n\nEn modal/popup med to kolonner:\n\n\"Funnet i tegning\"\n\n\"Funnet i Masseliste\"\n\nAvvik:\n\nVis r√∏dt flagg hvis:\n\nKomponent finnes i Masseliste, men ikke i tegning.\n\nKomponent finnes i tegning, men ikke i Masseliste.\n\nOverride:\n\nLegg til en knapp \"Godkjenn avvik\" som lar bruker manuelt sette status til OK selv om programmet ikke fant match.\n\nTeller:\n\nVed siden av hvert dokument i dokumentlisten:\n\nVis et tall = antall unike komponenter funnet.\n\nKlikk p√• tallet √•pner matrisen nevnt over.\n\nKnapp (fremtidig):\n\nInkluder en knapp \"Eksporter til Protokoll\" som forel√∏pig er disabled.\n\nSTEG 4 ‚Äì Interaktiv PDF/Bilde-visning & Annotering\n\nLag en dokumentviser basert p√• valgt stack (f.eks. PDF-viewer eller bilde-canvas).\n\nAnnotering & Mentions\n\nBruker skal kunne klikke hvor som helst p√• tegningen for √• sette en \"Pin\".\n\nStatus-Pin:\n\n√Öpen sak = oransje prikk (gjerne med pulserende animasjon).\n\nLukket sak = gr√∏nn prikk (statisk).\n\nKommentarfelt:\n\nN√•r man trykker p√• en prikk, √•pnes en dialog/boks for kommentarer.\n\n@Mention-logikk:\n\nHvis bruker skriver @ i kommentarfeltet:\n\nVis en liste over prosjektmedlemmer.\n\nVed sending:\n\nLagre kommentaren.\n\nOpprett en Notification til brukeren(e) som ble tagget.\n\nDette skal vises i \"Meldingssentralen\" p√• prosjekt-dashboardet.\n\nDatabasedesign ‚Äì utvidelser\n\nUtvid schema/datamodell (med passende felt/typer for valgt ORM) til √• inkludere minst:\n\nDocument\n\nurl\n\ntype (tegning, skjema, masseliste, annet)\n\nrelasjon til SystemTag\n\nrelasjon til Project\n\nSystemTag\n\nsystemkode (f.eks. 360, 420)\n\nbeskrivelse (valgfritt)\n\nMassList\n\nid\n\ncode (full ID, f.eks. {byggnr}{system}{komponent}{typekode})\n\ndescription\n\nsystem\n\nrelasjon til Project (hvis relevant)\n\nAnnotation\n\nx, y\n\nstatus [OPEN, CLOSED]\n\nrelasjon til Document\n\nComment\n\ncontent\n\nauthor (relasjon til User)\n\nrelasjon til Annotation\n\nNotification\n\nrelasjon til mottaker (User)\n\nrelasjon til kilde (f.eks. Comment/Annotation)\n\nlest/ulest-status\n\ntidsstempel\n\nInstruksjoner for generering (Fase 2)\n\nOppdater datamodellen f√∏rst (ORM/schema/migreringer).\n\nGenerer filer/komponenter for:\n\nProsjekt-layout med sidebar/navigasjon.\n\nDashboard-widgets p√• prosjektniv√• (fremdrift, siste aktivitet, nylige dokumenter, meldingssentral).\n\nImplementer:\n\nDokument-opplasting med system-tagging.\n\nSkanner-funksjon (kan i f√∏rste omgang simuleres/stubbes, men strukturen m√• v√¶re p√• plass).\n\n\"Verifiser mot Masseliste\"-matrise med avvikslogikk.\n\nLag dokumentvisning med:\n\nPins (annoteringer).\n\nKommentarflyt.\n\n@mentions og tilh√∏rende notifikasjoner.\n\nS√∏rg for at UI fremst√•r som et showcase-produkt:\n\nGjennomf√∏rt design.\n\nKonsistent typografi og spacing.\n\nGod bruk av meldinger, tilbakemeldinger og states (loading, tomme lister, feil osv.).\n\nOppsummering til Codex CLI:\n\nVelg selv egnet kodespr√•k, rammeverk og designverkt√∏y basert p√• kravene over.\n\nOppfyll krav til:\n\nRBAC\n\nAutentisering\n\nProsjektstruktur\n\nDokumenth√•ndtering\n\nAnnotering\n\nRegex-basert ID-logikk\n\nDashboard og meldingssentral\n\nLever en komplett, containeriserbar prosjektstruktur som kan kj√∏res p√• en DigitalOcean Droplet.","path":null,"size_bytes":10509,"size_tokens":null},"next.config.ts":{"content":"import type { NextConfig } from \"next\";\n\nconst nextConfig: NextConfig = {\n  experimental: {\n    serverActions: {\n      bodySizeLimit: '50mb',\n    },\n  },\n  turbopack: {},\n  webpack: (config) => {\n    config.externals = [...(config.externals || []), { canvas: 'canvas' }];\n    return config;\n  },\n  allowedDevOrigins: [\n    'https://*.replit.dev',\n    'https://*.repl.co',\n    'https://*.kirk.replit.dev',\n    'http://127.0.0.1:5000',\n    'http://localhost:5000',\n  ],\n};\n\nexport default nextConfig;\n","path":null,"size_bytes":499,"size_tokens":null},"reset-admin-password.ts":{"content":"import { PrismaClient } from \"@prisma/client\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nasync function main() {\r\n    const email = \"flytlink.app@gmail.com\";\r\n    const password = \"Admin123!\";\r\n    const passwordHash = await bcrypt.hash(password, 10);\r\n\r\n    console.log(`Resetting password for ${email}...`);\r\n\r\n    const user = await prisma.user.update({\r\n        where: { email },\r\n        data: { passwordHash },\r\n    });\r\n\r\n    console.log(\"Password reset successfully.\");\r\n    console.log(`User: ${user.email}`);\r\n    console.log(`New Password: ${password}`);\r\n}\r\n\r\nmain()\r\n    .catch((e) => {\r\n        console.error(e);\r\n        process.exit(1);\r\n    })\r\n    .finally(async () => {\r\n        await prisma.$disconnect();\r\n    });\r\n","path":null,"size_bytes":767,"size_tokens":null},"src/app/(app)/layout.tsx":{"content":"import \"@/app/globals.css\";\n\nexport default function AppLayout({ children }: { children: React.ReactNode }) {\n  return children;\n}\n","path":null,"size_bytes":131,"size_tokens":null},"src/app/(app)/profile/page.tsx":{"content":"import { AppShell } from \"@/components/layout/app-shell\";\nimport prisma from \"@/lib/db\";\nimport { authOptions } from \"@/lib/auth\";\nimport { getServerSession } from \"next-auth\";\nimport { redirect } from \"next/navigation\";\nimport { ProfileForm } from \"@/components/pages/profile/profile-form\";\nimport { PasswordChange } from \"@/components/pages/profile/password-change\";\nimport { TotpSetup } from \"@/components/pages/profile/totp-setup\";\n\nexport default async function ProfilePage() {\n  const session = await getServerSession(authOptions);\n  if (!session?.user?.email) redirect(\"/login\");\n  if (session.user.status === \"PENDING\") redirect(\"/pending\");\n\n  const user = await prisma.user.findUnique({ \n    where: { email: session.user.email },\n    select: {\n      id: true,\n      firstName: true,\n      lastName: true,\n      email: true,\n      phone: true,\n      company: true,\n      title: true,\n      discipline: true,\n      role: true,\n      status: true,\n      totpEnabled: true,\n    }\n  });\n  if (!user) redirect(\"/login\");\n\n  return (\n    <AppShell>\n      <div className=\"space-y-6\">\n        <ProfileForm user={user} />\n        <div className=\"grid gap-6 lg:grid-cols-2\">\n          <PasswordChange />\n          <TotpSetup totpEnabled={user.totpEnabled} />\n        </div>\n      </div>\n    </AppShell>\n  );\n}\n","path":null,"size_bytes":1309,"size_tokens":null},"prisma/migrations/migration_lock.toml":{"content":"# Please do not edit this file manually\n# It should be added in your version-control system (i.e. Git)\nprovider = \"postgresql\"","path":null,"size_bytes":126,"size_tokens":null},"next-env.d.ts":{"content":"/// <reference types=\"next\" />\n/// <reference types=\"next/image-types/global\" />\nimport \"./.next/dev/types/routes.d.ts\";\n\n// NOTE: This file should not be edited\n// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.\n","path":null,"size_bytes":251,"size_tokens":null},"src/app/(app)/dashboard/page.tsx":{"content":"import { AppShell } from \"@/components/layout/app-shell\";\nimport { DashboardClient } from \"@/components/pages/dashboard/dashboard-client\";\nimport prisma from \"@/lib/db\";\nimport { authOptions } from \"@/lib/auth\";\nimport { getServerSession } from \"next-auth\";\nimport { redirect } from \"next/navigation\";\n\nexport default async function DashboardPage() {\n  const session = await getServerSession(authOptions);\n  if (!session?.user?.email) redirect(\"/login\");\n  if (session.user.status === \"PENDING\") redirect(\"/pending\");\n\n  const user = await prisma.user.findUnique({ where: { email: session.user.email } });\n  if (!user) redirect(\"/login\");\n\n  const projects = await prisma.project.findMany({\n    where: { OR: [{ createdById: user.id }, { members: { some: { userId: user.id } } }] },\n    include: {\n      members: { include: { user: true } },\n      documents: true,\n      chatRooms: {\n        where: { isActive: true },\n        select: {\n          id: true,\n          name: true,\n          type: true,\n          _count: { select: { messages: true } },\n        },\n        take: 5,\n      },\n      _count: { select: { chatRooms: true } },\n    },\n    orderBy: { updatedAt: \"desc\" },\n  });\n\n  const invited = projects.filter((p) => p.createdById !== user.id);\n  const mine = projects.filter((p) => p.createdById === user.id || p.members.some((m) => m.userId === user.id));\n\n  return (\n    <AppShell>\n      <DashboardClient\n        user={{\n          id: user.id,\n          role: user.role,\n          discipline: user.discipline || undefined,\n        }}\n        projects={projects}\n        mine={mine}\n        invited={invited}\n      />\n    </AppShell>\n  );\n}\n","path":null,"size_bytes":1651,"size_tokens":null},"src/app/(app)/admin/approvals/page.tsx":{"content":"import { AppShell } from \"@/components/layout/app-shell\";\nimport { ApprovalPanel } from \"@/components/pages/admin/approval-panel\";\nimport prisma from \"@/lib/db\";\nimport { authOptions } from \"@/lib/auth\";\nimport { getServerSession } from \"next-auth\";\nimport { redirect } from \"next/navigation\";\nimport { Role, UserStatus } from \"@prisma/client\";\n\nexport default async function ApprovalsPage() {\n  const session = await getServerSession(authOptions);\n  if (!session?.user?.email) redirect(\"/login\");\n  if (session.user.status === UserStatus.PENDING) redirect(\"/pending\");\n\n  const user = await prisma.user.findUnique({ where: { email: session.user.email } });\n  if (!user || user.role !== Role.ADMIN) redirect(\"/dashboard\");\n\n  const pending = await prisma.user.findMany({\n    where: { status: UserStatus.PENDING },\n    select: {\n      id: true,\n      firstName: true,\n      lastName: true,\n      email: true,\n      company: true,\n      title: true,\n      createdAt: true,\n      role: true,\n    },\n    orderBy: { createdAt: \"asc\" },\n  });\n\n  return (\n    <AppShell>\n      <ApprovalPanel initialUsers={pending} />\n    </AppShell>\n  );\n}\n","path":null,"size_bytes":1134,"size_tokens":null},"src/app/(auth)/reset/page.tsx":{"content":"\"use client\";\n\nimport { useSearchParams, useRouter } from \"next/navigation\";\nimport { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\n\nexport default function ResetPage() {\n  const search = useSearchParams();\n  const token = search.get(\"token\");\n  const mode = token ? \"confirm\" : \"request\";\n\n  return mode === \"request\" ? <RequestForm /> : <ConfirmForm token={token!} />;\n}\n\nfunction RequestForm() {\n  const [email, setEmail] = useState(\"\");\n  const [message, setMessage] = useState<string | null>(null);\n  const [loading, setLoading] = useState(false);\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    setLoading(true);\n    setMessage(null);\n    const res = await fetch(\"/api/auth/reset/request\", {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ email }),\n    });\n    const json = await res.json();\n    setLoading(false);\n    setMessage(res.ok ? \"Sjekk e-post for reset-lenke\" : json.error || \"Kunne ikke sende e-post\");\n  }\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      <div>\n        <p className=\"text-xs uppercase tracking-[0.3em] text-muted-foreground\">Glemt passord</p>\n        <h2 className=\"text-2xl font-semibold text-foreground\">Send reset-lenke</h2>\n      </div>\n      <form onSubmit={handleSubmit} className=\"flex flex-col gap-4\">\n        <Input label=\"E-post\" type=\"email\" value={email} onChange={(e) => setEmail(e.target.value)} required />\n        {message && <p className=\"text-sm text-info\">{message}</p>}\n        <Button type=\"submit\" loading={loading}>\n          Send lenke\n        </Button>\n      </form>\n    </div>\n  );\n}\n\nfunction ConfirmForm({ token }: { token: string }) {\n  const router = useRouter();\n  const [password, setPassword] = useState(\"\");\n  const [confirm, setConfirm] = useState(\"\");\n  const [message, setMessage] = useState<string | null>(null);\n  const [loading, setLoading] = useState(false);\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    if (password !== confirm) {\n      setMessage(\"Passordene matcher ikke\");\n      return;\n    }\n    setLoading(true);\n    setMessage(null);\n    const res = await fetch(\"/api/auth/reset/confirm\", {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ token, password }),\n    });\n    const json = await res.json();\n    setLoading(false);\n    if (res.ok) {\n      setMessage(\"Passord oppdatert. Du kan n√• logge inn.\");\n      setTimeout(() => router.replace(\"/login\"), 1200);\n    } else {\n      setMessage(json.error || \"Kunne ikke oppdatere passord\");\n    }\n  }\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      <div>\n        <p className=\"text-xs uppercase tracking-[0.3em] text-muted-foreground\">Tilbakestill passord</p>\n        <h2 className=\"text-2xl font-semibold text-foreground\">Sett nytt passord</h2>\n      </div>\n      <form onSubmit={handleSubmit} className=\"flex flex-col gap-4\">\n        <Input\n          label=\"Nytt passord\"\n          type=\"password\"\n          value={password}\n          onChange={(e) => setPassword(e.target.value)}\n          required\n        />\n        <Input\n          label=\"Gjenta passord\"\n          type=\"password\"\n          value={confirm}\n          onChange={(e) => setConfirm(e.target.value)}\n          required\n        />\n        {message && <p className=\"text-sm text-info\">{message}</p>}\n        <Button type=\"submit\" loading={loading}>\n          Oppdater passord\n        </Button>\n      </form>\n    </div>\n  );\n}\n","path":null,"size_bytes":3605,"size_tokens":null},"src/app/(auth)/layout.tsx":{"content":"import \"@/app/globals.css\";\n\nexport default function AuthLayout({ children }: { children: React.ReactNode }) {\n  return (\n    <div className=\"relative flex min-h-screen items-center justify-center bg-[radial-gradient(circle_at_20%_20%,rgba(59,130,246,0.08),transparent_30%),radial-gradient(circle_at_80%_0%,rgba(16,185,129,0.08),transparent_25%),var(--background)] px-6 py-10\">\n      <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_10%_10%,rgba(255,255,255,0.08),transparent_20%),radial-gradient(circle_at_90%_20%,rgba(255,255,255,0.05),transparent_22%)] pointer-events-none\" />\n      <div className=\"w-full max-w-5xl rounded-3xl border border-border bg-card/80 p-6 shadow-[0_30px_80px_rgba(0,0,0,0.12)] md:p-12\">\n        <div className=\"grid gap-10 md:grid-cols-[1.2fr,1fr]\">\n          <div className=\"flex flex-col justify-between gap-8\">\n            <div>\n              <p className=\"text-xs uppercase tracking-[0.35em] text-muted-foreground\">SysLink</p>\n              <h1 className=\"mt-4 flex flex-wrap items-center gap-3 text-4xl font-semibold leading-tight text-foreground md:text-5xl\">\n                Byggebransjen m√∏ter SysLink\n                <img src=\"/syslink-logo.png\" alt=\"SysLink Logo\" className=\"h-[2.25em] rounded-lg shadow-sm\" />\n              </h1>\n              <p className=\"mt-4 max-w-xl text-lg text-muted-foreground\">\n                Logg inn eller registrer deg for √• f√• tilgang til prosjektrom, dokumenth√•ndtering og verkt√∏y som er skreddersydd for dine byggeprosjekter.\n              </p>\n            </div>\n            <div className=\"hidden items-center gap-3 rounded-2xl border border-border bg-muted/30 p-4 md:flex\">\n              <div className=\"h-10 w-10 rounded-full bg-gradient-to-br from-slate-900 to-slate-700 shadow-lg\" />\n              <div>\n                <p className=\"text-sm font-semibold text-foreground\">Robust sikkerhet</p>\n                <p className=\"text-xs text-muted-foreground\">RBAC, godkjenning og audit-traces bygget inn fra start.</p>\n              </div>\n            </div>\n          </div>\n          <div className=\"glass relative overflow-hidden rounded-3xl p-6 shadow-inner\">\n            <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary/10 via-transparent to-info/10\" />\n            <div className=\"relative\">{children}</div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2405,"size_tokens":null},"src/lib/db.ts":{"content":"import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nconst prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n\nexport default prisma;\n","path":null,"size_bytes":301,"size_tokens":null},"src/types/next-auth.d.ts":{"content":"import { Role, UserStatus } from \"@prisma/client\";\nimport \"next-auth\";\nimport \"next-auth/jwt\";\n\ndeclare module \"next-auth\" {\n  interface User {\n    id: string;\n    role: Role;\n    status: UserStatus;\n  }\n\n  interface Session {\n    user: {\n      id: string;\n      email: string;\n      name: string;\n      role: Role;\n      status: UserStatus;\n    };\n  }\n}\n\ndeclare module \"next-auth/jwt\" {\n  interface JWT {\n    id: string;\n    role: Role;\n    status: UserStatus;\n  }\n}\n","path":null,"size_bytes":469,"size_tokens":null},"src/lib/utils.ts":{"content":"export const adminEmails = [\"tm5479@gk.no\", \"flytlink.app@gmail.com\"];\n\nexport function titleCase(str: string): string {\n  return str\n    .toLowerCase()\n    .split(\" \")\n    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\n    .join(\" \");\n}\n\nexport function cn(...inputs: (string | undefined | null | false)[]): string {\n  return inputs.filter(Boolean).join(\" \");\n}\n","path":null,"size_bytes":377,"size_tokens":null},"src/lib/auth.ts":{"content":"import { NextAuthOptions } from \"next-auth\";\nimport CredentialsProvider from \"next-auth/providers/credentials\";\nimport { PrismaAdapter } from \"@next-auth/prisma-adapter\";\nimport bcrypt from \"bcryptjs\";\nimport { authenticator } from \"otplib\";\nimport prisma from \"./db\";\n\nexport const authOptions: NextAuthOptions = {\n  adapter: PrismaAdapter(prisma),\n  session: {\n    strategy: \"jwt\",\n  },\n  pages: {\n    signIn: \"/login\",\n  },\n  providers: [\n    CredentialsProvider({\n      name: \"credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"email\" },\n        password: { label: \"Password\", type: \"password\" },\n        totpCode: { label: \"TOTP Code\", type: \"text\" },\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) {\n          throw new Error(\"E-post og passord er p√•krevd\");\n        }\n\n        const user = await prisma.user.findUnique({\n          where: { email: credentials.email.toLowerCase() },\n        });\n\n        if (!user) {\n          throw new Error(\"Ugyldig e-post eller passord\");\n        }\n\n        const passwordMatch = await bcrypt.compare(\n          credentials.password,\n          user.passwordHash\n        );\n\n        if (!passwordMatch) {\n          throw new Error(\"Ugyldig e-post eller passord\");\n        }\n\n        if (user.status === \"SUSPENDED\") {\n          throw new Error(\"Kontoen din er suspendert. Kontakt administrator.\");\n        }\n\n        if (user.status === \"PENDING\") {\n          throw new Error(\"Kontoen din venter p√• godkjenning fra administrator.\");\n        }\n\n        if (user.status !== \"ACTIVE\") {\n          throw new Error(\"Kontoen din er ikke aktiv.\");\n        }\n\n        if (user.totpEnabled && user.totpSecret) {\n          if (!credentials.totpCode) {\n            throw new Error(\"TOTP_REQUIRED\");\n          }\n\n          if (user.totpLockedUntil && user.totpLockedUntil > new Date()) {\n            const minutesLeft = Math.ceil((user.totpLockedUntil.getTime() - Date.now()) / 60000);\n            throw new Error(`For mange feilede fors√∏k. Pr√∏v igjen om ${minutesLeft} minutter.`);\n          }\n\n          const isValidTotp = authenticator.verify({\n            token: credentials.totpCode,\n            secret: user.totpSecret,\n          });\n\n          if (!isValidTotp) {\n            const newFailedAttempts = user.totpFailedAttempts + 1;\n            const lockoutTime = newFailedAttempts >= 5 \n              ? new Date(Date.now() + 15 * 60 * 1000) \n              : null;\n\n            await prisma.user.update({\n              where: { id: user.id },\n              data: {\n                totpFailedAttempts: newFailedAttempts,\n                totpLockedUntil: lockoutTime,\n              },\n            });\n\n            if (lockoutTime) {\n              throw new Error(\"For mange feilede fors√∏k. Kontoen er l√•st i 15 minutter.\");\n            }\n            throw new Error(\"Ugyldig verifiseringskode\");\n          }\n\n          await prisma.user.update({\n            where: { id: user.id },\n            data: {\n              totpFailedAttempts: 0,\n              totpLockedUntil: null,\n            },\n          });\n        }\n\n        return {\n          id: user.id,\n          email: user.email,\n          name: `${user.firstName} ${user.lastName}`,\n          role: user.role,\n          status: user.status,\n        };\n      },\n    }),\n  ],\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        token.id = user.id;\n        token.role = user.role;\n        token.status = user.status;\n      }\n      return token;\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        session.user.id = token.id;\n        session.user.role = token.role;\n        session.user.status = token.status;\n      }\n      return session;\n    },\n  },\n  secret: process.env.NEXTAUTH_SECRET,\n};\n","path":null,"size_bytes":3820,"size_tokens":null},"src/app/api/auth/[...nextauth]/route.ts":{"content":"import NextAuth from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\n\nconst handler = NextAuth(authOptions);\n\nexport { handler as GET, handler as POST };\n","path":null,"size_bytes":161,"size_tokens":null},"src/components/ui/textarea.tsx":{"content":"import * as React from \"react\";\nimport { cn } from \"@/lib/utils\";\n\nexport interface TextareaProps\n  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {\n  label?: string;\n}\n\nconst Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(\n  ({ className, label, ...props }, ref) => {\n    return (\n      <div className=\"flex flex-col gap-1.5\">\n        {label && (\n          <label className=\"text-sm font-medium text-foreground\">{label}</label>\n        )}\n        <textarea\n          className={cn(\n            \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        />\n      </div>\n    );\n  }\n);\nTextarea.displayName = \"Textarea\";\n\nexport { Textarea };\n","path":null,"size_bytes":990,"size_tokens":null},"src/app/api/projects/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { Role } from \"@prisma/client\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport { validateAndSanitizeProjectInput } from \"@/lib/sanitize\";\n\nexport async function GET() {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const user = authResult.user;\n\n    const projects = await prisma.project.findMany({\n      where: {\n        OR: [\n          { createdById: user.id },\n          { members: { some: { userId: user.id } } },\n        ],\n      },\n      include: {\n        members: { include: { user: true } },\n        documents: true,\n      },\n      orderBy: { updatedAt: \"desc\" },\n    });\n\n    return NextResponse.json(projects);\n  } catch (error) {\n    console.error(\"Error fetching projects:\", error);\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const user = authResult.user;\n\n    if (user.role !== \"ADMIN\" && user.role !== \"PROJECT_LEADER\") {\n      return NextResponse.json({ error: \"Kun admins og prosjektledere kan opprette prosjekter\" }, { status: 403 });\n    }\n\n    const body = await request.json();\n    const validation = validateAndSanitizeProjectInput(body);\n\n    if (!validation.valid) {\n      return NextResponse.json({ error: validation.error }, { status: 400 });\n    }\n\n    const project = await prisma.project.create({\n      data: {\n        name: validation.name,\n        description: validation.description,\n        createdById: user.id,\n        members: {\n          create: {\n            userId: user.id,\n            role: Role.PROJECT_LEADER,\n          },\n        },\n      },\n      include: {\n        members: { include: { user: true } },\n      },\n    });\n\n    return NextResponse.json(project, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating project:\", error);\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2228,"size_tokens":null},"src/components/ui/dialog.tsx":{"content":"\"use client\";\n\nimport * as React from \"react\";\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\";\nimport { X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nconst Dialog = DialogPrimitive.Root;\nconst DialogTrigger = DialogPrimitive.Trigger;\nconst DialogPortal = DialogPrimitive.Portal;\nconst DialogClose = DialogPrimitive.Close;\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n));\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName;\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-card p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n));\nDialogContent.displayName = DialogPrimitive.Content.displayName;\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n);\nDialogHeader.displayName = \"DialogHeader\";\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n);\nDialogFooter.displayName = \"DialogFooter\";\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n));\nDialogTitle.displayName = DialogPrimitive.Title.displayName;\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nDialogDescription.displayName = DialogPrimitive.Description.displayName;\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n};\n","path":null,"size_bytes":3874,"size_tokens":null},"src/lib/auth-helpers.ts":{"content":"import { getServerSession } from \"next-auth\";\nimport { NextResponse } from \"next/server\";\nimport { authOptions } from \"./auth\";\nimport prisma from \"./db\";\n\nexport type AuthUser = {\n  id: string;\n  email: string;\n  role: \"ADMIN\" | \"PROJECT_LEADER\" | \"USER\" | \"READER\";\n  status: \"PENDING\" | \"ACTIVE\" | \"SUSPENDED\";\n};\n\nexport type AuthResult = \n  | { success: true; user: AuthUser }\n  | { success: false; error: NextResponse };\n\nexport async function requireAuth(): Promise<AuthResult> {\n  const session = await getServerSession(authOptions);\n  \n  if (!session?.user?.id) {\n    return {\n      success: false,\n      error: NextResponse.json({ error: \"Ikke autentisert\" }, { status: 401 }),\n    };\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: session.user.id },\n    select: { id: true, email: true, role: true, status: true },\n  });\n\n  if (!user) {\n    return {\n      success: false,\n      error: NextResponse.json({ error: \"Bruker ikke funnet\" }, { status: 401 }),\n    };\n  }\n\n  if (user.status !== \"ACTIVE\") {\n    return {\n      success: false,\n      error: NextResponse.json({ error: \"Kontoen er ikke aktiv\" }, { status: 403 }),\n    };\n  }\n\n  return {\n    success: true,\n    user: user as AuthUser,\n  };\n}\n\nexport async function requireAdmin(): Promise<AuthResult> {\n  const authResult = await requireAuth();\n  \n  if (!authResult.success) {\n    return authResult;\n  }\n\n  if (authResult.user.role !== \"ADMIN\") {\n    return {\n      success: false,\n      error: NextResponse.json({ error: \"Krever administratortilgang\" }, { status: 403 }),\n    };\n  }\n\n  return authResult;\n}\n\nexport async function requireProjectAccess(projectId: string): Promise<AuthResult> {\n  const authResult = await requireAuth();\n  \n  if (!authResult.success) {\n    return authResult;\n  }\n\n  if (authResult.user.role === \"ADMIN\") {\n    return authResult;\n  }\n\n  const membership = await prisma.projectMember.findFirst({\n    where: {\n      projectId,\n      userId: authResult.user.id,\n    },\n  });\n\n  if (!membership) {\n    return {\n      success: false,\n      error: NextResponse.json({ error: \"Ingen tilgang til dette prosjektet\" }, { status: 403 }),\n    };\n  }\n\n  return authResult;\n}\n\nexport async function requireProjectLeaderAccess(projectId: string): Promise<AuthResult> {\n  const authResult = await requireAuth();\n  \n  if (!authResult.success) {\n    return authResult;\n  }\n\n  if (authResult.user.role === \"ADMIN\") {\n    return authResult;\n  }\n\n  const membership = await prisma.projectMember.findFirst({\n    where: {\n      projectId,\n      userId: authResult.user.id,\n      role: \"PROJECT_LEADER\",\n    },\n  });\n\n  if (!membership) {\n    return {\n      success: false,\n      error: NextResponse.json({ error: \"Krever prosjektledertilgang\" }, { status: 403 }),\n    };\n  }\n\n  return authResult;\n}\n\nexport function canEditProject(userRole: string, memberRole?: string): boolean {\n  if (userRole === \"ADMIN\" || userRole === \"PROJECT_LEADER\") {\n    return true;\n  }\n  return memberRole === \"PROJECT_LEADER\" || memberRole === \"USER\";\n}\n\nexport function canDeleteProject(userRole: string): boolean {\n  return userRole === \"ADMIN\" || userRole === \"PROJECT_LEADER\";\n}\n\nexport function canManageUsers(userRole: string): boolean {\n  return userRole === \"ADMIN\";\n}\n\nexport function canUploadDocuments(userRole: string, memberRole?: string): boolean {\n  if (userRole === \"ADMIN\" || userRole === \"PROJECT_LEADER\") {\n    return true;\n  }\n  return memberRole === \"PROJECT_LEADER\" || memberRole === \"USER\";\n}\n\nexport function canAnnotateDocuments(userRole: string, memberRole?: string): boolean {\n  if (userRole === \"ADMIN\" || userRole === \"PROJECT_LEADER\") {\n    return true;\n  }\n  return memberRole !== \"READER\";\n}\n","path":null,"size_bytes":3699,"size_tokens":null},"src/lib/sanitize.ts":{"content":"export function sanitizeString(input: unknown, maxLength?: number): string {\n  if (typeof input !== \"string\") {\n    return \"\";\n  }\n  \n  let sanitized = input\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#x27;\")\n    .replace(/\\//g, \"&#x2F;\")\n    .trim();\n  \n  if (maxLength && sanitized.length > maxLength) {\n    sanitized = sanitized.slice(0, maxLength);\n  }\n  \n  return sanitized;\n}\n\nexport function sanitizeStringAllowEmpty(input: unknown): string | null {\n  if (input === null || input === undefined) {\n    return null;\n  }\n  \n  if (typeof input !== \"string\") {\n    return null;\n  }\n  \n  const sanitized = sanitizeString(input);\n  return sanitized.length > 0 ? sanitized : null;\n}\n\nexport function validateAndSanitizeProjectInput(data: unknown): {\n  valid: true;\n  name: string;\n  description: string | null;\n} | {\n  valid: false;\n  error: string;\n} {\n  if (typeof data !== \"object\" || data === null) {\n    return { valid: false, error: \"Ugyldig input\" };\n  }\n\n  const { name, description } = data as { name?: unknown; description?: unknown };\n\n  if (typeof name !== \"string\" || name.trim().length === 0) {\n    return { valid: false, error: \"Prosjektnavn er p√•krevd\" };\n  }\n\n  if (name.trim().length > 200) {\n    return { valid: false, error: \"Prosjektnavn kan ikke v√¶re lengre enn 200 tegn\" };\n  }\n\n  const sanitizedName = sanitizeString(name);\n  const sanitizedDescription = sanitizeStringAllowEmpty(description);\n\n  if (sanitizedDescription && sanitizedDescription.length > 2000) {\n    return { valid: false, error: \"Beskrivelse kan ikke v√¶re lengre enn 2000 tegn\" };\n  }\n\n  return {\n    valid: true,\n    name: sanitizedName,\n    description: sanitizedDescription,\n  };\n}\n\nexport function validateAndSanitizeProfileInput(data: unknown): {\n  valid: true;\n  firstName?: string;\n  lastName?: string;\n  phone?: string | null;\n  company?: string | null;\n  title?: string | null;\n  discipline?: string | null;\n} | {\n  valid: false;\n  error: string;\n} {\n  if (typeof data !== \"object\" || data === null) {\n    return { valid: false, error: \"Ugyldig input\" };\n  }\n\n  const { firstName, lastName, phone, company, title, discipline } = data as Record<string, unknown>;\n\n  const result: {\n    valid: true;\n    firstName?: string;\n    lastName?: string;\n    phone?: string | null;\n    company?: string | null;\n    title?: string | null;\n    discipline?: string | null;\n  } = { valid: true };\n\n  if (firstName !== undefined) {\n    if (typeof firstName !== \"string\") {\n      return { valid: false, error: \"Ugyldig fornavn\" };\n    }\n    if (firstName.length > 100) {\n      return { valid: false, error: \"Fornavn kan ikke v√¶re lengre enn 100 tegn\" };\n    }\n    result.firstName = sanitizeString(firstName);\n  }\n\n  if (lastName !== undefined) {\n    if (typeof lastName !== \"string\") {\n      return { valid: false, error: \"Ugyldig etternavn\" };\n    }\n    if (lastName.length > 100) {\n      return { valid: false, error: \"Etternavn kan ikke v√¶re lengre enn 100 tegn\" };\n    }\n    result.lastName = sanitizeString(lastName);\n  }\n\n  if (phone !== undefined) {\n    result.phone = sanitizeStringAllowEmpty(phone);\n    if (result.phone && result.phone.length > 30) {\n      return { valid: false, error: \"Telefonnummer kan ikke v√¶re lengre enn 30 tegn\" };\n    }\n  }\n\n  if (company !== undefined) {\n    result.company = sanitizeStringAllowEmpty(company);\n    if (result.company && result.company.length > 200) {\n      return { valid: false, error: \"Firmanavn kan ikke v√¶re lengre enn 200 tegn\" };\n    }\n  }\n\n  if (title !== undefined) {\n    result.title = sanitizeStringAllowEmpty(title);\n    if (result.title && result.title.length > 100) {\n      return { valid: false, error: \"Tittel kan ikke v√¶re lengre enn 100 tegn\" };\n    }\n  }\n\n  if (discipline !== undefined) {\n    result.discipline = sanitizeStringAllowEmpty(discipline);\n    if (result.discipline && result.discipline.length > 100) {\n      return { valid: false, error: \"Fagomr√•de kan ikke v√¶re lengre enn 100 tegn\" };\n    }\n  }\n\n  return result;\n}\n","path":null,"size_bytes":4057,"size_tokens":null},"src/app/api/totp/disable/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { authenticator } from \"otplib\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport prisma from \"@/lib/db\";\n\nexport async function POST(request: NextRequest) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const body = await request.json();\n  const { code } = body;\n\n  if (!code || typeof code !== \"string\") {\n    return NextResponse.json(\n      { error: \"Verifiseringskode er p√•krevd\" },\n      { status: 400 }\n    );\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: authResult.user.id },\n    select: { \n      totpSecret: true, \n      totpEnabled: true,\n      totpFailedAttempts: true,\n      totpLockedUntil: true,\n    },\n  });\n\n  if (!user || !user.totpEnabled || !user.totpSecret) {\n    return NextResponse.json(\n      { error: \"Tofaktor-autentisering er ikke aktivert\" },\n      { status: 400 }\n    );\n  }\n\n  if (user.totpLockedUntil && user.totpLockedUntil > new Date()) {\n    const minutesLeft = Math.ceil((user.totpLockedUntil.getTime() - Date.now()) / 60000);\n    return NextResponse.json(\n      { error: `For mange feilede fors√∏k. Pr√∏v igjen om ${minutesLeft} minutter.` },\n      { status: 429 }\n    );\n  }\n\n  const isValid = authenticator.verify({\n    token: code,\n    secret: user.totpSecret,\n  });\n\n  if (!isValid) {\n    const newFailedAttempts = user.totpFailedAttempts + 1;\n    const lockoutTime = newFailedAttempts >= 5 \n      ? new Date(Date.now() + 15 * 60 * 1000) \n      : null;\n\n    await prisma.user.update({\n      where: { id: authResult.user.id },\n      data: {\n        totpFailedAttempts: newFailedAttempts,\n        totpLockedUntil: lockoutTime,\n      },\n    });\n\n    if (lockoutTime) {\n      return NextResponse.json(\n        { error: \"For mange feilede fors√∏k. Kontoen er l√•st i 15 minutter.\" },\n        { status: 429 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Ugyldig verifiseringskode\" },\n      { status: 400 }\n    );\n  }\n\n  await prisma.user.update({\n    where: { id: authResult.user.id },\n    data: {\n      totpEnabled: false,\n      totpSecret: null,\n      totpFailedAttempts: 0,\n      totpLockedUntil: null,\n    },\n  });\n\n  return NextResponse.json({\n    success: true,\n    message: \"Tofaktor-autentisering er n√• deaktivert\",\n  });\n}\n","path":null,"size_bytes":2339,"size_tokens":null},"src/components/ui/separator.tsx":{"content":"\"use client\";\n\nimport * as React from \"react\";\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\";\nimport { cn } from \"@/lib/utils\";\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n);\nSeparator.displayName = SeparatorPrimitive.Root.displayName;\n\nexport { Separator };\n","path":null,"size_bytes":776,"size_tokens":null},"src/components/pages/project/mass-list/mass-list-upload.tsx":{"content":"\"use client\";\n\nimport { useState, useRef } from \"react\";\nimport { Upload, FileSpreadsheet, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\ninterface MassListUploadProps {\n  projectId: string;\n  onUploadComplete: () => void;\n}\n\nexport function MassListUpload({ projectId, onUploadComplete }: MassListUploadProps) {\n  const [uploading, setUploading] = useState(false);\n  const [dragActive, setDragActive] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  async function handleFile(file: File) {\n    if (!file.name.endsWith(\".xlsx\") && !file.name.endsWith(\".xls\")) {\n      setError(\"Kun Excel-filer (.xlsx, .xls) er tillatt\");\n      return;\n    }\n\n    setUploading(true);\n    setError(null);\n\n    try {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n\n      const res = await fetch(`/api/projects/${projectId}/mass-list`, {\n        method: \"POST\",\n        body: formData,\n      });\n\n      if (!res.ok) {\n        const data = await res.json();\n        throw new Error(data.error || \"Opplasting feilet\");\n      }\n\n      onUploadComplete();\n    } catch (err: any) {\n      setError(err.message || \"En feil oppstod under opplasting\");\n    } finally {\n      setUploading(false);\n    }\n  }\n\n  function handleDrag(e: React.DragEvent) {\n    e.preventDefault();\n    e.stopPropagation();\n    if (e.type === \"dragenter\" || e.type === \"dragover\") {\n      setDragActive(true);\n    } else if (e.type === \"dragleave\") {\n      setDragActive(false);\n    }\n  }\n\n  function handleDrop(e: React.DragEvent) {\n    e.preventDefault();\n    e.stopPropagation();\n    setDragActive(false);\n    if (e.dataTransfer.files && e.dataTransfer.files[0]) {\n      handleFile(e.dataTransfer.files[0]);\n    }\n  }\n\n  function handleChange(e: React.ChangeEvent<HTMLInputElement>) {\n    e.preventDefault();\n    if (e.target.files && e.target.files[0]) {\n      handleFile(e.target.files[0]);\n    }\n  }\n\n  return (\n    <Card>\n      <CardContent className=\"p-6\">\n        <div\n          className={`relative rounded-xl border-2 border-dashed transition-colors ${\n            dragActive\n              ? \"border-primary bg-primary/5\"\n              : \"border-border hover:border-primary/50\"\n          }`}\n          onDragEnter={handleDrag}\n          onDragLeave={handleDrag}\n          onDragOver={handleDrag}\n          onDrop={handleDrop}\n        >\n          <input\n            ref={inputRef}\n            type=\"file\"\n            accept=\".xlsx,.xls\"\n            onChange={handleChange}\n            className=\"absolute inset-0 cursor-pointer opacity-0\"\n            disabled={uploading}\n          />\n          <div className=\"flex flex-col items-center justify-center py-10\">\n            {uploading ? (\n              <>\n                <Loader2 className=\"mb-4 animate-spin text-primary\" size={48} />\n                <p className=\"text-sm text-muted-foreground\">\n                  Laster opp og behandler fil...\n                </p>\n              </>\n            ) : (\n              <>\n                <FileSpreadsheet className=\"mb-4 text-primary\" size={48} />\n                <p className=\"mb-2 font-medium text-foreground\">\n                  Dra og slipp Excel-fil her\n                </p>\n                <p className=\"mb-4 text-sm text-muted-foreground\">\n                  eller klikk for √• velge fil\n                </p>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => inputRef.current?.click()}\n                >\n                  <Upload size={16} className=\"mr-2\" />\n                  Velg fil\n                </Button>\n              </>\n            )}\n          </div>\n        </div>\n\n        {error && (\n          <p className=\"mt-4 text-center text-sm text-red-500\">{error}</p>\n        )}\n\n        <div className=\"mt-4 rounded-lg bg-muted/50 p-4 text-sm text-muted-foreground\">\n          <p className=\"font-medium text-foreground\">Forventet format:</p>\n          <ul className=\"mt-2 list-inside list-disc space-y-1\">\n            <li>Kolonne A: TFM-kode (f.eks. 360.1, 420.5)</li>\n            <li>Kolonne B: Beskrivelse</li>\n            <li>Kolonne C: Mengde (valgfritt)</li>\n            <li>Kolonne D: Enhet (valgfritt)</li>\n          </ul>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":4400,"size_tokens":null},"src/components/ui/popover.tsx":{"content":"\"use client\";\n\nimport * as React from \"react\";\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\";\nimport { cn } from \"@/lib/utils\";\n\nconst Popover = PopoverPrimitive.Root;\nconst PopoverTrigger = PopoverPrimitive.Trigger;\nconst PopoverAnchor = PopoverPrimitive.Anchor;\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border border-border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n));\nPopoverContent.displayName = PopoverPrimitive.Content.displayName;\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor };\n","path":null,"size_bytes":1327,"size_tokens":null},"src/components/pages/profile/totp-setup.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { Shield, ShieldCheck, ShieldOff, Loader2 } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface TotpSetupProps {\n  totpEnabled: boolean;\n}\n\nexport function TotpSetup({ totpEnabled: initialEnabled }: TotpSetupProps) {\n  const [enabled, setEnabled] = useState(initialEnabled);\n  const [loading, setLoading] = useState(false);\n  const [step, setStep] = useState<\"idle\" | \"setup\" | \"verify\" | \"disable\">(\"idle\");\n  const [qrCode, setQrCode] = useState<string | null>(null);\n  const [secret, setSecret] = useState<string | null>(null);\n  const [code, setCode] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState<string | null>(null);\n\n  async function startSetup() {\n    setLoading(true);\n    setError(null);\n    try {\n      const res = await fetch(\"/api/totp/setup\", { method: \"POST\" });\n      const data = await res.json();\n      if (res.ok) {\n        setQrCode(data.qrCode);\n        setSecret(data.secret);\n        setStep(\"setup\");\n      } else {\n        setError(data.error || \"Kunne ikke starte oppsett\");\n      }\n    } catch {\n      setError(\"Nettverksfeil\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function verifyCode() {\n    if (code.length !== 6) {\n      setError(\"Koden m√• v√¶re 6 siffer\");\n      return;\n    }\n    setLoading(true);\n    setError(null);\n    try {\n      const res = await fetch(\"/api/totp/verify\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ code }),\n      });\n      const data = await res.json();\n      if (res.ok) {\n        setEnabled(true);\n        setStep(\"idle\");\n        setSuccess(\"Tofaktor-autentisering er n√• aktivert!\");\n        setCode(\"\");\n        setQrCode(null);\n        setSecret(null);\n        setTimeout(() => setSuccess(null), 3000);\n      } else {\n        setError(data.error || \"Verifisering feilet\");\n        setCode(\"\");\n      }\n    } catch {\n      setError(\"Nettverksfeil\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function disableTotp() {\n    if (code.length !== 6) {\n      setError(\"Koden m√• v√¶re 6 siffer\");\n      return;\n    }\n    setLoading(true);\n    setError(null);\n    try {\n      const res = await fetch(\"/api/totp/disable\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ code }),\n      });\n      const data = await res.json();\n      if (res.ok) {\n        setEnabled(false);\n        setStep(\"idle\");\n        setSuccess(\"Tofaktor-autentisering er n√• deaktivert\");\n        setCode(\"\");\n        setTimeout(() => setSuccess(null), 3000);\n      } else {\n        setError(data.error || \"Deaktivering feilet\");\n        setCode(\"\");\n      }\n    } catch {\n      setError(\"Nettverksfeil\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  function cancel() {\n    setStep(\"idle\");\n    setCode(\"\");\n    setError(null);\n    setQrCode(null);\n    setSecret(null);\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Shield className=\"h-5 w-5\" />\n          Tofaktor-autentisering\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {step === \"idle\" && (\n          <>\n            <div className=\"flex items-center gap-3 rounded-lg bg-muted/50 p-4\">\n              {enabled ? (\n                <ShieldCheck className=\"h-8 w-8 text-green-500\" />\n              ) : (\n                <ShieldOff className=\"h-8 w-8 text-muted-foreground\" />\n              )}\n              <div>\n                <p className=\"font-medium text-foreground\">\n                  {enabled ? \"Aktivert\" : \"Ikke aktivert\"}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">\n                  {enabled\n                    ? \"Din konto er beskyttet med tofaktor-autentisering\"\n                    : \"Legg til et ekstra lag med sikkerhet\"}\n                </p>\n              </div>\n              <Badge\n                tone={enabled ? \"success\" : \"muted\"}\n                className=\"ml-auto\"\n              >\n                {enabled ? \"Aktiv\" : \"Av\"}\n              </Badge>\n            </div>\n\n            {success && (\n              <p className=\"text-sm text-green-500\">{success}</p>\n            )}\n\n            {enabled ? (\n              <Button\n                variant=\"outline\"\n                onClick={() => setStep(\"disable\")}\n                className=\"w-full\"\n              >\n                <ShieldOff className=\"mr-2 h-4 w-4\" />\n                Deaktiver tofaktor\n              </Button>\n            ) : (\n              <Button onClick={startSetup} loading={loading} className=\"w-full\">\n                <ShieldCheck className=\"mr-2 h-4 w-4\" />\n                Aktiver tofaktor\n              </Button>\n            )}\n          </>\n        )}\n\n        {step === \"setup\" && qrCode && (\n          <div className=\"space-y-4\">\n            <div className=\"text-center\">\n              <p className=\"mb-4 text-sm text-muted-foreground\">\n                Scan denne QR-koden med din authenticator-app (Google Authenticator, Microsoft Authenticator, etc.)\n              </p>\n              <img\n                src={qrCode}\n                alt=\"TOTP QR Code\"\n                className=\"mx-auto rounded-lg border bg-white p-2\"\n                width={200}\n                height={200}\n              />\n            </div>\n\n            {secret && (\n              <div className=\"rounded-lg bg-muted/50 p-3\">\n                <p className=\"text-xs text-muted-foreground mb-1\">\n                  Kan ikke scanne? Skriv inn denne koden manuelt:\n                </p>\n                <code className=\"text-sm font-mono break-all\">{secret}</code>\n              </div>\n            )}\n\n            <Input\n              label=\"Verifiseringskode\"\n              type=\"text\"\n              inputMode=\"numeric\"\n              pattern=\"[0-9]*\"\n              maxLength={6}\n              value={code}\n              onChange={(e) => setCode(e.target.value.replace(/\\D/g, \"\"))}\n              placeholder=\"000000\"\n              hint=\"Skriv inn 6-sifret kode fra appen\"\n              autoComplete=\"one-time-code\"\n            />\n\n            {error && <p className=\"text-sm text-danger\">{error}</p>}\n\n            <div className=\"flex flex-col gap-2 sm:flex-row\">\n              <Button variant=\"outline\" onClick={cancel} className=\"flex-1 order-2 sm:order-1\">\n                Avbryt\n              </Button>\n              <Button onClick={verifyCode} loading={loading} className=\"flex-1 order-1 sm:order-2\">\n                Verifiser og aktiver\n              </Button>\n            </div>\n          </div>\n        )}\n\n        {step === \"disable\" && (\n          <div className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              For √• deaktivere tofaktor-autentisering, skriv inn en kode fra din authenticator-app.\n            </p>\n\n            <Input\n              label=\"Verifiseringskode\"\n              type=\"text\"\n              inputMode=\"numeric\"\n              pattern=\"[0-9]*\"\n              maxLength={6}\n              value={code}\n              onChange={(e) => setCode(e.target.value.replace(/\\D/g, \"\"))}\n              placeholder=\"000000\"\n              autoComplete=\"one-time-code\"\n            />\n\n            {error && <p className=\"text-sm text-danger\">{error}</p>}\n\n            <div className=\"flex flex-col gap-2 sm:flex-row\">\n              <Button variant=\"outline\" onClick={cancel} className=\"flex-1 order-2 sm:order-1\">\n                Avbryt\n              </Button>\n              <Button\n                variant=\"destructive\"\n                onClick={disableTotp}\n                loading={loading}\n                className=\"flex-1 order-1 sm:order-2\"\n              >\n                Deaktiver\n              </Button>\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":8178,"size_tokens":null},"src/lib/file-utils.ts":{"content":"import path from \"path\";\nimport { mkdir, writeFile, unlink, stat } from \"fs/promises\";\n\nconst UPLOADS_DIR = path.join(process.cwd(), \"uploads\");\n\nconst ALLOWED_FILE_TYPES: Record<string, string[]> = {\n  document: [\".pdf\"],\n  spreadsheet: [\".xlsx\", \".xls\"],\n  image: [\".png\", \".jpg\", \".jpeg\", \".gif\", \".webp\"],\n};\n\nconst MAX_FILE_SIZES: Record<string, number> = {\n  document: 50 * 1024 * 1024, // 50MB for PDFs\n  spreadsheet: 10 * 1024 * 1024, // 10MB for Excel files\n  image: 5 * 1024 * 1024, // 5MB for images\n};\n\nexport type FileValidationResult = \n  | { valid: true; type: string }\n  | { valid: false; error: string };\n\nexport function validateFileName(fileName: string): FileValidationResult {\n  if (!fileName || typeof fileName !== \"string\") {\n    return { valid: false, error: \"Filnavn er p√•krevd\" };\n  }\n\n  if (fileName.includes(\"..\") || fileName.includes(\"~\") || fileName.includes(\"/\") || fileName.includes(\"\\\\\")) {\n    return { valid: false, error: \"Ugyldig filnavn\" };\n  }\n\n  const ext = path.extname(fileName).toLowerCase();\n  \n  for (const [type, extensions] of Object.entries(ALLOWED_FILE_TYPES)) {\n    if (extensions.includes(ext)) {\n      return { valid: true, type };\n    }\n  }\n\n  return { valid: false, error: `Filtypen ${ext} er ikke tillatt` };\n}\n\nexport function validateFileSize(size: number, fileType: string): FileValidationResult {\n  const maxSize = MAX_FILE_SIZES[fileType];\n  \n  if (!maxSize) {\n    return { valid: false, error: \"Ukjent filtype\" };\n  }\n\n  if (size > maxSize) {\n    const maxMB = Math.round(maxSize / (1024 * 1024));\n    return { valid: false, error: `Filen er for stor. Maks st√∏rrelse er ${maxMB}MB` };\n  }\n\n  return { valid: true, type: fileType };\n}\n\nexport function validateFileMimeType(mimeType: string, fileType: string): FileValidationResult {\n  const validMimeTypes: Record<string, string[]> = {\n    document: [\"application/pdf\"],\n    spreadsheet: [\n      \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n      \"application/vnd.ms-excel\",\n    ],\n    image: [\"image/png\", \"image/jpeg\", \"image/gif\", \"image/webp\"],\n  };\n\n  const allowed = validMimeTypes[fileType];\n  if (!allowed || !allowed.includes(mimeType)) {\n    return { valid: false, error: \"Ugyldig filtype\" };\n  }\n\n  return { valid: true, type: fileType };\n}\n\nexport async function saveFile(\n  projectId: string,\n  fileName: string,\n  buffer: Buffer\n): Promise<{ success: true; path: string } | { success: false; error: string }> {\n  try {\n    const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9._-]/g, \"_\");\n    const timestamp = Date.now();\n    const uniqueFileName = `${timestamp}_${sanitizedFileName}`;\n    \n    const projectDir = path.join(UPLOADS_DIR, projectId);\n    await mkdir(projectDir, { recursive: true });\n    \n    const filePath = path.join(projectDir, uniqueFileName);\n    \n    const normalizedPath = path.normalize(filePath);\n    if (!normalizedPath.startsWith(UPLOADS_DIR)) {\n      return { success: false, error: \"Ugyldig filsti\" };\n    }\n    \n    await writeFile(filePath, buffer);\n    \n    return { success: true, path: `/api/files/${projectId}/${uniqueFileName}` };\n  } catch (error) {\n    console.error(\"Error saving file:\", error);\n    return { success: false, error: \"Kunne ikke lagre fil\" };\n  }\n}\n\nexport async function deleteFile(\n  projectId: string,\n  fileName: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const filePath = path.join(UPLOADS_DIR, projectId, fileName);\n    \n    const normalizedPath = path.normalize(filePath);\n    if (!normalizedPath.startsWith(UPLOADS_DIR)) {\n      return { success: false, error: \"Ugyldig filsti\" };\n    }\n    \n    await unlink(filePath);\n    return { success: true };\n  } catch (error) {\n    console.error(\"Error deleting file:\", error);\n    return { success: false, error: \"Kunne ikke slette fil\" };\n  }\n}\n\nexport async function fileExists(\n  projectId: string,\n  fileName: string\n): Promise<boolean> {\n  try {\n    const filePath = path.join(UPLOADS_DIR, projectId, fileName);\n    const normalizedPath = path.normalize(filePath);\n    \n    if (!normalizedPath.startsWith(UPLOADS_DIR)) {\n      return false;\n    }\n    \n    await stat(filePath);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport function generateSecureFileName(originalName: string): string {\n  const ext = path.extname(originalName).toLowerCase();\n  const baseName = path.basename(originalName, ext)\n    .replace(/[^a-zA-Z0-9._-]/g, \"_\")\n    .substring(0, 100);\n  const timestamp = Date.now();\n  const random = Math.random().toString(36).substring(2, 8);\n  \n  return `${timestamp}_${random}_${baseName}${ext}`;\n}\n","path":null,"size_bytes":4615,"size_tokens":null},"src/components/ui/button.tsx":{"content":"import * as React from \"react\";\nimport { Slot } from \"@radix-ui/react-slot\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\nimport { cn } from \"@/lib/utils\";\nimport { Loader2 } from \"lucide-react\";\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 touch-manipulation active:scale-[0.98]\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90 active:bg-primary/80\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90 active:bg-destructive/80\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground active:bg-accent/80\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80 active:bg-secondary/70\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground active:bg-accent/80\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"min-h-[44px] sm:min-h-[40px] px-4 py-2\",\n        sm: \"min-h-[40px] sm:min-h-[36px] rounded-md px-3\",\n        lg: \"min-h-[48px] sm:min-h-[44px] rounded-md px-8\",\n        icon: \"min-h-[44px] min-w-[44px] sm:min-h-[40px] sm:min-w-[40px]\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n);\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean;\n  loading?: boolean;\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, loading, disabled, children, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\";\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        disabled={disabled || loading}\n        {...props}\n      >\n        {loading && <Loader2 className=\"animate-spin\" size={16} />}\n        {children}\n      </Comp>\n    );\n  }\n);\nButton.displayName = \"Button\";\n\nexport { Button, buttonVariants };\n","path":null,"size_bytes":2409,"size_tokens":null},"src/app/page.tsx":{"content":"import { redirect } from \"next/navigation\";\n\nexport default function HomePage() {\n  redirect(\"/login\");\n}\n","path":null,"size_bytes":106,"size_tokens":null},"replit.md":{"content":"# SysLink - Project Documentation\n\n## Overview\nSysLink is a Next.js-based project management platform designed for construction projects. It aims to streamline project workflows, enhance communication, and provide robust document handling capabilities. Key features include role-based access control, comprehensive project and document management, advanced PDF annotation, mass list management with TFM codes, and a user approval system. The platform also integrates PratLink, a communication module offering real-time chat, task management, and seamless switching between document and communication views. The overall vision is to provide a unified and secure environment for construction project stakeholders, facilitating efficient collaboration and reducing operational complexities.\n\n## User Preferences\n- Language: Norwegian (Bokm√•l)\n- Admin emails are configured in `src/lib/utils.ts`\n- Theme preference persisted via next-themes\n\n## System Architecture\nSysLink is built on Next.js 16 with the App Router and Turbopack. It utilizes a PostgreSQL database with Prisma ORM for data management and NextAuth v4 for authentication, featuring a credentials provider. Styling is handled by Tailwind CSS v4, with `next-themes` for light/dark mode functionality.\n\n**UI/UX Decisions:**\nThe application supports light/dark themes, with user preferences persisted. Mobile optimization is a core design principle, featuring draft persistence for forms, navigation guards for unsaved changes, touch-friendly UI elements (44px minimum touch targets), responsive layouts, and a mobile-specific hamburger menu.\n\n**Technical Implementations & Feature Specifications:**\n- **Role-Based Access Control (RBAC):** Supports ADMIN, PROJECT_LEADER, USER, and READER roles with granular permissions.\n- **Project Management:** Includes project creation, archiving, restoration, and permanent deletion (admin only). Features a dashboard with progress cards, activity feed, and recent documents.\n- **Document Management:** Upload, manage, and track work drawings and system schemas. Supports revision handling, where documents with the same title create new revisions.\n- **PDF Annotation System:** Allows creation of interactive pins on PDFs to mark issues. Pins have Open/Closed statuses with visual indicators (orange pulsing for open, green static for closed). Comments can be added to annotations.\n- **Mass List Management:** Manages TFM (Technical Facility Management) codes, with Excel export and improved search capabilities.\n- **PratLink Communication Module:**\n    - **Chat System:** Teams-like chat rooms per project with real-time messaging, @mention support, threads, and file attachments (PDF, Excel, images, docs up to 10MB).\n    - **Task/ToDo Management:** Create tasks from chat or directly, assign to members with email notifications, track status (Open, In Progress, Done, Cancelled), and set due dates with priority.\n    - **Mode Switcher:** Seamless toggle between SysLink (document management) and PratLink (communication) views.\n- **User Management:** Includes user approval workflow for PENDING users, member invitation system for projects, and global user search.\n- **Notifications System:** Real-time notifications for @mentions and task assignments, with a bell icon indicating unread counts and direct links to relevant content.\n- **PDF Processing & Verification:** Utilizes `pdfjs-dist` and `react-pdf` for PDF rendering. Features text extraction with coordinate data, TFM code pattern matching, and automatic system code detection from filenames. Documents can be verified against the project mass list, reporting matched/unmatched components.\n- **Security Architecture:**\n    - **Authentication:** Status-based login blocking (ACTIVE users only), middleware protection for all routes, and JWT session management via NextAuth.\n    - **Two-Factor Authentication (TOTP):** Support for authenticator apps (Google, Microsoft), QR code setup, rate limiting (5 failed attempts locks for 15 mins), and a 14-day activation deadline with warnings and auto-suspension.\n    - **Secure Password Change:** Requires current password verification, enforces complexity rules (8+ chars, uppercase, lowercase, number, special character), prevents reuse, requires TOTP if enabled, rate limits attempts, and logs changes.\n    - **Authorization (RBAC):** Centralized helpers (`requireAuth()`, `requireAdmin()`, `requireProjectAccess()`, `requireProjectLeaderAccess()`) enforce role-based and project-scoped access.\n    - **File Security:** Secure storage outside public folders, authenticated access via API, file validation (extension, MIME type, size limits), and path traversal prevention.\n    - **Input Sanitization:** HTML entity escaping for user inputs, length validation, and strict type checking for API inputs.\n\n**System Design Choices:**\n- **Framework:** Next.js with App Router for modern web development.\n- **Database:** PostgreSQL with Prisma ORM for type-safe database interactions.\n- **Authentication:** NextAuth for robust authentication flows.\n- **Styling:** Tailwind CSS for utility-first styling.\n- **File Uploads:** Stored securely with authenticated access.\n- **PDF Processing:** `pdfjs-dist` and `react-pdf` for efficient PDF handling.\n- **Excel Processing:** `xlsx` library for mass list functionalities.\n\n## External Dependencies\n- **Database:** PostgreSQL (Replit/Neon)\n- **ORM:** Prisma\n- **Authentication:** NextAuth v4\n- **Styling:** Tailwind CSS v4\n- **Theming:** `next-themes`\n- **PDF Processing:** `pdfjs-dist`, `react-pdf`\n- **Excel Processing:** `xlsx`\n- **Email Service:** Gmail SMTP (via environment variables for `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`)","path":null,"size_bytes":5686,"size_tokens":null},"src/app/globals.css":{"content":"@import \"tailwindcss\";\n\n@theme {\n  --color-background: hsl(0 0% 100%);\n  --color-foreground: hsl(240 10% 3.9%);\n  --color-card: hsl(0 0% 100%);\n  --color-card-foreground: hsl(240 10% 3.9%);\n  --color-popover: hsl(0 0% 100%);\n  --color-popover-foreground: hsl(240 10% 3.9%);\n  --color-primary: hsl(240 5.9% 10%);\n  --color-primary-foreground: hsl(0 0% 98%);\n  --color-secondary: hsl(240 4.8% 95.9%);\n  --color-secondary-foreground: hsl(240 5.9% 10%);\n  --color-muted: hsl(240 4.8% 95.9%);\n  --color-muted-foreground: hsl(240 3.8% 46.1%);\n  --color-accent: hsl(240 4.8% 95.9%);\n  --color-accent-foreground: hsl(240 5.9% 10%);\n  --color-destructive: hsl(0 84.2% 60.2%);\n  --color-destructive-foreground: hsl(0 0% 98%);\n  --color-border: hsl(240 5.9% 90%);\n  --color-input: hsl(240 5.9% 90%);\n  --color-ring: hsl(240 5.9% 10%);\n  --color-info: hsl(220 90% 56%);\n  --color-danger: hsl(0 84.2% 60.2%);\n  --radius: 0.5rem;\n}\n\n@media (prefers-color-scheme: dark) {\n  @theme {\n    --color-background: hsl(240 10% 3.9%);\n    --color-foreground: hsl(0 0% 98%);\n    --color-card: hsl(240 10% 3.9%);\n    --color-card-foreground: hsl(0 0% 98%);\n    --color-popover: hsl(240 10% 3.9%);\n    --color-popover-foreground: hsl(0 0% 98%);\n    --color-primary: hsl(0 0% 98%);\n    --color-primary-foreground: hsl(240 5.9% 10%);\n    --color-secondary: hsl(240 3.7% 15.9%);\n    --color-secondary-foreground: hsl(0 0% 98%);\n    --color-muted: hsl(240 3.7% 15.9%);\n    --color-muted-foreground: hsl(240 5% 64.9%);\n    --color-accent: hsl(240 3.7% 15.9%);\n    --color-accent-foreground: hsl(0 0% 98%);\n    --color-destructive: hsl(0 62.8% 30.6%);\n    --color-destructive-foreground: hsl(0 0% 98%);\n    --color-border: hsl(240 3.7% 15.9%);\n    --color-input: hsl(240 3.7% 15.9%);\n    --color-ring: hsl(240 4.9% 83.9%);\n    --color-info: hsl(220 90% 56%);\n    --color-danger: hsl(0 62.8% 30.6%);\n  }\n}\n\n* {\n  border-color: var(--color-border);\n}\n\nbody {\n  background-color: var(--color-background);\n  color: var(--color-foreground);\n}\n\n.glass {\n  background: rgba(255, 255, 255, 0.05);\n  backdrop-filter: blur(10px);\n  -webkit-backdrop-filter: blur(10px);\n  border: 1px solid rgba(255, 255, 255, 0.18);\n}\n","path":null,"size_bytes":2175,"size_tokens":null},"src/components/ui/input.tsx":{"content":"import * as React from \"react\";\n\ninterface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {\n  label?: string;\n  hint?: string;\n}\n\nconst Input = React.forwardRef<HTMLInputElement, InputProps>(\n  ({ className = \"\", label, hint, ...props }, ref) => {\n    return (\n      <div className=\"flex flex-col gap-1.5\">\n        {label && (\n          <label className=\"text-sm font-medium text-foreground\">\n            {label}\n          </label>\n        )}\n        <input\n          className={`flex min-h-[44px] sm:min-h-[40px] w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 ${className}`}\n          ref={ref}\n          {...props}\n        />\n        {hint && (\n          <p className=\"text-xs text-muted-foreground\">{hint}</p>\n        )}\n      </div>\n    );\n  }\n);\n\nInput.displayName = \"Input\";\n\nexport { Input };\n","path":null,"size_bytes":1093,"size_tokens":null},"src/components/pages/project/project-sidebar.tsx":{"content":"\"use client\";\n\nimport Link from \"next/link\";\nimport { usePathname } from \"next/navigation\";\nimport {\n  FileText,\n  List,\n  Users,\n  ChevronLeft,\n  FolderKanban,\n  PenTool,\n  Network,\n  ClipboardCheck,\n  TrendingUp,\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface ProjectSidebarProps {\n  project?: {\n    id: string;\n    name: string;\n    description?: string | null;\n    members?: { user: { firstName: string; lastName: string } }[];\n    documents?: { id: string }[];\n    massList?: { id: string }[];\n  };\n  projectId?: string;\n}\n\nexport function ProjectSidebar({ project, projectId }: ProjectSidebarProps) {\n  const pathname = usePathname();\n  const id = project?.id || projectId;\n\n  if (!id) return null;\n\n  const navItems = [\n    {\n      href: `/projects/${id}`,\n      label: \"Dashboard\",\n      icon: FolderKanban,\n      exact: true,\n    },\n    {\n      href: `/projects/${id}/drawings`,\n      label: \"Arbeidstegninger\",\n      icon: PenTool,\n    },\n    {\n      href: `/projects/${id}/schemas`,\n      label: \"Systemskjema\",\n      icon: Network,\n    },\n    {\n      href: `/projects/${id}/mass-list`,\n      label: \"Masseliste\",\n      icon: List,\n    },\n    {\n      href: `/projects/${id}/protocols`,\n      label: \"Protokoller MC\",\n      icon: ClipboardCheck,\n    },\n    {\n      href: `/projects/${id}/progress`,\n      label: \"Fremdrift\",\n      icon: TrendingUp,\n    },\n  ];\n\n  return (\n    <div className=\"flex h-full flex-col p-4\">\n      <Link\n        href=\"/dashboard\"\n        className=\"mb-4 flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground\"\n      >\n        <ChevronLeft size={16} />\n        Tilbake til dashboard\n      </Link>\n\n      {project && (\n        <div className=\"mb-6\">\n          <h2 className=\"font-semibold text-foreground\">{project.name}</h2>\n          {project.description && (\n            <p className=\"mt-1 text-sm text-muted-foreground line-clamp-2\">\n              {project.description}\n            </p>\n          )}\n        </div>\n      )}\n\n      <nav className=\"space-y-1\">\n        {navItems.map((item) => {\n          const isActive = item.exact\n            ? pathname === item.href\n            : pathname.startsWith(item.href);\n          return (\n            <Link\n              key={item.href}\n              href={item.href}\n              className={cn(\n                \"flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors\",\n                isActive\n                  ? \"bg-primary/10 text-primary\"\n                  : \"text-muted-foreground hover:bg-muted hover:text-foreground\"\n              )}\n            >\n              <item.icon size={18} />\n              {item.label}\n            </Link>\n          );\n        })}\n      </nav>\n\n      {project && (\n        <div className=\"mt-auto space-y-3 border-t border-border pt-4\">\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <FileText size={14} />\n            <span>{project.documents?.length || 0} dokumenter</span>\n          </div>\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <Users size={14} />\n            <span>{project.members?.length || 0} medlemmer</span>\n          </div>\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <List size={14} />\n            <span>{project.massList?.length || 0} i masseliste</span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":3469,"size_tokens":null},"src/components/ui/checkbox.tsx":{"content":"\"use client\";\n\nimport * as React from \"react\";\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\";\nimport { Check } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n));\nCheckbox.displayName = CheckboxPrimitive.Root.displayName;\n\nexport { Checkbox };\n","path":null,"size_bytes":1077,"size_tokens":null},"src/app/api/projects/[projectId]/mass-list/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport * as XLSX from \"xlsx\";\nimport { requireProjectAccess, requireProjectLeaderAccess, canUploadDocuments } from \"@/lib/auth-helpers\";\nimport { validateFileName, validateFileSize } from \"@/lib/file-utils\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const massList = await prisma.massList.findMany({\n      where: { projectId },\n      orderBy: { createdAt: \"desc\" },\n    });\n\n    return NextResponse.json(massList);\n  } catch (error) {\n    console.error(\"Error fetching mass list:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n      where: { projectId, userId: authResult.user.id },\n    });\n\n    if (!canUploadDocuments(authResult.user.role, membership?.role)) {\n      return NextResponse.json(\n        { error: \"Ingen tilgang til √• laste opp masselister\" },\n        { status: 403 }\n      );\n    }\n\n    const formData = await request.formData();\n    const file = formData.get(\"file\") as File;\n\n    if (!file) {\n      return NextResponse.json({ error: \"Fil er p√•krevd\" }, { status: 400 });\n    }\n\n    const fileNameValidation = validateFileName(file.name);\n    if (!fileNameValidation.valid) {\n      return NextResponse.json({ error: fileNameValidation.error }, { status: 400 });\n    }\n\n    if (fileNameValidation.type !== \"spreadsheet\") {\n      return NextResponse.json(\n        { error: \"Kun Excel-filer (.xlsx, .xls) er tillatt for masselister\" },\n        { status: 400 }\n      );\n    }\n\n    const validMimeTypes = [\n      \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n      \"application/vnd.ms-excel\",\n    ];\n    if (!validMimeTypes.includes(file.type)) {\n      return NextResponse.json(\n        { error: \"Ugyldig filtype. Kun Excel-filer er tillatt.\" },\n        { status: 400 }\n      );\n    }\n\n    const fileSizeValidation = validateFileSize(file.size, \"spreadsheet\");\n    if (!fileSizeValidation.valid) {\n      return NextResponse.json({ error: fileSizeValidation.error }, { status: 400 });\n    }\n\n    const buffer = Buffer.from(await file.arrayBuffer());\n    \n    let workbook;\n    try {\n      workbook = XLSX.read(buffer, { type: \"buffer\" });\n    } catch {\n      return NextResponse.json(\n        { error: \"Kunne ikke lese Excel-filen. Sjekk at formatet er korrekt.\" },\n        { status: 400 }\n      );\n    }\n\n    const sheetName = workbook.SheetNames[0];\n    const sheet = workbook.Sheets[sheetName];\n    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 }) as unknown[][];\n\n    const entries = [];\n    for (let i = 1; i < data.length; i++) {\n      const row = data[i];\n      if (!row || !row[0]) continue;\n\n      entries.push({\n        projectId,\n        typeCode: String(row[0] || \"\"),\n        description: String(row[1] || \"\"),\n        tfm: row[2] ? String(row[2]) : null,\n        building: row[3] ? String(row[3]) : null,\n        system: row[4] ? String(row[4]) : null,\n        component: row[5] ? String(row[5]) : null,\n        productName: row[6] ? String(row[6]) : null,\n        location: row[7] ? String(row[7]) : null,\n        zone: row[8] ? String(row[8]) : null,\n      });\n    }\n\n    if (entries.length === 0) {\n      return NextResponse.json(\n        { error: \"Ingen gyldige rader funnet i filen\" },\n        { status: 400 }\n      );\n    }\n\n    await prisma.massList.createMany({\n      data: entries,\n    });\n\n    return NextResponse.json({ count: entries.length }, { status: 201 });\n  } catch (error) {\n    console.error(\"Error uploading mass list:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectLeaderAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { searchParams } = new URL(request.url);\n    const id = searchParams.get(\"id\");\n    const all = searchParams.get(\"all\");\n\n    if (all === \"true\") {\n      await prisma.massList.deleteMany({\n        where: { projectId },\n      });\n    } else if (id) {\n      const entry = await prisma.massList.findFirst({\n        where: { id, projectId },\n      });\n\n      if (!entry) {\n        return NextResponse.json(\n          { error: \"Oppf√∏ring ikke funnet\" },\n          { status: 404 }\n        );\n      }\n\n      await prisma.massList.delete({\n        where: { id },\n      });\n    } else {\n      return NextResponse.json(\n        { error: \"ID eller all-parameter er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error(\"Error deleting mass list:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":5526,"size_tokens":null},"src/hooks/use-draft-persistence.ts":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback, useRef } from \"react\";\n\ninterface UseDraftPersistenceOptions<T> {\n  key: string;\n  initialData: T;\n  debounceMs?: number;\n}\n\nexport function useDraftPersistence<T extends object>({\n  key,\n  initialData,\n  debounceMs = 500,\n}: UseDraftPersistenceOptions<T>) {\n  const [data, setData] = useState<T>(initialData);\n  const [isDirty, setIsDirty] = useState(false);\n  const [hasRecoveredDraft, setHasRecoveredDraft] = useState(false);\n  const initialDataRef = useRef(initialData);\n  const debounceTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const isDirtyRef = useRef(false);\n\n  const storageKey = `draft_${key}`;\n\n  useEffect(() => {\n    isDirtyRef.current = isDirty;\n  }, [isDirty]);\n\n  useEffect(() => {\n    try {\n      const saved = localStorage.getItem(storageKey);\n      if (saved) {\n        const parsed = JSON.parse(saved) as T;\n        const hasChanges = JSON.stringify(parsed) !== JSON.stringify(initialData);\n        if (hasChanges) {\n          setData(parsed);\n          setIsDirty(true);\n          setHasRecoveredDraft(true);\n        } else {\n          localStorage.removeItem(storageKey);\n        }\n      }\n    } catch {\n      localStorage.removeItem(storageKey);\n    }\n  }, [storageKey]);\n\n  const saveDraft = useCallback(\n    (newData: T) => {\n      if (debounceTimerRef.current) {\n        clearTimeout(debounceTimerRef.current);\n      }\n\n      debounceTimerRef.current = setTimeout(() => {\n        try {\n          const hasChanges = JSON.stringify(newData) !== JSON.stringify(initialDataRef.current);\n          if (hasChanges) {\n            localStorage.setItem(storageKey, JSON.stringify(newData));\n          } else {\n            localStorage.removeItem(storageKey);\n          }\n        } catch {\n        }\n      }, debounceMs);\n    },\n    [storageKey, debounceMs]\n  );\n\n  const updateField = useCallback(\n    <K extends keyof T>(field: K, value: T[K]) => {\n      setData((prev) => {\n        const newData = { ...prev, [field]: value };\n        setIsDirty(JSON.stringify(newData) !== JSON.stringify(initialDataRef.current));\n        saveDraft(newData);\n        return newData;\n      });\n    },\n    [saveDraft]\n  );\n\n  const clearDraft = useCallback(() => {\n    try {\n      localStorage.removeItem(storageKey);\n    } catch {\n    }\n    setIsDirty(false);\n    setHasRecoveredDraft(false);\n  }, [storageKey]);\n\n  const discardDraft = useCallback(() => {\n    setData(initialDataRef.current);\n    clearDraft();\n  }, [clearDraft]);\n\n  const resetToServer = useCallback((serverData: T) => {\n    initialDataRef.current = serverData;\n    setData(serverData);\n    clearDraft();\n  }, [clearDraft]);\n\n  useEffect(() => {\n    if (!isDirty) return;\n\n    const handleBeforeUnload = (e: BeforeUnloadEvent) => {\n      e.preventDefault();\n      e.returnValue = \"Du har ulagrede endringer. Er du sikker p√• at du vil forlate siden?\";\n      return e.returnValue;\n    };\n\n    window.addEventListener(\"beforeunload\", handleBeforeUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleBeforeUnload);\n  }, [isDirty]);\n\n  useEffect(() => {\n    const handleClick = (e: MouseEvent) => {\n      if (!isDirtyRef.current) return;\n      \n      const target = e.target as HTMLElement;\n      const anchor = target.closest(\"a\");\n      \n      if (anchor && anchor.href && !anchor.href.startsWith(\"javascript:\")) {\n        const currentUrl = new URL(window.location.href);\n        const targetUrl = new URL(anchor.href, window.location.origin);\n        \n        if (currentUrl.pathname !== targetUrl.pathname) {\n          const confirmed = window.confirm(\n            \"Du har ulagrede endringer. Er du sikker p√• at du vil forlate siden?\"\n          );\n          \n          if (!confirmed) {\n            e.preventDefault();\n            e.stopPropagation();\n          }\n        }\n      }\n    };\n\n    document.addEventListener(\"click\", handleClick, true);\n    return () => document.removeEventListener(\"click\", handleClick, true);\n  }, []);\n\n  return {\n    data,\n    setData,\n    updateField,\n    isDirty,\n    hasRecoveredDraft,\n    clearDraft,\n    discardDraft,\n    resetToServer,\n  };\n}\n","path":null,"size_bytes":4143,"size_tokens":null},"src/app/api/totp/setup/route.ts":{"content":"import { NextResponse } from \"next/server\";\nimport { authenticator } from \"otplib\";\nimport QRCode from \"qrcode\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport prisma from \"@/lib/db\";\n\nexport async function POST() {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: authResult.user.id },\n    select: { email: true, totpEnabled: true, totpSecret: true },\n  });\n\n  if (!user) {\n    return NextResponse.json({ error: \"Bruker ikke funnet\" }, { status: 404 });\n  }\n\n  if (user.totpEnabled) {\n    return NextResponse.json(\n      { error: \"Tofaktor-autentisering er allerede aktivert\" },\n      { status: 400 }\n    );\n  }\n\n  const secret = authenticator.generateSecret();\n\n  await prisma.user.update({\n    where: { id: authResult.user.id },\n    data: { totpSecret: secret },\n  });\n\n  const otpauth = authenticator.keyuri(user.email, \"SysLink\", secret);\n  const qrCodeDataUrl = await QRCode.toDataURL(otpauth);\n\n  return NextResponse.json({\n    secret,\n    qrCode: qrCodeDataUrl,\n    message: \"Scan QR-koden med din authenticator-app\",\n  });\n}\n\nexport async function GET() {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: authResult.user.id },\n    select: { totpEnabled: true },\n  });\n\n  return NextResponse.json({\n    totpEnabled: user?.totpEnabled ?? false,\n  });\n}\n","path":null,"size_bytes":1508,"size_tokens":null},"src/components/layout/app-shell.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport Link from \"next/link\";\nimport { usePathname } from \"next/navigation\";\nimport { signOut, useSession } from \"next-auth/react\";\nimport {\n  LayoutDashboard,\n  FolderKanban,\n  User,\n  Shield,\n  LogOut,\n  Menu,\n  X,\n  ChevronRight,\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport { TotpWarningBanner } from \"@/components/totp/totp-warning-banner\";\nimport { ThemeToggle } from \"@/components/ui/theme-toggle\";\nimport { NotificationDropdown } from \"@/components/layout/notification-dropdown\";\n\ninterface TotpWarning {\n  daysRemaining: number;\n  deadline: string;\n  expired: boolean;\n  message: string;\n}\n\ninterface AppShellProps {\n  children: React.ReactNode;\n  sidebar?: React.ReactNode;\n}\n\nconst navItems = [\n  { href: \"/dashboard\", label: \"Dashboard\", icon: LayoutDashboard },\n  { href: \"/profile\", label: \"Profil\", icon: User },\n];\n\nconst adminItems = [\n  { href: \"/admin/approvals\", label: \"Godkjenninger\", icon: Shield },\n];\n\nexport function AppShell({ children, sidebar }: AppShellProps) {\n  const pathname = usePathname();\n  const { data: session } = useSession();\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n  const [totpWarning, setTotpWarning] = useState<TotpWarning | null>(null);\n\n  const isAdmin = session?.user?.role === \"ADMIN\";\n\n  useEffect(() => {\n    async function checkTotpStatus() {\n      try {\n        const res = await fetch(\"/api/totp/status\");\n        if (res.ok) {\n          const data = await res.json();\n          if (data.warning && !data.totpEnabled) {\n            setTotpWarning(data.warning);\n          }\n        }\n      } catch (error) {\n        console.error(\"Failed to check TOTP status:\", error);\n      }\n    }\n    \n    if (session?.user) {\n      checkTotpStatus();\n    }\n  }, [session?.user]);\n\n  useEffect(() => {\n    if (mobileMenuOpen) {\n      document.body.style.overflow = \"hidden\";\n    } else {\n      document.body.style.overflow = \"\";\n    }\n    return () => {\n      document.body.style.overflow = \"\";\n    };\n  }, [mobileMenuOpen]);\n\n  useEffect(() => {\n    const handleResize = () => {\n      if (window.innerWidth >= 1024) {\n        setMobileMenuOpen(false);\n      }\n    };\n    window.addEventListener(\"resize\", handleResize);\n    return () => window.removeEventListener(\"resize\", handleResize);\n  }, []);\n\n  return (\n    <div className=\"flex min-h-screen bg-background\">\n      <button\n        type=\"button\"\n        className=\"fixed left-4 top-4 z-50 flex h-11 w-11 items-center justify-center rounded-lg bg-card shadow-lg lg:hidden touch-manipulation\"\n        onClick={() => setMobileMenuOpen(!mobileMenuOpen)}\n        aria-label={mobileMenuOpen ? \"Lukk meny\" : \"√Öpne meny\"}\n        aria-expanded={mobileMenuOpen}\n      >\n        {mobileMenuOpen ? <X size={22} /> : <Menu size={22} />}\n      </button>\n\n      <aside\n        className={cn(\n          \"fixed inset-y-0 left-0 z-40 flex w-[280px] sm:w-64 flex-col border-r border-border bg-card transition-transform duration-200 lg:translate-x-0\",\n          \"pb-[env(safe-area-inset-bottom)]\",\n          mobileMenuOpen ? \"translate-x-0\" : \"-translate-x-full\"\n        )}\n      >\n        <div className=\"flex h-16 items-center justify-between border-b border-border px-6\">\n          <Link href=\"/dashboard\" className=\"flex items-center gap-2\">\n            <span className=\"text-xl font-bold text-foreground\">SysLink</span>\n          </Link>\n          <div className=\"flex items-center gap-2\">\n            <NotificationDropdown />\n            <ThemeToggle />\n          </div>\n        </div>\n\n        <nav className=\"flex-1 space-y-1 overflow-y-auto p-4\">\n          {navItems.map((item) => {\n            const isActive = pathname === item.href;\n            return (\n              <Link\n                key={item.href}\n                href={item.href}\n                className={cn(\n                  \"flex min-h-[44px] items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors touch-manipulation\",\n                  isActive\n                    ? \"bg-primary/10 text-primary\"\n                    : \"text-muted-foreground hover:bg-muted hover:text-foreground active:bg-muted/80\"\n                )}\n                onClick={() => setMobileMenuOpen(false)}\n              >\n                <item.icon size={20} />\n                {item.label}\n              </Link>\n            );\n          })}\n\n          {isAdmin && (\n            <>\n              <div className=\"my-4 border-t border-border\" />\n              <p className=\"mb-2 px-3 text-xs font-semibold uppercase tracking-wider text-muted-foreground\">\n                Admin\n              </p>\n              {adminItems.map((item) => {\n                const isActive = pathname === item.href;\n                return (\n                  <Link\n                    key={item.href}\n                    href={item.href}\n                    className={cn(\n                      \"flex min-h-[44px] items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors touch-manipulation\",\n                      isActive\n                        ? \"bg-primary/10 text-primary\"\n                        : \"text-muted-foreground hover:bg-muted hover:text-foreground active:bg-muted/80\"\n                    )}\n                    onClick={() => setMobileMenuOpen(false)}\n                  >\n                    <item.icon size={20} />\n                    {item.label}\n                  </Link>\n                );\n              })}\n            </>\n          )}\n        </nav>\n\n        <div className=\"border-t border-border p-4\">\n          <div className=\"mb-3 rounded-lg bg-muted/50 px-3 py-2\">\n            <p className=\"text-sm font-medium text-foreground truncate\">\n              {session?.user?.email}\n            </p>\n            <p className=\"text-xs text-muted-foreground\">\n              {session?.user?.role}\n            </p>\n          </div>\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            className=\"w-full min-h-[44px] justify-start gap-2 text-muted-foreground hover:text-foreground touch-manipulation\"\n            onClick={() => signOut({ callbackUrl: \"/login\" })}\n          >\n            <LogOut size={20} />\n            Logg ut\n          </Button>\n        </div>\n      </aside>\n\n      <div className=\"flex flex-1 lg:pl-64\">\n        {sidebar && (\n          <aside className=\"fixed inset-y-0 left-64 hidden w-72 shrink-0 border-r border-border bg-card/50 lg:block overflow-y-auto\">\n            {sidebar}\n          </aside>\n        )}\n\n        <main className={cn(\n          \"flex-1 p-4 pt-16 sm:p-6 sm:pt-6 lg:pt-6\",\n          sidebar ? \"lg:pl-72\" : \"\"\n        )}>\n          <div className=\"mx-auto max-w-6xl\">\n            {totpWarning && totpWarning.daysRemaining > 0 && (\n              <TotpWarningBanner \n                daysRemaining={totpWarning.daysRemaining}\n                onDismiss={() => setTotpWarning(null)}\n              />\n            )}\n            {children}\n          </div>\n        </main>\n      </div>\n\n      {mobileMenuOpen && (\n        <div\n          className=\"fixed inset-0 z-30 bg-black/50 lg:hidden touch-manipulation\"\n          onClick={() => setMobileMenuOpen(false)}\n          aria-hidden=\"true\"\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":7304,"size_tokens":null},"src/components/pdf-viewer/save-and-close-button.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Save, ArrowLeft, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface SaveAndCloseButtonProps {\n  projectId: string;\n  documentId: string;\n  systemTags: string[];\n}\n\nexport default function SaveAndCloseButton({\n  projectId,\n  documentId,\n  systemTags,\n}: SaveAndCloseButtonProps) {\n  const router = useRouter();\n  const [saving, setSaving] = useState(false);\n\n  async function handleSaveAndClose() {\n    setSaving(true);\n    try {\n      await new Promise((resolve) => setTimeout(resolve, 500));\n      router.push(`/projects/${projectId}`);\n    } catch (err) {\n      console.error(err);\n      setSaving(false);\n    }\n  }\n\n  function handleBack() {\n    router.push(`/projects/${projectId}`);\n  }\n\n  return (\n    <div className=\"flex items-center gap-3\">\n      <div className=\"flex gap-2\">\n        {systemTags.slice(0, 3).map((tag, idx) => (\n          <Badge key={idx} tone=\"info\">\n            {tag}\n          </Badge>\n        ))}\n      </div>\n\n      <Button variant=\"outline\" onClick={handleBack}>\n        <ArrowLeft size={16} className=\"mr-1\" />\n        Tilbake\n      </Button>\n\n      <Button onClick={handleSaveAndClose} disabled={saving}>\n        {saving ? (\n          <>\n            <Loader2 size={16} className=\"mr-1 animate-spin\" />\n            Lagrer...\n          </>\n        ) : (\n          <>\n            <Save size={16} className=\"mr-1\" />\n            Lagre og lukk\n          </>\n        )}\n      </Button>\n    </div>\n  );\n}\n","path":null,"size_bytes":1621,"size_tokens":null},"src/components/pages/project/mass-list/mass-list-table.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { Trash2, Search, AlertTriangle, Download, FileSpreadsheet } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport * as XLSX from \"xlsx\";\n\ninterface MassListItem {\n  id: string;\n  typeCode: string | null;\n  description: string | null;\n  tfm?: string | null;\n  building?: string | null;\n  system?: string | null;\n  component?: string | null;\n  productName?: string | null;\n  location?: string | null;\n  zone?: string | null;\n}\n\ninterface MassListTableProps {\n  data: MassListItem[];\n  projectName?: string;\n  onDelete: (id: string) => void;\n  onDeleteAll: () => void;\n}\n\nexport function MassListTable({ data, projectName, onDelete, onDeleteAll }: MassListTableProps) {\n  const [search, setSearch] = useState(\"\");\n  const [systemFilter, setSystemFilter] = useState<string>(\"all\");\n\n  const uniqueSystems = [...new Set(data.map((item) => item.system).filter(Boolean))] as string[];\n\n  const filtered = data.filter((item) => {\n    const matchesSearch =\n      (item.typeCode?.toLowerCase() || \"\").includes(search.toLowerCase()) ||\n      (item.tfm?.toLowerCase() || \"\").includes(search.toLowerCase()) ||\n      (item.description?.toLowerCase() || \"\").includes(search.toLowerCase()) ||\n      (item.productName?.toLowerCase() || \"\").includes(search.toLowerCase()) ||\n      (item.building?.toLowerCase() || \"\").includes(search.toLowerCase()) ||\n      (item.location?.toLowerCase() || \"\").includes(search.toLowerCase());\n\n    const matchesSystem = systemFilter === \"all\" || item.system === systemFilter;\n\n    return matchesSearch && matchesSystem;\n  });\n\n  function handleExport() {\n    const exportData = filtered.map((item) => ({\n      \"TFM-kode\": item.tfm || item.typeCode || \"\",\n      \"Byggnr\": item.building || \"\",\n      \"System\": item.system || \"\",\n      \"Komponent\": item.component || \"\",\n      \"Typekode\": item.typeCode || \"\",\n      \"Produktnavn\": item.productName || \"\",\n      \"Plassering\": item.location || \"\",\n      \"Sone\": item.zone || \"\",\n      \"Beskrivelse\": item.description || \"\",\n    }));\n\n    const worksheet = XLSX.utils.json_to_sheet(exportData);\n    const workbook = XLSX.utils.book_new();\n    XLSX.utils.book_append_sheet(workbook, worksheet, \"Masseliste\");\n\n    const colWidths = [\n      { wch: 20 },\n      { wch: 10 },\n      { wch: 10 },\n      { wch: 15 },\n      { wch: 15 },\n      { wch: 25 },\n      { wch: 20 },\n      { wch: 15 },\n      { wch: 30 },\n    ];\n    worksheet[\"!cols\"] = colWidths;\n\n    const filename = `masseliste${projectName ? `_${projectName.replace(/\\s+/g, \"_\")}` : \"\"}_${new Date().toISOString().split(\"T\")[0]}.xlsx`;\n    XLSX.writeFile(workbook, filename);\n  }\n\n  if (data.length === 0) {\n    return (\n      <Card>\n        <CardContent className=\"py-12 text-center\">\n          <AlertTriangle className=\"mx-auto mb-4 text-muted-foreground\" size={48} />\n          <p className=\"text-muted-foreground\">Ingen oppf√∏ringer i masselisten</p>\n          <p className=\"mt-2 text-sm text-muted-foreground\">\n            Last opp en Excel-fil for √• legge til oppf√∏ringer\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <CardTitle className=\"flex items-center gap-2\">\n            <FileSpreadsheet className=\"text-primary\" size={20} />\n            Masseliste\n          </CardTitle>\n          <p className=\"mt-1 text-sm text-muted-foreground\">\n            {filtered.length} av {data.length} oppf√∏ringer\n          </p>\n        </div>\n        <div className=\"flex flex-wrap gap-2\">\n          <Button variant=\"outline\" size=\"sm\" onClick={handleExport}>\n            <Download size={14} className=\"mr-1\" />\n            Eksporter\n          </Button>\n          <Button variant=\"destructive\" size=\"sm\" onClick={onDeleteAll}>\n            <Trash2 size={14} className=\"mr-1\" />\n            Slett alle\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"mb-4 flex flex-col gap-3 sm:flex-row\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" size={16} />\n            <Input\n              placeholder=\"S√∏k etter TFM-kode, produkt, plassering...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"pl-9\"\n            />\n          </div>\n          {uniqueSystems.length > 0 && (\n            <Select value={systemFilter} onValueChange={setSystemFilter}>\n              <SelectTrigger className=\"w-full sm:w-40\">\n                <SelectValue placeholder=\"Alle systemer\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Alle systemer</SelectItem>\n                {uniqueSystems.map((system) => (\n                  <SelectItem key={system} value={system}>\n                    System {system}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          )}\n        </div>\n\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full\">\n            <thead>\n              <tr className=\"border-b border-border text-left text-sm text-muted-foreground\">\n                <th className=\"pb-3 pr-4 font-medium\">TFM-kode</th>\n                <th className=\"pb-3 pr-4 font-medium\">Bygg</th>\n                <th className=\"pb-3 pr-4 font-medium\">System</th>\n                <th className=\"pb-3 pr-4 font-medium\">Produkt</th>\n                <th className=\"pb-3 pr-4 font-medium\">Plassering</th>\n                <th className=\"pb-3 pr-4 font-medium\">Sone</th>\n                <th className=\"pb-3 font-medium\">Handlinger</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filtered.map((item) => (\n                <tr\n                  key={item.id}\n                  className=\"border-b border-border/50 text-sm hover:bg-muted/30\"\n                >\n                  <td className=\"py-3 pr-4\">\n                    <span className=\"font-mono font-medium text-primary\">\n                      {item.tfm || item.typeCode || \"-\"}\n                    </span>\n                  </td>\n                  <td className=\"py-3 pr-4 text-foreground\">\n                    {item.building || \"-\"}\n                  </td>\n                  <td className=\"py-3 pr-4\">\n                    {item.system ? (\n                      <Badge tone=\"info\" className=\"text-xs\">\n                        {item.system}\n                      </Badge>\n                    ) : (\n                      \"-\"\n                    )}\n                  </td>\n                  <td className=\"py-3 pr-4 text-foreground\">\n                    {item.productName || \"-\"}\n                  </td>\n                  <td className=\"py-3 pr-4 text-muted-foreground\">\n                    {item.location || \"-\"}\n                  </td>\n                  <td className=\"py-3 pr-4 text-muted-foreground\">\n                    {item.zone || \"-\"}\n                  </td>\n                  <td className=\"py-3\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => onDelete(item.id)}\n                      className=\"h-8 w-8 text-muted-foreground hover:text-red-500\"\n                    >\n                      <Trash2 size={14} />\n                    </Button>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n\n        {filtered.length === 0 && (search || systemFilter !== \"all\") && (\n          <div className=\"py-8 text-center text-muted-foreground\">\n            <p>Ingen resultater for gjeldende filter</p>\n            <Button\n              variant=\"link\"\n              className=\"mt-2\"\n              onClick={() => {\n                setSearch(\"\");\n                setSystemFilter(\"all\");\n              }}\n            >\n              Nullstill filter\n            </Button>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":8409,"size_tokens":null},"src/app/layout.tsx":{"content":"import \"./globals.css\";\nimport type { Metadata } from \"next\";\nimport AuthSessionProvider from \"@/components/providers/session-provider\";\nimport { ThemeProvider } from \"@/components/providers/theme-provider\";\n\nexport const metadata: Metadata = {\n  title: \"SysLink - Prosjekth√•ndtering\",\n  description: \"Plattform for dokumenth√•ndtering og QA i byggeprosjekter\",\n};\n\nexport default function RootLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <html lang=\"no\" suppressHydrationWarning>\n      <body>\n        <ThemeProvider\n          attribute=\"class\"\n          defaultTheme=\"dark\"\n          enableSystem\n          disableTransitionOnChange\n        >\n          <AuthSessionProvider>{children}</AuthSessionProvider>\n        </ThemeProvider>\n      </body>\n    </html>\n  );\n}\n","path":null,"size_bytes":797,"size_tokens":null},"src/components/ui/card.tsx":{"content":"import * as React from \"react\";\nimport { cn } from \"@/lib/utils\";\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-2xl border border-border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\";\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\";\n\nconst CardTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h3\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n));\nCardTitle.displayName = \"CardTitle\";\n\nconst CardDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <p\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\";\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n));\nCardContent.displayName = \"CardContent\";\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n));\nCardFooter.displayName = \"CardFooter\";\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };\n","path":null,"size_bytes":1905,"size_tokens":null},"src/app/api/files/[...path]/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { requireProjectAccess } from \"@/lib/auth-helpers\";\nimport prisma from \"@/lib/db\";\nimport { readFile, stat } from \"fs/promises\";\nimport path from \"path\";\n\nconst UPLOADS_DIR = path.join(process.cwd(), \"uploads\");\n\nconst MIME_TYPES: Record<string, string> = {\n  \".pdf\": \"application/pdf\",\n  \".xlsx\": \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  \".xls\": \"application/vnd.ms-excel\",\n  \".png\": \"image/png\",\n  \".jpg\": \"image/jpeg\",\n  \".jpeg\": \"image/jpeg\",\n  \".gif\": \"image/gif\",\n  \".webp\": \"image/webp\",\n};\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ path: string[] }> }\n) {\n  try {\n    const { path: pathSegments } = await params;\n    \n    if (!pathSegments || pathSegments.length < 2) {\n      return NextResponse.json({ error: \"Ugyldig filsti\" }, { status: 400 });\n    }\n\n    const projectId = pathSegments[0];\n    const fileName = pathSegments.slice(1).join(\"/\");\n\n    if (fileName.includes(\"..\") || fileName.includes(\"~\")) {\n      return NextResponse.json({ error: \"Ugyldig filsti\" }, { status: 400 });\n    }\n\n    const document = await prisma.document.findFirst({\n      where: {\n        projectId,\n        OR: [\n          { fileUrl: { contains: fileName } },\n          { fileName: fileName },\n        ],\n      },\n      select: { id: true, projectId: true },\n    });\n\n    if (!document) {\n      return NextResponse.json({ error: \"Dokument ikke funnet\" }, { status: 404 });\n    }\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const filePath = path.join(UPLOADS_DIR, projectId, fileName);\n    const normalizedPath = path.normalize(filePath);\n    \n    if (!normalizedPath.startsWith(UPLOADS_DIR)) {\n      return NextResponse.json({ error: \"Ugyldig filsti\" }, { status: 400 });\n    }\n\n    try {\n      await stat(normalizedPath);\n    } catch {\n      return NextResponse.json({ error: \"Fil ikke funnet\" }, { status: 404 });\n    }\n\n    const fileBuffer = await readFile(normalizedPath);\n    const ext = path.extname(fileName).toLowerCase();\n    const contentType = MIME_TYPES[ext] || \"application/octet-stream\";\n\n    return new NextResponse(fileBuffer, {\n      status: 200,\n      headers: {\n        \"Content-Type\": contentType,\n        \"Content-Disposition\": `inline; filename=\"${encodeURIComponent(path.basename(fileName))}\"`,\n        \"Cache-Control\": \"private, max-age=3600\",\n        \"X-Content-Type-Options\": \"nosniff\",\n      },\n    });\n  } catch (error) {\n    console.error(\"Error serving file:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke hente fil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2729,"size_tokens":null},"src/components/pages/admin/approval-panel.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport { Check, X, User, Mail, Building2, Clock, Shield } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\ninterface PendingUser {\n  id: string;\n  firstName: string;\n  lastName: string;\n  email: string;\n  company: string | null;\n  title: string | null;\n  createdAt: Date;\n  role: string;\n}\n\ninterface ApprovalPanelProps {\n  initialUsers: PendingUser[];\n}\n\nexport function ApprovalPanel({ initialUsers }: ApprovalPanelProps) {\n  const [users, setUsers] = useState(initialUsers);\n  const [loading, setLoading] = useState<string | null>(null);\n  const [selectedRoles, setSelectedRoles] = useState<Record<string, string>>({});\n\n  async function handleApprove(userId: string) {\n    setLoading(userId);\n    try {\n      const role = selectedRoles[userId] || \"USER\";\n      const res = await fetch(\"/api/admin/users\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ userId, action: \"approve\", role }),\n      });\n      if (res.ok) {\n        setUsers((prev) => prev.filter((u) => u.id !== userId));\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setLoading(null);\n    }\n  }\n\n  async function handleReject(userId: string) {\n    setLoading(userId);\n    try {\n      const res = await fetch(\"/api/admin/users\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ userId, action: \"reject\" }),\n      });\n      if (res.ok) {\n        setUsers((prev) => prev.filter((u) => u.id !== userId));\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setLoading(null);\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-foreground\">Godkjenninger</h1>\n        <p className=\"text-muted-foreground\">\n          Administrer ventende brukerforesp√∏rsler\n        </p>\n      </div>\n\n      {users.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <Shield className=\"mx-auto mb-4 text-green-500\" size={48} />\n            <p className=\"font-medium text-foreground\">Alt er i orden!</p>\n            <p className=\"mt-2 text-sm text-muted-foreground\">\n              Ingen ventende brukerforesp√∏rsler\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Clock className=\"text-warning\" size={18} />\n                Ventende brukere\n                <Badge tone=\"warning\">{users.length}</Badge>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {users.map((user) => (\n                  <div\n                    key={user.id}\n                    className=\"rounded-xl border border-border p-4\"\n                  >\n                    <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between\">\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-primary/20 text-sm font-medium text-primary\">\n                            {user.firstName[0]}\n                            {user.lastName[0]}\n                          </div>\n                          <div>\n                            <p className=\"font-semibold text-foreground\">\n                              {user.firstName} {user.lastName}\n                            </p>\n                            <p className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                              <Mail size={12} />\n                              {user.email}\n                            </p>\n                          </div>\n                        </div>\n\n                        <div className=\"flex flex-wrap gap-3 text-sm text-muted-foreground\">\n                          {user.company && (\n                            <span className=\"flex items-center gap-1\">\n                              <Building2 size={12} />\n                              {user.company}\n                            </span>\n                          )}\n                          {user.title && (\n                            <span className=\"flex items-center gap-1\">\n                              <User size={12} />\n                              {user.title}\n                            </span>\n                          )}\n                          <span className=\"flex items-center gap-1\">\n                            <Clock size={12} />\n                            Registrert{\" \"}\n                            {format(new Date(user.createdAt), \"d. MMM yyyy\", {\n                              locale: nb,\n                            })}\n                          </span>\n                        </div>\n                      </div>\n\n                      <div className=\"flex items-center gap-2\">\n                        <Select\n                          value={selectedRoles[user.id] || \"USER\"}\n                          onValueChange={(value) =>\n                            setSelectedRoles((prev) => ({\n                              ...prev,\n                              [user.id]: value,\n                            }))\n                          }\n                        >\n                          <SelectTrigger className=\"w-40\">\n                            <SelectValue placeholder=\"Velg rolle\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"USER\">Bruker</SelectItem>\n                            <SelectItem value=\"PROJECT_LEADER\">\n                              Prosjektleder\n                            </SelectItem>\n                            <SelectItem value=\"READER\">Leser</SelectItem>\n                            <SelectItem value=\"ADMIN\">Admin</SelectItem>\n                          </SelectContent>\n                        </Select>\n\n                        <Button\n                          size=\"sm\"\n                          onClick={() => handleApprove(user.id)}\n                          disabled={loading === user.id}\n                          className=\"gap-1\"\n                        >\n                          <Check size={14} />\n                          Godkjenn\n                        </Button>\n\n                        <Button\n                          size=\"sm\"\n                          variant=\"destructive\"\n                          onClick={() => handleReject(user.id)}\n                          disabled={loading === user.id}\n                          className=\"gap-1\"\n                        >\n                          <X size={14} />\n                          Avvis\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":7454,"size_tokens":null},"src/components/pages/project/project-header.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport { Users, Calendar, Edit2, Archive, RotateCcw, X, MoreHorizontal } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { MemberInvite } from \"./member-invite\";\n\ninterface ProjectMember {\n  id: string;\n  role: string;\n  user: {\n    id: string;\n    firstName: string;\n    lastName: string;\n    email: string;\n  };\n}\n\ninterface ProjectHeaderProps {\n  project: {\n    id: string;\n    name: string;\n    description: string | null;\n    status: string;\n    createdAt: Date;\n    updatedAt: Date;\n    createdById: string | null;\n    members: ProjectMember[];\n  };\n  canEdit: boolean;\n  currentUserId: string;\n}\n\nexport function ProjectHeader({ project, canEdit, currentUserId }: ProjectHeaderProps) {\n  const router = useRouter();\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [name, setName] = useState(project.name);\n  const [description, setDescription] = useState(project.description || \"\");\n  const [archiveLoading, setArchiveLoading] = useState(false);\n  const [removingMemberId, setRemovingMemberId] = useState<string | null>(null);\n\n  const isArchived = project.status === \"ARCHIVED\";\n\n  async function handleUpdate(e: React.FormEvent) {\n    e.preventDefault();\n    setLoading(true);\n    try {\n      const res = await fetch(`/api/projects/${project.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name, description }),\n      });\n      if (res.ok) {\n        setDialogOpen(false);\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleArchive() {\n    setArchiveLoading(true);\n    try {\n      const res = await fetch(`/api/projects/${project.id}/archive`, {\n        method: \"POST\",\n      });\n      if (res.ok) {\n        router.push(\"/dashboard\");\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setArchiveLoading(false);\n    }\n  }\n\n  async function handleRestore() {\n    setArchiveLoading(true);\n    try {\n      const res = await fetch(`/api/projects/${project.id}/restore`, {\n        method: \"POST\",\n      });\n      if (res.ok) {\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setArchiveLoading(false);\n    }\n  }\n\n  async function handleRemoveMember(userId: string) {\n    setRemovingMemberId(userId);\n    try {\n      const res = await fetch(`/api/projects/${project.id}/members?userId=${userId}`, {\n        method: \"DELETE\",\n      });\n      if (res.ok) {\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setRemovingMemberId(null);\n    }\n  }\n\n  const roleLabels: Record<string, string> = {\n    ADMIN: \"Admin\",\n    PROJECT_LEADER: \"Prosjektleder\",\n    USER: \"Bruker\",\n    READER: \"Leser\",\n  };\n\n  return (\n    <div className=\"rounded-2xl border border-border bg-card p-6\">\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between\">\n        <div>\n          <div className=\"flex items-center gap-3\">\n            <h1 className=\"text-2xl font-bold text-foreground\">{project.name}</h1>\n            <Badge tone={isArchived ? \"warning\" : \"info\"}>\n              {isArchived ? \"Arkivert\" : \"Aktiv\"}\n            </Badge>\n          </div>\n          {project.description && (\n            <p className=\"mt-2 text-muted-foreground\">{project.description}</p>\n          )}\n          <div className=\"mt-4 flex flex-wrap gap-4 text-sm text-muted-foreground\">\n            <span className=\"flex items-center gap-1\">\n              <Users size={14} />\n              {project.members.length} medlem{project.members.length !== 1 ? \"mer\" : \"\"}\n            </span>\n            <span className=\"flex items-center gap-1\">\n              <Calendar size={14} />\n              Opprettet {format(new Date(project.createdAt), \"d. MMM yyyy\", { locale: nb })}\n            </span>\n          </div>\n        </div>\n\n        {canEdit && (\n          <div className=\"flex flex-wrap gap-2\">\n            {isArchived ? (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleRestore}\n                loading={archiveLoading}\n              >\n                <RotateCcw size={14} className=\"mr-1\" />\n                Gjenopprett\n              </Button>\n            ) : (\n              <>\n                <MemberInvite projectId={project.id} />\n                <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button variant=\"outline\" size=\"sm\">\n                      <Edit2 size={14} className=\"mr-1\" />\n                      Rediger\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Rediger prosjekt</DialogTitle>\n                    </DialogHeader>\n                    <form onSubmit={handleUpdate} className=\"space-y-4\">\n                      <Input\n                        label=\"Prosjektnavn\"\n                        value={name}\n                        onChange={(e) => setName(e.target.value)}\n                        required\n                      />\n                      <Textarea\n                        label=\"Beskrivelse\"\n                        value={description}\n                        onChange={(e) => setDescription(e.target.value)}\n                      />\n                      <div className=\"flex justify-end gap-2\">\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          onClick={() => setDialogOpen(false)}\n                        >\n                          Avbryt\n                        </Button>\n                        <Button type=\"submit\" loading={loading}>\n                          Lagre\n                        </Button>\n                      </div>\n                    </form>\n                  </DialogContent>\n                </Dialog>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleArchive}\n                  loading={archiveLoading}\n                  className=\"text-muted-foreground hover:text-destructive\"\n                >\n                  <Archive size={14} className=\"mr-1\" />\n                  Arkiver\n                </Button>\n              </>\n            )}\n          </div>\n        )}\n      </div>\n\n      {project.members.length > 0 && (\n        <div className=\"mt-6 border-t border-border pt-4\">\n          <h3 className=\"mb-3 text-sm font-semibold text-foreground\">Medlemmer</h3>\n          <div className=\"flex flex-wrap gap-2\">\n            {project.members.map((member) => {\n              const isCreator = project.createdById === member.user.id;\n              const isCurrentUser = member.user.id === currentUserId;\n              const canRemove = canEdit && !isCreator && !isCurrentUser;\n\n              return (\n                <div\n                  key={member.id}\n                  className=\"group flex items-center gap-2 rounded-full bg-muted px-3 py-1 text-sm\"\n                >\n                  <div className=\"flex h-6 w-6 items-center justify-center rounded-full bg-primary/20 text-xs font-medium text-primary\">\n                    {member.user.firstName[0]}\n                    {member.user.lastName[0]}\n                  </div>\n                  <span>\n                    {member.user.firstName} {member.user.lastName}\n                  </span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    ({roleLabels[member.role] || member.role})\n                  </span>\n                  {canRemove && (\n                    <button\n                      type=\"button\"\n                      className=\"ml-1 hidden rounded-full p-0.5 text-muted-foreground transition-colors hover:bg-destructive/10 hover:text-destructive group-hover:block\"\n                      onClick={() => handleRemoveMember(member.user.id)}\n                      disabled={removingMemberId === member.user.id}\n                      title=\"Fjern medlem\"\n                    >\n                      <X size={12} />\n                    </button>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":8894,"size_tokens":null},"src/app/api/projects/[projectId]/documents/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectAccess, canUploadDocuments } from \"@/lib/auth-helpers\";\nimport { validateFileName, validateFileSize, validateFileMimeType, saveFile } from \"@/lib/file-utils\";\nimport { extractSystemCodesFromPDF } from \"@/lib/pdf-text-extractor\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { searchParams } = new URL(request.url);\n    const type = searchParams.get(\"type\");\n    const latestOnly = searchParams.get(\"latest\") !== \"false\";\n\n    const whereClause: Record<string, unknown> = { projectId };\n    \n    if (type) {\n      whereClause.type = type;\n    }\n    \n    if (latestOnly) {\n      whereClause.isLatest = true;\n    }\n\n    const documents = await prisma.document.findMany({\n      where: whereClause,\n      include: {\n        tags: { include: { systemTag: true } },\n        systemAnnotations: {\n          select: { id: true, systemCode: true },\n        },\n        _count: {\n          select: {\n            annotations: true,\n            components: true,\n          },\n        },\n      },\n      orderBy: { createdAt: \"desc\" },\n    });\n\n    return NextResponse.json(documents);\n  } catch (error) {\n    console.error(\"Error fetching documents:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n      where: { projectId, userId: authResult.user.id },\n    });\n\n    if (!canUploadDocuments(authResult.user.role, membership?.role)) {\n      return NextResponse.json(\n        { error: \"Ingen tilgang til √• laste opp dokumenter\" },\n        { status: 403 }\n      );\n    }\n\n    const formData = await request.formData();\n    const file = formData.get(\"file\") as File;\n    const title = formData.get(\"title\") as string;\n    const type = (formData.get(\"type\") as string) || \"OTHER\";\n    const autoTag = formData.get(\"autoTag\") !== \"false\";\n\n    if (!file) {\n      return NextResponse.json({ error: \"Fil er p√•krevd\" }, { status: 400 });\n    }\n\n    if (!title || typeof title !== \"string\" || title.trim().length === 0) {\n      return NextResponse.json({ error: \"Tittel er p√•krevd\" }, { status: 400 });\n    }\n\n    const fileNameValidation = validateFileName(file.name);\n    if (!fileNameValidation.valid) {\n      return NextResponse.json({ error: fileNameValidation.error }, { status: 400 });\n    }\n\n    const fileSizeValidation = validateFileSize(file.size, fileNameValidation.type);\n    if (!fileSizeValidation.valid) {\n      return NextResponse.json({ error: fileSizeValidation.error }, { status: 400 });\n    }\n\n    const mimeValidation = validateFileMimeType(file.type, fileNameValidation.type);\n    if (!mimeValidation.valid) {\n      return NextResponse.json({ error: mimeValidation.error }, { status: 400 });\n    }\n\n    const buffer = Buffer.from(await file.arrayBuffer());\n\n    const existingDoc = await prisma.document.findFirst({\n      where: {\n        projectId,\n        title: title.trim(),\n        isLatest: true,\n      },\n      orderBy: { revision: \"desc\" },\n    });\n\n    let revision = 1;\n    if (existingDoc) {\n      revision = existingDoc.revision + 1;\n      \n      await prisma.document.update({\n        where: { id: existingDoc.id },\n        data: { isLatest: false },\n      });\n    }\n\n    const saveResult = await saveFile(projectId, file.name, buffer);\n    if (!saveResult.success) {\n      return NextResponse.json({ error: saveResult.error }, { status: 500 });\n    }\n\n    let systemCodes: string[] = [];\n    if (autoTag && file.name.toLowerCase().endsWith(\".pdf\")) {\n      try {\n        systemCodes = await extractSystemCodesFromPDF(buffer, file.name);\n      } catch (err) {\n        console.error(\"Error extracting system codes:\", err);\n      }\n    }\n\n    const document = await prisma.document.create({\n      data: {\n        title: title.trim(),\n        fileName: file.name,\n        fileUrl: saveResult.path,\n        url: saveResult.path,\n        projectId,\n        type: type as \"DRAWING\" | \"SCHEMA\" | \"MASSLIST\" | \"OTHER\",\n        revision,\n        isLatest: true,\n        uploadedById: authResult.user.id,\n        systemTags: systemCodes,\n      },\n      include: {\n        tags: { include: { systemTag: true } },\n      },\n    });\n\n    if (systemCodes.length > 0) {\n      for (const code of systemCodes) {\n        try {\n          const systemTag = await prisma.systemTag.upsert({\n            where: { code },\n            update: {},\n            create: { code },\n          });\n\n          await prisma.documentSystemTag.create({\n            data: {\n              documentId: document.id,\n              systemTagId: systemTag.id,\n            },\n          });\n        } catch (err) {\n          console.error(`Error creating system tag ${code}:`, err);\n        }\n      }\n    }\n\n    return NextResponse.json(document, { status: 201 });\n  } catch (error) {\n    console.error(\"Error uploading document:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":5600,"size_tokens":null},"src/components/pdf-viewer/pdf-viewer-wrapper.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useRef } from \"react\";\nimport { Document, Page, pdfjs } from \"react-pdf\";\nimport { useRouter } from \"next/navigation\";\nimport {\n  ZoomIn,\n  ZoomOut,\n  ChevronLeft,\n  ChevronRight,\n  MessageSquare,\n  Loader2,\n  Plus,\n  X,\n  CheckCircle,\n  Circle,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport \"react-pdf/dist/Page/AnnotationLayer.css\";\nimport \"react-pdf/dist/Page/TextLayer.css\";\n\npdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`;\n\ninterface Annotation {\n  id: string;\n  x: number;\n  y: number;\n  status: string;\n  author: { firstName: string; lastName: string; email: string };\n  comments: {\n    id: string;\n    content: string;\n    author: { firstName: string; lastName: string };\n    createdAt: string;\n  }[];\n}\n\ninterface ProjectMember {\n  id: string;\n  name: string;\n  email: string;\n}\n\ninterface PDFViewerWrapperProps {\n  url: string;\n  systemTags: string[];\n  documentId: string;\n  initialAnnotations: Annotation[];\n  projectMembers: ProjectMember[];\n  currentUserEmail?: string;\n  canEdit?: boolean;\n  initialAnnotationId?: string;\n  initialPage?: number;\n}\n\nexport default function PDFViewerWrapper({\n  url,\n  systemTags,\n  documentId,\n  initialAnnotations,\n  projectMembers,\n  currentUserEmail,\n  canEdit = true,\n  initialAnnotationId,\n  initialPage,\n}: PDFViewerWrapperProps) {\n  const router = useRouter();\n  const [numPages, setNumPages] = useState<number | null>(null);\n  const [pageNumber, setPageNumber] = useState(initialPage || 1);\n  const [scale, setScale] = useState(1.0);\n  const [loading, setLoading] = useState(true);\n  const [annotations, setAnnotations] = useState<Annotation[]>(initialAnnotations);\n  const [selectedAnnotation, setSelectedAnnotation] = useState<Annotation | null>(\n    initialAnnotationId \n      ? initialAnnotations.find((a) => a.id === initialAnnotationId) || null \n      : null\n  );\n  const [newComment, setNewComment] = useState(\"\");\n  const [addingComment, setAddingComment] = useState(false);\n  const [isAddingPin, setIsAddingPin] = useState(false);\n  const [newPinPosition, setNewPinPosition] = useState<{ x: number; y: number } | null>(null);\n  const [newPinComment, setNewPinComment] = useState(\"\");\n  const [creatingPin, setCreatingPin] = useState(false);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const pageRef = useRef<HTMLDivElement>(null);\n\n  function onDocumentLoadSuccess({ numPages }: { numPages: number }) {\n    setNumPages(numPages);\n    setLoading(false);\n  }\n\n  function goToPrevPage() {\n    setPageNumber((prev) => Math.max(prev - 1, 1));\n    setSelectedAnnotation(null);\n    setNewPinPosition(null);\n  }\n\n  function goToNextPage() {\n    setPageNumber((prev) => Math.min(prev + 1, numPages || 1));\n    setSelectedAnnotation(null);\n    setNewPinPosition(null);\n  }\n\n  function zoomIn() {\n    setScale((prev) => Math.min(prev + 0.25, 3));\n  }\n\n  function zoomOut() {\n    setScale((prev) => Math.max(prev - 0.25, 0.5));\n  }\n\n  function handlePageClick(e: React.MouseEvent<HTMLDivElement>) {\n    if (!isAddingPin || !pageRef.current) return;\n\n    const rect = pageRef.current.getBoundingClientRect();\n    const x = (e.clientX - rect.left) / scale;\n    const y = (e.clientY - rect.top) / scale;\n\n    setNewPinPosition({ x, y });\n    setSelectedAnnotation(null);\n  }\n\n  async function handleCreatePin() {\n    if (!newPinPosition) return;\n\n    setCreatingPin(true);\n    try {\n      const res = await fetch(`/api/documents/${documentId}/annotations`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          x: newPinPosition.x,\n          y: newPinPosition.y,\n          pageNumber,\n          content: newPinComment,\n        }),\n      });\n\n      if (res.ok) {\n        const newAnnotation = await res.json();\n        setAnnotations((prev) => [...prev, newAnnotation]);\n        setNewPinPosition(null);\n        setNewPinComment(\"\");\n        setIsAddingPin(false);\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setCreatingPin(false);\n    }\n  }\n\n  async function handleAddComment() {\n    if (!selectedAnnotation || !newComment.trim()) return;\n\n    setAddingComment(true);\n    try {\n      const res = await fetch(\n        `/api/annotations/${selectedAnnotation.id}/comments`,\n        {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ content: newComment }),\n        }\n      );\n\n      if (res.ok) {\n        const comment = await res.json();\n        setAnnotations((prev) =>\n          prev.map((a) =>\n            a.id === selectedAnnotation.id\n              ? { ...a, comments: [...a.comments, comment] }\n              : a\n          )\n        );\n        setSelectedAnnotation((prev) =>\n          prev ? { ...prev, comments: [...prev.comments, comment] } : null\n        );\n        setNewComment(\"\");\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setAddingComment(false);\n    }\n  }\n\n  async function handleToggleStatus(annotation: Annotation) {\n    const newStatus = annotation.status === \"OPEN\" ? \"CLOSED\" : \"OPEN\";\n    try {\n      const res = await fetch(`/api/documents/${documentId}/annotations`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          annotationId: annotation.id,\n          status: newStatus,\n        }),\n      });\n\n      if (res.ok) {\n        setAnnotations((prev) =>\n          prev.map((a) =>\n            a.id === annotation.id ? { ...a, status: newStatus } : a\n          )\n        );\n        if (selectedAnnotation?.id === annotation.id) {\n          setSelectedAnnotation((prev) =>\n            prev ? { ...prev, status: newStatus } : null\n          );\n        }\n      }\n    } catch (err) {\n      console.error(err);\n    }\n  }\n\n  const pageAnnotations = annotations;\n\n  return (\n    <div className=\"flex h-full\">\n      <div className=\"flex-1 overflow-auto bg-gray-900\" ref={containerRef}>\n        <div className=\"sticky top-0 z-10 flex flex-wrap items-center justify-between gap-2 border-b border-border bg-card/90 px-4 py-2 backdrop-blur\">\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={goToPrevPage}\n              disabled={pageNumber <= 1}\n            >\n              <ChevronLeft size={16} />\n            </Button>\n            <span className=\"text-sm text-foreground\">\n              Side {pageNumber} av {numPages || \"...\"}\n            </span>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={goToNextPage}\n              disabled={pageNumber >= (numPages || 1)}\n            >\n              <ChevronRight size={16} />\n            </Button>\n          </div>\n\n          <div className=\"flex items-center gap-2\">\n            <Button variant=\"outline\" size=\"sm\" onClick={zoomOut}>\n              <ZoomOut size={16} />\n            </Button>\n            <span className=\"text-sm text-foreground\">\n              {Math.round(scale * 100)}%\n            </span>\n            <Button variant=\"outline\" size=\"sm\" onClick={zoomIn}>\n              <ZoomIn size={16} />\n            </Button>\n          </div>\n\n          <div className=\"flex items-center gap-2\">\n            {canEdit && (\n              <Button\n                variant={isAddingPin ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={() => {\n                  setIsAddingPin(!isAddingPin);\n                  setNewPinPosition(null);\n                  setSelectedAnnotation(null);\n                }}\n              >\n                {isAddingPin ? (\n                  <>\n                    <X size={16} className=\"mr-1\" />\n                    Avbryt\n                  </>\n                ) : (\n                  <>\n                    <Plus size={16} className=\"mr-1\" />\n                    Ny pin\n                  </>\n                )}\n              </Button>\n            )}\n            {systemTags.map((tag, idx) => (\n              <Badge key={idx} tone=\"info\">\n                {tag}\n              </Badge>\n            ))}\n          </div>\n        </div>\n\n        {isAddingPin && (\n          <div className=\"sticky top-[52px] z-10 border-b border-primary/50 bg-primary/10 px-4 py-2 text-center text-sm text-primary\">\n            Klikk p√• tegningen for √• plassere en ny pin\n          </div>\n        )}\n\n        <div className=\"relative flex justify-center p-4\">\n          {loading && (\n            <div className=\"absolute inset-0 flex items-center justify-center bg-gray-900\">\n              <Loader2 className=\"animate-spin text-primary\" size={48} />\n            </div>\n          )}\n          <Document\n            file={url}\n            onLoadSuccess={onDocumentLoadSuccess}\n            loading={null}\n          >\n            <div\n              ref={pageRef}\n              className={`relative ${isAddingPin ? \"cursor-crosshair\" : \"\"}`}\n              onClick={handlePageClick}\n            >\n              <Page\n                pageNumber={pageNumber}\n                scale={scale}\n                renderAnnotationLayer={false}\n              />\n              {pageAnnotations.map((annotation) => (\n                <button\n                  key={annotation.id}\n                  type=\"button\"\n                  className={`absolute flex h-6 w-6 -translate-x-1/2 -translate-y-1/2 items-center justify-center rounded-full transition-all ${\n                    annotation.status === \"CLOSED\"\n                      ? \"bg-green-500 text-white\"\n                      : \"animate-pulse bg-orange-500 text-white\"\n                  } ${\n                    selectedAnnotation?.id === annotation.id\n                      ? \"ring-2 ring-white ring-offset-2 ring-offset-gray-900\"\n                      : \"\"\n                  }`}\n                  style={{\n                    left: `${annotation.x * scale}px`,\n                    top: `${annotation.y * scale}px`,\n                  }}\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    setSelectedAnnotation(annotation);\n                    setNewPinPosition(null);\n                  }}\n                  title={annotation.status === \"CLOSED\" ? \"Lukket\" : \"√Öpen\"}\n                >\n                  {annotation.status === \"CLOSED\" ? (\n                    <CheckCircle size={14} />\n                  ) : (\n                    <Circle size={14} />\n                  )}\n                </button>\n              ))}\n              {newPinPosition && (\n                <div\n                  className=\"absolute flex h-6 w-6 -translate-x-1/2 -translate-y-1/2 items-center justify-center rounded-full bg-primary text-white ring-2 ring-white ring-offset-2 ring-offset-gray-900\"\n                  style={{\n                    left: `${newPinPosition.x * scale}px`,\n                    top: `${newPinPosition.y * scale}px`,\n                  }}\n                >\n                  <Plus size={14} />\n                </div>\n              )}\n            </div>\n          </Document>\n        </div>\n      </div>\n\n      {(selectedAnnotation || newPinPosition) && (\n        <div className=\"w-80 shrink-0 border-l border-border bg-card p-4 overflow-y-auto\">\n          {newPinPosition ? (\n            <>\n              <div className=\"mb-4 flex items-center justify-between\">\n                <h3 className=\"font-semibold text-foreground\">Ny annotasjon</h3>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => {\n                    setNewPinPosition(null);\n                    setNewPinComment(\"\");\n                  }}\n                >\n                  <X size={16} />\n                </Button>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div className=\"rounded-lg bg-primary/10 p-3 text-sm text-primary\">\n                  Posisjon: ({Math.round(newPinPosition.x)}, {Math.round(newPinPosition.y)})\n                </div>\n\n                <Textarea\n                  placeholder=\"Legg til en kommentar (valgfritt)...\"\n                  value={newPinComment}\n                  onChange={(e) => setNewPinComment(e.target.value)}\n                  className=\"min-h-[100px]\"\n                />\n\n                <Button\n                  onClick={handleCreatePin}\n                  loading={creatingPin}\n                  className=\"w-full\"\n                >\n                  Opprett annotasjon\n                </Button>\n              </div>\n            </>\n          ) : selectedAnnotation ? (\n            <>\n              <div className=\"mb-4 flex items-center justify-between\">\n                <h3 className=\"font-semibold text-foreground\">Annotasjon</h3>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setSelectedAnnotation(null)}\n                >\n                  <X size={16} />\n                </Button>\n              </div>\n\n              <div className=\"mb-4 space-y-3\">\n                <div className=\"flex items-center justify-between rounded-lg bg-muted/50 p-3\">\n                  <div>\n                    <p className=\"text-sm font-medium text-foreground\">\n                      Status: {selectedAnnotation.status === \"CLOSED\" ? \"Lukket\" : \"√Öpen\"}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Av {selectedAnnotation.author.firstName} {selectedAnnotation.author.lastName}\n                    </p>\n                  </div>\n                  {canEdit && (\n                    <Button\n                      variant={selectedAnnotation.status === \"CLOSED\" ? \"outline\" : \"default\"}\n                      size=\"sm\"\n                      onClick={() => handleToggleStatus(selectedAnnotation)}\n                    >\n                      {selectedAnnotation.status === \"CLOSED\" ? (\n                        <>\n                          <Circle size={14} className=\"mr-1\" />\n                          Gjen√•pne\n                        </>\n                      ) : (\n                        <>\n                          <CheckCircle size={14} className=\"mr-1\" />\n                          Lukk\n                        </>\n                      )}\n                    </Button>\n                  )}\n                </div>\n              </div>\n\n              <h4 className=\"mb-2 flex items-center gap-2 text-sm font-medium text-foreground\">\n                <MessageSquare size={14} />\n                Kommentarer ({selectedAnnotation.comments.length})\n              </h4>\n\n              <div className=\"mb-4 max-h-60 space-y-3 overflow-auto\">\n                {selectedAnnotation.comments.length === 0 ? (\n                  <p className=\"text-sm text-muted-foreground\">Ingen kommentarer enda</p>\n                ) : (\n                  selectedAnnotation.comments.map((comment) => (\n                    <div\n                      key={comment.id}\n                      className=\"rounded-lg border border-border p-3\"\n                    >\n                      <p className=\"text-sm text-foreground\">{comment.content}</p>\n                      <p className=\"mt-1 text-xs text-muted-foreground\">\n                        {comment.author.firstName} {comment.author.lastName}\n                      </p>\n                    </div>\n                  ))\n                )}\n              </div>\n\n              {canEdit && (\n                <div className=\"space-y-2\">\n                  <Textarea\n                    placeholder=\"Skriv en kommentar...\"\n                    value={newComment}\n                    onChange={(e) => setNewComment(e.target.value)}\n                    className=\"min-h-[80px]\"\n                  />\n                  <Button\n                    onClick={handleAddComment}\n                    disabled={!newComment.trim() || addingComment}\n                    loading={addingComment}\n                    className=\"w-full\"\n                  >\n                    Legg til kommentar\n                  </Button>\n                </div>\n              )}\n            </>\n          ) : null}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":16399,"size_tokens":null},"src/components/ui/badge.tsx":{"content":"import * as React from \"react\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\nimport { cn } from \"@/lib/utils\";\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n      tone: {\n        default: \"\",\n        info: \"border-blue-500/30 bg-blue-500/10 text-blue-400\",\n        success: \"border-green-500/30 bg-green-500/10 text-green-400\",\n        warning: \"border-yellow-500/30 bg-yellow-500/10 text-yellow-400\",\n        danger: \"border-red-500/30 bg-red-500/10 text-red-400\",\n        muted: \"border-border bg-muted text-muted-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      tone: \"default\",\n    },\n  }\n);\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, tone, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant, tone }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants };\n","path":null,"size_bytes":1549,"size_tokens":null},"src/components/pages/project/project-content-switcher.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  FileText,\n  Upload,\n  List,\n  MessageSquare,\n  Plus,\n  Eye,\n  Trash2,\n  CheckCircle2,\n  AlertTriangle,\n  Clock,\n  Calendar,\n  TrendingUp,\n  Activity,\n} from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\n\ninterface ProjectContentSwitcherProps {\n  project: {\n    id: string;\n    documents: {\n      id: string;\n      title: string;\n      url: string;\n      type: string;\n      createdAt: Date;\n      updatedAt: Date;\n      tags: { systemTag: { code: string; description: string | null } }[];\n      annotations?: { id: string; status: string }[];\n    }[];\n    massList: { id: string; tfm: string | null; productName: string | null; building: string | null; system: string | null }[];\n    comments: {\n      id: string;\n      content: string;\n      createdAt: Date;\n      author: { firstName: string; lastName: string };\n    }[];\n    members: { user: { firstName: string; lastName: string } }[];\n  };\n  canEdit: boolean;\n}\n\nexport function ProjectContentSwitcher({\n  project,\n  canEdit,\n}: ProjectContentSwitcherProps) {\n  const router = useRouter();\n  const [uploadDialogOpen, setUploadDialogOpen] = useState(false);\n  const [uploading, setUploading] = useState(false);\n  const [title, setTitle] = useState(\"\");\n  const [file, setFile] = useState<File | null>(null);\n\n  async function handleUpload(e: React.FormEvent) {\n    e.preventDefault();\n    if (!file) return;\n\n    setUploading(true);\n    try {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      formData.append(\"title\", title);\n\n      const res = await fetch(`/api/projects/${project.id}/documents`, {\n        method: \"POST\",\n        body: formData,\n      });\n\n      if (res.ok) {\n        setUploadDialogOpen(false);\n        setTitle(\"\");\n        setFile(null);\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setUploading(false);\n    }\n  }\n\n  const totalAnnotations = project.documents.reduce(\n    (acc, doc) => acc + (doc.annotations?.length || 0),\n    0\n  );\n  const closedAnnotations = project.documents.reduce(\n    (acc, doc) =>\n      acc + (doc.annotations?.filter((a) => a.status === \"CLOSED\").length || 0),\n    0\n  );\n  const openAnnotations = totalAnnotations - closedAnnotations;\n\n  const progressPercent =\n    totalAnnotations > 0\n      ? Math.round((closedAnnotations / totalAnnotations) * 100)\n      : 0;\n\n  const recentDocuments = [...project.documents]\n    .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime())\n    .slice(0, 5);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n        <ProgressCard\n          title=\"Utf√∏rte\"\n          value={closedAnnotations}\n          icon={CheckCircle2}\n          color=\"text-green-500\"\n          bgColor=\"bg-green-500/10\"\n        />\n        <ProgressCard\n          title=\"Avvik\"\n          value={openAnnotations}\n          icon={AlertTriangle}\n          color=\"text-orange-500\"\n          bgColor=\"bg-orange-500/10\"\n        />\n        <ProgressCard\n          title=\"Dokumenter\"\n          value={project.documents.length}\n          icon={FileText}\n          color=\"text-blue-500\"\n          bgColor=\"bg-blue-500/10\"\n        />\n        <ProgressCard\n          title=\"Masseliste\"\n          value={project.massList.length}\n          icon={List}\n          color=\"text-purple-500\"\n          bgColor=\"bg-purple-500/10\"\n        />\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-3\">\n        <Card className=\"lg:col-span-2\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <TrendingUp className=\"text-primary\" size={18} />\n              Fremdrift\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center gap-6\">\n              <div className=\"relative h-32 w-32 flex-shrink-0\">\n                <svg className=\"h-full w-full -rotate-90\" viewBox=\"0 0 100 100\">\n                  <circle\n                    cx=\"50\"\n                    cy=\"50\"\n                    r=\"40\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"12\"\n                    className=\"text-muted/30\"\n                  />\n                  <circle\n                    cx=\"50\"\n                    cy=\"50\"\n                    r=\"40\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"12\"\n                    strokeLinecap=\"round\"\n                    strokeDasharray={`${progressPercent * 2.51} 251`}\n                    className=\"text-primary transition-all duration-500\"\n                  />\n                </svg>\n                <div className=\"absolute inset-0 flex items-center justify-center\">\n                  <span className=\"text-2xl font-bold text-foreground\">\n                    {progressPercent}%\n                  </span>\n                </div>\n              </div>\n              <div className=\"flex-1 space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Fullf√∏rt</span>\n                  <span className=\"font-medium text-green-500\">{closedAnnotations}</span>\n                </div>\n                <div className=\"h-2 overflow-hidden rounded-full bg-muted/30\">\n                  <div\n                    className=\"h-full bg-green-500 transition-all duration-500\"\n                    style={{ width: `${progressPercent}%` }}\n                  />\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Gjenst√•ende</span>\n                  <span className=\"font-medium text-orange-500\">{openAnnotations}</span>\n                </div>\n                <div className=\"h-2 overflow-hidden rounded-full bg-muted/30\">\n                  <div\n                    className=\"h-full bg-orange-500 transition-all duration-500\"\n                    style={{ width: `${100 - progressPercent}%` }}\n                  />\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Activity className=\"text-primary\" size={18} />\n              Siste aktivitet\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {project.comments.length === 0 ? (\n              <div className=\"py-4 text-center text-sm text-muted-foreground\">\n                Ingen aktivitet enda\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {project.comments.slice(0, 4).map((comment) => (\n                  <div key={comment.id} className=\"flex gap-2\">\n                    <div className=\"flex h-7 w-7 shrink-0 items-center justify-center rounded-full bg-primary/20 text-xs font-medium text-primary\">\n                      {comment.author.firstName[0]}\n                      {comment.author.lastName[0]}\n                    </div>\n                    <div className=\"min-w-0 flex-1\">\n                      <p className=\"truncate text-sm text-foreground\">\n                        {comment.author.firstName} kommenterte\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {format(new Date(comment.createdAt), \"d. MMM HH:mm\", {\n                          locale: nb,\n                        })}\n                      </p>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-2\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <FileText className=\"text-primary\" size={18} />\n              Nylige dokumenter\n            </CardTitle>\n            {canEdit && (\n              <Dialog open={uploadDialogOpen} onOpenChange={setUploadDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button size=\"sm\" variant=\"outline\">\n                    <Plus size={14} className=\"mr-1\" />\n                    Last opp\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>Last opp dokument</DialogTitle>\n                  </DialogHeader>\n                  <form onSubmit={handleUpload} className=\"space-y-4\">\n                    <Input\n                      label=\"Tittel\"\n                      value={title}\n                      onChange={(e) => setTitle(e.target.value)}\n                      placeholder=\"F.eks. Plantegning etasje 1\"\n                      required\n                    />\n                    <div>\n                      <label className=\"mb-1.5 block text-sm font-medium text-foreground\">\n                        PDF-fil\n                      </label>\n                      <input\n                        type=\"file\"\n                        accept=\".pdf\"\n                        onChange={(e) => setFile(e.target.files?.[0] || null)}\n                        className=\"w-full rounded-md border border-input bg-background px-3 py-2 text-sm\"\n                        required\n                      />\n                    </div>\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        onClick={() => setUploadDialogOpen(false)}\n                      >\n                        Avbryt\n                      </Button>\n                      <Button type=\"submit\" loading={uploading}>\n                        Last opp\n                      </Button>\n                    </div>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            )}\n          </CardHeader>\n          <CardContent>\n            {recentDocuments.length === 0 ? (\n              <div className=\"py-8 text-center text-muted-foreground\">\n                <FileText className=\"mx-auto mb-2\" size={32} />\n                <p>Ingen dokumenter enda</p>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {recentDocuments.map((doc) => (\n                  <Link\n                    key={doc.id}\n                    href={`/projects/${project.id}/documents/${doc.id}`}\n                    className=\"flex items-center justify-between rounded-lg border border-border p-3 transition-colors hover:bg-muted/50\"\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <FileText className=\"text-red-500\" size={20} />\n                      <div>\n                        <p className=\"font-medium text-foreground\">{doc.title}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {format(new Date(doc.updatedAt), \"d. MMM yyyy\", {\n                            locale: nb,\n                          })}\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {doc.annotations && doc.annotations.length > 0 && (\n                        <Badge tone=\"muted\" className=\"text-xs\">\n                          {doc.annotations.length} pins\n                        </Badge>\n                      )}\n                      <Eye size={16} className=\"text-muted-foreground\" />\n                    </div>\n                  </Link>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <List className=\"text-primary\" size={18} />\n              Masseliste\n            </CardTitle>\n            <Link href={`/projects/${project.id}/mass-list`}>\n              <Button size=\"sm\" variant=\"outline\">\n                Se alle\n              </Button>\n            </Link>\n          </CardHeader>\n          <CardContent>\n            {project.massList.length === 0 ? (\n              <div className=\"py-8 text-center text-muted-foreground\">\n                <List className=\"mx-auto mb-2\" size={32} />\n                <p>Ingen oppf√∏ringer i masselisten</p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                {project.massList.slice(0, 5).map((item) => (\n                  <div\n                    key={item.id}\n                    className=\"flex items-center justify-between rounded-lg bg-muted/50 px-3 py-2 text-sm\"\n                  >\n                    <span className=\"font-mono text-primary\">\n                      {item.tfm || `${item.building || \"\"}-${item.system || \"\"}`}\n                    </span>\n                    <span className=\"text-muted-foreground line-clamp-1\">\n                      {item.productName || \"-\"}\n                    </span>\n                  </div>\n                ))}\n                {project.massList.length > 5 && (\n                  <p className=\"text-center text-sm text-muted-foreground\">\n                    + {project.massList.length - 5} flere...\n                  </p>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <MessageSquare className=\"text-primary\" size={18} />\n            Siste kommentarer\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {project.comments.length === 0 ? (\n            <div className=\"py-8 text-center text-muted-foreground\">\n              <MessageSquare className=\"mx-auto mb-2\" size={32} />\n              <p>Ingen kommentarer enda</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {project.comments.map((comment) => (\n                <div\n                  key={comment.id}\n                  className=\"flex gap-3 rounded-lg border border-border p-3\"\n                >\n                  <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-primary/20 text-xs font-medium text-primary\">\n                    {comment.author.firstName[0]}\n                    {comment.author.lastName[0]}\n                  </div>\n                  <div>\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"font-medium text-foreground\">\n                        {comment.author.firstName} {comment.author.lastName}\n                      </span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {format(new Date(comment.createdAt), \"d. MMM yyyy HH:mm\", {\n                          locale: nb,\n                        })}\n                      </span>\n                    </div>\n                    <p className=\"mt-1 text-sm text-muted-foreground\">\n                      {comment.content}\n                    </p>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction ProgressCard({\n  title,\n  value,\n  icon: Icon,\n  color,\n  bgColor,\n}: {\n  title: string;\n  value: number;\n  icon: React.ComponentType<{ size?: number; className?: string }>;\n  color: string;\n  bgColor: string;\n}) {\n  return (\n    <Card>\n      <CardContent className=\"flex items-center gap-4 p-4\">\n        <div className={`rounded-xl p-3 ${bgColor}`}>\n          <Icon size={24} className={color} />\n        </div>\n        <div>\n          <p className=\"text-sm text-muted-foreground\">{title}</p>\n          <p className=\"text-2xl font-bold text-foreground\">{value}</p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":16564,"size_tokens":null},"src/components/pages/dashboard/project-explorer.tsx":{"content":"\"use client\";\n\nimport { useState, useMemo } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  FolderKanban,\n  Plus,\n  FileText,\n  Users,\n  ChevronRight,\n  Building2,\n  Calendar,\n  Search,\n  Archive,\n  RotateCcw,\n  Trash2,\n} from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\n\ninterface Project {\n  id: string;\n  name: string;\n  description: string | null;\n  status: string;\n  archivedAt: Date | null;\n  createdAt: Date;\n  updatedAt: Date;\n  members: { user: { firstName: string; lastName: string } }[];\n  documents: { id: string }[];\n}\n\ninterface ProjectExplorerProps {\n  mine: Project[];\n  invited: Project[];\n  canCreate: boolean;\n  canDelete: boolean;\n  userDiscipline?: string;\n}\n\nexport function ProjectExplorer({\n  mine,\n  invited,\n  canCreate,\n  canDelete,\n  userDiscipline,\n}: ProjectExplorerProps) {\n  const router = useRouter();\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [name, setName] = useState(\"\");\n  const [description, setDescription] = useState(\"\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showArchived, setShowArchived] = useState(false);\n  const [actionLoading, setActionLoading] = useState<string | null>(null);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<string | null>(null);\n\n  const allProjects = useMemo(() => {\n    const combined = [...mine, ...invited.filter((p) => !mine.some((m) => m.id === p.id))];\n    return combined;\n  }, [mine, invited]);\n\n  const filteredProjects = useMemo(() => {\n    let projects = allProjects;\n\n    if (showArchived) {\n      projects = projects.filter((p) => p.status === \"ARCHIVED\");\n    } else {\n      projects = projects.filter((p) => p.status === \"ACTIVE\");\n    }\n\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      projects = projects.filter(\n        (p) =>\n          p.name.toLowerCase().includes(query) ||\n          p.description?.toLowerCase().includes(query)\n      );\n    }\n\n    return projects;\n  }, [allProjects, showArchived, searchQuery]);\n\n  const activeCount = allProjects.filter((p) => p.status === \"ACTIVE\").length;\n  const archivedCount = allProjects.filter((p) => p.status === \"ARCHIVED\").length;\n\n  async function handleCreate(e: React.FormEvent) {\n    e.preventDefault();\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/projects\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name, description }),\n      });\n      if (res.ok) {\n        setDialogOpen(false);\n        setName(\"\");\n        setDescription(\"\");\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleArchive(projectId: string) {\n    setActionLoading(projectId);\n    try {\n      const res = await fetch(`/api/projects/${projectId}/archive`, {\n        method: \"POST\",\n      });\n      if (res.ok) {\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setActionLoading(null);\n    }\n  }\n\n  async function handleRestore(projectId: string) {\n    setActionLoading(projectId);\n    try {\n      const res = await fetch(`/api/projects/${projectId}/restore`, {\n        method: \"POST\",\n      });\n      if (res.ok) {\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setActionLoading(null);\n    }\n  }\n\n  async function handleDelete(projectId: string) {\n    setActionLoading(projectId);\n    try {\n      const res = await fetch(`/api/projects/${projectId}`, {\n        method: \"DELETE\",\n      });\n      if (res.ok) {\n        setDeleteConfirmId(null);\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setActionLoading(null);\n    }\n  }\n\n  return (\n    <Card>\n      <CardHeader className=\"space-y-4\">\n        <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <FolderKanban className=\"text-primary\" size={20} />\n              {showArchived ? \"Arkiverte prosjekter\" : \"Mine prosjekter\"}\n            </CardTitle>\n            <p className=\"mt-1 text-sm text-muted-foreground\">\n              {filteredProjects.length} prosjekt{filteredProjects.length !== 1 ? \"er\" : \"\"}\n            </p>\n          </div>\n          {canCreate && !showArchived && (\n            <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n              <DialogTrigger asChild>\n                <Button size=\"sm\">\n                  <Plus size={16} className=\"mr-1\" />\n                  Nytt prosjekt\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Opprett nytt prosjekt</DialogTitle>\n                </DialogHeader>\n                <form onSubmit={handleCreate} className=\"space-y-4\">\n                  <Input\n                    label=\"Prosjektnavn\"\n                    value={name}\n                    onChange={(e) => setName(e.target.value)}\n                    placeholder=\"F.eks. Fjord Tower U1\"\n                    required\n                  />\n                  <Textarea\n                    label=\"Beskrivelse\"\n                    value={description}\n                    onChange={(e) => setDescription(e.target.value)}\n                    placeholder=\"Kort beskrivelse av prosjektet...\"\n                  />\n                  <div className=\"flex justify-end gap-2\">\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      onClick={() => setDialogOpen(false)}\n                    >\n                      Avbryt\n                    </Button>\n                    <Button type=\"submit\" loading={loading}>\n                      Opprett\n                    </Button>\n                  </div>\n                </form>\n              </DialogContent>\n            </Dialog>\n          )}\n        </div>\n\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" size={16} />\n            <Input\n              type=\"search\"\n              placeholder=\"S√∏k etter prosjekt...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9\"\n            />\n          </div>\n          <div className=\"flex gap-2\">\n            <Button\n              variant={!showArchived ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => setShowArchived(false)}\n            >\n              Aktive ({activeCount})\n            </Button>\n            <Button\n              variant={showArchived ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => setShowArchived(true)}\n            >\n              <Archive size={14} className=\"mr-1\" />\n              Arkiv ({archivedCount})\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {filteredProjects.length === 0 ? (\n          <div className=\"py-12 text-center\">\n            {showArchived ? (\n              <>\n                <Archive className=\"mx-auto mb-4 text-muted-foreground\" size={48} />\n                <p className=\"text-muted-foreground\">Ingen arkiverte prosjekter</p>\n              </>\n            ) : searchQuery ? (\n              <>\n                <Search className=\"mx-auto mb-4 text-muted-foreground\" size={48} />\n                <p className=\"text-muted-foreground\">Ingen prosjekter matcher s√∏ket</p>\n              </>\n            ) : (\n              <>\n                <FolderKanban className=\"mx-auto mb-4 text-muted-foreground\" size={48} />\n                <p className=\"text-muted-foreground\">Ingen prosjekter enda</p>\n                {canCreate && (\n                  <p className=\"mt-2 text-sm text-muted-foreground\">\n                    Klikk &quot;Nytt prosjekt&quot; for √• komme i gang\n                  </p>\n                )}\n              </>\n            )}\n          </div>\n        ) : (\n          <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\n            {filteredProjects.map((project) => (\n              <div\n                key={project.id}\n                className=\"group relative rounded-xl border border-border bg-card/50 p-4 transition-all hover:border-primary/50 hover:shadow-md\"\n              >\n                <Link\n                  href={`/projects/${project.id}`}\n                  className=\"block\"\n                >\n                  <div className=\"mb-3 flex items-start justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"text-primary\" size={18} />\n                      <h3 className=\"font-semibold text-foreground group-hover:text-primary\">\n                        {project.name}\n                      </h3>\n                    </div>\n                    <ChevronRight\n                      className=\"text-muted-foreground transition-transform group-hover:translate-x-1\"\n                      size={18}\n                    />\n                  </div>\n\n                  {project.description && (\n                    <p className=\"mb-3 line-clamp-2 text-sm text-muted-foreground\">\n                      {project.description}\n                    </p>\n                  )}\n\n                  <div className=\"flex flex-wrap gap-2 text-xs text-muted-foreground\">\n                    <span className=\"flex items-center gap-1\">\n                      <FileText size={12} />\n                      {project.documents.length} dok\n                    </span>\n                    <span className=\"flex items-center gap-1\">\n                      <Users size={12} />\n                      {project.members.length} medlem{project.members.length !== 1 ? \"mer\" : \"\"}\n                    </span>\n                    <span className=\"flex items-center gap-1\">\n                      <Calendar size={12} />\n                      {format(new Date(project.updatedAt), \"d. MMM\", { locale: nb })}\n                    </span>\n                  </div>\n\n                  <div className=\"mt-3\">\n                    <Badge tone={project.status === \"ARCHIVED\" ? \"warning\" : \"info\"} className=\"text-xs\">\n                      {project.status === \"ARCHIVED\" ? \"Arkivert\" : \"Aktiv\"}\n                    </Badge>\n                  </div>\n                </Link>\n\n                <div className=\"mt-3 flex gap-2 border-t border-border pt-3\">\n                  {project.status === \"ACTIVE\" ? (\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"flex-1 text-xs\"\n                      onClick={(e) => {\n                        e.preventDefault();\n                        handleArchive(project.id);\n                      }}\n                      loading={actionLoading === project.id}\n                    >\n                      <Archive size={12} className=\"mr-1\" />\n                      Arkiver\n                    </Button>\n                  ) : (\n                    <>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"flex-1 text-xs\"\n                        onClick={(e) => {\n                          e.preventDefault();\n                          handleRestore(project.id);\n                        }}\n                        loading={actionLoading === project.id}\n                      >\n                        <RotateCcw size={12} className=\"mr-1\" />\n                        Gjenopprett\n                      </Button>\n                      {canDelete && (\n                        <Dialog open={deleteConfirmId === project.id} onOpenChange={(open) => !open && setDeleteConfirmId(null)}>\n                          <DialogTrigger asChild>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              className=\"text-xs text-destructive hover:text-destructive\"\n                              onClick={(e) => {\n                                e.preventDefault();\n                                setDeleteConfirmId(project.id);\n                              }}\n                            >\n                              <Trash2 size={12} />\n                            </Button>\n                          </DialogTrigger>\n                          <DialogContent>\n                            <DialogHeader>\n                              <DialogTitle>Slett prosjekt permanent?</DialogTitle>\n                            </DialogHeader>\n                            <p className=\"text-sm text-muted-foreground\">\n                              Er du sikker p√• at du vil slette &quot;{project.name}&quot;? \n                              Denne handlingen kan ikke angres, og alle dokumenter og data vil bli slettet.\n                            </p>\n                            <div className=\"flex justify-end gap-2\">\n                              <Button\n                                variant=\"ghost\"\n                                onClick={() => setDeleteConfirmId(null)}\n                              >\n                                Avbryt\n                              </Button>\n                              <Button\n                                variant=\"destructive\"\n                                onClick={() => handleDelete(project.id)}\n                                loading={actionLoading === project.id}\n                              >\n                                Slett permanent\n                              </Button>\n                            </div>\n                          </DialogContent>\n                        </Dialog>\n                      )}\n                    </>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":14600,"size_tokens":null},"src/app/api/totp/verify/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { authenticator } from \"otplib\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport prisma from \"@/lib/db\";\n\nexport async function POST(request: NextRequest) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const body = await request.json();\n  const { code } = body;\n\n  if (!code || typeof code !== \"string\") {\n    return NextResponse.json(\n      { error: \"Verifiseringskode er p√•krevd\" },\n      { status: 400 }\n    );\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: authResult.user.id },\n    select: { \n      totpSecret: true, \n      totpEnabled: true,\n      totpFailedAttempts: true,\n      totpLockedUntil: true,\n    },\n  });\n\n  if (!user || !user.totpSecret) {\n    return NextResponse.json(\n      { error: \"Tofaktor-autentisering er ikke konfigurert\" },\n      { status: 400 }\n    );\n  }\n\n  if (user.totpLockedUntil && user.totpLockedUntil > new Date()) {\n    const minutesLeft = Math.ceil((user.totpLockedUntil.getTime() - Date.now()) / 60000);\n    return NextResponse.json(\n      { error: `For mange feilede fors√∏k. Pr√∏v igjen om ${minutesLeft} minutter.` },\n      { status: 429 }\n    );\n  }\n\n  const isValid = authenticator.verify({\n    token: code,\n    secret: user.totpSecret,\n  });\n\n  if (!isValid) {\n    const newFailedAttempts = user.totpFailedAttempts + 1;\n    const lockoutTime = newFailedAttempts >= 5 \n      ? new Date(Date.now() + 15 * 60 * 1000) \n      : null;\n\n    await prisma.user.update({\n      where: { id: authResult.user.id },\n      data: {\n        totpFailedAttempts: newFailedAttempts,\n        totpLockedUntil: lockoutTime,\n      },\n    });\n\n    if (lockoutTime) {\n      return NextResponse.json(\n        { error: \"For mange feilede fors√∏k. Kontoen er l√•st i 15 minutter.\" },\n        { status: 429 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Ugyldig verifiseringskode\" },\n      { status: 400 }\n    );\n  }\n\n  await prisma.user.update({\n    where: { id: authResult.user.id },\n    data: {\n      totpFailedAttempts: 0,\n      totpLockedUntil: null,\n      totpEnabled: !user.totpEnabled ? true : undefined,\n    },\n  });\n\n  return NextResponse.json({\n    success: true,\n    message: user.totpEnabled ? \"Kode verifisert\" : \"Tofaktor-autentisering er n√• aktivert\",\n  });\n}\n","path":null,"size_bytes":2365,"size_tokens":null},"src/components/pages/dashboard/backup-trigger.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { Database, CheckCircle, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\nexport function BackupTrigger() {\n  const [status, setStatus] = useState<\"idle\" | \"running\" | \"done\">(\"idle\");\n  const [progress, setProgress] = useState(0);\n\n  async function handleBackup() {\n    setStatus(\"running\");\n    setProgress(0);\n\n    // Simulate backup progress\n    for (let i = 0; i <= 100; i += 10) {\n      await new Promise((resolve) => setTimeout(resolve, 200));\n      setProgress(i);\n    }\n\n    setStatus(\"done\");\n    setTimeout(() => {\n      setStatus(\"idle\");\n      setProgress(0);\n    }, 3000);\n  }\n\n  return (\n    <div className=\"flex items-center gap-4\">\n      <Button\n        onClick={handleBackup}\n        disabled={status === \"running\"}\n        variant=\"outline\"\n        className=\"gap-2\"\n      >\n        {status === \"running\" ? (\n          <>\n            <Loader2 className=\"animate-spin\" size={16} />\n            Kj√∏rer backup... {progress}%\n          </>\n        ) : status === \"done\" ? (\n          <>\n            <CheckCircle className=\"text-green-500\" size={16} />\n            Backup fullf√∏rt!\n          </>\n        ) : (\n          <>\n            <Database size={16} />\n            Trigger backup\n          </>\n        )}\n      </Button>\n      {status === \"running\" && (\n        <div className=\"h-2 flex-1 overflow-hidden rounded-full bg-muted\">\n          <div\n            className=\"h-full bg-primary transition-all duration-200\"\n            style={{ width: `${progress}%` }}\n          />\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":1624,"size_tokens":null},"src/components/ui/select.tsx":{"content":"\"use client\";\n\nimport * as React from \"react\";\nimport * as SelectPrimitive from \"@radix-ui/react-select\";\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nconst Select = SelectPrimitive.Root;\nconst SelectGroup = SelectPrimitive.Group;\nconst SelectValue = SelectPrimitive.Value;\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex min-h-[44px] sm:min-h-[40px] w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 touch-manipulation\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n));\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName;\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n));\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName;\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n));\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName;\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border border-border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n));\nSelectContent.displayName = SelectPrimitive.Content.displayName;\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n));\nSelectLabel.displayName = SelectPrimitive.Label.displayName;\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm min-h-[44px] sm:min-h-[36px] py-2 pl-8 pr-2 text-base sm:text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 touch-manipulation\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n));\nSelectItem.displayName = SelectPrimitive.Item.displayName;\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n));\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName;\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n};\n","path":null,"size_bytes":5777,"size_tokens":null},"src/app/api/projects/[projectId]/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectAccess, requireProjectLeaderAccess, requireAdmin } from \"@/lib/auth-helpers\";\nimport { validateAndSanitizeProjectInput } from \"@/lib/sanitize\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const project = await prisma.project.findUnique({\n      where: { id: projectId },\n      include: {\n        members: { include: { user: true } },\n        documents: true,\n        massList: true,\n      },\n    });\n\n    if (!project) {\n      return NextResponse.json({ error: \"Prosjekt ikke funnet\" }, { status: 404 });\n    }\n\n    return NextResponse.json(project);\n  } catch (error) {\n    console.error(\"Error fetching project:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectLeaderAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const body = await request.json();\n    const validation = validateAndSanitizeProjectInput(body);\n\n    if (!validation.valid) {\n      return NextResponse.json({ error: validation.error }, { status: 400 });\n    }\n\n    const project = await prisma.project.update({\n      where: { id: projectId },\n      data: { \n        name: validation.name,\n        description: validation.description,\n      },\n    });\n\n    return NextResponse.json(project);\n  } catch (error) {\n    console.error(\"Error updating project:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const authResult = await requireAdmin();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { projectId } = await params;\n\n    const project = await prisma.project.findUnique({\n      where: { id: projectId },\n    });\n\n    if (!project) {\n      return NextResponse.json({ error: \"Prosjekt ikke funnet\" }, { status: 404 });\n    }\n\n    await prisma.project.delete({\n      where: { id: projectId },\n    });\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error(\"Error deleting project:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2798,"size_tokens":null},"src/components/providers/session-provider.tsx":{"content":"\"use client\";\n\nimport { SessionProvider } from \"next-auth/react\";\n\ninterface Props {\n  children: React.ReactNode;\n}\n\nexport default function AuthSessionProvider({ children }: Props) {\n  return <SessionProvider>{children}</SessionProvider>;\n}\n","path":null,"size_bytes":242,"size_tokens":null},"src/app/api/profile/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport { validateAndSanitizeProfileInput } from \"@/lib/sanitize\";\n\nexport async function GET() {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const user = await prisma.user.findUnique({\n      where: { id: authResult.user.id },\n      select: {\n        id: true,\n        firstName: true,\n        lastName: true,\n        email: true,\n        phone: true,\n        company: true,\n        title: true,\n        discipline: true,\n        role: true,\n        status: true,\n      },\n    });\n\n    if (!user) {\n      return NextResponse.json({ error: \"Bruker ikke funnet\" }, { status: 404 });\n    }\n\n    return NextResponse.json(user);\n  } catch (error) {\n    console.error(\"Error fetching profile:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(request: NextRequest) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const body = await request.json();\n    const validation = validateAndSanitizeProfileInput(body);\n\n    if (!validation.valid) {\n      return NextResponse.json({ error: validation.error }, { status: 400 });\n    }\n\n    const user = await prisma.user.update({\n      where: { id: authResult.user.id },\n      data: {\n        ...(validation.firstName !== undefined && { firstName: validation.firstName }),\n        ...(validation.lastName !== undefined && { lastName: validation.lastName }),\n        ...(validation.phone !== undefined && { phone: validation.phone }),\n        ...(validation.company !== undefined && { company: validation.company }),\n        ...(validation.title !== undefined && { title: validation.title }),\n        ...(validation.discipline !== undefined && { discipline: validation.discipline }),\n      },\n      select: {\n        id: true,\n        firstName: true,\n        lastName: true,\n        email: true,\n        phone: true,\n        company: true,\n        title: true,\n        discipline: true,\n        role: true,\n        status: true,\n      },\n    });\n\n    return NextResponse.json(user);\n  } catch (error) {\n    console.error(\"Error updating profile:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2481,"size_tokens":null},"src/components/pages/profile/profile-form.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { User, Mail, Building2, Briefcase, Phone, Save, Undo2, AlertCircle } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useDraftPersistence } from \"@/hooks/use-draft-persistence\";\nimport { DISCIPLINES } from \"@/lib/constants\";\n\ninterface ProfileFormProps {\n  user: {\n    id: string;\n    firstName: string;\n    lastName: string;\n    email: string;\n    phone: string | null;\n    company: string | null;\n    title: string | null;\n    discipline: string | null;\n    role: string;\n    status: string;\n  };\n}\n\ninterface FormData {\n  firstName: string;\n  lastName: string;\n  phone: string;\n  company: string;\n  title: string;\n  discipline: string;\n}\n\nexport function ProfileForm({ user }: ProfileFormProps) {\n  const [loading, setLoading] = useState(false);\n  const [success, setSuccess] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const {\n    data: formData,\n    updateField,\n    isDirty,\n    hasRecoveredDraft,\n    clearDraft,\n    discardDraft,\n    resetToServer,\n  } = useDraftPersistence<FormData>({\n    key: `profile_${user.id}`,\n    initialData: {\n      firstName: user.firstName,\n      lastName: user.lastName,\n      phone: user.phone || \"\",\n      company: user.company || \"\",\n      title: user.title || \"\",\n      discipline: user.discipline || \"\",\n    },\n  });\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    setLoading(true);\n    setSuccess(false);\n    setError(null);\n\n    try {\n      const res = await fetch(\"/api/profile\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(formData),\n      });\n\n      if (res.ok) {\n        const updated = await res.json();\n        resetToServer({\n          firstName: updated.firstName,\n          lastName: updated.lastName,\n          phone: updated.phone || \"\",\n          company: updated.company || \"\",\n          title: updated.title || \"\",\n          discipline: updated.discipline || \"\",\n        });\n        setSuccess(true);\n        setTimeout(() => setSuccess(false), 3000);\n      } else {\n        const data = await res.json();\n        setError(data.error || \"Kunne ikke lagre endringer\");\n      }\n    } catch (err) {\n      console.error(err);\n      setError(\"Nettverksfeil - pr√∏v igjen\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-xl sm:text-2xl font-bold text-foreground\">Min profil</h1>\n        <p className=\"text-sm sm:text-base text-muted-foreground\">Administrer din kontoinformasjon</p>\n      </div>\n\n      {hasRecoveredDraft && (\n        <div className=\"flex items-center gap-3 rounded-lg border border-amber-500/50 bg-amber-500/10 p-3 sm:p-4\">\n          <AlertCircle className=\"h-5 w-5 shrink-0 text-amber-500\" />\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-medium text-foreground\">\n              Ulagrede endringer funnet\n            </p>\n            <p className=\"text-xs text-muted-foreground\">\n              Vi gjenopprettet endringene du hadde f√∏r siden ble lastet p√• nytt.\n            </p>\n          </div>\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={discardDraft}\n            className=\"shrink-0\"\n          >\n            <Undo2 className=\"h-4 w-4 mr-1\" />\n            <span className=\"hidden sm:inline\">Forkast</span>\n          </Button>\n        </div>\n      )}\n\n      <div className=\"grid gap-6 lg:grid-cols-3\">\n        <Card className=\"lg:col-span-2\">\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-lg\">Profilinformasjon</CardTitle>\n          </CardHeader>\n          <CardContent className=\"pb-0\">\n            <form onSubmit={handleSubmit} className=\"space-y-4 sm:space-y-5\">\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                <Input\n                  label=\"Fornavn\"\n                  value={formData.firstName}\n                  onChange={(e) => updateField(\"firstName\", e.target.value)}\n                  required\n                  autoComplete=\"given-name\"\n                  className=\"text-base\"\n                />\n                <Input\n                  label=\"Etternavn\"\n                  value={formData.lastName}\n                  onChange={(e) => updateField(\"lastName\", e.target.value)}\n                  required\n                  autoComplete=\"family-name\"\n                  className=\"text-base\"\n                />\n              </div>\n\n              <Input\n                label=\"Telefon\"\n                type=\"tel\"\n                value={formData.phone}\n                onChange={(e) => updateField(\"phone\", e.target.value)}\n                placeholder=\"+47 XXX XX XXX\"\n                autoComplete=\"tel\"\n                className=\"text-base\"\n              />\n\n              <Input\n                label=\"Firma\"\n                value={formData.company}\n                onChange={(e) => updateField(\"company\", e.target.value)}\n                placeholder=\"Ditt firma\"\n                autoComplete=\"organization\"\n                className=\"text-base\"\n              />\n\n              <Input\n                label=\"Tittel\"\n                value={formData.title}\n                onChange={(e) => updateField(\"title\", e.target.value)}\n                placeholder=\"Din tittel\"\n                autoComplete=\"organization-title\"\n                className=\"text-base\"\n              />\n\n              <div className=\"flex flex-col gap-1.5\">\n                <label className=\"text-sm font-medium text-foreground\">Fagomr√•de</label>\n                <Select\n                  value={formData.discipline}\n                  onValueChange={(value) => updateField(\"discipline\", value)}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Velg fagomr√•de...\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {DISCIPLINES.map((discipline) => (\n                      <SelectItem key={discipline.value} value={discipline.value}>\n                        {discipline.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {error && (\n                <p className=\"text-sm text-danger\">{error}</p>\n              )}\n\n              <div className=\"sticky bottom-0 -mx-6 mt-6 border-t border-border bg-card px-6 py-4 sm:relative sm:mx-0 sm:mt-0 sm:border-0 sm:bg-transparent sm:px-0 sm:py-0\">\n                <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\n                  <Button \n                    type=\"submit\" \n                    loading={loading}\n                    disabled={!isDirty && !loading}\n                    className=\"w-full sm:w-auto min-h-[44px] text-base\"\n                  >\n                    <Save size={18} className=\"mr-2\" />\n                    Lagre endringer\n                  </Button>\n                  \n                  {isDirty && !loading && (\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      onClick={discardDraft}\n                      className=\"w-full sm:w-auto min-h-[44px]\"\n                    >\n                      <Undo2 size={18} className=\"mr-2\" />\n                      Forkast endringer\n                    </Button>\n                  )}\n\n                  {success && (\n                    <span className=\"text-sm text-green-500 text-center sm:text-left\">\n                      Profil oppdatert!\n                    </span>\n                  )}\n                </div>\n              </div>\n            </form>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-lg\">Kontostatus</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex items-center gap-3 rounded-lg bg-muted/50 p-3\">\n              <Mail className=\"text-muted-foreground shrink-0\" size={18} />\n              <div className=\"min-w-0 flex-1\">\n                <p className=\"text-xs text-muted-foreground\">E-post</p>\n                <p className=\"text-sm font-medium text-foreground truncate\">{user.email}</p>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-3 rounded-lg bg-muted/50 p-3\">\n              <User className=\"text-muted-foreground shrink-0\" size={18} />\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Rolle</p>\n                <Badge tone=\"info\" className=\"mt-1\">\n                  {user.role}\n                </Badge>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-3 rounded-lg bg-muted/50 p-3\">\n              <div\n                className={`h-3 w-3 shrink-0 rounded-full ${\n                  user.status === \"ACTIVE\" ? \"bg-green-500\" : \"bg-yellow-500\"\n                }`}\n              />\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Status</p>\n                <Badge\n                  tone={user.status === \"ACTIVE\" ? \"success\" : \"warning\"}\n                  className=\"mt-1\"\n                >\n                  {user.status}\n                </Badge>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9803,"size_tokens":null},"src/components/ui/label.tsx":{"content":"\"use client\";\n\nimport * as React from \"react\";\nimport * as LabelPrimitive from \"@radix-ui/react-label\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\nimport { cn } from \"@/lib/utils\";\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n);\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n));\nLabel.displayName = LabelPrimitive.Root.displayName;\n\nexport { Label };\n","path":null,"size_bytes":732,"size_tokens":null},"src/app/api/profile/password/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport bcrypt from \"bcryptjs\";\nimport { authenticator } from \"otplib\";\n\nconst rateLimitMap = new Map<string, { count: number; resetTime: number }>();\nconst RATE_LIMIT_WINDOW = 15 * 60 * 1000;\nconst MAX_ATTEMPTS = 5;\n\nfunction checkRateLimit(userId: string): { allowed: boolean; remainingTime?: number } {\n  const now = Date.now();\n  const entry = rateLimitMap.get(userId);\n\n  if (!entry || now > entry.resetTime) {\n    rateLimitMap.set(userId, { count: 1, resetTime: now + RATE_LIMIT_WINDOW });\n    return { allowed: true };\n  }\n\n  if (entry.count >= MAX_ATTEMPTS) {\n    const remainingTime = Math.ceil((entry.resetTime - now) / 1000 / 60);\n    return { allowed: false, remainingTime };\n  }\n\n  entry.count++;\n  return { allowed: true };\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const rateLimit = checkRateLimit(authResult.user.id);\n    if (!rateLimit.allowed) {\n      return NextResponse.json(\n        { error: `For mange fors√∏k. Pr√∏v igjen om ${rateLimit.remainingTime} minutter.` },\n        { status: 429 }\n      );\n    }\n\n    const body = await request.json();\n    const { currentPassword, newPassword, confirmPassword, totpCode } = body;\n\n    if (!currentPassword || !newPassword || !confirmPassword) {\n      return NextResponse.json(\n        { error: \"Alle felt m√• fylles ut\" },\n        { status: 400 }\n      );\n    }\n\n    if (newPassword !== confirmPassword) {\n      return NextResponse.json(\n        { error: \"Nytt passord og bekreftelse stemmer ikke overens\" },\n        { status: 400 }\n      );\n    }\n\n    if (newPassword.length < 8) {\n      return NextResponse.json(\n        { error: \"Passord m√• v√¶re minst 8 tegn\" },\n        { status: 400 }\n      );\n    }\n\n    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]).{8,}$/;\n    if (!passwordRegex.test(newPassword)) {\n      return NextResponse.json(\n        { error: \"Passord m√• inneholde minst √©n stor bokstav, √©n liten bokstav, ett tall og ett spesialtegn\" },\n        { status: 400 }\n      );\n    }\n\n    const user = await prisma.user.findUnique({\n      where: { id: authResult.user.id },\n      select: { \n        passwordHash: true,\n        totpEnabled: true,\n        totpSecret: true,\n      },\n    });\n\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Bruker ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    if (user.totpEnabled && user.totpSecret) {\n      if (!totpCode) {\n        return NextResponse.json(\n          { error: \"TOTP_REQUIRED\", requiresTotp: true },\n          { status: 400 }\n        );\n      }\n\n      const isValidTotp = authenticator.verify({ token: totpCode, secret: user.totpSecret });\n      if (!isValidTotp) {\n        return NextResponse.json(\n          { error: \"Ugyldig verifiseringskode\" },\n          { status: 400 }\n        );\n      }\n    }\n\n    const isValid = await bcrypt.compare(currentPassword, user.passwordHash);\n    if (!isValid) {\n      return NextResponse.json(\n        { error: \"N√•v√¶rende passord er feil\" },\n        { status: 400 }\n      );\n    }\n\n    const isSamePassword = await bcrypt.compare(newPassword, user.passwordHash);\n    if (isSamePassword) {\n      return NextResponse.json(\n        { error: \"Nytt passord kan ikke v√¶re likt det n√•v√¶rende passordet\" },\n        { status: 400 }\n      );\n    }\n\n    const hashedPassword = await bcrypt.hash(newPassword, 12);\n    await prisma.user.update({\n      where: { id: authResult.user.id },\n      data: { passwordHash: hashedPassword },\n    });\n\n    rateLimitMap.delete(authResult.user.id);\n\n    console.log(`Password changed for user ${authResult.user.id} at ${new Date().toISOString()}`);\n\n    return NextResponse.json({ message: \"Passord oppdatert\" });\n  } catch (error) {\n    console.error(\"Error changing password:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4145,"size_tokens":null},"src/app/api/totp/status/route.ts":{"content":"import { NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\n\nconst TOTP_DEADLINE_DAYS = 14;\n\nexport async function GET() {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const user = await prisma.user.findUnique({\n      where: { id: authResult.user.id },\n      select: {\n        totpEnabled: true,\n        totpDeadline: true,\n        createdAt: true,\n        role: true,\n      },\n    });\n\n    if (!user) {\n      return NextResponse.json({ error: \"Bruker ikke funnet\" }, { status: 404 });\n    }\n\n    if (user.totpEnabled) {\n      return NextResponse.json({ totpEnabled: true, warning: null });\n    }\n\n    if (user.role === \"ADMIN\") {\n      return NextResponse.json({ totpEnabled: false, warning: null });\n    }\n\n    const totpDeadline = user.totpDeadline || new Date(user.createdAt.getTime() + TOTP_DEADLINE_DAYS * 24 * 60 * 60 * 1000);\n    const now = new Date();\n    const daysRemaining = Math.max(0, Math.ceil((totpDeadline.getTime() - now.getTime()) / (24 * 60 * 60 * 1000)));\n\n    if (now >= totpDeadline) {\n      return NextResponse.json({\n        totpEnabled: false,\n        warning: {\n          daysRemaining: 0,\n          deadline: totpDeadline.toISOString(),\n          expired: true,\n          message: \"Fristen for √• aktivere tofaktor-autentisering har utl√∏pt\",\n        },\n      });\n    }\n\n    return NextResponse.json({\n      totpEnabled: false,\n      warning: {\n        daysRemaining,\n        deadline: totpDeadline.toISOString(),\n        expired: false,\n        message: daysRemaining === 1\n          ? \"Du har 1 dag igjen til √• aktivere tofaktor-autentisering\"\n          : `Du har ${daysRemaining} dager igjen til √• aktivere tofaktor-autentisering`,\n      },\n    });\n  } catch (error) {\n    console.error(\"Error getting TOTP status:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2007,"size_tokens":null},"src/components/totp/totp-warning-banner.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { AlertTriangle, Shield, ExternalLink, X, Clock } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\n\ninterface TotpWarningBannerProps {\n  daysRemaining: number;\n  onDismiss?: () => void;\n}\n\nconst AUTHENTICATOR_GUIDES = [\n  {\n    name: \"Google Authenticator\",\n    icon: \"üîê\",\n    links: [\n      { label: \"Android\", url: \"https://support.google.com/accounts/answer/1066447?hl=no&co=GENIE.Platform%3DAndroid\" },\n      { label: \"iPhone\", url: \"https://support.google.com/accounts/answer/1066447?hl=no&co=GENIE.Platform%3DiOS\" },\n    ],\n  },\n  {\n    name: \"Microsoft Authenticator\",\n    icon: \"üõ°Ô∏è\",\n    links: [\n      { label: \"Veiledning\", url: \"https://support.microsoft.com/nb-no/account-billing/how-to-use-the-microsoft-authenticator-app-9783c865-0308-42fb-a519-8cf666fe0acc\" },\n    ],\n  },\n];\n\nexport function TotpWarningBanner({ daysRemaining, onDismiss }: TotpWarningBannerProps) {\n  const [dismissed, setDismissed] = useState(false);\n  const [showGuides, setShowGuides] = useState(false);\n\n  useEffect(() => {\n    const dismissedUntil = localStorage.getItem(\"totp-warning-dismissed\");\n    if (dismissedUntil) {\n      const dismissedDate = new Date(dismissedUntil);\n      if (dismissedDate > new Date()) {\n        setDismissed(true);\n      } else {\n        localStorage.removeItem(\"totp-warning-dismissed\");\n      }\n    }\n  }, []);\n\n  const handleDismiss = () => {\n    const dismissUntil = new Date();\n    dismissUntil.setTime(dismissUntil.getTime() + 24 * 60 * 60 * 1000);\n    localStorage.setItem(\"totp-warning-dismissed\", dismissUntil.toISOString());\n    setDismissed(true);\n    onDismiss?.();\n  };\n\n  if (dismissed) return null;\n\n  const isUrgent = daysRemaining <= 3;\n  const bgColor = isUrgent ? \"bg-danger/10 border-danger/50\" : \"bg-warning/10 border-warning/50\";\n  const textColor = isUrgent ? \"text-danger\" : \"text-warning\";\n  const iconColor = isUrgent ? \"text-danger\" : \"text-warning\";\n\n  return (\n    <div className={`rounded-lg border ${bgColor} p-4 mb-4`}>\n      <div className=\"flex items-start gap-3\">\n        <div className={`p-2 rounded-full ${isUrgent ? \"bg-danger/20\" : \"bg-warning/20\"}`}>\n          {isUrgent ? (\n            <AlertTriangle className={`h-5 w-5 ${iconColor}`} />\n          ) : (\n            <Clock className={`h-5 w-5 ${iconColor}`} />\n          )}\n        </div>\n        \n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center justify-between gap-2\">\n            <h3 className={`font-semibold ${textColor}`}>\n              {isUrgent ? \"Hastevarsel: \" : \"\"}\n              Aktiver tofaktor-autentisering\n            </h3>\n            <button\n              onClick={handleDismiss}\n              className=\"p-1 hover:bg-muted rounded-md transition-colors\"\n              title=\"Skjul til i morgen\"\n            >\n              <X className=\"h-4 w-4 text-muted-foreground\" />\n            </button>\n          </div>\n          \n          <p className=\"text-sm text-muted-foreground mt-1\">\n            {daysRemaining === 1 ? (\n              <span className={textColor}>\n                Du har <strong>1 dag</strong> igjen til √• aktivere tofaktor-autentisering.\n              </span>\n            ) : (\n              <>\n                Du har <strong className={textColor}>{daysRemaining} dager</strong> igjen til √• aktivere tofaktor-autentisering.\n              </>\n            )}\n            {\" \"}Kontoen din vil bli deaktivert hvis du ikke aktiverer dette innen fristen.\n          </p>\n\n          <div className=\"flex flex-wrap gap-2 mt-3\">\n            <Link href=\"/profile\">\n              <Button variant=\"default\" size=\"sm\" className=\"gap-2\">\n                <Shield className=\"h-4 w-4\" />\n                Aktiver n√•\n              </Button>\n            </Link>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setShowGuides(!showGuides)}\n              className=\"gap-2\"\n            >\n              <ExternalLink className=\"h-4 w-4\" />\n              {showGuides ? \"Skjul veiledninger\" : \"Hvordan sette opp?\"}\n            </Button>\n          </div>\n\n          {showGuides && (\n            <div className=\"mt-4 p-3 bg-muted/50 rounded-lg space-y-3\">\n              <p className=\"text-sm font-medium text-foreground\">\n                Last ned en authenticator-app og f√∏lg veiledningen:\n              </p>\n              {AUTHENTICATOR_GUIDES.map((guide) => (\n                <div key={guide.name} className=\"flex items-center gap-2 flex-wrap\">\n                  <span className=\"text-lg\">{guide.icon}</span>\n                  <span className=\"text-sm font-medium\">{guide.name}:</span>\n                  {guide.links.map((link, idx) => (\n                    <a\n                      key={idx}\n                      href={link.url}\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className=\"text-sm text-info hover:underline inline-flex items-center gap-1\"\n                    >\n                      {link.label}\n                      <ExternalLink className=\"h-3 w-3\" />\n                    </a>\n                  ))}\n                </div>\n              ))}\n              <p className=\"text-xs text-muted-foreground mt-2\">\n                Etter at du har installert appen, g√• til din profil og f√∏lg instruksjonene for √• aktivere tofaktor-autentisering.\n              </p>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5554,"size_tokens":null},"src/app/api/auth/login/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport bcrypt from \"bcryptjs\";\nimport { authenticator } from \"otplib\";\n\nconst TOTP_DEADLINE_DAYS = 14;\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { email, password, totpCode } = body;\n\n    if (!email || !password) {\n      return NextResponse.json(\n        { error: \"E-post og passord er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    const user = await prisma.user.findUnique({\n      where: { email: email.toLowerCase() },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        lastName: true,\n        passwordHash: true,\n        role: true,\n        status: true,\n        totpEnabled: true,\n        totpSecret: true,\n        totpFailedAttempts: true,\n        totpLockedUntil: true,\n        totpDeadline: true,\n        createdAt: true,\n      },\n    });\n\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Ugyldig e-post eller passord\" },\n        { status: 401 }\n      );\n    }\n\n    const passwordMatch = await bcrypt.compare(password, user.passwordHash);\n    if (!passwordMatch) {\n      return NextResponse.json(\n        { error: \"Ugyldig e-post eller passord\" },\n        { status: 401 }\n      );\n    }\n\n    if (user.status === \"SUSPENDED\") {\n      return NextResponse.json(\n        { error: \"Kontoen din er suspendert. Kontakt administrator.\" },\n        { status: 403 }\n      );\n    }\n\n    if (user.status === \"PENDING\") {\n      return NextResponse.json(\n        { error: \"Kontoen din venter p√• godkjenning fra administrator.\" },\n        { status: 403 }\n      );\n    }\n\n    if (user.status !== \"ACTIVE\") {\n      return NextResponse.json(\n        { error: \"Kontoen din er ikke aktiv.\" },\n        { status: 403 }\n      );\n    }\n\n    const totpDeadline = user.totpDeadline || new Date(user.createdAt.getTime() + TOTP_DEADLINE_DAYS * 24 * 60 * 60 * 1000);\n    const now = new Date();\n    const daysRemaining = Math.ceil((totpDeadline.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n\n    if (!user.totpEnabled && now >= totpDeadline) {\n      await prisma.user.update({\n        where: { id: user.id },\n        data: { status: \"SUSPENDED\" },\n      });\n      return NextResponse.json(\n        { error: \"Kontoen din er deaktivert fordi tofaktor-autentisering ikke ble aktivert innen fristen. Kontakt administrator.\" },\n        { status: 403 }\n      );\n    }\n\n    if (user.totpEnabled && user.totpSecret) {\n      if (!totpCode) {\n        return NextResponse.json(\n          { requiresTotp: true, message: \"TOTP_REQUIRED\" },\n          { status: 200 }\n        );\n      }\n\n      if (user.totpLockedUntil && user.totpLockedUntil > new Date()) {\n        const minutesLeft = Math.ceil((user.totpLockedUntil.getTime() - Date.now()) / 60000);\n        return NextResponse.json(\n          { error: `For mange feilede fors√∏k. Pr√∏v igjen om ${minutesLeft} minutter.` },\n          { status: 429 }\n        );\n      }\n\n      const isValidTotp = authenticator.verify({\n        token: totpCode,\n        secret: user.totpSecret,\n      });\n\n      if (!isValidTotp) {\n        const newFailedAttempts = user.totpFailedAttempts + 1;\n        const lockoutTime = newFailedAttempts >= 5 \n          ? new Date(Date.now() + 15 * 60 * 1000) \n          : null;\n\n        await prisma.user.update({\n          where: { id: user.id },\n          data: {\n            totpFailedAttempts: newFailedAttempts,\n            totpLockedUntil: lockoutTime,\n          },\n        });\n\n        if (lockoutTime) {\n          return NextResponse.json(\n            { error: \"For mange feilede fors√∏k. Kontoen er l√•st i 15 minutter.\" },\n            { status: 429 }\n          );\n        }\n        return NextResponse.json(\n          { error: \"Ugyldig verifiseringskode\" },\n          { status: 401 }\n        );\n      }\n\n      await prisma.user.update({\n        where: { id: user.id },\n        data: {\n          totpFailedAttempts: 0,\n          totpLockedUntil: null,\n        },\n      });\n    }\n\n    const totpWarning = !user.totpEnabled && daysRemaining > 0 && daysRemaining <= TOTP_DEADLINE_DAYS\n      ? {\n          daysRemaining,\n          deadline: totpDeadline.toISOString(),\n          message: daysRemaining === 1\n            ? \"Du har 1 dag igjen til √• aktivere tofaktor-autentisering\"\n            : `Du har ${daysRemaining} dager igjen til √• aktivere tofaktor-autentisering`,\n        }\n      : null;\n\n    return NextResponse.json({\n      success: true,\n      user: {\n        id: user.id,\n        email: user.email,\n        name: `${user.firstName} ${user.lastName}`,\n        role: user.role,\n        status: user.status,\n      },\n      totpWarning,\n    });\n  } catch (error) {\n    console.error(\"Login error:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4890,"size_tokens":null},"src/lib/constants.ts":{"content":"export const DISCIPLINES = [\n  { value: \"Elektro\", label: \"Elektro\" },\n  { value: \"Ventilasjon\", label: \"Ventilasjon\" },\n  { value: \"Kulde\", label: \"Kulde\" },\n  { value: \"Byggautomasjon\", label: \"Byggautomasjon\" },\n  { value: \"R√∏rlegger\", label: \"R√∏rlegger\" },\n  { value: \"Administrasjon\", label: \"Administrasjon\" },\n  { value: \"Totalentrepren√∏r\", label: \"Totalentrepren√∏r\" },\n  { value: \"Byggherre\", label: \"Byggherre\" },\n  { value: \"Annet\", label: \"Annet\" },\n] as const;\n\nexport type Discipline = typeof DISCIPLINES[number][\"value\"];\n","path":null,"size_bytes":540,"size_tokens":null},"src/components/pages/profile/password-change.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { Key, Eye, EyeOff, Check, Shield } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\n\nexport function PasswordChange() {\n  const [loading, setLoading] = useState(false);\n  const [success, setSuccess] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [requiresTotp, setRequiresTotp] = useState(false);\n  const [showPasswords, setShowPasswords] = useState({\n    current: false,\n    new: false,\n    confirm: false,\n  });\n  const [formData, setFormData] = useState({\n    currentPassword: \"\",\n    newPassword: \"\",\n    confirmPassword: \"\",\n    totpCode: \"\",\n  });\n\n  const passwordRequirements = [\n    { label: \"Minst 8 tegn\", met: formData.newPassword.length >= 8 },\n    { label: \"Stor bokstav\", met: /[A-Z]/.test(formData.newPassword) },\n    { label: \"Liten bokstav\", met: /[a-z]/.test(formData.newPassword) },\n    { label: \"Tall\", met: /\\d/.test(formData.newPassword) },\n    { label: \"Spesialtegn\", met: /[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(formData.newPassword) },\n  ];\n\n  const allRequirementsMet = passwordRequirements.every((req) => req.met);\n  const passwordsMatch = formData.newPassword === formData.confirmPassword && formData.confirmPassword.length > 0;\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    setLoading(true);\n    setSuccess(false);\n    setError(null);\n\n    try {\n      const res = await fetch(\"/api/profile/password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(formData),\n      });\n\n      const data = await res.json();\n\n      if (res.ok) {\n        setSuccess(true);\n        setRequiresTotp(false);\n        setFormData({ currentPassword: \"\", newPassword: \"\", confirmPassword: \"\", totpCode: \"\" });\n        setTimeout(() => setSuccess(false), 5000);\n      } else if (data.requiresTotp) {\n        setRequiresTotp(true);\n        setError(null);\n      } else {\n        setError(data.error || \"Kunne ikke endre passord\");\n      }\n    } catch (err) {\n      console.error(err);\n      setError(\"Nettverksfeil - pr√∏v igjen\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  function togglePasswordVisibility(field: \"current\" | \"new\" | \"confirm\") {\n    setShowPasswords((prev) => ({ ...prev, [field]: !prev[field] }));\n  }\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-4\">\n        <CardTitle className=\"flex items-center gap-2 text-lg\">\n          <Key className=\"h-5 w-5\" />\n          Endre passord\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"relative\">\n            <Input\n              label=\"N√•v√¶rende passord\"\n              type={showPasswords.current ? \"text\" : \"password\"}\n              value={formData.currentPassword}\n              onChange={(e) =>\n                setFormData((prev) => ({ ...prev, currentPassword: e.target.value }))\n              }\n              required\n              autoComplete=\"current-password\"\n            />\n            <button\n              type=\"button\"\n              className=\"absolute right-3 top-[34px] text-muted-foreground hover:text-foreground\"\n              onClick={() => togglePasswordVisibility(\"current\")}\n              aria-label={showPasswords.current ? \"Skjul passord\" : \"Vis passord\"}\n            >\n              {showPasswords.current ? <EyeOff size={18} /> : <Eye size={18} />}\n            </button>\n          </div>\n\n          <div className=\"relative\">\n            <Input\n              label=\"Nytt passord\"\n              type={showPasswords.new ? \"text\" : \"password\"}\n              value={formData.newPassword}\n              onChange={(e) =>\n                setFormData((prev) => ({ ...prev, newPassword: e.target.value }))\n              }\n              required\n              autoComplete=\"new-password\"\n            />\n            <button\n              type=\"button\"\n              className=\"absolute right-3 top-[34px] text-muted-foreground hover:text-foreground\"\n              onClick={() => togglePasswordVisibility(\"new\")}\n              aria-label={showPasswords.new ? \"Skjul passord\" : \"Vis passord\"}\n            >\n              {showPasswords.new ? <EyeOff size={18} /> : <Eye size={18} />}\n            </button>\n          </div>\n\n          {formData.newPassword && (\n            <div className=\"rounded-lg bg-muted/50 p-3 space-y-1\">\n              <p className=\"text-xs font-medium text-muted-foreground mb-2\">Passordkrav:</p>\n              {passwordRequirements.map((req, i) => (\n                <div key={i} className=\"flex items-center gap-2 text-xs\">\n                  <div\n                    className={`h-4 w-4 rounded-full flex items-center justify-center ${\n                      req.met ? \"bg-green-500 text-white\" : \"bg-muted-foreground/20\"\n                    }`}\n                  >\n                    {req.met && <Check size={10} />}\n                  </div>\n                  <span className={req.met ? \"text-foreground\" : \"text-muted-foreground\"}>\n                    {req.label}\n                  </span>\n                </div>\n              ))}\n            </div>\n          )}\n\n          <div className=\"relative\">\n            <Input\n              label=\"Bekreft nytt passord\"\n              type={showPasswords.confirm ? \"text\" : \"password\"}\n              value={formData.confirmPassword}\n              onChange={(e) =>\n                setFormData((prev) => ({ ...prev, confirmPassword: e.target.value }))\n              }\n              required\n              autoComplete=\"new-password\"\n            />\n            <button\n              type=\"button\"\n              className=\"absolute right-3 top-[34px] text-muted-foreground hover:text-foreground\"\n              onClick={() => togglePasswordVisibility(\"confirm\")}\n              aria-label={showPasswords.confirm ? \"Skjul passord\" : \"Vis passord\"}\n            >\n              {showPasswords.confirm ? <EyeOff size={18} /> : <Eye size={18} />}\n            </button>\n          </div>\n\n          {formData.confirmPassword && !passwordsMatch && (\n            <p className=\"text-sm text-danger\">Passordene stemmer ikke overens</p>\n          )}\n\n          {requiresTotp && (\n            <div className=\"space-y-3 rounded-lg border border-primary/50 bg-primary/5 p-4\">\n              <div className=\"flex items-center gap-2 text-sm font-medium text-foreground\">\n                <Shield className=\"h-4 w-4 text-primary\" />\n                Tofaktor-verifisering p√•krevd\n              </div>\n              <Input\n                label=\"Verifiseringskode\"\n                type=\"text\"\n                inputMode=\"numeric\"\n                pattern=\"[0-9]*\"\n                maxLength={6}\n                value={formData.totpCode}\n                onChange={(e) =>\n                  setFormData((prev) => ({ ...prev, totpCode: e.target.value.replace(/\\D/g, \"\") }))\n                }\n                placeholder=\"000000\"\n                hint=\"Skriv inn 6-sifret kode fra authenticator-appen\"\n                autoComplete=\"one-time-code\"\n              />\n            </div>\n          )}\n\n          {error && <p className=\"text-sm text-danger\">{error}</p>}\n\n          {success && (\n            <div className=\"rounded-lg bg-green-500/10 border border-green-500/50 p-3\">\n              <p className=\"text-sm text-green-500 font-medium\">Passord oppdatert!</p>\n            </div>\n          )}\n\n          <Button\n            type=\"submit\"\n            loading={loading}\n            disabled={!allRequirementsMet || !passwordsMatch || !formData.currentPassword || (requiresTotp && formData.totpCode.length !== 6)}\n            className=\"w-full\"\n          >\n            Endre passord\n          </Button>\n        </form>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":7941,"size_tokens":null},"src/app/api/projects/[projectId]/restore/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectLeaderAccess } from \"@/lib/auth-helpers\";\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectLeaderAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const project = await prisma.project.findUnique({\n      where: { id: projectId },\n    });\n\n    if (!project) {\n      return NextResponse.json({ error: \"Prosjekt ikke funnet\" }, { status: 404 });\n    }\n\n    if (project.status !== \"ARCHIVED\") {\n      return NextResponse.json({ error: \"Prosjektet er ikke arkivert\" }, { status: 400 });\n    }\n\n    const updatedProject = await prisma.project.update({\n      where: { id: projectId },\n      data: {\n        status: \"ACTIVE\",\n        archivedAt: null,\n      },\n    });\n\n    return NextResponse.json(updatedProject);\n  } catch (error) {\n    console.error(\"Error restoring project:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":1194,"size_tokens":null},"src/app/api/projects/[projectId]/members/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectLeaderAccess, requireProjectAccess } from \"@/lib/auth-helpers\";\nimport { Role } from \"@prisma/client\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const members = await prisma.projectMember.findMany({\n      where: { projectId },\n      include: {\n        user: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n            company: true,\n            title: true,\n          },\n        },\n      },\n    });\n\n    return NextResponse.json(members);\n  } catch (error) {\n    console.error(\"Error fetching members:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectLeaderAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const body = await request.json();\n    const { userId, role } = body;\n\n    if (!userId) {\n      return NextResponse.json({ error: \"Bruker-ID er p√•krevd\" }, { status: 400 });\n    }\n\n    const validRoles: Role[] = [\"PROJECT_LEADER\", \"USER\", \"READER\"];\n    const memberRole = validRoles.includes(role) ? role : \"USER\";\n\n    const user = await prisma.user.findUnique({\n      where: { id: userId },\n    });\n\n    if (!user) {\n      return NextResponse.json({ error: \"Bruker ikke funnet\" }, { status: 404 });\n    }\n\n    if (user.status !== \"ACTIVE\") {\n      return NextResponse.json({ error: \"Bruker er ikke aktiv\" }, { status: 400 });\n    }\n\n    const existingMember = await prisma.projectMember.findUnique({\n      where: {\n        projectId_userId: {\n          projectId,\n          userId,\n        },\n      },\n    });\n\n    if (existingMember) {\n      return NextResponse.json({ error: \"Bruker er allerede medlem\" }, { status: 400 });\n    }\n\n    const member = await prisma.projectMember.create({\n      data: {\n        projectId,\n        userId,\n        role: memberRole,\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n            company: true,\n            title: true,\n          },\n        },\n      },\n    });\n\n    return NextResponse.json(member, { status: 201 });\n  } catch (error) {\n    console.error(\"Error adding member:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectLeaderAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { searchParams } = new URL(request.url);\n    const userId = searchParams.get(\"userId\");\n\n    if (!userId) {\n      return NextResponse.json({ error: \"Bruker-ID er p√•krevd\" }, { status: 400 });\n    }\n\n    const member = await prisma.projectMember.findUnique({\n      where: {\n        projectId_userId: {\n          projectId,\n          userId,\n        },\n      },\n    });\n\n    if (!member) {\n      return NextResponse.json({ error: \"Medlem ikke funnet\" }, { status: 404 });\n    }\n\n    const project = await prisma.project.findUnique({\n      where: { id: projectId },\n    });\n\n    if (project?.createdById === userId) {\n      return NextResponse.json({ error: \"Kan ikke fjerne prosjektoppretteren\" }, { status: 400 });\n    }\n\n    await prisma.projectMember.delete({\n      where: {\n        projectId_userId: {\n          projectId,\n          userId,\n        },\n      },\n    });\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error(\"Error removing member:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4327,"size_tokens":null},"src/components/ui/theme-toggle.tsx":{"content":"\"use client\";\n\nimport { Moon, Sun } from \"lucide-react\";\nimport { useTheme } from \"next-themes\";\nimport { Button } from \"@/components/ui/button\";\nimport { useEffect, useState } from \"react\";\n\nexport function ThemeToggle() {\n  const [mounted, setMounted] = useState(false);\n  const { theme, setTheme } = useTheme();\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  if (!mounted) {\n    return (\n      <Button variant=\"ghost\" size=\"sm\" className=\"w-9 h-9 p-0\">\n        <Sun size={18} />\n      </Button>\n    );\n  }\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"sm\"\n      className=\"w-9 h-9 p-0\"\n      onClick={() => setTheme(theme === \"dark\" ? \"light\" : \"dark\")}\n      title={theme === \"dark\" ? \"Bytt til lys modus\" : \"Bytt til m√∏rk modus\"}\n    >\n      {theme === \"dark\" ? (\n        <Sun size={18} className=\"text-yellow-500\" />\n      ) : (\n        <Moon size={18} className=\"text-slate-700\" />\n      )}\n    </Button>\n  );\n}\n","path":null,"size_bytes":941,"size_tokens":null},"src/app/api/projects/[projectId]/archive/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectLeaderAccess } from \"@/lib/auth-helpers\";\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectLeaderAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const project = await prisma.project.findUnique({\n      where: { id: projectId },\n    });\n\n    if (!project) {\n      return NextResponse.json({ error: \"Prosjekt ikke funnet\" }, { status: 404 });\n    }\n\n    if (project.status === \"ARCHIVED\") {\n      return NextResponse.json({ error: \"Prosjektet er allerede arkivert\" }, { status: 400 });\n    }\n\n    const updatedProject = await prisma.project.update({\n      where: { id: projectId },\n      data: {\n        status: \"ARCHIVED\",\n        archivedAt: new Date(),\n      },\n    });\n\n    return NextResponse.json(updatedProject);\n  } catch (error) {\n    console.error(\"Error archiving project:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":1206,"size_tokens":null},"src/app/api/users/search/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport { Role } from \"@prisma/client\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { searchParams } = new URL(request.url);\n    const query = searchParams.get(\"q\") || \"\";\n    const excludeProjectId = searchParams.get(\"excludeProject\");\n\n    if (!excludeProjectId) {\n      return NextResponse.json({ error: \"Prosjekt-ID er p√•krevd\" }, { status: 400 });\n    }\n\n    const requesterMembership = await prisma.projectMember.findFirst({\n      where: {\n        projectId: excludeProjectId,\n        userId: authResult.user.id,\n      },\n    });\n\n    const isAdmin = authResult.user.role === Role.ADMIN;\n    const isProjectLeader = requesterMembership?.role === Role.PROJECT_LEADER;\n\n    if (!isAdmin && !isProjectLeader) {\n      return NextResponse.json(\n        { error: \"Kun admins og prosjektledere kan s√∏ke etter brukere\" },\n        { status: 403 }\n      );\n    }\n\n    if (query.length < 2) {\n      return NextResponse.json([]);\n    }\n\n    const existingMembers = await prisma.projectMember.findMany({\n      where: { projectId: excludeProjectId },\n      select: { userId: true },\n    });\n    const excludeUserIds = existingMembers.map((m) => m.userId);\n\n    const users = await prisma.user.findMany({\n      where: {\n        status: \"ACTIVE\",\n        id: {\n          notIn: excludeUserIds,\n        },\n        OR: [\n          { firstName: { contains: query, mode: \"insensitive\" } },\n          { lastName: { contains: query, mode: \"insensitive\" } },\n          { email: { contains: query, mode: \"insensitive\" } },\n          { company: { contains: query, mode: \"insensitive\" } },\n        ],\n      },\n      select: {\n        id: true,\n        firstName: true,\n        lastName: true,\n        email: true,\n        company: true,\n        title: true,\n      },\n      take: 10,\n    });\n\n    return NextResponse.json(users);\n  } catch (error) {\n    console.error(\"Error searching users:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2261,"size_tokens":null},"src/components/pages/project/member-invite.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useRef } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { UserPlus, Search, X, Check } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\ninterface User {\n  id: string;\n  firstName: string;\n  lastName: string;\n  email: string;\n  company: string | null;\n  title: string | null;\n}\n\ninterface MemberInviteProps {\n  projectId: string;\n}\n\nexport function MemberInvite({ projectId }: MemberInviteProps) {\n  const router = useRouter();\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [searchResults, setSearchResults] = useState<User[]>([]);\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\n  const [selectedRole, setSelectedRole] = useState(\"USER\");\n  const [loading, setLoading] = useState(false);\n  const [searching, setSearching] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const searchTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    if (searchTimeoutRef.current) {\n      clearTimeout(searchTimeoutRef.current);\n    }\n\n    if (searchQuery.length < 2) {\n      setSearchResults([]);\n      return;\n    }\n\n    setSearching(true);\n    searchTimeoutRef.current = setTimeout(async () => {\n      try {\n        const res = await fetch(\n          `/api/users/search?q=${encodeURIComponent(searchQuery)}&excludeProject=${projectId}`\n        );\n        if (res.ok) {\n          const users = await res.json();\n          setSearchResults(users);\n        }\n      } catch (err) {\n        console.error(err);\n      } finally {\n        setSearching(false);\n      }\n    }, 300);\n\n    return () => {\n      if (searchTimeoutRef.current) {\n        clearTimeout(searchTimeoutRef.current);\n      }\n    };\n  }, [searchQuery, projectId]);\n\n  async function handleInvite() {\n    if (!selectedUser) return;\n\n    setLoading(true);\n    setError(null);\n\n    try {\n      const res = await fetch(`/api/projects/${projectId}/members`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          userId: selectedUser.id,\n          role: selectedRole,\n        }),\n      });\n\n      if (res.ok) {\n        setDialogOpen(false);\n        setSearchQuery(\"\");\n        setSelectedUser(null);\n        setSelectedRole(\"USER\");\n        setSearchResults([]);\n        router.refresh();\n      } else {\n        const data = await res.json();\n        setError(data.error || \"Kunne ikke legge til medlem\");\n      }\n    } catch (err) {\n      console.error(err);\n      setError(\"Noe gikk galt\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  function handleOpenChange(open: boolean) {\n    setDialogOpen(open);\n    if (!open) {\n      setSearchQuery(\"\");\n      setSelectedUser(null);\n      setSelectedRole(\"USER\");\n      setSearchResults([]);\n      setError(null);\n    }\n  }\n\n  return (\n    <Dialog open={dialogOpen} onOpenChange={handleOpenChange}>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\" size=\"sm\">\n          <UserPlus size={14} className=\"mr-1\" />\n          Inviter\n        </Button>\n      </DialogTrigger>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Inviter medlem til prosjekt</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4\">\n          {!selectedUser ? (\n            <>\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" size={16} />\n                <Input\n                  type=\"search\"\n                  placeholder=\"S√∏k etter navn, e-post eller firma...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  autoFocus\n                />\n              </div>\n\n              {searching && (\n                <p className=\"text-sm text-muted-foreground\">S√∏ker...</p>\n              )}\n\n              {searchResults.length > 0 && (\n                <div className=\"max-h-60 space-y-2 overflow-y-auto\">\n                  {searchResults.map((user) => (\n                    <button\n                      key={user.id}\n                      type=\"button\"\n                      className=\"flex w-full items-center gap-3 rounded-lg border border-border p-3 text-left transition-colors hover:border-primary/50 hover:bg-muted/50\"\n                      onClick={() => setSelectedUser(user)}\n                    >\n                      <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-primary/20 text-sm font-medium text-primary\">\n                        {user.firstName[0]}\n                        {user.lastName[0]}\n                      </div>\n                      <div className=\"flex-1 overflow-hidden\">\n                        <p className=\"truncate font-medium text-foreground\">\n                          {user.firstName} {user.lastName}\n                        </p>\n                        <p className=\"truncate text-sm text-muted-foreground\">\n                          {user.email}\n                        </p>\n                        {user.company && (\n                          <p className=\"truncate text-xs text-muted-foreground\">\n                            {user.title ? `${user.title} @ ` : \"\"}{user.company}\n                          </p>\n                        )}\n                      </div>\n                    </button>\n                  ))}\n                </div>\n              )}\n\n              {searchQuery.length >= 2 && !searching && searchResults.length === 0 && (\n                <p className=\"py-4 text-center text-sm text-muted-foreground\">\n                  Ingen brukere funnet\n                </p>\n              )}\n\n              {searchQuery.length < 2 && (\n                <p className=\"py-4 text-center text-sm text-muted-foreground\">\n                  Skriv minst 2 tegn for √• s√∏ke\n                </p>\n              )}\n            </>\n          ) : (\n            <>\n              <div className=\"flex items-center gap-3 rounded-lg border border-primary/50 bg-primary/5 p-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-primary/20 text-sm font-medium text-primary\">\n                  {selectedUser.firstName[0]}\n                  {selectedUser.lastName[0]}\n                </div>\n                <div className=\"flex-1 overflow-hidden\">\n                  <p className=\"truncate font-medium text-foreground\">\n                    {selectedUser.firstName} {selectedUser.lastName}\n                  </p>\n                  <p className=\"truncate text-sm text-muted-foreground\">\n                    {selectedUser.email}\n                  </p>\n                </div>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setSelectedUser(null)}\n                >\n                  <X size={14} />\n                </Button>\n              </div>\n\n              <div>\n                <label className=\"mb-2 block text-sm font-medium text-foreground\">\n                  Rolle i prosjektet\n                </label>\n                <Select value={selectedRole} onValueChange={setSelectedRole}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"PROJECT_LEADER\">Prosjektleder</SelectItem>\n                    <SelectItem value=\"USER\">Bruker</SelectItem>\n                    <SelectItem value=\"READER\">Leser</SelectItem>\n                  </SelectContent>\n                </Select>\n                <p className=\"mt-1 text-xs text-muted-foreground\">\n                  {selectedRole === \"PROJECT_LEADER\" && \"Kan redigere prosjekt og invitere medlemmer\"}\n                  {selectedRole === \"USER\" && \"Kan endre status og kommentere\"}\n                  {selectedRole === \"READER\" && \"Kun lesetilgang\"}\n                </p>\n              </div>\n\n              {error && (\n                <p className=\"text-sm text-destructive\">{error}</p>\n              )}\n\n              <div className=\"flex justify-end gap-2\">\n                <Button variant=\"ghost\" onClick={() => handleOpenChange(false)}>\n                  Avbryt\n                </Button>\n                <Button onClick={handleInvite} loading={loading}>\n                  <Check size={14} className=\"mr-1\" />\n                  Legg til medlem\n                </Button>\n              </div>\n            </>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":8912,"size_tokens":null},"src/components/providers/theme-provider.tsx":{"content":"\"use client\";\n\nimport * as React from \"react\";\nimport { ThemeProvider as NextThemesProvider } from \"next-themes\";\n\nexport function ThemeProvider({\n  children,\n  ...props\n}: React.ComponentProps<typeof NextThemesProvider>) {\n  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;\n}\n","path":null,"size_bytes":299,"size_tokens":null},"src/app/api/notifications/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { searchParams } = new URL(request.url);\n    const unreadOnly = searchParams.get(\"unread\") === \"true\";\n    const limit = parseInt(searchParams.get(\"limit\") || \"20\");\n\n    const notifications = await prisma.notification.findMany({\n      where: {\n        userId: authResult.user.id,\n        ...(unreadOnly ? { read: false } : {}),\n      },\n      include: {\n        comment: {\n          select: {\n            id: true,\n            content: true,\n            author: {\n              select: {\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n        annotation: {\n          select: {\n            id: true,\n            document: {\n              select: {\n                id: true,\n                title: true,\n                projectId: true,\n              },\n            },\n          },\n        },\n        systemAnnotation: {\n          select: {\n            id: true,\n            document: {\n              select: {\n                id: true,\n                title: true,\n                projectId: true,\n              },\n            },\n          },\n        },\n      },\n      orderBy: { createdAt: \"desc\" },\n      take: limit,\n    });\n\n    const unreadCount = await prisma.notification.count({\n      where: {\n        userId: authResult.user.id,\n        read: false,\n      },\n    });\n\n    const formattedNotifications = notifications.map((n) => ({\n      id: n.id,\n      type: n.type,\n      read: n.read,\n      createdAt: n.createdAt.toISOString(),\n      metadata: n.metadata,\n      comment: n.comment\n        ? {\n            id: n.comment.id,\n            content: n.comment.content,\n            author: n.comment.author,\n          }\n        : null,\n      annotation: n.annotation\n        ? {\n            id: n.annotation.id,\n            document: n.annotation.document,\n          }\n        : n.systemAnnotation\n        ? {\n            id: n.systemAnnotation.id,\n            document: n.systemAnnotation.document,\n          }\n        : null,\n    }));\n\n    return NextResponse.json({\n      notifications: formattedNotifications,\n      unreadCount,\n    });\n  } catch (error) {\n    console.error(\"Error fetching notifications:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(request: NextRequest) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const body = await request.json();\n    const { notificationId, markAllRead } = body;\n\n    if (markAllRead) {\n      await prisma.notification.updateMany({\n        where: {\n          userId: authResult.user.id,\n          read: false,\n        },\n        data: { read: true },\n      });\n      return NextResponse.json({ success: true });\n    }\n\n    if (!notificationId) {\n      return NextResponse.json({ error: \"Mangler varsel-ID\" }, { status: 400 });\n    }\n\n    const notification = await prisma.notification.findUnique({\n      where: { id: notificationId },\n    });\n\n    if (!notification) {\n      return NextResponse.json({ error: \"Varsel ikke funnet\" }, { status: 404 });\n    }\n\n    if (notification.userId !== authResult.user.id) {\n      return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    await prisma.notification.update({\n      where: { id: notificationId },\n      data: { read: true },\n    });\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error(\"Error updating notification:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":3961,"size_tokens":null},"src/components/pages/project/protocols-content.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  ClipboardCheck,\n  Plus,\n  Search,\n  FileDown,\n  Building2,\n  Cpu,\n  MapPin,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\ninterface MassListItem {\n  id: string;\n  tfm?: string | null;\n  building?: string | null;\n  system?: string | null;\n  component?: string | null;\n  typeCode?: string | null;\n  productName?: string | null;\n  location?: string | null;\n  zone?: string | null;\n  createdAt: Date;\n}\n\ninterface ProtocolsContentProps {\n  project: { id: string; name: string };\n  massListItems: MassListItem[];\n  canCreate: boolean;\n}\n\nexport function ProtocolsContent({\n  project,\n  massListItems,\n  canCreate,\n}: ProtocolsContentProps) {\n  const [search, setSearch] = useState(\"\");\n  const [systemFilter, setSystemFilter] = useState<string>(\"all\");\n  const [selectedItems, setSelectedItems] = useState<Set<string>>(new Set());\n\n  const systems = [...new Set(massListItems.map((item) => item.system).filter(Boolean))];\n\n  const filteredItems = massListItems.filter((item) => {\n    const matchesSearch =\n      !search ||\n      item.tfm?.toLowerCase().includes(search.toLowerCase()) ||\n      item.productName?.toLowerCase().includes(search.toLowerCase()) ||\n      item.location?.toLowerCase().includes(search.toLowerCase());\n\n    const matchesSystem =\n      systemFilter === \"all\" || item.system === systemFilter;\n\n    return matchesSearch && matchesSystem;\n  });\n\n  function toggleItem(id: string) {\n    const newSelected = new Set(selectedItems);\n    if (newSelected.has(id)) {\n      newSelected.delete(id);\n    } else {\n      newSelected.add(id);\n    }\n    setSelectedItems(newSelected);\n  }\n\n  function selectAll() {\n    if (selectedItems.size === filteredItems.length) {\n      setSelectedItems(new Set());\n    } else {\n      setSelectedItems(new Set(filteredItems.map((item) => item.id)));\n    }\n  }\n\n  async function generateProtocol() {\n    if (selectedItems.size === 0) return;\n\n    try {\n      const res = await fetch(`/api/projects/${project.id}/protocols`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          massListItemIds: Array.from(selectedItems),\n        }),\n      });\n\n      if (res.ok) {\n        const blob = await res.blob();\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement(\"a\");\n        a.href = url;\n        a.download = `protokoll-${format(new Date(), \"yyyy-MM-dd\")}.pdf`;\n        a.click();\n        URL.revokeObjectURL(url);\n        setSelectedItems(new Set());\n      }\n    } catch (err) {\n      console.error(err);\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\">Protokoller MC</h1>\n          <p className=\"text-muted-foreground\">\n            Generer mekanisk komplettering protokoller fra masselisten\n          </p>\n        </div>\n        {canCreate && selectedItems.size > 0 && (\n          <Button onClick={generateProtocol}>\n            <FileDown size={16} className=\"mr-2\" />\n            Generer protokoll ({selectedItems.size})\n          </Button>\n        )}\n      </div>\n\n      <div className=\"flex flex-col gap-4 sm:flex-row\">\n        <div className=\"relative flex-1\">\n          <Search\n            size={16}\n            className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\"\n          />\n          <Input\n            placeholder=\"S√∏k etter TFM, produkt eller plassering...\"\n            value={search}\n            onChange={(e) => setSearch(e.target.value)}\n            className=\"pl-9\"\n          />\n        </div>\n        <Select value={systemFilter} onValueChange={setSystemFilter}>\n          <SelectTrigger className=\"w-full sm:w-48\">\n            <SelectValue placeholder=\"Alle systemer\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Alle systemer</SelectItem>\n            {systems.map((sys) => (\n              <SelectItem key={sys} value={sys!}>\n                {sys}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {filteredItems.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <ClipboardCheck size={48} className=\"mb-4 text-muted-foreground/50\" />\n            <h3 className=\"text-lg font-medium text-foreground\">\n              Ingen komponenter\n            </h3>\n            <p className=\"mt-1 text-sm text-muted-foreground\">\n              {search || systemFilter !== \"all\"\n                ? \"Ingen komponenter matcher filteret\"\n                : \"Importer masseliste for √• generere protokoller\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <>\n          <div className=\"flex items-center justify-between rounded-lg border border-border bg-card p-3\">\n            <label className=\"flex cursor-pointer items-center gap-2\">\n              <input\n                type=\"checkbox\"\n                checked={selectedItems.size === filteredItems.length}\n                onChange={selectAll}\n                className=\"h-4 w-4 rounded border-border\"\n              />\n              <span className=\"text-sm text-muted-foreground\">\n                Velg alle ({filteredItems.length})\n              </span>\n            </label>\n            {selectedItems.size > 0 && (\n              <span className=\"text-sm text-primary\">\n                {selectedItems.size} valgt\n              </span>\n            )}\n          </div>\n\n          <div className=\"grid gap-3\">\n            {filteredItems.map((item) => (\n              <Card\n                key={item.id}\n                className={`cursor-pointer transition-colors ${\n                  selectedItems.has(item.id)\n                    ? \"border-primary bg-primary/5\"\n                    : \"hover:border-primary/50\"\n                }`}\n                onClick={() => toggleItem(item.id)}\n              >\n                <CardContent className=\"flex items-center gap-4 p-4\">\n                  <input\n                    type=\"checkbox\"\n                    checked={selectedItems.has(item.id)}\n                    onChange={() => toggleItem(item.id)}\n                    onClick={(e) => e.stopPropagation()}\n                    className=\"h-4 w-4 rounded border-border\"\n                  />\n                  <div className=\"flex-1 space-y-1\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"font-mono text-sm font-medium text-foreground\">\n                        {item.tfm || \"‚Äî\"}\n                      </span>\n                      {item.system && (\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          <Cpu size={10} className=\"mr-1\" />\n                          {item.system}\n                        </Badge>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {item.productName || \"Ukjent produkt\"}\n                    </p>\n                    <div className=\"flex flex-wrap gap-3 text-xs text-muted-foreground\">\n                      {item.building && (\n                        <span className=\"flex items-center gap-1\">\n                          <Building2 size={12} />\n                          Bygg {item.building}\n                        </span>\n                      )}\n                      {item.location && (\n                        <span className=\"flex items-center gap-1\">\n                          <MapPin size={12} />\n                          {item.location}\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":8318,"size_tokens":null},"src/app/api/system-tags/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport { Role } from \"@prisma/client\";\n\nexport async function GET() {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const tags = await prisma.systemTag.findMany({\n      orderBy: { code: \"asc\" },\n    });\n\n    return NextResponse.json(tags);\n  } catch (error) {\n    console.error(\"Error fetching system tags:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    if (authResult.user.role !== Role.ADMIN && authResult.user.role !== Role.PROJECT_LEADER) {\n      return NextResponse.json(\n        { error: \"Kun admins og prosjektledere kan opprette systemkoder\" },\n        { status: 403 }\n      );\n    }\n\n    const body = await request.json();\n    const { code, description } = body;\n\n    if (!code || typeof code !== \"string\") {\n      return NextResponse.json(\n        { error: \"Systemkode er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    const existingTag = await prisma.systemTag.findUnique({\n      where: { code: code.toUpperCase() },\n    });\n\n    if (existingTag) {\n      return NextResponse.json(\n        { error: \"Systemkoden eksisterer allerede\" },\n        { status: 409 }\n      );\n    }\n\n    const tag = await prisma.systemTag.create({\n      data: {\n        code: code.toUpperCase(),\n        description: description || null,\n      },\n    });\n\n    return NextResponse.json(tag, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating system tag:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":1943,"size_tokens":null},"src/components/pages/project/drawings-content.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  FileText,\n  Upload,\n  Search,\n  AlertCircle,\n  CheckCircle2,\n  Eye,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface Document {\n  id: string;\n  title: string;\n  url: string;\n  createdAt: Date;\n  annotations: {\n    id: string;\n    status: string;\n    author: { firstName: string; lastName: string };\n  }[];\n}\n\ninterface DrawingsContentProps {\n  project: { id: string; name: string };\n  documents: Document[];\n  canUpload: boolean;\n}\n\nexport function DrawingsContent({\n  project,\n  documents,\n  canUpload,\n}: DrawingsContentProps) {\n  const [search, setSearch] = useState(\"\");\n  const [uploading, setUploading] = useState(false);\n\n  const filteredDocuments = documents.filter((doc) =>\n    doc.title.toLowerCase().includes(search.toLowerCase())\n  );\n\n  async function handleUpload(e: React.ChangeEvent<HTMLInputElement>) {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    setUploading(true);\n    try {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      formData.append(\"title\", file.name.replace(/\\.[^/.]+$/, \"\"));\n      formData.append(\"type\", \"DRAWING\");\n\n      const res = await fetch(`/api/projects/${project.id}/documents`, {\n        method: \"POST\",\n        body: formData,\n      });\n\n      if (res.ok) {\n        window.location.reload();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setUploading(false);\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\">Arbeidstegninger</h1>\n          <p className=\"text-muted-foreground\">\n            Administrer og se p√• arbeidstegninger for prosjektet\n          </p>\n        </div>\n        {canUpload && (\n          <>\n            <input\n              type=\"file\"\n              id=\"drawing-upload\"\n              accept=\".pdf\"\n              className=\"hidden\"\n              onChange={handleUpload}\n              disabled={uploading}\n            />\n            <Button\n              type=\"button\"\n              disabled={uploading}\n              onClick={() => document.getElementById(\"drawing-upload\")?.click()}\n            >\n              <Upload size={16} className=\"mr-2\" />\n              {uploading ? \"Laster opp...\" : \"Last opp tegning\"}\n            </Button>\n          </>\n        )}\n      </div>\n\n      <div className=\"relative\">\n        <Search\n          size={16}\n          className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\"\n        />\n        <Input\n          placeholder=\"S√∏k i tegninger...\"\n          value={search}\n          onChange={(e) => setSearch(e.target.value)}\n          className=\"pl-9\"\n        />\n      </div>\n\n      {filteredDocuments.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <FileText size={48} className=\"mb-4 text-muted-foreground/50\" />\n            <h3 className=\"text-lg font-medium text-foreground\">\n              Ingen tegninger\n            </h3>\n            <p className=\"mt-1 text-sm text-muted-foreground\">\n              {search\n                ? \"Ingen tegninger matcher s√∏ket\"\n                : \"Last opp arbeidstegninger for √• komme i gang\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {filteredDocuments.map((doc) => {\n            const openIssues = doc.annotations.filter(\n              (a) => a.status === \"OPEN\"\n            ).length;\n            const closedIssues = doc.annotations.filter(\n              (a) => a.status === \"CLOSED\"\n            ).length;\n\n            return (\n              <Card key={doc.id} className=\"group hover:border-primary/50\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between\">\n                    <CardTitle className=\"text-base line-clamp-2\">\n                      {doc.title}\n                    </CardTitle>\n                    <Link href={`/projects/${project.id}/documents/${doc.id}`}>\n                      <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\">\n                        <Eye size={16} />\n                      </Button>\n                    </Link>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <span>\n                      Lastet opp{\" \"}\n                      {format(new Date(doc.createdAt), \"d. MMM yyyy\", {\n                        locale: nb,\n                      })}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    {openIssues > 0 && (\n                      <Badge variant=\"destructive\" className=\"gap-1\">\n                        <AlertCircle size={12} />\n                        {openIssues} √•pne\n                      </Badge>\n                    )}\n                    {closedIssues > 0 && (\n                      <Badge variant=\"secondary\" className=\"gap-1\">\n                        <CheckCircle2 size={12} />\n                        {closedIssues} lukket\n                      </Badge>\n                    )}\n                    {openIssues === 0 && closedIssues === 0 && (\n                      <span className=\"text-xs text-muted-foreground\">\n                        Ingen avvik\n                      </span>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":6067,"size_tokens":null},"src/app/(app)/projects/[projectId]/drawings/page.tsx":{"content":"import { redirect } from \"next/navigation\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\nimport prisma from \"@/lib/db\";\nimport { DrawingsContent } from \"@/components/pages/project/drawings-content\";\nimport { Role } from \"@prisma/client\";\n\ninterface DrawingsPageProps {\n  params: Promise<{ projectId: string }>;\n}\n\nexport default async function DrawingsPage({ params }: DrawingsPageProps) {\n  const { projectId } = await params;\n  const session = await getServerSession(authOptions);\n\n  if (!session?.user?.id) {\n    redirect(\"/login\");\n  }\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    include: {\n      documents: {\n        where: { type: \"DRAWING\" },\n        orderBy: { createdAt: \"desc\" },\n        include: {\n          annotations: {\n            include: {\n              author: {\n                select: { firstName: true, lastName: true },\n              },\n            },\n          },\n        },\n      },\n      members: {\n        where: { userId: session.user.id },\n      },\n    },\n  });\n\n  if (!project) {\n    redirect(\"/dashboard\");\n  }\n\n  const isAdmin = session.user.role === Role.ADMIN;\n  const isMember = project.members.length > 0;\n\n  if (!isAdmin && !isMember) {\n    redirect(\"/dashboard\");\n  }\n\n  const canUpload =\n    isAdmin || project.members.some((m) => m.role !== \"READER\");\n\n  return (\n    <DrawingsContent\n      project={project}\n      documents={project.documents}\n      canUpload={canUpload}\n    />\n  );\n}\n","path":null,"size_bytes":1512,"size_tokens":null},"src/app/(app)/projects/[projectId]/layout.tsx":{"content":"import { AppShell } from \"@/components/layout/app-shell\";\nimport { ProjectSidebar } from \"@/components/pages/project/project-sidebar\";\nimport prisma from \"@/lib/db\";\nimport { authOptions } from \"@/lib/auth\";\nimport { getServerSession } from \"next-auth\";\nimport { redirect } from \"next/navigation\";\nimport { Role, UserStatus } from \"@prisma/client\";\n\ninterface ProjectLayoutProps {\n  children: React.ReactNode;\n  params: Promise<{ projectId: string }>;\n}\n\nexport default async function ProjectLayout({ children, params }: ProjectLayoutProps) {\n  const session = await getServerSession(authOptions);\n  if (!session?.user?.email) redirect(\"/login\");\n  if (session.user.status === UserStatus.PENDING) redirect(\"/pending\");\n\n  const user = await prisma.user.findUnique({ where: { email: session.user.email } });\n  if (!user) redirect(\"/login\");\n\n  const { projectId } = await params;\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    include: {\n      members: { select: { userId: true, role: true, user: { select: { firstName: true, lastName: true } } } },\n      documents: { select: { id: true } },\n      massList: { select: { id: true } },\n    },\n  });\n\n  if (!project) redirect(\"/dashboard\");\n\n  const isMember = project.members.some((m) => m.userId === user.id) || user.role === Role.ADMIN;\n  if (!isMember) redirect(\"/dashboard\");\n\n  return (\n    <AppShell sidebar={<ProjectSidebar project={project} />}>\n      {children}\n    </AppShell>\n  );\n}\n","path":null,"size_bytes":1482,"size_tokens":null},"src/app/api/documents/[documentId]/annotations/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth, canAnnotateDocuments } from \"@/lib/auth-helpers\";\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ documentId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { documentId } = await params;\n\n    const document = await prisma.document.findUnique({\n      where: { id: documentId },\n      include: { project: true },\n    });\n\n    if (!document) {\n      return NextResponse.json({ error: \"Dokument ikke funnet\" }, { status: 404 });\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n      where: {\n        projectId: document.projectId,\n        userId: authResult.user.id,\n      },\n    });\n\n    if (!membership && authResult.user.role !== \"ADMIN\") {\n      return NextResponse.json({ error: \"Ingen tilgang til dette prosjektet\" }, { status: 403 });\n    }\n\n    if (!canAnnotateDocuments(authResult.user.role, membership?.role)) {\n      return NextResponse.json({ error: \"Ingen tilgang til √• opprette annoteringer\" }, { status: 403 });\n    }\n\n    const body = await request.json();\n    const { x, y, pageNumber, content } = body;\n\n    if (typeof x !== \"number\" || typeof y !== \"number\" || typeof pageNumber !== \"number\") {\n      return NextResponse.json({ error: \"Mangler posisjon eller sidenummer\" }, { status: 400 });\n    }\n\n    const annotation = await prisma.annotation.create({\n      data: {\n        documentId,\n        authorId: authResult.user.id,\n        x,\n        y,\n        status: \"OPEN\",\n      },\n      include: {\n        author: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n          },\n        },\n        comments: {\n          include: {\n            author: {\n              select: {\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    if (content && typeof content === \"string\" && content.trim()) {\n      await prisma.comment.create({\n        data: {\n          content: content.trim(),\n          annotationId: annotation.id,\n          authorId: authResult.user.id,\n          projectId: document.projectId,\n        },\n      });\n    }\n\n    const fullAnnotation = await prisma.annotation.findUnique({\n      where: { id: annotation.id },\n      include: {\n        author: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n          },\n        },\n        comments: {\n          include: {\n            author: {\n              select: {\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n          orderBy: { createdAt: \"asc\" },\n        },\n      },\n    });\n\n    return NextResponse.json({\n      ...fullAnnotation,\n      pageNumber,\n    }, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating annotation:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ documentId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const body = await request.json();\n    const { annotationId, status } = body;\n\n    if (!annotationId || !status) {\n      return NextResponse.json({ error: \"Mangler annotasjon-ID eller status\" }, { status: 400 });\n    }\n\n    const validStatuses = [\"OPEN\", \"CLOSED\"];\n    if (!validStatuses.includes(status)) {\n      return NextResponse.json({ error: \"Ugyldig status\" }, { status: 400 });\n    }\n\n    const annotation = await prisma.annotation.findUnique({\n      where: { id: annotationId },\n      include: { document: true },\n    });\n\n    if (!annotation) {\n      return NextResponse.json({ error: \"Annotasjon ikke funnet\" }, { status: 404 });\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n      where: {\n        projectId: annotation.document.projectId,\n        userId: authResult.user.id,\n      },\n    });\n\n    if (!membership && authResult.user.role !== \"ADMIN\") {\n      return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    if (!canAnnotateDocuments(authResult.user.role, membership?.role)) {\n      return NextResponse.json({ error: \"Ingen tilgang til √• oppdatere annotasjoner\" }, { status: 403 });\n    }\n\n    const updatedAnnotation = await prisma.annotation.update({\n      where: { id: annotationId },\n      data: { status },\n    });\n\n    return NextResponse.json(updatedAnnotation);\n  } catch (error) {\n    console.error(\"Error updating annotation:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4969,"size_tokens":null},"src/app/(app)/projects/[projectId]/progress/page.tsx":{"content":"import { redirect } from \"next/navigation\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\nimport prisma from \"@/lib/db\";\nimport { ProgressContent } from \"@/components/pages/project/progress-content\";\nimport { Role } from \"@prisma/client\";\n\ninterface ProgressPageProps {\n  params: Promise<{ projectId: string }>;\n}\n\nexport default async function ProgressPage({ params }: ProgressPageProps) {\n  const { projectId } = await params;\n  const session = await getServerSession(authOptions);\n\n  if (!session?.user?.id) {\n    redirect(\"/login\");\n  }\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    include: {\n      documents: {\n        include: {\n          annotations: true,\n          systemAnnotations: true,\n        },\n      },\n      massList: true,\n      members: {\n        where: { userId: session.user.id },\n        include: {\n          user: {\n            select: { firstName: true, lastName: true },\n          },\n        },\n      },\n    },\n  });\n\n  if (!project) {\n    redirect(\"/dashboard\");\n  }\n\n  const isAdmin = session.user.role === Role.ADMIN;\n  const isMember = project.members.length > 0;\n\n  if (!isAdmin && !isMember) {\n    redirect(\"/dashboard\");\n  }\n\n  const totalAnnotations = project.documents.reduce(\n    (acc, doc) => acc + doc.annotations.length,\n    0\n  );\n\n  const closedAnnotations = project.documents.reduce(\n    (acc, doc) => acc + doc.annotations.filter((a) => a.status === \"CLOSED\").length,\n    0\n  );\n\n  const totalSystemBoxed = project.documents.reduce(\n    (acc, doc) => acc + doc.systemAnnotations.length,\n    0\n  );\n\n  const stats = {\n    totalDocuments: project.documents.length,\n    totalMassListItems: project.massList.length,\n    totalAnnotations,\n    closedAnnotations,\n    openAnnotations: totalAnnotations - closedAnnotations,\n    totalSystemBoxed,\n    completionRate:\n      totalAnnotations > 0\n        ? Math.round((closedAnnotations / totalAnnotations) * 100)\n        : 0,\n  };\n\n  return <ProgressContent project={project} stats={stats} />;\n}\n","path":null,"size_bytes":2061,"size_tokens":null},"src/components/layout/notification-dropdown.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useRef } from \"react\";\nimport Link from \"next/link\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport { Bell, Check, CheckCheck, CheckSquare, MessageSquare } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\n\ninterface Notification {\n  id: string;\n  type: string;\n  read: boolean;\n  createdAt: string;\n  metadata?: Record<string, unknown>;\n  comment?: {\n    id: string;\n    content: string;\n    author: { firstName: string; lastName: string };\n  } | null;\n  annotation?: {\n    id: string;\n    document: { id: string; title: string; projectId: string };\n  } | null;\n}\n\nexport function NotificationDropdown() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [notifications, setNotifications] = useState<Notification[]>([]);\n  const [unreadCount, setUnreadCount] = useState(0);\n  const [loading, setLoading] = useState(false);\n  const dropdownRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    fetchNotifications();\n    const interval = setInterval(fetchNotifications, 60000);\n    return () => clearInterval(interval);\n  }, []);\n\n  useEffect(() => {\n    function handleClickOutside(event: MouseEvent) {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n      }\n    }\n\n    if (isOpen) {\n      document.addEventListener(\"mousedown\", handleClickOutside);\n    }\n\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n    };\n  }, [isOpen]);\n\n  async function fetchNotifications() {\n    try {\n      const res = await fetch(\"/api/notifications?limit=10\");\n      if (res.ok) {\n        const data = await res.json();\n        setNotifications(data.notifications || []);\n        setUnreadCount(data.unreadCount || 0);\n      }\n    } catch (err) {\n      console.error(err);\n    }\n  }\n\n  async function handleMarkAsRead(notificationId: string) {\n    try {\n      const res = await fetch(\"/api/notifications\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ notificationId }),\n      });\n      if (res.ok) {\n        setNotifications((prev) =>\n          prev.map((n) => (n.id === notificationId ? { ...n, read: true } : n))\n        );\n        setUnreadCount((prev) => Math.max(0, prev - 1));\n      }\n    } catch (err) {\n      console.error(err);\n    }\n  }\n\n  async function handleMarkAllRead() {\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/notifications\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ markAllRead: true }),\n      });\n      if (res.ok) {\n        setNotifications((prev) => prev.map((n) => ({ ...n, read: true })));\n        setUnreadCount(0);\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  function getNotificationContent(notification: Notification) {\n    if (notification.type === \"mention\" && notification.comment) {\n      const author = notification.comment.author;\n      const docTitle = notification.annotation?.document?.title || \"dokument\";\n      return {\n        icon: MessageSquare,\n        text: `${author.firstName} ${author.lastName} nevnte deg i \"${docTitle}\"`,\n        link: notification.annotation?.document\n          ? `/projects/${notification.annotation.document.projectId}/documents/${notification.annotation.document.id}`\n          : null,\n      };\n    }\n\n    if (notification.type === \"chat_mention\" && notification.metadata) {\n      const meta = notification.metadata as {\n        senderName?: string;\n        roomName?: string;\n        projectId?: string;\n        messagePreview?: string;\n      };\n      return {\n        icon: MessageSquare,\n        text: `${meta.senderName || \"Noen\"} nevnte deg i #${meta.roomName || \"chat\"}`,\n        link: meta.projectId ? `/pratlink/${meta.projectId}` : null,\n      };\n    }\n\n    if (notification.type === \"task_assigned\" && notification.metadata) {\n      const meta = notification.metadata as {\n        taskTitle?: string;\n        projectName?: string;\n        projectId?: string;\n        assignerName?: string;\n      };\n      return {\n        icon: CheckSquare,\n        text: `${meta.assignerName || \"Noen\"} tildelte deg en oppgave: \"${meta.taskTitle || \"Oppgave\"}\"`,\n        link: meta.projectId ? `/pratlink/${meta.projectId}?tab=tasks` : null,\n      };\n    }\n\n    return {\n      icon: Bell,\n      text: \"Ny varsling\",\n      link: null,\n    };\n  }\n\n  return (\n    <div className=\"relative\" ref={dropdownRef}>\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"relative h-9 w-9 p-0\"\n        onClick={() => setIsOpen(!isOpen)}\n        title=\"Varsler\"\n      >\n        <Bell size={18} />\n        {unreadCount > 0 && (\n          <span className=\"absolute -right-1 -top-1 flex h-5 w-5 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-white\">\n            {unreadCount > 9 ? \"9+\" : unreadCount}\n          </span>\n        )}\n      </Button>\n\n      {isOpen && (\n        <div className=\"absolute right-0 top-full z-50 mt-2 w-80 overflow-hidden rounded-xl border border-border bg-card shadow-lg\">\n          <div className=\"flex items-center justify-between border-b border-border px-4 py-3\">\n            <h3 className=\"font-semibold text-foreground\">Varsler</h3>\n            {unreadCount > 0 && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"h-8 text-xs\"\n                onClick={handleMarkAllRead}\n                disabled={loading}\n              >\n                <CheckCheck size={14} className=\"mr-1\" />\n                Marker alle som lest\n              </Button>\n            )}\n          </div>\n\n          <div className=\"max-h-96 overflow-y-auto\">\n            {notifications.length === 0 ? (\n              <div className=\"py-8 text-center text-sm text-muted-foreground\">\n                <Bell className=\"mx-auto mb-2 opacity-50\" size={24} />\n                Ingen varsler enda\n              </div>\n            ) : (\n              notifications.map((notification) => {\n                const { icon: Icon, text, link } = getNotificationContent(notification);\n                const content = (\n                  <div\n                    className={cn(\n                      \"flex gap-3 px-4 py-3 transition-colors hover:bg-muted/50\",\n                      !notification.read && \"bg-primary/5\"\n                    )}\n                  >\n                    <div\n                      className={cn(\n                        \"flex h-8 w-8 shrink-0 items-center justify-center rounded-full\",\n                        notification.read ? \"bg-muted\" : \"bg-primary/20\"\n                      )}\n                    >\n                      <Icon\n                        size={14}\n                        className={notification.read ? \"text-muted-foreground\" : \"text-primary\"}\n                      />\n                    </div>\n                    <div className=\"min-w-0 flex-1\">\n                      <p\n                        className={cn(\n                          \"text-sm\",\n                          notification.read ? \"text-muted-foreground\" : \"text-foreground\"\n                        )}\n                      >\n                        {text}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {format(new Date(notification.createdAt), \"d. MMM HH:mm\", {\n                          locale: nb,\n                        })}\n                      </p>\n                    </div>\n                    {!notification.read && (\n                      <button\n                        type=\"button\"\n                        className=\"shrink-0 rounded p-1 text-muted-foreground hover:bg-muted hover:text-foreground\"\n                        onClick={(e) => {\n                          e.preventDefault();\n                          e.stopPropagation();\n                          handleMarkAsRead(notification.id);\n                        }}\n                        title=\"Marker som lest\"\n                      >\n                        <Check size={14} />\n                      </button>\n                    )}\n                  </div>\n                );\n\n                if (link) {\n                  return (\n                    <Link\n                      key={notification.id}\n                      href={link}\n                      onClick={() => {\n                        if (!notification.read) {\n                          handleMarkAsRead(notification.id);\n                        }\n                        setIsOpen(false);\n                      }}\n                    >\n                      {content}\n                    </Link>\n                  );\n                }\n\n                return <div key={notification.id}>{content}</div>;\n              })\n            )}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9028,"size_tokens":null},"src/app/(app)/projects/[projectId]/protocols/page.tsx":{"content":"import { redirect } from \"next/navigation\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\nimport prisma from \"@/lib/db\";\nimport { ProtocolsContent } from \"@/components/pages/project/protocols-content\";\nimport { Role } from \"@prisma/client\";\n\ninterface ProtocolsPageProps {\n  params: Promise<{ projectId: string }>;\n}\n\nexport default async function ProtocolsPage({ params }: ProtocolsPageProps) {\n  const { projectId } = await params;\n  const session = await getServerSession(authOptions);\n\n  if (!session?.user?.id) {\n    redirect(\"/login\");\n  }\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    include: {\n      massList: {\n        orderBy: { createdAt: \"desc\" },\n      },\n      members: {\n        where: { userId: session.user.id },\n      },\n    },\n  });\n\n  if (!project) {\n    redirect(\"/dashboard\");\n  }\n\n  const isAdmin = session.user.role === Role.ADMIN;\n  const isMember = project.members.length > 0;\n\n  if (!isAdmin && !isMember) {\n    redirect(\"/dashboard\");\n  }\n\n  const canCreate =\n    isAdmin || project.members.some((m) => m.role !== \"READER\");\n\n  return (\n    <ProtocolsContent\n      project={project}\n      massListItems={project.massList}\n      canCreate={canCreate}\n    />\n  );\n}\n","path":null,"size_bytes":1276,"size_tokens":null},"src/components/pages/project/schemas-content.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  Network,\n  Upload,\n  Search,\n  Eye,\n  Tag,\n  CheckCircle2,\n  Plus,\n  X,\n  Filter,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\n\ninterface SystemAnnotation {\n  id: string;\n  systemCode?: string | null;\n  createdBy?: { firstName: string; lastName: string } | null;\n}\n\ninterface SystemTag {\n  id: string;\n  code: string;\n  description?: string | null;\n}\n\ninterface Document {\n  id: string;\n  title: string;\n  url: string;\n  createdAt: Date;\n  systemAnnotations: SystemAnnotation[];\n  tags: { systemTag: SystemTag }[];\n}\n\ninterface SchemasContentProps {\n  project: { id: string; name: string };\n  documents: Document[];\n  systemTags: SystemTag[];\n  canUpload: boolean;\n}\n\nexport function SchemasContent({\n  project,\n  documents,\n  systemTags,\n  canUpload,\n}: SchemasContentProps) {\n  const [search, setSearch] = useState(\"\");\n  const [uploading, setUploading] = useState(false);\n  const [selectedTag, setSelectedTag] = useState<string>(\"all\");\n  const [showTagDialog, setShowTagDialog] = useState(false);\n  const [newTagCode, setNewTagCode] = useState(\"\");\n  const [newTagDescription, setNewTagDescription] = useState(\"\");\n  const [creatingTag, setCreatingTag] = useState(false);\n\n  const allTags = [...new Set(documents.flatMap((doc) => doc.tags.map((t) => t.systemTag.code)))];\n\n  const filteredDocuments = documents.filter((doc) => {\n    const matchesSearch =\n      doc.title.toLowerCase().includes(search.toLowerCase()) ||\n      doc.tags.some((t) =>\n        t.systemTag.code.toLowerCase().includes(search.toLowerCase())\n      );\n\n    const matchesTag =\n      selectedTag === \"all\" ||\n      doc.tags.some((t) => t.systemTag.code === selectedTag);\n\n    return matchesSearch && matchesTag;\n  });\n\n  async function handleUpload(e: React.ChangeEvent<HTMLInputElement>) {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    setUploading(true);\n    try {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      formData.append(\"title\", file.name.replace(/\\.[^/.]+$/, \"\"));\n      formData.append(\"type\", \"SCHEMA\");\n\n      const res = await fetch(`/api/projects/${project.id}/documents`, {\n        method: \"POST\",\n        body: formData,\n      });\n\n      if (res.ok) {\n        window.location.reload();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setUploading(false);\n    }\n  }\n\n  async function handleCreateTag() {\n    if (!newTagCode.trim()) return;\n\n    setCreatingTag(true);\n    try {\n      const res = await fetch(`/api/system-tags`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          code: newTagCode.toUpperCase(),\n          description: newTagDescription || null,\n        }),\n      });\n\n      if (res.ok) {\n        setNewTagCode(\"\");\n        setNewTagDescription(\"\");\n        setShowTagDialog(false);\n        window.location.reload();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setCreatingTag(false);\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\">Systemskjema</h1>\n          <p className=\"text-muted-foreground\">\n            Tekniske skjemaer med systemkoding og boksing\n          </p>\n        </div>\n        <div className=\"flex flex-wrap gap-2\">\n          {canUpload && (\n            <>\n              <Dialog open={showTagDialog} onOpenChange={setShowTagDialog}>\n                <DialogTrigger asChild>\n                  <Button variant=\"outline\" size=\"sm\">\n                    <Tag size={16} className=\"mr-2\" />\n                    Ny systemkode\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>Opprett ny systemkode</DialogTitle>\n                  </DialogHeader>\n                  <div className=\"space-y-4 pt-4\">\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Systemkode</label>\n                      <Input\n                        placeholder=\"F.eks. 360, VVS, EL\"\n                        value={newTagCode}\n                        onChange={(e) => setNewTagCode(e.target.value.toUpperCase())}\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Beskrivelse (valgfritt)</label>\n                      <Input\n                        placeholder=\"F.eks. Ventilasjon, Sanit√¶r, Elektro\"\n                        value={newTagDescription}\n                        onChange={(e) => setNewTagDescription(e.target.value)}\n                      />\n                    </div>\n                    <div className=\"flex justify-end gap-2\">\n                      <Button variant=\"outline\" onClick={() => setShowTagDialog(false)}>\n                        Avbryt\n                      </Button>\n                      <Button onClick={handleCreateTag} disabled={creatingTag || !newTagCode.trim()}>\n                        {creatingTag ? \"Oppretter...\" : \"Opprett\"}\n                      </Button>\n                    </div>\n                  </div>\n                </DialogContent>\n              </Dialog>\n              <input\n                type=\"file\"\n                id=\"schema-upload\"\n                accept=\".pdf\"\n                className=\"hidden\"\n                onChange={handleUpload}\n                disabled={uploading}\n              />\n              <Button\n                type=\"button\"\n                disabled={uploading}\n                onClick={() => document.getElementById(\"schema-upload\")?.click()}\n              >\n                <Upload size={16} className=\"mr-2\" />\n                {uploading ? \"Laster opp...\" : \"Last opp skjema\"}\n              </Button>\n            </>\n          )}\n        </div>\n      </div>\n\n      <div className=\"flex flex-col gap-4 sm:flex-row\">\n        <div className=\"relative flex-1\">\n          <Search\n            size={16}\n            className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\"\n          />\n          <Input\n            placeholder=\"S√∏k etter skjema eller systemkode...\"\n            value={search}\n            onChange={(e) => setSearch(e.target.value)}\n            className=\"pl-9\"\n          />\n        </div>\n        <Select value={selectedTag} onValueChange={setSelectedTag}>\n          <SelectTrigger className=\"w-full sm:w-48\">\n            <Filter size={16} className=\"mr-2\" />\n            <SelectValue placeholder=\"Alle systemer\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Alle systemer</SelectItem>\n            {allTags.map((tag) => (\n              <SelectItem key={tag} value={tag}>\n                {tag}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {systemTags.length > 0 && (\n        <div className=\"flex flex-wrap gap-2\">\n          <span className=\"text-sm text-muted-foreground\">Systemkoder:</span>\n          {systemTags.slice(0, 10).map((tag) => (\n            <Badge\n              key={tag.id}\n              variant={selectedTag === tag.code ? \"default\" : \"outline\"}\n              className=\"cursor-pointer\"\n              onClick={() => setSelectedTag(selectedTag === tag.code ? \"all\" : tag.code)}\n            >\n              {tag.code}\n              {tag.description && (\n                <span className=\"ml-1 text-xs opacity-70\">({tag.description})</span>\n              )}\n            </Badge>\n          ))}\n          {systemTags.length > 10 && (\n            <Badge variant=\"outline\">+{systemTags.length - 10} flere</Badge>\n          )}\n        </div>\n      )}\n\n      {filteredDocuments.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <Network size={48} className=\"mb-4 text-muted-foreground/50\" />\n            <h3 className=\"text-lg font-medium text-foreground\">\n              Ingen systemskjema\n            </h3>\n            <p className=\"mt-1 text-sm text-muted-foreground\">\n              {search || selectedTag !== \"all\"\n                ? \"Ingen skjema matcher filteret\"\n                : \"Last opp systemskjema for √• komme i gang\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {filteredDocuments.map((doc) => {\n            const totalBoxed = doc.systemAnnotations.filter(\n              (a) => a.systemCode\n            ).length;\n\n            return (\n              <Card key={doc.id} className=\"group hover:border-primary/50\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between\">\n                    <CardTitle className=\"text-base line-clamp-2\">\n                      {doc.title}\n                    </CardTitle>\n                    <Link href={`/projects/${project.id}/documents/${doc.id}`}>\n                      <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\">\n                        <Eye size={16} />\n                      </Button>\n                    </Link>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {doc.tags.length > 0 && (\n                    <div className=\"flex flex-wrap gap-1\">\n                      {doc.tags.slice(0, 3).map((tag, i) => (\n                        <Badge key={i} variant=\"outline\" className=\"gap-1 text-xs\">\n                          <Tag size={10} />\n                          {tag.systemTag.code}\n                        </Badge>\n                      ))}\n                      {doc.tags.length > 3 && (\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          +{doc.tags.length - 3}\n                        </Badge>\n                      )}\n                    </div>\n                  )}\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <span>\n                      {format(new Date(doc.createdAt), \"d. MMM yyyy\", {\n                        locale: nb,\n                      })}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    {totalBoxed > 0 ? (\n                      <Badge variant=\"secondary\" className=\"gap-1\">\n                        <CheckCircle2 size={12} />\n                        {totalBoxed} bokset\n                      </Badge>\n                    ) : (\n                      <span className=\"text-xs text-muted-foreground\">\n                        Ingen boksing\n                      </span>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":11582,"size_tokens":null},"src/app/(app)/projects/[projectId]/schemas/page.tsx":{"content":"import { redirect } from \"next/navigation\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\nimport prisma from \"@/lib/db\";\nimport { DocumentWorkspace } from \"@/components/pages/project/document-workspace\";\nimport { Role } from \"@prisma/client\";\n\ninterface SchemasPageProps {\n  params: Promise<{ projectId: string }>;\n}\n\nexport default async function SchemasPage({ params }: SchemasPageProps) {\n  const { projectId } = await params;\n  const session = await getServerSession(authOptions);\n\n  if (!session?.user?.id) {\n    redirect(\"/login\");\n  }\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    include: {\n      documents: {\n        where: { type: \"SCHEMA\", isLatest: true },\n        orderBy: { createdAt: \"desc\" },\n        include: {\n          systemAnnotations: {\n            select: { id: true, systemCode: true },\n          },\n          tags: {\n            include: {\n              systemTag: true,\n            },\n          },\n          _count: {\n            select: {\n              annotations: true,\n              components: true,\n            },\n          },\n        },\n      },\n      members: {\n        where: { userId: session.user.id },\n      },\n    },\n  });\n\n  if (!project) {\n    redirect(\"/dashboard\");\n  }\n\n  const systemTags = await prisma.systemTag.findMany({\n    orderBy: { code: \"asc\" },\n  });\n\n  const isAdmin = session.user.role === Role.ADMIN;\n  const isMember = project.members.length > 0;\n\n  if (!isAdmin && !isMember) {\n    redirect(\"/dashboard\");\n  }\n\n  const canUpload =\n    isAdmin || project.members.some((m) => m.role !== \"READER\");\n\n  const formattedDocuments = project.documents.map((doc) => ({\n    id: doc.id,\n    title: doc.title,\n    fileName: doc.fileName,\n    url: doc.url,\n    type: doc.type,\n    revision: doc.revision,\n    isLatest: doc.isLatest,\n    approvedDeviations: doc.approvedDeviations,\n    createdAt: doc.createdAt.toISOString(),\n    updatedAt: doc.updatedAt.toISOString(),\n    tags: doc.tags,\n    systemAnnotations: doc.systemAnnotations,\n    _count: doc._count,\n  }));\n\n  return (\n    <DocumentWorkspace\n      project={project}\n      documents={formattedDocuments}\n      systemTags={systemTags}\n      documentType=\"SCHEMA\"\n      canUpload={canUpload}\n    />\n  );\n}\n","path":null,"size_bytes":2291,"size_tokens":null},"src/components/pages/project/progress-content.tsx":{"content":"\"use client\";\n\nimport {\n  TrendingUp,\n  FileText,\n  List,\n  AlertCircle,\n  CheckCircle2,\n  Activity,\n} from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\ninterface ProgressStats {\n  totalDocuments: number;\n  totalMassListItems: number;\n  totalAnnotations: number;\n  closedAnnotations: number;\n  openAnnotations: number;\n  totalSystemBoxed: number;\n  completionRate: number;\n}\n\ninterface ProgressContentProps {\n  project: { id: string; name: string };\n  stats: ProgressStats;\n}\n\nexport function ProgressContent({ project, stats }: ProgressContentProps) {\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-foreground\">Fremdrift</h1>\n        <p className=\"text-muted-foreground\">\n          Oversikt over prosjektets status og fremdrift\n        </p>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n              Dokumenter\n            </CardTitle>\n            <FileText size={16} className=\"text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-foreground\">\n              {stats.totalDocuments}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Tegninger og skjema\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n              Masseliste\n            </CardTitle>\n            <List size={16} className=\"text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-foreground\">\n              {stats.totalMassListItems}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Komponenter registrert\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n              √Öpne avvik\n            </CardTitle>\n            <AlertCircle size={16} className=\"text-orange-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-orange-500\">\n              {stats.openAnnotations}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Krever oppf√∏lging\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n              Utf√∏rt\n            </CardTitle>\n            <CheckCircle2 size={16} className=\"text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-500\">\n              {stats.closedAnnotations}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Avvik lukket\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Activity size={20} />\n            Fullf√∏ringsgrad\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-sm text-muted-foreground\">Total fremdrift</span>\n            <span className=\"text-2xl font-bold text-foreground\">\n              {stats.completionRate}%\n            </span>\n          </div>\n          <div className=\"h-4 w-full overflow-hidden rounded-full bg-muted\">\n            <div\n              className=\"h-full rounded-full bg-gradient-to-r from-primary to-green-500 transition-all duration-500\"\n              style={{ width: `${stats.completionRate}%` }}\n            />\n          </div>\n          <div className=\"flex justify-between text-xs text-muted-foreground\">\n            <span>0%</span>\n            <span>50%</span>\n            <span>100%</span>\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"grid gap-4 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">Avvik per type</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"h-3 w-3 rounded-full bg-orange-500\" />\n                <span className=\"text-sm\">√Öpne avvik</span>\n              </div>\n              <span className=\"font-medium\">{stats.openAnnotations}</span>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"h-3 w-3 rounded-full bg-green-500\" />\n                <span className=\"text-sm\">Lukkede avvik</span>\n              </div>\n              <span className=\"font-medium\">{stats.closedAnnotations}</span>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">Prosjektstatus</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Dokumenter</span>\n                <span>{stats.totalDocuments} lastet opp</span>\n              </div>\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Masseliste</span>\n                <span>{stats.totalMassListItems} komponenter</span>\n              </div>\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Totale avvik</span>\n                <span>{stats.totalAnnotations} registrert</span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6433,"size_tokens":null},"src/lib/email.ts":{"content":"import nodemailer from \"nodemailer\";\n\nconst transporter = nodemailer.createTransport({\n  host: process.env.SMTP_HOST || \"smtp.gmail.com\",\n  port: parseInt(process.env.SMTP_PORT || \"587\"),\n  secure: false,\n  auth: {\n    user: process.env.SMTP_USER,\n    pass: process.env.SMTP_PASS,\n  },\n});\n\nexport async function sendResetEmail(to: string, resetUrl: string) {\n  const mailOptions = {\n    from: process.env.SMTP_FROM || process.env.SMTP_USER,\n    to,\n    subject: \"Tilbakestill passord - SysLink\",\n    html: `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px;\">\n          <div style=\"max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n            <div style=\"background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 32px; text-align: center;\">\n              <h1 style=\"color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;\">SysLink</h1>\n            </div>\n            <div style=\"padding: 32px;\">\n              <h2 style=\"color: #1f2937; margin: 0 0 16px 0; font-size: 20px;\">Tilbakestill passord</h2>\n              <p style=\"color: #4b5563; line-height: 1.6; margin: 0 0 24px 0;\">\n                Vi mottok en foresp√∏rsel om √• tilbakestille passordet for din SysLink-konto. \n                Klikk p√• knappen nedenfor for √• opprette et nytt passord.\n              </p>\n              <div style=\"text-align: center; margin: 32px 0;\">\n                <a href=\"${resetUrl}\" style=\"display: inline-block; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #ffffff; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600; font-size: 16px;\">\n                  Tilbakestill passord\n                </a>\n              </div>\n              <p style=\"color: #6b7280; font-size: 14px; line-height: 1.6; margin: 0 0 16px 0;\">\n                Denne lenken utl√∏per om 1 time. Hvis du ikke har bedt om √• tilbakestille passordet, \n                kan du ignorere denne e-posten.\n              </p>\n              <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 24px 0;\">\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n                Hvis knappen ikke fungerer, kopier og lim inn denne lenken i nettleseren din:\n                <br>\n                <a href=\"${resetUrl}\" style=\"color: #6366f1; word-break: break-all;\">${resetUrl}</a>\n              </p>\n            </div>\n            <div style=\"background-color: #f9fafb; padding: 20px; text-align: center;\">\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n                ¬© ${new Date().getFullYear()} SysLink. Alle rettigheter forbeholdt.\n              </p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `,\n    text: `\nTilbakestill passord - SysLink\n\nVi mottok en foresp√∏rsel om √• tilbakestille passordet for din SysLink-konto.\n\nKlikk p√• lenken nedenfor for √• opprette et nytt passord:\n${resetUrl}\n\nDenne lenken utl√∏per om 1 time.\n\nHvis du ikke har bedt om √• tilbakestille passordet, kan du ignorere denne e-posten.\n\n¬© ${new Date().getFullYear()} SysLink\n    `,\n  };\n\n  try {\n    await transporter.sendMail(mailOptions);\n    console.log(`Reset email sent to ${to}`);\n  } catch (error) {\n    console.error(\"Failed to send reset email:\", error);\n    throw new Error(\"Kunne ikke sende e-post\");\n  }\n}\n\nexport async function sendWelcomeEmail(to: string, firstName: string) {\n  const mailOptions = {\n    from: process.env.SMTP_FROM || process.env.SMTP_USER,\n    to,\n    subject: \"Velkommen til SysLink\",\n    html: `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px;\">\n          <div style=\"max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n            <div style=\"background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 32px; text-align: center;\">\n              <h1 style=\"color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;\">SysLink</h1>\n            </div>\n            <div style=\"padding: 32px;\">\n              <h2 style=\"color: #1f2937; margin: 0 0 16px 0; font-size: 20px;\">Velkommen, ${firstName}!</h2>\n              <p style=\"color: #4b5563; line-height: 1.6; margin: 0 0 24px 0;\">\n                Takk for at du registrerte deg p√• SysLink. Din konto venter p√• godkjenning fra en administrator.\n              </p>\n              <p style=\"color: #4b5563; line-height: 1.6; margin: 0 0 24px 0;\">\n                Du vil motta en e-post n√•r kontoen din er aktivert og du kan logge inn.\n              </p>\n              <div style=\"background-color: #fef3c7; border-radius: 8px; padding: 16px; margin: 24px 0;\">\n                <p style=\"color: #92400e; margin: 0; font-size: 14px;\">\n                  <strong>Viktig:</strong> N√•r kontoen din er aktivert, m√• du sette opp tofaktorautentisering (2FA) \n                  innen 14 dager for √• opprettholde tilgangen.\n                </p>\n              </div>\n            </div>\n            <div style=\"background-color: #f9fafb; padding: 20px; text-align: center;\">\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n                ¬© ${new Date().getFullYear()} SysLink. Alle rettigheter forbeholdt.\n              </p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `,\n  };\n\n  try {\n    await transporter.sendMail(mailOptions);\n    console.log(`Welcome email sent to ${to}`);\n  } catch (error) {\n    console.error(\"Failed to send welcome email:\", error);\n  }\n}\n\nexport async function sendTaskAssignedEmail(\n  to: string,\n  assigneeName: string,\n  taskTitle: string,\n  projectName: string,\n  assignerName: string,\n  dueDate: string | null,\n  taskUrl: string\n) {\n  const dueDateText = dueDate\n    ? `<p style=\"color: #4b5563; line-height: 1.6; margin: 0 0 16px 0;\"><strong>Frist:</strong> ${dueDate}</p>`\n    : \"\";\n\n  const mailOptions = {\n    from: process.env.SMTP_FROM || process.env.SMTP_USER,\n    to,\n    subject: `Ny oppgave tildelt: ${taskTitle} - SysLink`,\n    html: `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px;\">\n          <div style=\"max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n            <div style=\"background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 32px; text-align: center;\">\n              <h1 style=\"color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;\">SysLink</h1>\n            </div>\n            <div style=\"padding: 32px;\">\n              <h2 style=\"color: #1f2937; margin: 0 0 16px 0; font-size: 20px;\">Ny oppgave tildelt</h2>\n              <p style=\"color: #4b5563; line-height: 1.6; margin: 0 0 24px 0;\">\n                Hei ${assigneeName}, ${assignerName} har tildelt deg en ny oppgave.\n              </p>\n              <div style=\"background-color: #f3f4f6; border-radius: 8px; padding: 20px; margin: 24px 0;\">\n                <p style=\"color: #1f2937; margin: 0 0 8px 0; font-size: 18px; font-weight: 600;\">${taskTitle}</p>\n                <p style=\"color: #6b7280; margin: 0; font-size: 14px;\">Prosjekt: ${projectName}</p>\n              </div>\n              ${dueDateText}\n              <div style=\"text-align: center; margin: 32px 0;\">\n                <a href=\"${taskUrl}\" style=\"display: inline-block; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #ffffff; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600; font-size: 16px;\">\n                  Se oppgave\n                </a>\n              </div>\n            </div>\n            <div style=\"background-color: #f9fafb; padding: 20px; text-align: center;\">\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n                ¬© ${new Date().getFullYear()} SysLink. Alle rettigheter forbeholdt.\n              </p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `,\n    text: `\nNy oppgave tildelt - SysLink\n\nHei ${assigneeName}, ${assignerName} har tildelt deg en ny oppgave.\n\nOppgave: ${taskTitle}\nProsjekt: ${projectName}\n${dueDate ? `Frist: ${dueDate}` : \"\"}\n\nSe oppgaven: ${taskUrl}\n\n¬© ${new Date().getFullYear()} SysLink\n    `,\n  };\n\n  try {\n    await transporter.sendMail(mailOptions);\n    console.log(`Task assigned email sent to ${to}`);\n  } catch (error) {\n    console.error(\"Failed to send task assigned email:\", error);\n  }\n}\n\nexport async function sendAccountActivatedEmail(to: string, firstName: string, loginUrl: string) {\n  const mailOptions = {\n    from: process.env.SMTP_FROM || process.env.SMTP_USER,\n    to,\n    subject: \"Kontoen din er aktivert - SysLink\",\n    html: `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px;\">\n          <div style=\"max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n            <div style=\"background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 32px; text-align: center;\">\n              <h1 style=\"color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;\">SysLink</h1>\n            </div>\n            <div style=\"padding: 32px;\">\n              <h2 style=\"color: #1f2937; margin: 0 0 16px 0; font-size: 20px;\">Kontoen din er aktivert!</h2>\n              <p style=\"color: #4b5563; line-height: 1.6; margin: 0 0 24px 0;\">\n                Hei ${firstName}, kontoen din p√• SysLink er n√• godkjent og aktivert.\n              </p>\n              <div style=\"text-align: center; margin: 32px 0;\">\n                <a href=\"${loginUrl}\" style=\"display: inline-block; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #ffffff; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600; font-size: 16px;\">\n                  Logg inn n√•\n                </a>\n              </div>\n              <div style=\"background-color: #fef3c7; border-radius: 8px; padding: 16px; margin: 24px 0;\">\n                <p style=\"color: #92400e; margin: 0; font-size: 14px;\">\n                  <strong>Viktig:</strong> Husk √• sette opp tofaktorautentisering (2FA) innen 14 dager \n                  for √• opprettholde tilgangen til kontoen din.\n                </p>\n              </div>\n            </div>\n            <div style=\"background-color: #f9fafb; padding: 20px; text-align: center;\">\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n                ¬© ${new Date().getFullYear()} SysLink. Alle rettigheter forbeholdt.\n              </p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `,\n  };\n\n  try {\n    await transporter.sendMail(mailOptions);\n    console.log(`Account activated email sent to ${to}`);\n  } catch (error) {\n    console.error(\"Failed to send account activated email:\", error);\n  }\n}\n","path":null,"size_bytes":11974,"size_tokens":null},"src/app/api/projects/[projectId]/documents/[documentId]/components/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectAccess } from \"@/lib/auth-helpers\";\nimport { scanDocumentForComponents, saveComponentsToDocument } from \"@/lib/scan\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string; documentId: string }> }\n) {\n  try {\n    const { projectId, documentId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const document = await prisma.document.findUnique({\n      where: { id: documentId, projectId },\n    });\n\n    if (!document) {\n      return NextResponse.json(\n        { error: \"Dokument ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    const { searchParams } = new URL(request.url);\n    const rescan = searchParams.get(\"rescan\") === \"true\";\n\n    if (rescan) {\n      const scanResult = await scanDocumentForComponents(documentId);\n      await saveComponentsToDocument(documentId, scanResult.components);\n    }\n\n    const components = await prisma.documentComponent.findMany({\n      where: { documentId },\n      orderBy: [{ system: \"asc\" }, { code: \"asc\" }],\n    });\n\n    const massList = await prisma.massList.findMany({\n      where: { projectId },\n      select: {\n        id: true,\n        tfm: true,\n        system: true,\n        component: true,\n        productName: true,\n        location: true,\n      },\n    });\n\n    const componentsWithMatch = components.map((comp) => {\n      const normalizedCode = comp.code.replace(/[.\\-_]/g, \"\").toLowerCase();\n      \n      const massListMatch = massList.find((m) => {\n        const tfmNorm = (m.tfm || \"\").replace(/[.\\-_]/g, \"\").toLowerCase();\n        const compNorm = (m.component || \"\").replace(/[.\\-_]/g, \"\").toLowerCase();\n        \n        return (\n          tfmNorm.includes(normalizedCode) ||\n          normalizedCode.includes(tfmNorm) ||\n          compNorm === normalizedCode ||\n          (m.system && comp.system && m.system === comp.system)\n        );\n      });\n\n      return {\n        ...comp,\n        massListMatch: massListMatch || null,\n      };\n    });\n\n    return NextResponse.json({\n      components: componentsWithMatch,\n      total: components.length,\n      matched: componentsWithMatch.filter((c) => c.massListMatch).length,\n    });\n  } catch (error) {\n    console.error(\"Error fetching components:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke hente komponenter\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string; documentId: string }> }\n) {\n  try {\n    const { projectId, documentId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const document = await prisma.document.findUnique({\n      where: { id: documentId, projectId },\n    });\n\n    if (!document) {\n      return NextResponse.json(\n        { error: \"Dokument ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    const scanResult = await scanDocumentForComponents(documentId);\n    const savedCount = await saveComponentsToDocument(documentId, scanResult.components);\n\n    return NextResponse.json({\n      success: true,\n      scannedCount: scanResult.components.length,\n      savedCount,\n      systemCodes: scanResult.systemCodes,\n    });\n  } catch (error) {\n    console.error(\"Error scanning components:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke skanne komponenter\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string; documentId: string }> }\n) {\n  try {\n    const { projectId, documentId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const document = await prisma.document.findUnique({\n      where: { id: documentId, projectId },\n    });\n\n    if (!document) {\n      return NextResponse.json(\n        { error: \"Dokument ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    const body = await request.json();\n    const { componentId, system } = body;\n\n    if (!componentId) {\n      return NextResponse.json(\n        { error: \"componentId er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    const existingComponent = await prisma.documentComponent.findFirst({\n      where: { id: componentId, documentId },\n    });\n\n    if (!existingComponent) {\n      return NextResponse.json(\n        { error: \"Komponent ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    const component = await prisma.documentComponent.update({\n      where: { id: componentId },\n      data: { system },\n    });\n\n    return NextResponse.json(component);\n  } catch (error) {\n    console.error(\"Error updating component:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke oppdatere komponent\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":5075,"size_tokens":null},"src/lib/pdf-text-extractor.ts":{"content":"import * as pdfjsLib from \"pdfjs-dist\";\n\npdfjsLib.GlobalWorkerOptions.workerSrc = \"\";\n\nexport interface TextItem {\n  text: string;\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n  page: number;\n}\n\nexport interface ExtractedComponent {\n  code: string;\n  system: string | null;\n  x: number;\n  y: number;\n  page: number;\n  confidence: number;\n}\n\nconst TFM_PATTERNS = [\n  /(\\d{3,4})[.\\-_](\\d{3})/g,\n  /(\\d{3,4})\\.(\\d{3})\\.\\d+/g,\n  /([A-Z]{2,3})[-_]?(\\d{3,4})/gi,\n  /(\\d{2,4})[-.](\\d{2,4})[-.](\\d{2,4})/g,\n];\n\nconst SYSTEM_CODE_PATTERNS = [\n  /^(\\d{2,4})$/,\n  /^(\\d{3,4})\\.\\d{3}/,\n  /^([A-Z]{2,3})\\d*/i,\n];\n\nexport function extractSystemCode(text: string): string | null {\n  const cleaned = text.trim().toUpperCase();\n  \n  const match320 = cleaned.match(/^(\\d{3})\\./);\n  if (match320) return match320[1];\n  \n  const match4digit = cleaned.match(/^(\\d{4})\\./);\n  if (match4digit) return match4digit[1];\n  \n  for (const pattern of SYSTEM_CODE_PATTERNS) {\n    const match = cleaned.match(pattern);\n    if (match) return match[1];\n  }\n  \n  return null;\n}\n\nexport async function extractTextFromPDF(\n  pdfBuffer: Buffer\n): Promise<{ text: string; items: TextItem[] }> {\n  try {\n    const data = new Uint8Array(pdfBuffer);\n    const pdf = await pdfjsLib.getDocument({ data, useSystemFonts: true }).promise;\n    \n    let fullText = \"\";\n    const allItems: TextItem[] = [];\n    \n    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {\n      const page = await pdf.getPage(pageNum);\n      const viewport = page.getViewport({ scale: 1.0 });\n      const textContent = await page.getTextContent();\n      \n      for (const item of textContent.items) {\n        if (\"str\" in item && item.str.trim()) {\n          const tx = item.transform;\n          const x = (tx[4] / viewport.width) * 100;\n          const y = (1 - tx[5] / viewport.height) * 100;\n          \n          allItems.push({\n            text: item.str,\n            x,\n            y,\n            width: (item.width / viewport.width) * 100,\n            height: (item.height / viewport.height) * 100,\n            page: pageNum,\n          });\n          \n          fullText += item.str + \" \";\n        }\n      }\n      \n      fullText += \"\\n\";\n    }\n    \n    return { text: fullText, items: allItems };\n  } catch (error) {\n    console.error(\"Error extracting PDF text:\", error);\n    return { text: \"\", items: [] };\n  }\n}\n\nexport function findComponentsInText(\n  items: TextItem[]\n): ExtractedComponent[] {\n  const components: ExtractedComponent[] = [];\n  const seen = new Set<string>();\n  \n  for (const item of items) {\n    for (const pattern of TFM_PATTERNS) {\n      pattern.lastIndex = 0;\n      let match;\n      \n      while ((match = pattern.exec(item.text)) !== null) {\n        const code = match[0];\n        const system = extractSystemCode(code);\n        const key = `${code}-${item.page}`;\n        \n        if (!seen.has(key)) {\n          seen.add(key);\n          components.push({\n            code,\n            system,\n            x: item.x,\n            y: item.y,\n            page: item.page,\n            confidence: 0.8,\n          });\n        }\n      }\n    }\n  }\n  \n  return components;\n}\n\nexport function findSystemCodesInFilename(filename: string): string[] {\n  const systems: string[] = [];\n  const seen = new Set<string>();\n  \n  for (const pattern of TFM_PATTERNS) {\n    pattern.lastIndex = 0;\n    let match;\n    \n    while ((match = pattern.exec(filename)) !== null) {\n      const system = extractSystemCode(match[0]);\n      if (system && !seen.has(system)) {\n        seen.add(system);\n        systems.push(system);\n      }\n    }\n  }\n  \n  const directMatch = filename.match(/(\\d{3,4})/g);\n  if (directMatch) {\n    for (const m of directMatch.slice(0, 3)) {\n      if (!seen.has(m) && m.length >= 3) {\n        seen.add(m);\n        systems.push(m);\n      }\n    }\n  }\n  \n  return systems;\n}\n\nexport async function extractSystemCodesFromPDF(\n  pdfBuffer: Buffer,\n  filename: string\n): Promise<string[]> {\n  const systemCodes = new Set<string>();\n  \n  const filenameMatches = findSystemCodesInFilename(filename);\n  filenameMatches.forEach((s) => systemCodes.add(s));\n  \n  try {\n    const { items } = await extractTextFromPDF(pdfBuffer);\n    const components = findComponentsInText(items);\n    \n    for (const comp of components) {\n      if (comp.system) {\n        systemCodes.add(comp.system);\n      }\n    }\n  } catch (error) {\n    console.error(\"Error extracting system codes from PDF:\", error);\n  }\n  \n  return Array.from(systemCodes);\n}\n","path":null,"size_bytes":4502,"size_tokens":null},"src/app/api/projects/[projectId]/documents/[documentId]/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectAccess, requireProjectLeaderAccess } from \"@/lib/auth-helpers\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string; documentId: string }> }\n) {\n  try {\n    const { projectId, documentId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const document = await prisma.document.findUnique({\n      where: { id: documentId, projectId },\n      include: {\n        tags: { include: { systemTag: true } },\n        components: {\n          orderBy: [{ system: \"asc\" }, { code: \"asc\" }],\n        },\n        annotations: {\n          include: {\n            author: {\n              select: { id: true, firstName: true, lastName: true, email: true },\n            },\n            comments: {\n              include: {\n                author: { select: { firstName: true, lastName: true } },\n              },\n              orderBy: { createdAt: \"asc\" },\n            },\n          },\n          orderBy: { createdAt: \"asc\" },\n        },\n        systemAnnotations: {\n          include: {\n            createdBy: {\n              select: { firstName: true, lastName: true },\n            },\n            comments: {\n              include: {\n                author: { select: { firstName: true, lastName: true } },\n              },\n              orderBy: { createdAt: \"asc\" },\n            },\n          },\n          orderBy: { createdAt: \"asc\" },\n        },\n      },\n    });\n\n    if (!document) {\n      return NextResponse.json(\n        { error: \"Dokument ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    return NextResponse.json(document);\n  } catch (error) {\n    console.error(\"Error fetching document:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string; documentId: string }> }\n) {\n  try {\n    const { projectId, documentId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const existingDoc = await prisma.document.findUnique({\n      where: { id: documentId, projectId },\n    });\n\n    if (!existingDoc) {\n      return NextResponse.json(\n        { error: \"Dokument ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    const body = await request.json();\n    const { title, systemTags, approvedDeviations, type } = body;\n\n    const updateData: Record<string, unknown> = {};\n\n    if (title !== undefined) {\n      updateData.title = title;\n    }\n\n    if (systemTags !== undefined) {\n      updateData.systemTags = systemTags;\n    }\n\n    if (approvedDeviations !== undefined) {\n      updateData.approvedDeviations = approvedDeviations;\n    }\n\n    if (type !== undefined) {\n      updateData.type = type;\n    }\n\n    const document = await prisma.document.update({\n      where: { id: documentId },\n      data: updateData,\n      include: {\n        tags: { include: { systemTag: true } },\n      },\n    });\n\n    return NextResponse.json(document);\n  } catch (error) {\n    console.error(\"Error updating document:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke oppdatere dokument\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string; documentId: string }> }\n) {\n  try {\n    const { projectId, documentId } = await params;\n\n    const authResult = await requireProjectLeaderAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const existingDoc = await prisma.document.findUnique({\n      where: { id: documentId, projectId },\n    });\n\n    if (!existingDoc) {\n      return NextResponse.json(\n        { error: \"Dokument ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    await prisma.document.delete({\n      where: { id: documentId },\n    });\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error(\"Error deleting document:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke slette dokument\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4352,"size_tokens":null},"src/app/api/projects/[projectId]/documents/[documentId]/verify/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectAccess } from \"@/lib/auth-helpers\";\nimport { verifyAgainstMassList } from \"@/lib/scan\";\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string; documentId: string }> }\n) {\n  try {\n    const { projectId, documentId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const document = await prisma.document.findUnique({\n      where: { id: documentId, projectId },\n    });\n\n    if (!document) {\n      return NextResponse.json(\n        { error: \"Dokument ikke funnet\" },\n        { status: 404 }\n      );\n    }\n\n    const result = await verifyAgainstMassList(projectId, documentId);\n\n    return NextResponse.json(result);\n  } catch (error) {\n    console.error(\"Error verifying document:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke verifisere dokument\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":1071,"size_tokens":null},"src/app/api/documents/[documentId]/system-annotations/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth, canAnnotateDocuments } from \"@/lib/auth-helpers\";\nimport { Point } from \"@/lib/geometry-utils\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ documentId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { documentId } = await params;\n\n    const document = await prisma.document.findUnique({\n      where: { id: documentId },\n      select: { projectId: true },\n    });\n\n    if (!document) {\n      return NextResponse.json({ error: \"Dokument ikke funnet\" }, { status: 404 });\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n      where: {\n        projectId: document.projectId,\n        userId: authResult.user.id,\n      },\n    });\n\n    if (!membership && authResult.user.role !== \"ADMIN\") {\n      return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    const annotations = await prisma.systemAnnotation.findMany({\n      where: { documentId },\n      include: {\n        createdBy: {\n          select: { firstName: true, lastName: true },\n        },\n        comments: {\n          include: {\n            author: { select: { firstName: true, lastName: true } },\n          },\n          orderBy: { createdAt: \"asc\" },\n        },\n      },\n      orderBy: { createdAt: \"asc\" },\n    });\n\n    return NextResponse.json(annotations);\n  } catch (error) {\n    console.error(\"Error fetching system annotations:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ documentId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { documentId } = await params;\n\n    const document = await prisma.document.findUnique({\n      where: { id: documentId },\n      select: { projectId: true },\n    });\n\n    if (!document) {\n      return NextResponse.json({ error: \"Dokument ikke funnet\" }, { status: 404 });\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n      where: {\n        projectId: document.projectId,\n        userId: authResult.user.id,\n      },\n    });\n\n    if (!membership && authResult.user.role !== \"ADMIN\") {\n      return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    if (!canAnnotateDocuments(authResult.user.role, membership?.role)) {\n      return NextResponse.json({ error: \"Ingen tilgang til √• opprette annoteringer\" }, { status: 403 });\n    }\n\n    const body = await request.json();\n    const { type, systemCode, content, pageNumber, color, points, x, y, width, height } = body;\n\n    if (typeof pageNumber !== \"number\") {\n      return NextResponse.json({ error: \"Sidenummer er p√•krevd\" }, { status: 400 });\n    }\n\n    const annotation = await prisma.systemAnnotation.create({\n      data: {\n        documentId,\n        type: type || \"SYSTEM\",\n        systemCode: systemCode || null,\n        content: content || null,\n        pageNumber,\n        color: color || \"#3B82F6\",\n        points: points as Point[] | undefined,\n        x: x ?? null,\n        y: y ?? null,\n        width: width ?? null,\n        height: height ?? null,\n        createdById: authResult.user.id,\n      },\n      include: {\n        createdBy: {\n          select: { firstName: true, lastName: true },\n        },\n        comments: true,\n      },\n    });\n\n    return NextResponse.json(annotation, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating system annotation:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ documentId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const body = await request.json();\n    const { annotationId, systemCode, content, color, points } = body;\n\n    if (!annotationId) {\n      return NextResponse.json({ error: \"annotationId er p√•krevd\" }, { status: 400 });\n    }\n\n    const annotation = await prisma.systemAnnotation.findUnique({\n      where: { id: annotationId },\n      include: { document: true },\n    });\n\n    if (!annotation) {\n      return NextResponse.json({ error: \"Annotasjon ikke funnet\" }, { status: 404 });\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n      where: {\n        projectId: annotation.document.projectId,\n        userId: authResult.user.id,\n      },\n    });\n\n    if (!membership && authResult.user.role !== \"ADMIN\") {\n      return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    if (!canAnnotateDocuments(authResult.user.role, membership?.role)) {\n      return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    const updateData: Record<string, unknown> = {};\n    if (systemCode !== undefined) updateData.systemCode = systemCode;\n    if (content !== undefined) updateData.content = content;\n    if (color !== undefined) updateData.color = color;\n    if (points !== undefined) updateData.points = points;\n\n    const updated = await prisma.systemAnnotation.update({\n      where: { id: annotationId },\n      data: updateData,\n      include: {\n        createdBy: {\n          select: { firstName: true, lastName: true },\n        },\n        comments: {\n          include: {\n            author: { select: { firstName: true, lastName: true } },\n          },\n        },\n      },\n    });\n\n    return NextResponse.json(updated);\n  } catch (error) {\n    console.error(\"Error updating system annotation:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ documentId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { searchParams } = new URL(request.url);\n    const annotationId = searchParams.get(\"id\");\n\n    if (!annotationId) {\n      return NextResponse.json({ error: \"Mangler annotasjon-ID\" }, { status: 400 });\n    }\n\n    const annotation = await prisma.systemAnnotation.findUnique({\n      where: { id: annotationId },\n      include: { document: true },\n    });\n\n    if (!annotation) {\n      return NextResponse.json({ error: \"Annotasjon ikke funnet\" }, { status: 404 });\n    }\n\n    const membership = await prisma.projectMember.findFirst({\n      where: {\n        projectId: annotation.document.projectId,\n        userId: authResult.user.id,\n      },\n    });\n\n    if (!membership && authResult.user.role !== \"ADMIN\") {\n      return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    if (!canAnnotateDocuments(authResult.user.role, membership?.role)) {\n      return NextResponse.json({ error: \"Ingen tilgang\" }, { status: 403 });\n    }\n\n    await prisma.systemAnnotation.delete({\n      where: { id: annotationId },\n    });\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error(\"Error deleting system annotation:\", error);\n    return NextResponse.json(\n      { error: \"Intern serverfeil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":7469,"size_tokens":null},"src/lib/scan.ts":{"content":"import prisma from \"@/lib/db\";\nimport { extractTextFromPDF, findComponentsInText, ExtractedComponent } from \"./pdf-text-extractor\";\nimport { readFile } from \"fs/promises\";\nimport path from \"path\";\n\nexport interface VerificationResult {\n  documentId: string;\n  totalComponents: number;\n  matchedComponents: number;\n  unmatchedComponents: ExtractedComponent[];\n  matches: {\n    component: ExtractedComponent;\n    massListItem: {\n      id: string;\n      tfm: string | null;\n      system: string | null;\n      component: string | null;\n      productName: string | null;\n      location: string | null;\n    };\n  }[];\n}\n\nexport interface ScanResult {\n  documentId: string;\n  components: ExtractedComponent[];\n  systemCodes: string[];\n}\n\nexport async function scanDocumentForComponents(\n  documentId: string\n): Promise<ScanResult> {\n  const document = await prisma.document.findUnique({\n    where: { id: documentId },\n    select: {\n      id: true,\n      url: true,\n      title: true,\n    },\n  });\n\n  if (!document) {\n    throw new Error(\"Document not found\");\n  }\n\n  const filePath = path.join(process.cwd(), \"uploads\", document.url);\n  \n  let pdfBuffer: Buffer;\n  try {\n    pdfBuffer = await readFile(filePath);\n  } catch {\n    const altPath = path.join(process.cwd(), document.url);\n    try {\n      pdfBuffer = await readFile(altPath);\n    } catch {\n      throw new Error(\"Could not read PDF file\");\n    }\n  }\n\n  const { items } = await extractTextFromPDF(pdfBuffer);\n  const components = findComponentsInText(items);\n  \n  const systemCodes = [...new Set(\n    components\n      .map((c) => c.system)\n      .filter((s): s is string => s !== null)\n  )];\n\n  return {\n    documentId,\n    components,\n    systemCodes,\n  };\n}\n\nexport async function verifyAgainstMassList(\n  projectId: string,\n  documentId: string\n): Promise<VerificationResult> {\n  const scanResult = await scanDocumentForComponents(documentId);\n  \n  const massList = await prisma.massList.findMany({\n    where: { projectId },\n    select: {\n      id: true,\n      tfm: true,\n      system: true,\n      component: true,\n      productName: true,\n      location: true,\n    },\n  });\n\n  const matches: VerificationResult[\"matches\"] = [];\n  const matchedCodes = new Set<string>();\n\n  for (const comp of scanResult.components) {\n    const normalizedCode = comp.code.replace(/[.\\-_]/g, \"\").toLowerCase();\n    \n    for (const massItem of massList) {\n      const tfmNormalized = (massItem.tfm || \"\").replace(/[.\\-_]/g, \"\").toLowerCase();\n      const componentNormalized = (massItem.component || \"\").replace(/[.\\-_]/g, \"\").toLowerCase();\n      \n      if (\n        tfmNormalized.includes(normalizedCode) ||\n        normalizedCode.includes(tfmNormalized) ||\n        componentNormalized === normalizedCode ||\n        (massItem.system && comp.system && massItem.system === comp.system)\n      ) {\n        matches.push({\n          component: comp,\n          massListItem: massItem,\n        });\n        matchedCodes.add(comp.code);\n        break;\n      }\n    }\n  }\n\n  const unmatchedComponents = scanResult.components.filter(\n    (c) => !matchedCodes.has(c.code)\n  );\n\n  return {\n    documentId,\n    totalComponents: scanResult.components.length,\n    matchedComponents: matches.length,\n    unmatchedComponents,\n    matches,\n  };\n}\n\nexport async function saveComponentsToDocument(\n  documentId: string,\n  components: ExtractedComponent[]\n): Promise<number> {\n  let savedCount = 0;\n\n  for (const comp of components) {\n    try {\n      await prisma.documentComponent.upsert({\n        where: {\n          documentId_code: {\n            documentId,\n            code: comp.code,\n          },\n        },\n        update: {\n          system: comp.system,\n          x: comp.x,\n          y: comp.y,\n          page: comp.page,\n        },\n        create: {\n          documentId,\n          code: comp.code,\n          system: comp.system,\n          x: comp.x,\n          y: comp.y,\n          page: comp.page,\n        },\n      });\n      savedCount++;\n    } catch (error) {\n      console.error(`Error saving component ${comp.code}:`, error);\n    }\n  }\n\n  return savedCount;\n}\n","path":null,"size_bytes":4090,"size_tokens":null},"src/lib/geometry-utils.ts":{"content":"export interface Point {\n  x: number;\n  y: number;\n}\n\nexport interface Polygon {\n  points: Point[];\n  color: string;\n  systemCode?: string;\n}\n\nexport interface BoundingBox {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\nexport function pointInPolygon(point: Point, polygon: Point[]): boolean {\n  if (polygon.length < 3) return false;\n  \n  let inside = false;\n  const n = polygon.length;\n  \n  for (let i = 0, j = n - 1; i < n; j = i++) {\n    const xi = polygon[i].x;\n    const yi = polygon[i].y;\n    const xj = polygon[j].x;\n    const yj = polygon[j].y;\n    \n    if (\n      yi > point.y !== yj > point.y &&\n      point.x < ((xj - xi) * (point.y - yi)) / (yj - yi) + xi\n    ) {\n      inside = !inside;\n    }\n  }\n  \n  return inside;\n}\n\nexport function polygonToBoundingBox(polygon: Point[]): BoundingBox {\n  if (polygon.length === 0) {\n    return { x: 0, y: 0, width: 0, height: 0 };\n  }\n  \n  let minX = Infinity;\n  let minY = Infinity;\n  let maxX = -Infinity;\n  let maxY = -Infinity;\n  \n  for (const point of polygon) {\n    minX = Math.min(minX, point.x);\n    minY = Math.min(minY, point.y);\n    maxX = Math.max(maxX, point.x);\n    maxY = Math.max(maxY, point.y);\n  }\n  \n  return {\n    x: minX,\n    y: minY,\n    width: maxX - minX,\n    height: maxY - minY,\n  };\n}\n\nexport function boundingBoxToPolygon(box: BoundingBox): Point[] {\n  return [\n    { x: box.x, y: box.y },\n    { x: box.x + box.width, y: box.y },\n    { x: box.x + box.width, y: box.y + box.height },\n    { x: box.x, y: box.y + box.height },\n  ];\n}\n\nexport function calculatePolygonCenter(polygon: Point[]): Point {\n  if (polygon.length === 0) {\n    return { x: 0, y: 0 };\n  }\n  \n  let sumX = 0;\n  let sumY = 0;\n  \n  for (const point of polygon) {\n    sumX += point.x;\n    sumY += point.y;\n  }\n  \n  return {\n    x: sumX / polygon.length,\n    y: sumY / polygon.length,\n  };\n}\n\nexport function calculatePolygonArea(polygon: Point[]): number {\n  if (polygon.length < 3) return 0;\n  \n  let area = 0;\n  const n = polygon.length;\n  \n  for (let i = 0; i < n; i++) {\n    const j = (i + 1) % n;\n    area += polygon[i].x * polygon[j].y;\n    area -= polygon[j].x * polygon[i].y;\n  }\n  \n  return Math.abs(area / 2);\n}\n\nexport function simplifyPolygon(polygon: Point[], tolerance: number = 1): Point[] {\n  if (polygon.length <= 3) return polygon;\n  \n  const simplified: Point[] = [polygon[0]];\n  let lastIncluded = polygon[0];\n  \n  for (let i = 1; i < polygon.length - 1; i++) {\n    const dist = Math.sqrt(\n      Math.pow(polygon[i].x - lastIncluded.x, 2) +\n      Math.pow(polygon[i].y - lastIncluded.y, 2)\n    );\n    \n    if (dist >= tolerance) {\n      simplified.push(polygon[i]);\n      lastIncluded = polygon[i];\n    }\n  }\n  \n  simplified.push(polygon[polygon.length - 1]);\n  \n  return simplified;\n}\n\nexport function getPolygonColors(): string[] {\n  return [\n    \"#3B82F6\",\n    \"#10B981\",\n    \"#F59E0B\",\n    \"#EF4444\",\n    \"#8B5CF6\",\n    \"#EC4899\",\n    \"#06B6D4\",\n    \"#84CC16\",\n  ];\n}\n\nexport function getNextPolygonColor(existingColors: string[]): string {\n  const allColors = getPolygonColors();\n  const usedSet = new Set(existingColors);\n  \n  for (const color of allColors) {\n    if (!usedSet.has(color)) {\n      return color;\n    }\n  }\n  \n  return allColors[existingColors.length % allColors.length];\n}\n","path":null,"size_bytes":3276,"size_tokens":null},"src/components/pages/project/document-workspace.tsx":{"content":"\"use client\";\n\nimport { useState, useCallback } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  Search,\n  Filter,\n  Upload,\n  Eye,\n  FileText,\n  Tag,\n  CheckCircle2,\n  AlertTriangle,\n  RotateCcw,\n  Download,\n  Box,\n  Layers,\n  ChevronDown,\n  X,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\n\ninterface DocumentTag {\n  systemTag: {\n    id: string;\n    code: string;\n    description: string | null;\n  };\n}\n\ninterface SystemAnnotation {\n  id: string;\n  systemCode: string | null;\n}\n\ninterface Document {\n  id: string;\n  title: string;\n  fileName: string | null;\n  url: string;\n  type: string;\n  revision: number;\n  isLatest: boolean;\n  approvedDeviations: number;\n  createdAt: string;\n  updatedAt: string;\n  tags: DocumentTag[];\n  systemAnnotations: SystemAnnotation[];\n  _count?: {\n    annotations: number;\n    components: number;\n  };\n}\n\ninterface SystemTag {\n  id: string;\n  code: string;\n  description: string | null;\n}\n\ninterface VerificationResult {\n  documentId: string;\n  totalComponents: number;\n  matchedComponents: number;\n  unmatchedComponents: {\n    code: string;\n    system: string | null;\n    x: number;\n    y: number;\n    page: number;\n  }[];\n  matches: {\n    component: { code: string; system: string | null };\n    massListItem: {\n      id: string;\n      tfm: string | null;\n      system: string | null;\n      productName: string | null;\n    };\n  }[];\n}\n\ninterface ComponentData {\n  id: string;\n  code: string;\n  system: string | null;\n  x: number | null;\n  y: number | null;\n  page: number | null;\n  massListMatch: {\n    id: string;\n    tfm: string | null;\n    system: string | null;\n    productName: string | null;\n    location: string | null;\n  } | null;\n}\n\ninterface DocumentWorkspaceProps {\n  project: {\n    id: string;\n    name: string;\n  };\n  documents: Document[];\n  systemTags: SystemTag[];\n  documentType: \"DRAWING\" | \"SCHEMA\";\n  canUpload: boolean;\n}\n\nexport function DocumentWorkspace({\n  project,\n  documents,\n  systemTags,\n  documentType,\n  canUpload,\n}: DocumentWorkspaceProps) {\n  const router = useRouter();\n  const [search, setSearch] = useState(\"\");\n  const [selectedTag, setSelectedTag] = useState<string>(\"all\");\n  const [uploading, setUploading] = useState(false);\n  const [verifying, setVerifying] = useState<string | null>(null);\n  const [verificationResult, setVerificationResult] = useState<VerificationResult | null>(null);\n  const [showVerificationDialog, setShowVerificationDialog] = useState(false);\n  const [showComponentsDialog, setShowComponentsDialog] = useState(false);\n  const [selectedDocId, setSelectedDocId] = useState<string | null>(null);\n  const [components, setComponents] = useState<ComponentData[]>([]);\n  const [loadingComponents, setLoadingComponents] = useState(false);\n  const [componentFilter, setComponentFilter] = useState(\"\");\n\n  const allTags = [...new Set(documents.flatMap((doc) => doc.tags.map((t) => t.systemTag.code)))];\n\n  const filteredDocuments = documents.filter((doc) => {\n    const matchesSearch =\n      doc.title.toLowerCase().includes(search.toLowerCase()) ||\n      doc.tags.some((t) =>\n        t.systemTag.code.toLowerCase().includes(search.toLowerCase())\n      );\n\n    const matchesTag =\n      selectedTag === \"all\" ||\n      doc.tags.some((t) => t.systemTag.code === selectedTag);\n\n    return matchesSearch && matchesTag;\n  });\n\n  const handleUpload = useCallback(async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    setUploading(true);\n    try {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      formData.append(\"title\", file.name.replace(/\\.[^/.]+$/, \"\"));\n      formData.append(\"type\", documentType);\n      formData.append(\"autoTag\", \"true\");\n\n      const res = await fetch(`/api/projects/${project.id}/documents`, {\n        method: \"POST\",\n        body: formData,\n      });\n\n      if (res.ok) {\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setUploading(false);\n      e.target.value = \"\";\n    }\n  }, [project.id, documentType, router]);\n\n  const handleVerify = useCallback(async (documentId: string) => {\n    setVerifying(documentId);\n    try {\n      const res = await fetch(\n        `/api/projects/${project.id}/documents/${documentId}/verify`,\n        { method: \"POST\" }\n      );\n\n      if (res.ok) {\n        const result = await res.json();\n        setVerificationResult(result);\n        setShowVerificationDialog(true);\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setVerifying(null);\n    }\n  }, [project.id]);\n\n  const handleShowComponents = useCallback(async (documentId: string) => {\n    setSelectedDocId(documentId);\n    setLoadingComponents(true);\n    setShowComponentsDialog(true);\n\n    try {\n      const res = await fetch(\n        `/api/projects/${project.id}/documents/${documentId}/components?rescan=true`\n      );\n\n      if (res.ok) {\n        const data = await res.json();\n        setComponents(data.components || []);\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setLoadingComponents(false);\n    }\n  }, [project.id]);\n\n  const handleApproveDeviation = useCallback(async (documentId: string) => {\n    try {\n      const doc = documents.find((d) => d.id === documentId);\n      if (!doc) return;\n\n      await fetch(`/api/projects/${project.id}/documents/${documentId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          approvedDeviations: doc.approvedDeviations + 1,\n        }),\n      });\n\n      router.refresh();\n    } catch (err) {\n      console.error(err);\n    }\n  }, [project.id, documents, router]);\n\n  const filteredComponents = components.filter((c) =>\n    c.code.toLowerCase().includes(componentFilter.toLowerCase()) ||\n    (c.system?.toLowerCase().includes(componentFilter.toLowerCase()))\n  );\n\n  const typeLabel = documentType === \"SCHEMA\" ? \"Systemskjema\" : \"Arbeidstegning\";\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold\">{typeLabel}</h2>\n          <p className=\"text-sm text-muted-foreground\">\n            {filteredDocuments.length} dokument{filteredDocuments.length !== 1 ? \"er\" : \"\"}\n          </p>\n        </div>\n\n        {canUpload && (\n          <div className=\"flex gap-2\">\n            <label className=\"cursor-pointer\">\n              <input\n                type=\"file\"\n                accept=\".pdf\"\n                className=\"hidden\"\n                onChange={handleUpload}\n                disabled={uploading}\n              />\n              <Button disabled={uploading} asChild>\n                <span>\n                  <Upload size={16} className=\"mr-2\" />\n                  {uploading ? \"Laster opp...\" : \"Last opp\"}\n                </span>\n              </Button>\n            </label>\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex flex-col gap-4 sm:flex-row\">\n        <div className=\"relative flex-1\">\n          <Search\n            size={16}\n            className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\"\n          />\n          <Input\n            placeholder=\"S√∏k etter dokument eller systemkode...\"\n            value={search}\n            onChange={(e) => setSearch(e.target.value)}\n            className=\"pl-9\"\n          />\n        </div>\n\n        <Select value={selectedTag} onValueChange={setSelectedTag}>\n          <SelectTrigger className=\"w-full sm:w-48\">\n            <Filter size={16} className=\"mr-2\" />\n            <SelectValue placeholder=\"Alle systemer\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Alle systemer</SelectItem>\n            {allTags.map((tag) => (\n              <SelectItem key={tag} value={tag}>\n                {tag}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"rounded-lg border\">\n        <Table>\n          <TableHeader>\n            <TableRow>\n              <TableHead>Dokument</TableHead>\n              <TableHead>System</TableHead>\n              <TableHead className=\"text-center\">Rev</TableHead>\n              <TableHead className=\"text-center\">Boksing</TableHead>\n              <TableHead className=\"text-center\">Avvik</TableHead>\n              <TableHead>Oppdatert</TableHead>\n              <TableHead className=\"text-right\">Handlinger</TableHead>\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {filteredDocuments.length === 0 ? (\n              <TableRow>\n                <TableCell colSpan={7} className=\"h-24 text-center text-muted-foreground\">\n                  Ingen dokumenter funnet\n                </TableCell>\n              </TableRow>\n            ) : (\n              filteredDocuments.map((doc) => {\n                const boxedCount = doc.systemAnnotations.filter((a) => a.systemCode).length;\n\n                return (\n                  <TableRow key={doc.id}>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <FileText size={16} className=\"text-muted-foreground\" />\n                        <div>\n                          <div className=\"font-medium\">{doc.title}</div>\n                          {doc.fileName && (\n                            <div className=\"text-xs text-muted-foreground\">\n                              {doc.fileName}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {doc.tags.slice(0, 2).map((tag) => (\n                          <Badge key={tag.systemTag.id} variant=\"outline\" className=\"text-xs\">\n                            {tag.systemTag.code}\n                          </Badge>\n                        ))}\n                        {doc.tags.length > 2 && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            +{doc.tags.length - 2}\n                          </Badge>\n                        )}\n                      </div>\n                    </TableCell>\n                    <TableCell className=\"text-center\">\n                      <Badge variant=\"secondary\">{doc.revision}</Badge>\n                    </TableCell>\n                    <TableCell className=\"text-center\">\n                      {boxedCount > 0 ? (\n                        <Badge variant=\"default\" className=\"gap-1\">\n                          <Box size={12} />\n                          {boxedCount}\n                        </Badge>\n                      ) : (\n                        <span className=\"text-muted-foreground\">-</span>\n                      )}\n                    </TableCell>\n                    <TableCell className=\"text-center\">\n                      {doc.approvedDeviations > 0 ? (\n                        <Badge variant=\"outline\" className=\"gap-1 border-orange-500 text-orange-500\">\n                          <AlertTriangle size={12} />\n                          {doc.approvedDeviations}\n                        </Badge>\n                      ) : (\n                        <CheckCircle2 size={16} className=\"mx-auto text-green-500\" />\n                      )}\n                    </TableCell>\n                    <TableCell className=\"text-sm text-muted-foreground\">\n                      {format(new Date(doc.updatedAt), \"d. MMM yyyy\", { locale: nb })}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex justify-end gap-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => handleShowComponents(doc.id)}\n                          title=\"Vis komponenter\"\n                        >\n                          <Layers size={16} />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => handleVerify(doc.id)}\n                          disabled={verifying === doc.id}\n                          title=\"Verifiser mot masseliste\"\n                        >\n                          {verifying === doc.id ? (\n                            <RotateCcw size={16} className=\"animate-spin\" />\n                          ) : (\n                            <CheckCircle2 size={16} />\n                          )}\n                        </Button>\n                        <Link href={`/projects/${project.id}/documents/${doc.id}`}>\n                          <Button variant=\"ghost\" size=\"sm\" title=\"√Öpne dokument\">\n                            <Eye size={16} />\n                          </Button>\n                        </Link>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                );\n              })\n            )}\n          </TableBody>\n        </Table>\n      </div>\n\n      <Dialog open={showVerificationDialog} onOpenChange={setShowVerificationDialog}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Verifiseringsresultat</DialogTitle>\n          </DialogHeader>\n          {verificationResult && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-3 gap-4\">\n                <Card>\n                  <CardContent className=\"pt-4\">\n                    <div className=\"text-2xl font-bold\">{verificationResult.totalComponents}</div>\n                    <div className=\"text-sm text-muted-foreground\">Totalt funnet</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-4\">\n                    <div className=\"text-2xl font-bold text-green-600\">\n                      {verificationResult.matchedComponents}\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">Treff i masseliste</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-4\">\n                    <div className=\"text-2xl font-bold text-orange-600\">\n                      {verificationResult.unmatchedComponents.length}\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">Avvik</div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {verificationResult.unmatchedComponents.length > 0 && (\n                <div>\n                  <h4 className=\"mb-2 font-medium\">Komponenter uten match:</h4>\n                  <div className=\"max-h-48 overflow-y-auto rounded border\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Kode</TableHead>\n                          <TableHead>System</TableHead>\n                          <TableHead>Side</TableHead>\n                          <TableHead className=\"text-right\">Handling</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {verificationResult.unmatchedComponents.slice(0, 10).map((comp, i) => (\n                          <TableRow key={i}>\n                            <TableCell className=\"font-mono text-sm\">{comp.code}</TableCell>\n                            <TableCell>{comp.system || \"-\"}</TableCell>\n                            <TableCell>{comp.page}</TableCell>\n                            <TableCell className=\"text-right\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => handleApproveDeviation(verificationResult.documentId)}\n                              >\n                                Godkjenn avvik\n                              </Button>\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  </div>\n                </div>\n              )}\n\n              <div className=\"flex justify-end gap-2\">\n                <Button variant=\"outline\" onClick={() => setShowVerificationDialog(false)}>\n                  Lukk\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showComponentsDialog} onOpenChange={setShowComponentsDialog}>\n        <DialogContent className=\"max-w-3xl max-h-[80vh]\">\n          <DialogHeader>\n            <DialogTitle>Komponenter</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <Input\n              placeholder=\"Filtrer komponenter...\"\n              value={componentFilter}\n              onChange={(e) => setComponentFilter(e.target.value)}\n            />\n\n            {loadingComponents ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <RotateCcw className=\"h-6 w-6 animate-spin\" />\n                <span className=\"ml-2\">Skanner dokument...</span>\n              </div>\n            ) : (\n              <div className=\"max-h-96 overflow-y-auto rounded border\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Kode</TableHead>\n                      <TableHead>System</TableHead>\n                      <TableHead>Side</TableHead>\n                      <TableHead>Masseliste-match</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {filteredComponents.length === 0 ? (\n                      <TableRow>\n                        <TableCell colSpan={4} className=\"text-center text-muted-foreground\">\n                          Ingen komponenter funnet\n                        </TableCell>\n                      </TableRow>\n                    ) : (\n                      filteredComponents.map((comp) => (\n                        <TableRow key={comp.id}>\n                          <TableCell className=\"font-mono text-sm\">{comp.code}</TableCell>\n                          <TableCell>\n                            {comp.system ? (\n                              <Badge variant=\"outline\">{comp.system}</Badge>\n                            ) : (\n                              \"-\"\n                            )}\n                          </TableCell>\n                          <TableCell>{comp.page || \"-\"}</TableCell>\n                          <TableCell>\n                            {comp.massListMatch ? (\n                              <div className=\"text-sm\">\n                                <div className=\"font-medium\">{comp.massListMatch.productName}</div>\n                                <div className=\"text-muted-foreground\">\n                                  {comp.massListMatch.location}\n                                </div>\n                              </div>\n                            ) : (\n                              <Badge variant=\"outline\" className=\"border-orange-500 text-orange-500\">\n                                Ikke funnet\n                              </Badge>\n                            )}\n                          </TableCell>\n                        </TableRow>\n                      ))\n                    )}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n\n            <div className=\"flex justify-between\">\n              <div className=\"text-sm text-muted-foreground\">\n                {components.length} komponenter, {components.filter((c) => c.massListMatch).length} med match\n              </div>\n              <Button variant=\"outline\" onClick={() => setShowComponentsDialog(false)}>\n                Lukk\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":20817,"size_tokens":null},"src/app/(app)/pratlink/[projectId]/page.tsx":{"content":"import { AppShell } from \"@/components/layout/app-shell\";\nimport { ChatRoomView } from \"@/components/pages/pratlink/chat-room-view\";\nimport prisma from \"@/lib/db\";\nimport { authOptions } from \"@/lib/auth\";\nimport { getServerSession } from \"next-auth\";\nimport { redirect, notFound } from \"next/navigation\";\nimport { Role } from \"@prisma/client\";\n\nexport default async function PratLinkProjectPage({\n  params,\n}: {\n  params: Promise<{ projectId: string }>;\n}) {\n  const session = await getServerSession(authOptions);\n  if (!session?.user?.email) redirect(\"/login\");\n  if (session.user.status === \"PENDING\") redirect(\"/pending\");\n\n  const { projectId } = await params;\n\n  const user = await prisma.user.findUnique({\n    where: { email: session.user.email },\n  });\n  if (!user) redirect(\"/login\");\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    include: {\n      members: {\n        include: {\n          user: {\n            select: {\n              id: true,\n              firstName: true,\n              lastName: true,\n              email: true,\n              company: true,\n            },\n          },\n        },\n      },\n      chatRooms: {\n        where: { isActive: true },\n        include: {\n          _count: { select: { messages: true } },\n        },\n        orderBy: [{ type: \"asc\" }, { name: \"asc\" }],\n      },\n    },\n  });\n\n  if (!project) return notFound();\n\n  const isMember =\n    project.members.some((m) => m.userId === user.id) ||\n    user.role === Role.ADMIN;\n\n  if (!isMember) return notFound();\n\n  const isOwnerOrAdmin =\n    project.createdById === user.id || user.role === Role.ADMIN;\n\n  const members = project.members.map((m) => ({\n    id: m.user.id,\n    name: `${m.user.firstName} ${m.user.lastName}`,\n    email: m.user.email,\n    company: m.user.company,\n    role: m.role,\n  }));\n\n  const rooms = project.chatRooms.map((r) => ({\n    id: r.id,\n    name: r.name,\n    type: r.type,\n    description: r.description,\n    messageCount: r._count.messages,\n  }));\n\n  return (\n    <AppShell>\n      <ChatRoomView\n        project={{\n          id: project.id,\n          name: project.name,\n          description: project.description,\n        }}\n        rooms={rooms}\n        members={members}\n        currentUserId={user.id}\n        canManageRooms={isOwnerOrAdmin}\n      />\n    </AppShell>\n  );\n}\n","path":null,"size_bytes":2340,"size_tokens":null},"src/app/api/pratlink/projects/[projectId]/tasks/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { requireAuth, requireProjectAccess } from \"@/lib/auth-helpers\";\nimport prisma from \"@/lib/db\";\nimport { sanitizeString } from \"@/lib/sanitize\";\nimport { sendTaskAssignedEmail } from \"@/lib/email\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const { projectId } = await params;\n\n  const accessCheck = await requireProjectAccess(projectId);\n  if (!accessCheck.success) {\n    return accessCheck.error;\n  }\n\n  const url = new URL(request.url);\n  const status = url.searchParams.get(\"status\");\n  const assignedToMe = url.searchParams.get(\"assignedToMe\") === \"true\";\n\n  const whereClause: Record<string, unknown> = { projectId };\n\n  if (status) {\n    whereClause.status = status;\n  }\n\n  if (assignedToMe) {\n    whereClause.responsibleUserId = authResult.user.id;\n  }\n\n  const tasks = await prisma.chatTask.findMany({\n    where: whereClause,\n    include: {\n      responsibleUser: {\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n          email: true,\n        },\n      },\n      createdBy: {\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n        },\n      },\n      createdFromMessage: {\n        select: {\n          id: true,\n          content: true,\n          room: {\n            select: {\n              id: true,\n              name: true,\n            },\n          },\n        },\n      },\n    },\n    orderBy: [{ status: \"asc\" }, { dueDate: \"asc\" }, { createdAt: \"desc\" }],\n  });\n\n  return NextResponse.json({ tasks });\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const { projectId } = await params;\n\n  const accessCheck = await requireProjectAccess(projectId);\n  if (!accessCheck.success) {\n    return accessCheck.error;\n  }\n\n  const body = await request.json();\n  const { title, description, responsibleUserId, dueDate, messageId } = body;\n\n  if (!title || typeof title !== \"string\" || title.trim().length === 0) {\n    return NextResponse.json(\n      { error: \"Tittel er p√•krevd\" },\n      { status: 400 }\n    );\n  }\n\n  const sanitizedTitle = sanitizeString(title.trim(), 500);\n  const sanitizedDescription = description\n    ? sanitizeString(description.trim(), 5000)\n    : null;\n\n  let validResponsibleUserId: string | null = null;\n\n  if (responsibleUserId) {\n    const isMember = await prisma.projectMember.findFirst({\n      where: {\n        projectId,\n        userId: responsibleUserId,\n      },\n    });\n\n    if (!isMember) {\n      return NextResponse.json(\n        { error: \"Ansvarlig bruker er ikke medlem av prosjektet\" },\n        { status: 400 }\n      );\n    }\n\n    validResponsibleUserId = responsibleUserId;\n  }\n\n  let parsedDueDate: Date | null = null;\n  if (dueDate) {\n    parsedDueDate = new Date(dueDate);\n    if (isNaN(parsedDueDate.getTime())) {\n      return NextResponse.json(\n        { error: \"Ugyldig fristdato\" },\n        { status: 400 }\n      );\n    }\n  }\n\n  let validMessageId: string | null = null;\n  if (messageId) {\n    const message = await prisma.chatMessage.findFirst({\n      where: {\n        id: messageId,\n        room: {\n          projectId,\n        },\n      },\n    });\n\n    if (message) {\n      validMessageId = messageId;\n    }\n  }\n\n  const task = await prisma.chatTask.create({\n    data: {\n      projectId,\n      title: sanitizedTitle,\n      description: sanitizedDescription,\n      responsibleUserId: validResponsibleUserId,\n      dueDate: parsedDueDate,\n      createdFromMessageId: validMessageId,\n      createdById: authResult.user.id,\n    },\n    include: {\n      responsibleUser: {\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n          email: true,\n        },\n      },\n      createdBy: {\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n        },\n      },\n      project: {\n        select: {\n          name: true,\n        },\n      },\n    },\n  });\n\n  if (\n    task.responsibleUser &&\n    task.responsibleUser.id !== authResult.user.id\n  ) {\n    const baseUrl =\n      process.env.NEXTAUTH_URL || `https://${request.headers.get(\"host\")}`;\n    const taskUrl = `${baseUrl}/pratlink/${projectId}?tab=tasks`;\n\n    await sendTaskAssignedEmail(\n      task.responsibleUser.email,\n      task.responsibleUser.firstName,\n      task.title,\n      task.project.name,\n      `${authResult.user.firstName} ${authResult.user.lastName}`,\n      parsedDueDate\n        ? format(parsedDueDate, \"d. MMMM yyyy\", { locale: nb })\n        : null,\n      taskUrl\n    );\n\n    await prisma.chatTask.update({\n      where: { id: task.id },\n      data: { emailSent: true },\n    });\n\n    await prisma.notification.create({\n      data: {\n        userId: task.responsibleUser.id,\n        type: \"task_assigned\",\n        metadata: {\n          taskId: task.id,\n          taskTitle: task.title,\n          projectId,\n          projectName: task.project.name,\n          assignerName: `${authResult.user.firstName} ${authResult.user.lastName}`,\n        },\n      },\n    });\n  }\n\n  return NextResponse.json({ task }, { status: 201 });\n}\n","path":null,"size_bytes":5487,"size_tokens":null},"src/app/api/pratlink/rooms/[roomId]/messages/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport { sanitizeString } from \"@/lib/sanitize\";\n\nasync function verifyRoomAccess(roomId: string, userId: string) {\n  const room = await prisma.chatRoom.findUnique({\n    where: { id: roomId },\n    include: {\n      project: {\n        include: {\n          members: true,\n        },\n      },\n    },\n  });\n\n  if (!room || !room.isActive) {\n    return { success: false as const, error: \"Rom ikke funnet\" };\n  }\n\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  if (!user) {\n    return { success: false as const, error: \"Bruker ikke funnet\" };\n  }\n\n  const isMember =\n    room.project.members.some((m) => m.userId === userId) ||\n    user.role === \"ADMIN\";\n\n  if (!isMember) {\n    return { success: false as const, error: \"Ingen tilgang\" };\n  }\n\n  return { success: true as const, room, user };\n}\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ roomId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { roomId } = await params;\n\n    const accessCheck = await verifyRoomAccess(roomId, authResult.user.id);\n    if (!accessCheck.success) {\n      return NextResponse.json(\n        { error: accessCheck.error },\n        { status: 403 }\n      );\n    }\n\n    const { searchParams } = new URL(request.url);\n    const limit = Math.min(parseInt(searchParams.get(\"limit\") || \"50\"), 100);\n    const before = searchParams.get(\"before\");\n\n    const messages = await prisma.chatMessage.findMany({\n      where: {\n        roomId,\n        parentId: null,\n        deletedAt: null,\n        ...(before ? { createdAt: { lt: new Date(before) } } : {}),\n      },\n      include: {\n        author: {\n          select: { id: true, firstName: true, lastName: true },\n        },\n        mentions: {\n          include: {\n            mentionedUser: {\n              select: { id: true, firstName: true, lastName: true },\n            },\n          },\n        },\n        attachments: true,\n        links: true,\n        _count: { select: { replies: true } },\n      },\n      orderBy: { createdAt: \"asc\" },\n      take: limit,\n    });\n\n    return NextResponse.json({ messages });\n  } catch (error) {\n    console.error(\"Error fetching messages:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke hente meldinger\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ roomId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { roomId } = await params;\n\n    const accessCheck = await verifyRoomAccess(roomId, authResult.user.id);\n    if (!accessCheck.success) {\n      return NextResponse.json(\n        { error: accessCheck.error },\n        { status: 403 }\n      );\n    }\n\n    const body = await request.json();\n    const { content, parentId } = body;\n\n    if (!content || typeof content !== \"string\" || !content.trim()) {\n      return NextResponse.json(\n        { error: \"Meldingsinnhold er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    const sanitizedContent = sanitizeString(content, 10000);\n\n    const mentionRegex = /@([A-Za-z√Ü√ò√Ö√¶√∏√•\\s]+?)(?=\\s|$|@)/g;\n    const mentionMatches = [...sanitizedContent.matchAll(mentionRegex)];\n\n    const mentionedUserIds: string[] = [];\n\n    if (mentionMatches.length > 0) {\n      const mentionedNames = mentionMatches.map((m) => m[1].trim().toLowerCase());\n      \n      const projectMemberIds = accessCheck.room.project.members.map((m) => m.userId);\n      \n      const projectMemberUsers = await prisma.user.findMany({\n        where: {\n          id: { in: projectMemberIds },\n        },\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n        },\n      });\n      \n      for (const name of mentionedNames) {\n        const matchedMember = projectMemberUsers.find((user) => {\n          const fullName = `${user.firstName} ${user.lastName}`.toLowerCase();\n          const firstName = user.firstName.toLowerCase();\n          return fullName === name || fullName.startsWith(name) || firstName === name;\n        });\n        \n        if (\n          matchedMember &&\n          matchedMember.id !== authResult.user.id &&\n          !mentionedUserIds.includes(matchedMember.id)\n        ) {\n          mentionedUserIds.push(matchedMember.id);\n        }\n      }\n    }\n\n    const message = await prisma.chatMessage.create({\n      data: {\n        roomId,\n        authorId: authResult.user.id,\n        content: sanitizedContent,\n        parentId: parentId || null,\n        mentions: {\n          create: mentionedUserIds.map((userId) => ({\n            mentionedUserId: userId,\n          })),\n        },\n      },\n      include: {\n        author: {\n          select: { id: true, firstName: true, lastName: true },\n        },\n        mentions: {\n          include: {\n            mentionedUser: {\n              select: { id: true, firstName: true, lastName: true },\n            },\n          },\n        },\n      },\n    });\n\n    for (const mentionedUserId of mentionedUserIds) {\n      await prisma.notification.create({\n        data: {\n          userId: mentionedUserId,\n          type: \"chat_mention\",\n          metadata: {\n            roomId,\n            roomName: accessCheck.room.name,\n            messageId: message.id,\n            projectId: accessCheck.room.projectId,\n            projectName: accessCheck.room.project.name,\n            senderName: `${authResult.user.firstName} ${authResult.user.lastName}`,\n            messagePreview: sanitizedContent.slice(0, 100),\n          },\n        },\n      });\n    }\n\n    return NextResponse.json(message, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating message:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke sende melding\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":6062,"size_tokens":null},"src/components/ui/mode-toggle.tsx":{"content":"\"use client\";\n\nimport { cn } from \"@/lib/utils\";\nimport { FolderKanban, MessageSquare } from \"lucide-react\";\n\nexport type DashboardMode = \"syslink\" | \"pratlink\";\n\ninterface ModeToggleProps {\n  mode: DashboardMode;\n  onModeChange: (mode: DashboardMode) => void;\n}\n\nexport function ModeToggle({ mode, onModeChange }: ModeToggleProps) {\n  return (\n    <div className=\"flex items-center gap-1 rounded-full bg-white/10 p-1\">\n      <button\n        type=\"button\"\n        onClick={() => onModeChange(\"syslink\")}\n        className={cn(\n          \"flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium transition-all\",\n          mode === \"syslink\"\n            ? \"bg-white text-slate-900 shadow-sm\"\n            : \"text-white/70 hover:text-white\"\n        )}\n      >\n        <FolderKanban size={16} />\n        <span className=\"hidden sm:inline\">Prosjekter</span>\n      </button>\n      <button\n        type=\"button\"\n        onClick={() => onModeChange(\"pratlink\")}\n        className={cn(\n          \"flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium transition-all\",\n          mode === \"pratlink\"\n            ? \"bg-white text-slate-900 shadow-sm\"\n            : \"text-white/70 hover:text-white\"\n        )}\n      >\n        <MessageSquare size={16} />\n        <span className=\"hidden sm:inline\">Korrespondanse</span>\n      </button>\n    </div>\n  );\n}\n","path":null,"size_bytes":1363,"size_tokens":null},"src/components/pages/dashboard/dashboard-client.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ModeToggle, DashboardMode } from \"@/components/ui/mode-toggle\";\nimport { ProjectExplorer } from \"@/components/pages/dashboard/project-explorer\";\nimport { ChatProjectList } from \"@/components/pages/pratlink/chat-project-list\";\nimport { BackupTrigger } from \"@/components/pages/dashboard/backup-trigger\";\nimport { ShieldCheck, Database, MessageSquare, FolderKanban } from \"lucide-react\";\nimport { Role } from \"@prisma/client\";\n\ninterface Project {\n  id: string;\n  name: string;\n  description: string | null;\n  status: string;\n  archivedAt: Date | null;\n  createdAt: Date;\n  updatedAt: Date;\n  members: { user: { firstName: string; lastName: string } }[];\n  documents: { id: string }[];\n  chatRooms?: {\n    id: string;\n    name: string;\n    type: string;\n    _count?: { messages: number };\n  }[];\n  _count?: { chatRooms: number };\n}\n\ninterface DashboardClientProps {\n  user: {\n    id: string;\n    role: Role;\n    discipline?: string;\n  };\n  projects: Project[];\n  mine: Project[];\n  invited: Project[];\n}\n\nexport function DashboardClient({\n  user,\n  projects,\n  mine,\n  invited,\n}: DashboardClientProps) {\n  const [mode, setMode] = useState<DashboardMode>(\"syslink\");\n\n  const canCreate = user.role === Role.ADMIN || user.role === Role.PROJECT_LEADER;\n  const canDelete = user.role === Role.ADMIN;\n\n  return (\n    <div className=\"space-y-6\">\n      <Card className=\"relative overflow-hidden\">\n        <div className=\"absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 opacity-90\" />\n        <CardContent className=\"relative px-6 py-6 text-white\">\n          <div className=\"space-y-4\">\n            <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between\">\n              <div>\n                <p className=\"text-xs uppercase tracking-[0.35em] text-white/70\">\n                  Kontrollsenter\n                </p>\n                <h1 className=\"mt-2 flex flex-wrap items-center gap-3 text-2xl font-semibold leading-tight sm:text-3xl lg:text-4xl\">\n                  {mode === \"syslink\" ? (\n                    <>\n                      Byggebransjen m√∏ter SysLink\n                      <img\n                        src=\"/syslink-logo.png\"\n                        alt=\"SysLink Logo\"\n                        className=\"h-[2em] rounded-lg shadow-sm\"\n                      />\n                    </>\n                  ) : (\n                    <>\n                      <MessageSquare className=\"h-8 w-8\" />\n                      PratLink Korrespondanse\n                    </>\n                  )}\n                </h1>\n              </div>\n              <div className=\"flex flex-col items-end gap-3\">\n                <ModeToggle mode={mode} onModeChange={setMode} />\n                <div className=\"flex flex-wrap justify-end gap-2\">\n                  <Badge tone=\"info\">{projects.length} prosjekter</Badge>\n                  <Badge\n                    tone=\"success\"\n                    title=\"Rollebasert tilgangskontroll\"\n                  >\n                    RBAC aktivert\n                  </Badge>\n                </div>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {mode === \"syslink\" ? (\n        <>\n          <ProjectExplorer\n            mine={mine}\n            invited={invited}\n            canCreate={canCreate}\n            canDelete={canDelete}\n            userDiscipline={user.discipline}\n          />\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Tilgang og sikkerhet</CardTitle>\n              <Badge tone=\"muted\">{user.role}</Badge>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center gap-3 rounded-2xl border border-border p-3\">\n                <ShieldCheck className=\"text-success\" size={20} />\n                <div>\n                  <p className=\"text-sm font-semibold text-foreground\">RBAC</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Roller: Admin, Prosjektleder, Bruker, Leser. Pending-brukere\n                    f√•r begrenset visning.\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3 rounded-2xl border border-border p-3\">\n                <Database className=\"text-info\" size={20} />\n                <div>\n                  <p className=\"text-sm font-semibold text-foreground\">\n                    Mock backup\n                  </p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Trigger en simulert database-dump. Viser progress og svar i\n                    UI.\n                  </p>\n                </div>\n              </div>\n              {user.role === Role.ADMIN && <BackupTrigger />}\n            </CardContent>\n          </Card>\n        </>\n      ) : (\n        <ChatProjectList projects={projects} />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":5091,"size_tokens":null},"src/app/api/projects/[projectId]/mc/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectAccess } from \"@/lib/auth-helpers\";\n\ninterface MCItem {\n  system: string;\n  component: string;\n  location?: string;\n  documentId: string;\n  documentTitle: string;\n}\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const massList = await prisma.massList.findMany({\n      where: { projectId },\n      orderBy: [{ system: \"asc\" }, { component: \"asc\" }],\n    });\n\n    const documents = await prisma.document.findMany({\n      where: { \n        projectId, \n        type: \"SCHEMA\",\n        isLatest: true,\n      },\n      select: {\n        id: true,\n        title: true,\n        components: true,\n      },\n    });\n\n    const mcItems: MCItem[] = [];\n\n    for (const doc of documents) {\n      for (const comp of doc.components) {\n        const massListMatch = massList.find((m) => {\n          const normalizedCode = comp.code.replace(/[.\\-_]/g, \"\").toLowerCase();\n          const tfmNorm = (m.tfm || \"\").replace(/[.\\-_]/g, \"\").toLowerCase();\n          const compNorm = (m.component || \"\").replace(/[.\\-_]/g, \"\").toLowerCase();\n          \n          return (\n            tfmNorm.includes(normalizedCode) ||\n            normalizedCode.includes(tfmNorm) ||\n            compNorm === normalizedCode ||\n            (m.system && comp.system && m.system === comp.system)\n          );\n        });\n\n        if (massListMatch) {\n          mcItems.push({\n            system: massListMatch.system || comp.system || \"\",\n            component: comp.code,\n            location: massListMatch.location || undefined,\n            documentId: doc.id,\n            documentTitle: doc.title,\n          });\n        }\n      }\n    }\n\n    const grouped = mcItems.reduce((acc, item) => {\n      const key = item.system || \"Ukjent\";\n      if (!acc[key]) {\n        acc[key] = [];\n      }\n      acc[key].push(item);\n      return acc;\n    }, {} as Record<string, MCItem[]>);\n\n    return NextResponse.json({\n      items: mcItems,\n      grouped,\n      totalCount: mcItems.length,\n      systemCount: Object.keys(grouped).length,\n    });\n  } catch (error) {\n    console.error(\"Error fetching MC data:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke hente MC-data\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const body = await request.json();\n    const { items } = body;\n\n    if (!Array.isArray(items)) {\n      return NextResponse.json(\n        { error: \"items m√• v√¶re en array\" },\n        { status: 400 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: `${items.length} elementer mottatt for MC-protokoll`,\n    });\n  } catch (error) {\n    console.error(\"Error processing MC data:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke behandle MC-data\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":3362,"size_tokens":null},"src/components/pages/pratlink/chat-room-view.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useRef, useCallback } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  ArrowLeft,\n  Hash,\n  Plus,\n  Send,\n  Users,\n  AtSign,\n  MessageSquare,\n  CheckSquare,\n  Paperclip,\n  FileText,\n  Image,\n  X,\n  Download,\n  ExternalLink,\n  FileIcon,\n  AlertCircle,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { cn } from \"@/lib/utils\";\nimport { TaskPanel } from \"./task-panel\";\n\ninterface Member {\n  id: string;\n  name: string;\n  email: string;\n  company: string | null;\n  role: string;\n}\n\ninterface Room {\n  id: string;\n  name: string;\n  type: string;\n  description: string | null;\n  messageCount: number;\n}\n\ninterface Attachment {\n  id: string;\n  fileName: string;\n  fileUrl: string;\n  fileType: string | null;\n  fileSize: number | null;\n}\n\ninterface MessageLink {\n  id: string;\n  targetType: string;\n  targetId: string;\n}\n\ninterface Message {\n  id: string;\n  content: string;\n  createdAt: string;\n  author: {\n    id: string;\n    firstName: string;\n    lastName: string;\n  };\n  attachments?: Attachment[];\n  links?: MessageLink[];\n  replies?: Message[];\n  _count?: { replies: number };\n}\n\ninterface ChatRoomViewProps {\n  project: {\n    id: string;\n    name: string;\n    description: string | null;\n  };\n  rooms: Room[];\n  members: Member[];\n  currentUserId: string;\n  canManageRooms: boolean;\n}\n\nexport function ChatRoomView({\n  project,\n  rooms,\n  members,\n  currentUserId,\n  canManageRooms,\n}: ChatRoomViewProps) {\n  const router = useRouter();\n  const [activeTab, setActiveTab] = useState<\"chat\" | \"tasks\">(\"chat\");\n  const [selectedRoom, setSelectedRoom] = useState<Room | null>(\n    rooms.find((r) => r.type === \"PROJECT\") || rooms[0] || null\n  );\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [messageText, setMessageText] = useState(\"\");\n  const [sending, setSending] = useState(false);\n  const [showMentions, setShowMentions] = useState(false);\n  const [mentionSearch, setMentionSearch] = useState(\"\");\n  const [createRoomOpen, setCreateRoomOpen] = useState(false);\n  const [newRoomName, setNewRoomName] = useState(\"\");\n  const [creatingRoom, setCreatingRoom] = useState(false);\n  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);\n  const [uploadingFiles, setUploadingFiles] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const tab = urlParams.get(\"tab\");\n    if (tab === \"tasks\") {\n      setActiveTab(\"tasks\");\n    }\n  }, []);\n\n  const fetchMessages = useCallback(async () => {\n    if (!selectedRoom) return;\n    setLoading(true);\n    try {\n      const res = await fetch(\n        `/api/pratlink/rooms/${selectedRoom.id}/messages`\n      );\n      if (res.ok) {\n        const data = await res.json();\n        setMessages(data.messages || []);\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setLoading(false);\n    }\n  }, [selectedRoom]);\n\n  useEffect(() => {\n    fetchMessages();\n  }, [fetchMessages]);\n\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  const handleSendMessage = async () => {\n    if ((!messageText.trim() && selectedFiles.length === 0) || !selectedRoom) return;\n    setSending(true);\n    try {\n      const res = await fetch(\n        `/api/pratlink/rooms/${selectedRoom.id}/messages`,\n        {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ content: messageText || \"(fil vedlagt)\" }),\n        }\n      );\n      if (res.ok) {\n        const { message } = await res.json();\n\n        if (selectedFiles.length > 0) {\n          setUploadingFiles(true);\n          for (const file of selectedFiles) {\n            const formData = new FormData();\n            formData.append(\"file\", file);\n            formData.append(\"messageId\", message.id);\n            formData.append(\"projectId\", project.id);\n\n            await fetch(\"/api/pratlink/attachments\", {\n              method: \"POST\",\n              body: formData,\n            });\n          }\n          setUploadingFiles(false);\n          setSelectedFiles([]);\n        }\n\n        setMessageText(\"\");\n        fetchMessages();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setSending(false);\n      setUploadingFiles(false);\n    }\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    const validFiles = files.filter((file) => {\n      const ext = file.name.split(\".\").pop()?.toLowerCase();\n      const allowedExts = [\"pdf\", \"xlsx\", \"xls\", \"png\", \"jpg\", \"jpeg\", \"gif\", \"webp\", \"doc\", \"docx\"];\n      return ext && allowedExts.includes(ext) && file.size <= 10 * 1024 * 1024;\n    });\n    setSelectedFiles((prev) => [...prev, ...validFiles]);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const removeSelectedFile = (index: number) => {\n    setSelectedFiles((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  const getFileIcon = (fileType: string | null, fileName: string) => {\n    const ext = fileName.split(\".\").pop()?.toLowerCase();\n    if (fileType?.startsWith(\"image/\") || [\"png\", \"jpg\", \"jpeg\", \"gif\", \"webp\"].includes(ext || \"\")) {\n      return Image;\n    }\n    return FileText;\n  };\n\n  const getLinkInfo = (link: MessageLink) => {\n    switch (link.targetType) {\n      case \"document\":\n        return {\n          icon: FileIcon,\n          label: \"Dokument\",\n          href: `/projects/${project.id}/documents/${link.targetId}`,\n          color: \"text-blue-500\",\n        };\n      case \"annotation\":\n        return {\n          icon: AlertCircle,\n          label: \"Avvik\",\n          href: `/projects/${project.id}/documents?annotationId=${link.targetId}`,\n          color: \"text-orange-500\",\n        };\n      case \"task\":\n        return {\n          icon: CheckSquare,\n          label: \"Oppgave\",\n          href: `/pratlink/${project.id}?tab=tasks`,\n          color: \"text-green-500\",\n        };\n      default:\n        return {\n          icon: ExternalLink,\n          label: \"Lenke\",\n          href: \"#\",\n          color: \"text-muted-foreground\",\n        };\n    }\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      handleSendMessage();\n    }\n  };\n\n  const handleCreateRoom = async () => {\n    if (!newRoomName.trim()) return;\n    setCreatingRoom(true);\n    try {\n      const res = await fetch(`/api/pratlink/projects/${project.id}/rooms`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: newRoomName, type: \"TOPIC\" }),\n      });\n      if (res.ok) {\n        setNewRoomName(\"\");\n        setCreateRoomOpen(false);\n        router.refresh();\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      setCreatingRoom(false);\n    }\n  };\n\n  const insertMention = (member: Member) => {\n    const textarea = textareaRef.current;\n    if (!textarea) return;\n\n    const cursorPos = textarea.selectionStart;\n    const textBefore = messageText.slice(0, cursorPos);\n    const textAfter = messageText.slice(cursorPos);\n    const lastAtIndex = textBefore.lastIndexOf(\"@\");\n\n    if (lastAtIndex !== -1) {\n      const newText =\n        textBefore.slice(0, lastAtIndex) +\n        `@${member.name} ` +\n        textAfter;\n      setMessageText(newText);\n    }\n\n    setShowMentions(false);\n    setMentionSearch(\"\");\n    textarea.focus();\n  };\n\n  const handleTextChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const value = e.target.value;\n    setMessageText(value);\n\n    const cursorPos = e.target.selectionStart;\n    const textBefore = value.slice(0, cursorPos);\n    const lastAtIndex = textBefore.lastIndexOf(\"@\");\n\n    if (lastAtIndex !== -1 && lastAtIndex === textBefore.length - 1) {\n      setShowMentions(true);\n      setMentionSearch(\"\");\n    } else if (lastAtIndex !== -1) {\n      const searchText = textBefore.slice(lastAtIndex + 1);\n      if (!searchText.includes(\" \")) {\n        setShowMentions(true);\n        setMentionSearch(searchText.toLowerCase());\n      } else {\n        setShowMentions(false);\n      }\n    } else {\n      setShowMentions(false);\n    }\n  };\n\n  const filteredMembers = members.filter(\n    (m) =>\n      m.id !== currentUserId &&\n      (m.name.toLowerCase().includes(mentionSearch) ||\n        m.email.toLowerCase().includes(mentionSearch))\n  );\n\n  return (\n    <div className=\"flex h-[calc(100vh-8rem)] flex-col gap-4 lg:flex-row\">\n      <div className=\"flex flex-col gap-4 lg:w-72\">\n        <div className=\"flex items-center gap-2\">\n          <Button variant=\"ghost\" size=\"sm\" asChild>\n            <Link href=\"/dashboard\">\n              <ArrowLeft size={16} />\n            </Link>\n          </Button>\n          <div className=\"flex-1\">\n            <h1 className=\"font-semibold\">{project.name}</h1>\n            <p className=\"text-xs text-muted-foreground\">PratLink</p>\n          </div>\n        </div>\n\n        <div className=\"flex rounded-lg border border-border bg-muted p-1\">\n          <button\n            onClick={() => setActiveTab(\"chat\")}\n            className={cn(\n              \"flex items-center gap-2 rounded-md px-3 py-1.5 text-sm font-medium transition-colors\",\n              activeTab === \"chat\"\n                ? \"bg-background text-foreground shadow-sm\"\n                : \"text-muted-foreground hover:text-foreground\"\n            )}\n          >\n            <MessageSquare size={14} />\n            Chat\n          </button>\n          <button\n            onClick={() => setActiveTab(\"tasks\")}\n            className={cn(\n              \"flex items-center gap-2 rounded-md px-3 py-1.5 text-sm font-medium transition-colors\",\n              activeTab === \"tasks\"\n                ? \"bg-background text-foreground shadow-sm\"\n                : \"text-muted-foreground hover:text-foreground\"\n            )}\n          >\n            <CheckSquare size={14} />\n            Oppgaver\n          </button>\n        </div>\n\n        <Card className=\"flex-1 overflow-hidden\">\n          <CardHeader className=\"border-b px-4 py-3\">\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-sm\">Rom</CardTitle>\n              {canManageRooms && (\n                <Dialog open={createRoomOpen} onOpenChange={setCreateRoomOpen}>\n                  <DialogTrigger asChild>\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-7 w-7\">\n                      <Plus size={14} />\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Opprett nytt rom</DialogTitle>\n                    </DialogHeader>\n                    <div className=\"space-y-4 pt-4\">\n                      <Input\n                        placeholder=\"Romnavn (f.eks. Avvik, FDV)\"\n                        value={newRoomName}\n                        onChange={(e) => setNewRoomName(e.target.value)}\n                      />\n                      <Button\n                        onClick={handleCreateRoom}\n                        disabled={creatingRoom || !newRoomName.trim()}\n                        className=\"w-full\"\n                      >\n                        {creatingRoom ? \"Oppretter...\" : \"Opprett rom\"}\n                      </Button>\n                    </div>\n                  </DialogContent>\n                </Dialog>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-1 overflow-auto p-2\">\n            {rooms.map((room) => (\n              <button\n                key={room.id}\n                onClick={() => setSelectedRoom(room)}\n                className={cn(\n                  \"flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left text-sm transition-colors\",\n                  selectedRoom?.id === room.id\n                    ? \"bg-primary/10 text-primary\"\n                    : \"hover:bg-muted\"\n                )}\n              >\n                <Hash size={14} />\n                <span className=\"flex-1 truncate\">{room.name}</span>\n                {room.messageCount > 0 && (\n                  <Badge tone=\"muted\" className=\"text-xs\">\n                    {room.messageCount}\n                  </Badge>\n                )}\n              </button>\n            ))}\n            {rooms.length === 0 && (\n              <p className=\"py-4 text-center text-sm text-muted-foreground\">\n                Ingen rom opprettet\n              </p>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"px-4 py-3\">\n            <CardTitle className=\"flex items-center gap-2 text-sm\">\n              <Users size={14} />\n              Medlemmer ({members.length})\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"max-h-48 space-y-1 overflow-auto p-2\">\n            {members.map((member) => (\n              <div\n                key={member.id}\n                className=\"flex items-center gap-2 rounded-lg px-3 py-2 text-sm\"\n              >\n                <div className=\"flex h-7 w-7 items-center justify-center rounded-full bg-primary/10 text-xs font-medium text-primary\">\n                  {member.name\n                    .split(\" \")\n                    .map((n) => n[0])\n                    .join(\"\")\n                    .slice(0, 2)}\n                </div>\n                <div className=\"flex-1 truncate\">\n                  <p className=\"truncate text-sm font-medium\">{member.name}</p>\n                  {member.company && (\n                    <p className=\"truncate text-xs text-muted-foreground\">\n                      {member.company}\n                    </p>\n                  )}\n                </div>\n              </div>\n            ))}\n          </CardContent>\n        </Card>\n      </div>\n\n      {activeTab === \"chat\" ? (\n        <Card className=\"flex flex-1 flex-col overflow-hidden\">\n          {selectedRoom ? (\n            <>\n              <CardHeader className=\"border-b px-4 py-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Hash size={18} />\n                  <CardTitle className=\"text-base\">{selectedRoom.name}</CardTitle>\n                  {selectedRoom.type === \"PROJECT\" && (\n                    <Badge tone=\"info\" className=\"text-xs\">\n                      Hovedrom\n                    </Badge>\n                  )}\n                </div>\n                {selectedRoom.description && (\n                  <p className=\"text-sm text-muted-foreground\">\n                    {selectedRoom.description}\n                  </p>\n                )}\n              </CardHeader>\n\n              <CardContent className=\"flex-1 overflow-auto p-4\">\n                {loading ? (\n                  <div className=\"flex h-full items-center justify-center\">\n                    <p className=\"text-muted-foreground\">Laster meldinger...</p>\n                  </div>\n                ) : messages.length === 0 ? (\n                  <div className=\"flex h-full flex-col items-center justify-center text-center\">\n                    <MessageSquare className=\"mb-4 h-12 w-12 text-muted-foreground/50\" />\n                    <h3 className=\"font-medium\">Ingen meldinger enn√•</h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      V√¶r den f√∏rste til √• skrive noe!\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {messages.map((message) => (\n                      <div key={message.id} className=\"group flex gap-3\">\n                        <div className=\"flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full bg-primary/10 text-sm font-medium text-primary\">\n                          {message.author.firstName[0]}\n                          {message.author.lastName[0]}\n                        </div>\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-baseline gap-2\">\n                            <span className=\"font-medium\">\n                              {message.author.firstName} {message.author.lastName}\n                            </span>\n                            <span className=\"text-xs text-muted-foreground\">\n                              {format(\n                                new Date(message.createdAt),\n                                \"d. MMM HH:mm\",\n                                { locale: nb }\n                              )}\n                            </span>\n                          </div>\n                          <p className=\"mt-1 whitespace-pre-wrap text-sm\">\n                            {message.content}\n                          </p>\n                          {message.attachments && message.attachments.length > 0 && (\n                            <div className=\"mt-2 flex flex-wrap gap-2\">\n                              {message.attachments.map((attachment) => {\n                                const FileIconComp = getFileIcon(attachment.fileType, attachment.fileName);\n                                return (\n                                  <a\n                                    key={attachment.id}\n                                    href={attachment.fileUrl}\n                                    target=\"_blank\"\n                                    rel=\"noopener noreferrer\"\n                                    className=\"group/file flex items-center gap-2 rounded-lg border border-border bg-muted/50 px-3 py-2 text-sm transition-colors hover:bg-muted\"\n                                  >\n                                    <FileIconComp size={16} className=\"text-muted-foreground\" />\n                                    <span className=\"max-w-[200px] truncate\">{attachment.fileName}</span>\n                                    {attachment.fileSize && (\n                                      <span className=\"text-xs text-muted-foreground\">\n                                        {formatFileSize(attachment.fileSize)}\n                                      </span>\n                                    )}\n                                    <Download size={14} className=\"text-muted-foreground opacity-0 transition-opacity group-hover/file:opacity-100\" />\n                                  </a>\n                                );\n                              })}\n                            </div>\n                          )}\n                          {message.links && message.links.length > 0 && (\n                            <div className=\"mt-2 flex flex-wrap gap-2\">\n                              {message.links.map((link) => {\n                                const linkInfo = getLinkInfo(link);\n                                const LinkIcon = linkInfo.icon;\n                                return (\n                                  <Link\n                                    key={link.id}\n                                    href={linkInfo.href}\n                                    className={cn(\n                                      \"flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm transition-colors hover:bg-muted\",\n                                      linkInfo.color\n                                    )}\n                                  >\n                                    <LinkIcon size={14} />\n                                    <span>{linkInfo.label}</span>\n                                    <ExternalLink size={12} className=\"opacity-50\" />\n                                  </Link>\n                                );\n                              })}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                    <div ref={messagesEndRef} />\n                  </div>\n                )}\n              </CardContent>\n\n              <div className=\"border-t p-4\">\n                <div className=\"relative\">\n                  {showMentions && filteredMembers.length > 0 && (\n                    <div className=\"absolute bottom-full left-0 mb-2 w-64 rounded-lg border bg-background p-1 shadow-lg\">\n                      {filteredMembers.slice(0, 5).map((member) => (\n                        <button\n                          key={member.id}\n                          onClick={() => insertMention(member)}\n                          className=\"flex w-full items-center gap-2 rounded px-3 py-2 text-left text-sm hover:bg-muted\"\n                        >\n                          <AtSign size={14} className=\"text-muted-foreground\" />\n                          <span>{member.name}</span>\n                        </button>\n                      ))}\n                    </div>\n                  )}\n\n                  {selectedFiles.length > 0 && (\n                    <div className=\"mb-2 flex flex-wrap gap-2\">\n                      {selectedFiles.map((file, index) => (\n                        <div\n                          key={index}\n                          className=\"flex items-center gap-2 rounded-lg border border-border bg-muted/50 px-2 py-1 text-sm\"\n                        >\n                          <Paperclip size={14} className=\"text-muted-foreground\" />\n                          <span className=\"max-w-[150px] truncate\">{file.name}</span>\n                          <span className=\"text-xs text-muted-foreground\">\n                            {formatFileSize(file.size)}\n                          </span>\n                          <button\n                            onClick={() => removeSelectedFile(index)}\n                            className=\"text-muted-foreground hover:text-foreground\"\n                          >\n                            <X size={14} />\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  <div className=\"flex gap-2\">\n                    <input\n                      ref={fileInputRef}\n                      type=\"file\"\n                      multiple\n                      accept=\".pdf,.xlsx,.xls,.png,.jpg,.jpeg,.gif,.webp,.doc,.docx\"\n                      onChange={handleFileSelect}\n                      className=\"hidden\"\n                    />\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      size=\"icon\"\n                      className=\"h-11 w-11 flex-shrink-0\"\n                      onClick={() => fileInputRef.current?.click()}\n                      title=\"Legg til fil\"\n                    >\n                      <Paperclip size={18} />\n                    </Button>\n                    <Textarea\n                      ref={textareaRef}\n                      placeholder={`Skriv en melding i #${selectedRoom.name}...`}\n                      value={messageText}\n                      onChange={handleTextChange}\n                      onKeyDown={handleKeyDown}\n                      className=\"min-h-[44px] resize-none\"\n                      rows={1}\n                    />\n                    <Button\n                      onClick={handleSendMessage}\n                      disabled={sending || uploadingFiles || (!messageText.trim() && selectedFiles.length === 0)}\n                      size=\"icon\"\n                      className=\"h-11 w-11\"\n                    >\n                      <Send size={18} />\n                    </Button>\n                  </div>\n                  <p className=\"mt-2 text-xs text-muted-foreground\">\n                    Bruk @ for √• nevne en person. Maks filst√∏rrelse: 10MB\n                  </p>\n                </div>\n              </div>\n            </>\n          ) : (\n            <CardContent className=\"flex h-full items-center justify-center\">\n              <div className=\"text-center\">\n                <Hash className=\"mx-auto mb-4 h-12 w-12 text-muted-foreground/50\" />\n                <h3 className=\"font-medium\">Velg et rom</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Eller opprett et nytt rom for √• starte\n                </p>\n              </div>\n            </CardContent>\n          )}\n        </Card>\n      ) : (\n        <Card className=\"flex flex-1 flex-col overflow-hidden\">\n          <TaskPanel\n            projectId={project.id}\n            members={members.map((m) => ({\n              id: m.id,\n              firstName: m.name.split(\" \")[0],\n              lastName: m.name.split(\" \").slice(1).join(\" \") || \"\",\n              email: m.email,\n            }))}\n            onNavigateToMessage={(roomId, messageId) => {\n              const room = rooms.find((r) => r.id === roomId);\n              if (room) {\n                setSelectedRoom(room);\n                setActiveTab(\"chat\");\n              }\n            }}\n          />\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":25821,"size_tokens":null},"src/components/pages/pratlink/chat-project-list.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  MessageSquare,\n  Users,\n  Search,\n  ChevronRight,\n  Hash,\n  Bell,\n  BellOff,\n} from \"lucide-react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\n\ninterface ChatRoom {\n  id: string;\n  name: string;\n  type: string;\n  _count?: {\n    messages: number;\n  };\n}\n\ninterface Project {\n  id: string;\n  name: string;\n  description: string | null;\n  status: string;\n  createdAt: Date;\n  members: { user: { firstName: string; lastName: string } }[];\n  chatRooms?: ChatRoom[];\n  _count?: {\n    chatRooms: number;\n  };\n}\n\ninterface ChatProjectListProps {\n  projects: Project[];\n}\n\nexport function ChatProjectList({ projects }: ChatProjectListProps) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const activeProjects = projects.filter((p) => p.status === \"ACTIVE\");\n\n  const filteredProjects = activeProjects.filter((p) => {\n    if (!searchQuery.trim()) return true;\n    const query = searchQuery.toLowerCase();\n    return (\n      p.name.toLowerCase().includes(query) ||\n      p.description?.toLowerCase().includes(query)\n    );\n  });\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h2 className=\"text-xl font-semibold\">Prosjektkorrespondanse</h2>\n          <p className=\"text-sm text-muted-foreground\">\n            Velg et prosjekt for √• √•pne chat og korrespondanse\n          </p>\n        </div>\n        <div className=\"relative w-full sm:w-72\">\n          <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n          <Input\n            placeholder=\"S√∏k i prosjekter...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n          />\n        </div>\n      </div>\n\n      {filteredProjects.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <MessageSquare className=\"mb-4 h-12 w-12 text-muted-foreground/50\" />\n            <h3 className=\"text-lg font-medium\">Ingen prosjekter funnet</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              {searchQuery\n                ? \"Pr√∏v et annet s√∏keord\"\n                : \"Du har ikke tilgang til noen aktive prosjekter enn√•\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\n          {filteredProjects.map((project) => (\n            <Link\n              key={project.id}\n              href={`/pratlink/${project.id}`}\n              className=\"group\"\n            >\n              <Card className=\"h-full transition-all hover:border-primary/50 hover:shadow-md\">\n                <CardContent className=\"p-5\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"flex-1 space-y-1\">\n                      <h3 className=\"font-semibold leading-tight group-hover:text-primary\">\n                        {project.name}\n                      </h3>\n                      {project.description && (\n                        <p className=\"line-clamp-2 text-sm text-muted-foreground\">\n                          {project.description}\n                        </p>\n                      )}\n                    </div>\n                    <ChevronRight className=\"mt-0.5 h-5 w-5 text-muted-foreground transition-transform group-hover:translate-x-0.5 group-hover:text-primary\" />\n                  </div>\n\n                  <div className=\"mt-4 flex flex-wrap items-center gap-2 text-xs text-muted-foreground\">\n                    <div className=\"flex items-center gap-1\">\n                      <Users size={14} />\n                      <span>{project.members.length} medlemmer</span>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <Hash size={14} />\n                      <span>{project._count?.chatRooms || 0} rom</span>\n                    </div>\n                  </div>\n\n                  {project.chatRooms && project.chatRooms.length > 0 && (\n                    <div className=\"mt-3 flex flex-wrap gap-1.5\">\n                      {project.chatRooms.slice(0, 3).map((room) => (\n                        <Badge key={room.id} tone=\"muted\" className=\"text-xs\">\n                          # {room.name}\n                        </Badge>\n                      ))}\n                      {project.chatRooms.length > 3 && (\n                        <Badge tone=\"muted\" className=\"text-xs\">\n                          +{project.chatRooms.length - 3}\n                        </Badge>\n                      )}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </Link>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":5112,"size_tokens":null},"src/app/api/pratlink/messages/[messageId]/links/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { requireAuth } from \"@/lib/auth-helpers\";\nimport prisma from \"@/lib/db\";\n\nasync function verifyMessageAccess(messageId: string, userId: string) {\n  const message = await prisma.chatMessage.findUnique({\n    where: { id: messageId },\n    include: {\n      room: {\n        include: {\n          project: {\n            include: {\n              members: true,\n            },\n          },\n        },\n      },\n    },\n  });\n\n  if (!message || message.deletedAt) {\n    return { success: false as const, error: \"Melding ikke funnet\" };\n  }\n\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  if (!user) {\n    return { success: false as const, error: \"Bruker ikke funnet\" };\n  }\n\n  const isMember =\n    message.room.project.members.some((m) => m.userId === userId) ||\n    user.role === \"ADMIN\";\n\n  if (!isMember) {\n    return { success: false as const, error: \"Ingen tilgang\" };\n  }\n\n  return { success: true as const, message, user };\n}\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ messageId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { messageId } = await params;\n\n    const accessCheck = await verifyMessageAccess(messageId, authResult.user.id);\n    if (!accessCheck.success) {\n      return NextResponse.json(\n        { error: accessCheck.error },\n        { status: 403 }\n      );\n    }\n\n    const links = await prisma.chatMessageLink.findMany({\n      where: { messageId },\n      orderBy: { createdAt: \"asc\" },\n    });\n\n    const enrichedLinks = await Promise.all(\n      links.map(async (link) => {\n        let target = null;\n\n        if (link.targetType === \"document\") {\n          target = await prisma.document.findUnique({\n            where: { id: link.targetId },\n            select: { id: true, title: true, projectId: true },\n          });\n        } else if (link.targetType === \"annotation\") {\n          target = await prisma.annotation.findUnique({\n            where: { id: link.targetId },\n            select: {\n              id: true,\n              status: true,\n              document: {\n                select: { id: true, title: true, projectId: true },\n              },\n            },\n          });\n        } else if (link.targetType === \"task\") {\n          target = await prisma.chatTask.findUnique({\n            where: { id: link.targetId },\n            select: { id: true, title: true, projectId: true },\n          });\n        }\n\n        return { ...link, target };\n      })\n    );\n\n    return NextResponse.json({ links: enrichedLinks });\n  } catch (error) {\n    console.error(\"Failed to fetch message links:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke hente lenker\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ messageId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { messageId } = await params;\n\n    const accessCheck = await verifyMessageAccess(messageId, authResult.user.id);\n    if (!accessCheck.success) {\n      return NextResponse.json(\n        { error: accessCheck.error },\n        { status: 403 }\n      );\n    }\n\n    if (accessCheck.message.senderId !== authResult.user.id) {\n      return NextResponse.json(\n        { error: \"Du kan bare legge til lenker til egne meldinger\" },\n        { status: 403 }\n      );\n    }\n\n    const body = await request.json();\n    const { targetType, targetId } = body;\n\n    if (!targetType || !targetId) {\n      return NextResponse.json(\n        { error: \"targetType og targetId er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    if (![\"document\", \"annotation\", \"task\"].includes(targetType)) {\n      return NextResponse.json(\n        { error: \"Ugyldig targetType\" },\n        { status: 400 }\n      );\n    }\n\n    const projectId = accessCheck.message.room.projectId;\n    let valid = false;\n\n    if (targetType === \"document\") {\n      const doc = await prisma.document.findFirst({\n        where: { id: targetId, projectId },\n      });\n      valid = !!doc;\n    } else if (targetType === \"annotation\") {\n      const ann = await prisma.annotation.findFirst({\n        where: {\n          id: targetId,\n          document: { projectId },\n        },\n      });\n      valid = !!ann;\n    } else if (targetType === \"task\") {\n      const task = await prisma.chatTask.findFirst({\n        where: { id: targetId, projectId },\n      });\n      valid = !!task;\n    }\n\n    if (!valid) {\n      return NextResponse.json(\n        { error: \"Ugyldig m√•l-ID eller ingen tilgang\" },\n        { status: 400 }\n      );\n    }\n\n    const existingLink = await prisma.chatMessageLink.findFirst({\n      where: { messageId, targetType, targetId },\n    });\n\n    if (existingLink) {\n      return NextResponse.json(\n        { error: \"Lenke finnes allerede\" },\n        { status: 400 }\n      );\n    }\n\n    const link = await prisma.chatMessageLink.create({\n      data: {\n        messageId,\n        targetType,\n        targetId,\n      },\n    });\n\n    return NextResponse.json({ link }, { status: 201 });\n  } catch (error) {\n    console.error(\"Failed to create message link:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke opprette lenke\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ messageId: string }> }\n) {\n  try {\n    const authResult = await requireAuth();\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const { messageId } = await params;\n    const { searchParams } = new URL(request.url);\n    const linkId = searchParams.get(\"linkId\");\n\n    if (!linkId) {\n      return NextResponse.json(\n        { error: \"linkId er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    const accessCheck = await verifyMessageAccess(messageId, authResult.user.id);\n    if (!accessCheck.success) {\n      return NextResponse.json(\n        { error: accessCheck.error },\n        { status: 403 }\n      );\n    }\n\n    if (accessCheck.message.senderId !== authResult.user.id && authResult.user.role !== \"ADMIN\") {\n      return NextResponse.json(\n        { error: \"Du kan bare fjerne lenker fra egne meldinger\" },\n        { status: 403 }\n      );\n    }\n\n    await prisma.chatMessageLink.delete({\n      where: { id: linkId },\n    });\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error(\"Failed to delete message link:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke slette lenke\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":6737,"size_tokens":null},"src/app/api/pratlink/tasks/[taskId]/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { requireAuth, requireProjectAccess } from \"@/lib/auth-helpers\";\nimport prisma from \"@/lib/db\";\nimport { sanitizeString } from \"@/lib/sanitize\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ taskId: string }> }\n) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const { taskId } = await params;\n\n  const task = await prisma.chatTask.findUnique({\n    where: { id: taskId },\n    include: {\n      responsibleUser: {\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n          email: true,\n        },\n      },\n      createdBy: {\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n        },\n      },\n      createdFromMessage: {\n        select: {\n          id: true,\n          content: true,\n          room: {\n            select: {\n              id: true,\n              name: true,\n            },\n          },\n        },\n      },\n      project: {\n        select: {\n          id: true,\n          name: true,\n        },\n      },\n    },\n  });\n\n  if (!task) {\n    return NextResponse.json(\n      { error: \"Oppgave ikke funnet\" },\n      { status: 404 }\n    );\n  }\n\n  const accessCheck = await requireProjectAccess(task.projectId);\n  if (!accessCheck.success) {\n    return accessCheck.error;\n  }\n\n  return NextResponse.json({ task });\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ taskId: string }> }\n) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const { taskId } = await params;\n\n  const task = await prisma.chatTask.findUnique({\n    where: { id: taskId },\n  });\n\n  if (!task) {\n    return NextResponse.json(\n      { error: \"Oppgave ikke funnet\" },\n      { status: 404 }\n    );\n  }\n\n  const accessCheck = await requireProjectAccess(task.projectId);\n  if (!accessCheck.success) {\n    return accessCheck.error;\n  }\n\n  const body = await request.json();\n  const { title, description, responsibleUserId, dueDate, status } = body;\n\n  const updateData: Record<string, unknown> = {};\n\n  if (title !== undefined) {\n    if (typeof title !== \"string\" || title.trim().length === 0) {\n      return NextResponse.json(\n        { error: \"Tittel kan ikke v√¶re tom\" },\n        { status: 400 }\n      );\n    }\n    updateData.title = sanitizeString(title.trim(), 500);\n  }\n\n  if (description !== undefined) {\n    updateData.description = description\n      ? sanitizeString(description.trim(), 5000)\n      : null;\n  }\n\n  if (responsibleUserId !== undefined) {\n    if (responsibleUserId === null) {\n      updateData.responsibleUserId = null;\n    } else {\n      const isMember = await prisma.projectMember.findFirst({\n        where: {\n          projectId: task.projectId,\n          userId: responsibleUserId,\n        },\n      });\n\n      if (!isMember) {\n        return NextResponse.json(\n          { error: \"Ansvarlig bruker er ikke medlem av prosjektet\" },\n          { status: 400 }\n        );\n      }\n\n      updateData.responsibleUserId = responsibleUserId;\n    }\n  }\n\n  if (dueDate !== undefined) {\n    if (dueDate === null) {\n      updateData.dueDate = null;\n    } else {\n      const parsedDate = new Date(dueDate);\n      if (isNaN(parsedDate.getTime())) {\n        return NextResponse.json(\n          { error: \"Ugyldig fristdato\" },\n          { status: 400 }\n        );\n      }\n      updateData.dueDate = parsedDate;\n    }\n  }\n\n  if (status !== undefined) {\n    if (![\"OPEN\", \"IN_PROGRESS\", \"DONE\", \"CANCELLED\"].includes(status)) {\n      return NextResponse.json(\n        { error: \"Ugyldig status\" },\n        { status: 400 }\n      );\n    }\n    updateData.status = status;\n  }\n\n  const updatedTask = await prisma.chatTask.update({\n    where: { id: taskId },\n    data: updateData,\n    include: {\n      responsibleUser: {\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n          email: true,\n        },\n      },\n      createdBy: {\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n        },\n      },\n    },\n  });\n\n  return NextResponse.json({ task: updatedTask });\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ taskId: string }> }\n) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  const { taskId } = await params;\n\n  const task = await prisma.chatTask.findUnique({\n    where: { id: taskId },\n  });\n\n  if (!task) {\n    return NextResponse.json(\n      { error: \"Oppgave ikke funnet\" },\n      { status: 404 }\n    );\n  }\n\n  const accessCheck = await requireProjectAccess(task.projectId);\n  if (!accessCheck.success) {\n    return accessCheck.error;\n  }\n\n  if (\n    authResult.user.role !== \"ADMIN\" &&\n    task.createdById !== authResult.user.id\n  ) {\n    return NextResponse.json(\n      { error: \"Du kan bare slette oppgaver du har opprettet\" },\n      { status: 403 }\n    );\n  }\n\n  await prisma.chatTask.delete({\n    where: { id: taskId },\n  });\n\n  return NextResponse.json({ success: true });\n}\n","path":null,"size_bytes":5206,"size_tokens":null},"src/components/ui/table.tsx":{"content":"import * as React from \"react\";\nimport { cn } from \"@/lib/utils\";\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n));\nTable.displayName = \"Table\";\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n));\nTableHeader.displayName = \"TableHeader\";\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n));\nTableBody.displayName = \"TableBody\";\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n));\nTableFooter.displayName = \"TableFooter\";\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n));\nTableRow.displayName = \"TableRow\";\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n));\nTableHead.displayName = \"TableHead\";\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n));\nTableCell.displayName = \"TableCell\";\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nTableCaption.displayName = \"TableCaption\";\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n};\n","path":null,"size_bytes":2783,"size_tokens":null},"src/components/pages/pratlink/task-panel.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { format } from \"date-fns\";\nimport { nb } from \"date-fns/locale\";\nimport {\n  Plus,\n  CheckCircle2,\n  Circle,\n  Clock,\n  Ban,\n  Calendar,\n  User,\n  ChevronDown,\n  ChevronUp,\n  Loader2,\n  MessageSquare,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\ninterface User {\n  id: string;\n  firstName: string;\n  lastName: string;\n  email: string;\n}\n\ninterface Task {\n  id: string;\n  title: string;\n  description: string | null;\n  status: \"OPEN\" | \"IN_PROGRESS\" | \"DONE\" | \"CANCELLED\";\n  dueDate: string | null;\n  responsibleUser: User | null;\n  createdBy: {\n    id: string;\n    firstName: string;\n    lastName: string;\n  } | null;\n  createdFromMessage: {\n    id: string;\n    content: string;\n    room: { id: string; name: string };\n  } | null;\n  createdAt: string;\n}\n\ninterface TaskPanelProps {\n  projectId: string;\n  members: User[];\n  onNavigateToMessage?: (roomId: string, messageId: string) => void;\n}\n\nconst statusConfig = {\n  OPEN: { icon: Circle, label: \"√Öpen\", color: \"text-blue-500\" },\n  IN_PROGRESS: { icon: Clock, label: \"P√•g√•r\", color: \"text-orange-500\" },\n  DONE: { icon: CheckCircle2, label: \"Fullf√∏rt\", color: \"text-green-500\" },\n  CANCELLED: { icon: Ban, label: \"Kansellert\", color: \"text-muted-foreground\" },\n};\n\nexport function TaskPanel({\n  projectId,\n  members,\n  onNavigateToMessage,\n}: TaskPanelProps) {\n  const [tasks, setTasks] = useState<Task[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [showCreateForm, setShowCreateForm] = useState(false);\n  const [expandedTaskId, setExpandedTaskId] = useState<string | null>(null);\n  const [filter, setFilter] = useState<\n    \"all\" | \"OPEN\" | \"IN_PROGRESS\" | \"DONE\" | \"CANCELLED\"\n  >(\"all\");\n  const [showMyTasks, setShowMyTasks] = useState(false);\n\n  const [newTitle, setNewTitle] = useState(\"\");\n  const [newDescription, setNewDescription] = useState(\"\");\n  const [newResponsibleId, setNewResponsibleId] = useState(\"\");\n  const [newDueDate, setNewDueDate] = useState(\"\");\n  const [creating, setCreating] = useState(false);\n\n  useEffect(() => {\n    fetchTasks();\n  }, [projectId, filter, showMyTasks]);\n\n  async function fetchTasks() {\n    setLoading(true);\n    try {\n      const params = new URLSearchParams();\n      if (filter !== \"all\") {\n        params.set(\"status\", filter);\n      }\n      if (showMyTasks) {\n        params.set(\"assignedToMe\", \"true\");\n      }\n\n      const res = await fetch(\n        `/api/pratlink/projects/${projectId}/tasks?${params.toString()}`\n      );\n      if (res.ok) {\n        const data = await res.json();\n        setTasks(data.tasks);\n      }\n    } catch (err) {\n      console.error(\"Failed to fetch tasks:\", err);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleCreateTask(e: React.FormEvent) {\n    e.preventDefault();\n    if (!newTitle.trim()) return;\n\n    setCreating(true);\n    try {\n      const res = await fetch(`/api/pratlink/projects/${projectId}/tasks`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          title: newTitle.trim(),\n          description: newDescription.trim() || null,\n          responsibleUserId: newResponsibleId || null,\n          dueDate: newDueDate || null,\n        }),\n      });\n\n      if (res.ok) {\n        setNewTitle(\"\");\n        setNewDescription(\"\");\n        setNewResponsibleId(\"\");\n        setNewDueDate(\"\");\n        setShowCreateForm(false);\n        fetchTasks();\n      }\n    } catch (err) {\n      console.error(\"Failed to create task:\", err);\n    } finally {\n      setCreating(false);\n    }\n  }\n\n  async function handleStatusChange(\n    taskId: string,\n    status: Task[\"status\"]\n  ) {\n    try {\n      const res = await fetch(`/api/pratlink/tasks/${taskId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status }),\n      });\n\n      if (res.ok) {\n        fetchTasks();\n      }\n    } catch (err) {\n      console.error(\"Failed to update task:\", err);\n    }\n  }\n\n  const filteredTasks = tasks;\n\n  return (\n    <div className=\"flex h-full flex-col\">\n      <div className=\"flex items-center justify-between border-b border-border p-4\">\n        <div className=\"flex items-center gap-2\">\n          <h2 className=\"font-semibold text-foreground\">Oppgaver</h2>\n          <Badge variant=\"secondary\">{tasks.length}</Badge>\n        </div>\n        <Button size=\"sm\" onClick={() => setShowCreateForm(!showCreateForm)}>\n          <Plus size={16} className=\"mr-1\" />\n          Ny oppgave\n        </Button>\n      </div>\n\n      <div className=\"flex flex-wrap items-center gap-2 border-b border-border p-3\">\n        <select\n          value={filter}\n          onChange={(e) => setFilter(e.target.value as typeof filter)}\n          className=\"rounded-lg border border-input bg-background px-3 py-1.5 text-sm\"\n        >\n          <option value=\"all\">Alle statuser</option>\n          <option value=\"OPEN\">√Öpne</option>\n          <option value=\"IN_PROGRESS\">P√•g√•r</option>\n          <option value=\"DONE\">Fullf√∏rt</option>\n          <option value=\"CANCELLED\">Kansellert</option>\n        </select>\n\n        <label className=\"flex items-center gap-2 text-sm\">\n          <input\n            type=\"checkbox\"\n            checked={showMyTasks}\n            onChange={(e) => setShowMyTasks(e.target.checked)}\n            className=\"rounded border-input\"\n          />\n          Mine oppgaver\n        </label>\n      </div>\n\n      {showCreateForm && (\n        <form\n          onSubmit={handleCreateTask}\n          className=\"space-y-3 border-b border-border bg-muted/50 p-4\"\n        >\n          <Input\n            placeholder=\"Oppgavetittel...\"\n            value={newTitle}\n            onChange={(e) => setNewTitle(e.target.value)}\n            required\n          />\n\n          <textarea\n            placeholder=\"Beskrivelse (valgfritt)...\"\n            value={newDescription}\n            onChange={(e) => setNewDescription(e.target.value)}\n            className=\"w-full rounded-lg border border-input bg-background px-3 py-2 text-sm\"\n            rows={2}\n          />\n\n          <div className=\"grid grid-cols-2 gap-3\">\n            <select\n              value={newResponsibleId}\n              onChange={(e) => setNewResponsibleId(e.target.value)}\n              className=\"rounded-lg border border-input bg-background px-3 py-2 text-sm\"\n            >\n              <option value=\"\">Velg ansvarlig...</option>\n              {members.map((member) => (\n                <option key={member.id} value={member.id}>\n                  {member.firstName} {member.lastName}\n                </option>\n              ))}\n            </select>\n\n            <Input\n              type=\"date\"\n              value={newDueDate}\n              onChange={(e) => setNewDueDate(e.target.value)}\n              placeholder=\"Frist\"\n            />\n          </div>\n\n          <div className=\"flex justify-end gap-2\">\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setShowCreateForm(false)}\n            >\n              Avbryt\n            </Button>\n            <Button type=\"submit\" size=\"sm\" disabled={creating || !newTitle.trim()}>\n              {creating ? (\n                <Loader2 size={16} className=\"mr-1 animate-spin\" />\n              ) : null}\n              Opprett\n            </Button>\n          </div>\n        </form>\n      )}\n\n      <div className=\"flex-1 overflow-y-auto\">\n        {loading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"animate-spin text-muted-foreground\" size={24} />\n          </div>\n        ) : filteredTasks.length === 0 ? (\n          <div className=\"py-12 text-center text-muted-foreground\">\n            <CheckCircle2 className=\"mx-auto mb-2 opacity-50\" size={32} />\n            <p>Ingen oppgaver</p>\n          </div>\n        ) : (\n          <div className=\"divide-y divide-border\">\n            {filteredTasks.map((task) => {\n              const config = statusConfig[task.status];\n              const StatusIcon = config.icon;\n              const isExpanded = expandedTaskId === task.id;\n\n              return (\n                <div key={task.id} className=\"p-4\">\n                  <div className=\"flex items-start gap-3\">\n                    <button\n                      onClick={() =>\n                        handleStatusChange(\n                          task.id,\n                          task.status === \"DONE\" ? \"OPEN\" : \"DONE\"\n                        )\n                      }\n                      className={cn(\n                        \"mt-0.5 transition-colors hover:opacity-70\",\n                        config.color\n                      )}\n                      title={\n                        task.status === \"DONE\"\n                          ? \"Marker som √•pen\"\n                          : \"Marker som fullf√∏rt\"\n                      }\n                    >\n                      <StatusIcon size={20} />\n                    </button>\n\n                    <div className=\"min-w-0 flex-1\">\n                      <button\n                        onClick={() =>\n                          setExpandedTaskId(isExpanded ? null : task.id)\n                        }\n                        className=\"flex w-full items-center justify-between text-left\"\n                      >\n                        <span\n                          className={cn(\n                            \"font-medium text-foreground\",\n                            task.status === \"DONE\" && \"line-through opacity-60\",\n                            task.status === \"CANCELLED\" &&\n                              \"line-through opacity-60\"\n                          )}\n                        >\n                          {task.title}\n                        </span>\n                        {isExpanded ? (\n                          <ChevronUp size={16} className=\"text-muted-foreground\" />\n                        ) : (\n                          <ChevronDown size={16} className=\"text-muted-foreground\" />\n                        )}\n                      </button>\n\n                      <div className=\"mt-1 flex flex-wrap items-center gap-2 text-xs text-muted-foreground\">\n                        {task.responsibleUser && (\n                          <span className=\"flex items-center gap-1\">\n                            <User size={12} />\n                            {task.responsibleUser.firstName}{\" \"}\n                            {task.responsibleUser.lastName}\n                          </span>\n                        )}\n                        {task.dueDate && (\n                          <span className=\"flex items-center gap-1\">\n                            <Calendar size={12} />\n                            {format(new Date(task.dueDate), \"d. MMM yyyy\", {\n                              locale: nb,\n                            })}\n                          </span>\n                        )}\n                        <Badge variant=\"outline\" className=\"text-[10px]\">\n                          {config.label}\n                        </Badge>\n                      </div>\n\n                      {isExpanded && (\n                        <div className=\"mt-3 space-y-3\">\n                          {task.description && (\n                            <p className=\"text-sm text-muted-foreground\">\n                              {task.description}\n                            </p>\n                          )}\n\n                          {task.createdFromMessage && (\n                            <button\n                              onClick={() =>\n                                onNavigateToMessage?.(\n                                  task.createdFromMessage!.room.id,\n                                  task.createdFromMessage!.id\n                                )\n                              }\n                              className=\"flex items-center gap-1 text-xs text-primary hover:underline\"\n                            >\n                              <MessageSquare size={12} />\n                              Opprettet fra melding i #\n                              {task.createdFromMessage.room.name}\n                            </button>\n                          )}\n\n                          <div className=\"flex flex-wrap gap-2\">\n                            {task.status !== \"IN_PROGRESS\" &&\n                              task.status !== \"DONE\" &&\n                              task.status !== \"CANCELLED\" && (\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() =>\n                                    handleStatusChange(task.id, \"IN_PROGRESS\")\n                                  }\n                                >\n                                  <Clock size={14} className=\"mr-1\" />\n                                  Start\n                                </Button>\n                              )}\n                            {task.status !== \"DONE\" && (\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() =>\n                                  handleStatusChange(task.id, \"DONE\")\n                                }\n                              >\n                                <CheckCircle2 size={14} className=\"mr-1\" />\n                                Fullf√∏rt\n                              </Button>\n                            )}\n                            {task.status !== \"CANCELLED\" &&\n                              task.status !== \"DONE\" && (\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  onClick={() =>\n                                    handleStatusChange(task.id, \"CANCELLED\")\n                                  }\n                                >\n                                  <Ban size={14} className=\"mr-1\" />\n                                  Kanseller\n                                </Button>\n                              )}\n                          </div>\n\n                          <p className=\"text-[11px] text-muted-foreground\">\n                            Opprettet{\" \"}\n                            {format(new Date(task.createdAt), \"d. MMM yyyy\", {\n                              locale: nb,\n                            })}\n                            {task.createdBy &&\n                              ` av ${task.createdBy.firstName} ${task.createdBy.lastName}`}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15061,"size_tokens":null},"src/app/api/pratlink/projects/[projectId]/rooms/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/db\";\nimport { requireProjectAccess, requireProjectLeaderAccess } from \"@/lib/auth-helpers\";\nimport { sanitizeString } from \"@/lib/sanitize\";\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const rooms = await prisma.chatRoom.findMany({\n      where: { projectId, isActive: true },\n      include: {\n        _count: { select: { messages: true } },\n        createdBy: {\n          select: { firstName: true, lastName: true },\n        },\n      },\n      orderBy: [{ type: \"asc\" }, { name: \"asc\" }],\n    });\n\n    return NextResponse.json({ rooms });\n  } catch (error) {\n    console.error(\"Error fetching chat rooms:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke hente rom\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ projectId: string }> }\n) {\n  try {\n    const { projectId } = await params;\n\n    const authResult = await requireProjectLeaderAccess(projectId);\n    if (!authResult.success) {\n      return authResult.error;\n    }\n\n    const body = await request.json();\n    const { name, type, description } = body;\n\n    if (!name || typeof name !== \"string\") {\n      return NextResponse.json(\n        { error: \"Romnavn er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    const sanitizedName = sanitizeString(name, 100);\n    const sanitizedDescription = description\n      ? sanitizeString(description, 500)\n      : null;\n\n    const roomType = type === \"PROJECT\" ? \"PROJECT\" : \"TOPIC\";\n\n    if (roomType === \"PROJECT\") {\n      const existingProjectRoom = await prisma.chatRoom.findFirst({\n        where: { projectId, type: \"PROJECT\", isActive: true },\n      });\n      if (existingProjectRoom) {\n        return NextResponse.json(\n          { error: \"Prosjektet har allerede et hovedrom\" },\n          { status: 400 }\n        );\n      }\n    }\n\n    const room = await prisma.chatRoom.create({\n      data: {\n        projectId,\n        name: sanitizedName,\n        description: sanitizedDescription,\n        type: roomType,\n        createdById: authResult.user.id,\n      },\n      include: {\n        _count: { select: { messages: true } },\n      },\n    });\n\n    return NextResponse.json(room, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating chat room:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke opprette rom\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2720,"size_tokens":null},"src/app/api/pratlink/attachments/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { requireAuth, requireProjectAccess } from \"@/lib/auth-helpers\";\nimport prisma from \"@/lib/db\";\nimport { saveFile } from \"@/lib/file-utils\";\n\nconst CHAT_ALLOWED_EXTENSIONS = [\".pdf\", \".xlsx\", \".xls\", \".png\", \".jpg\", \".jpeg\", \".gif\", \".webp\", \".doc\", \".docx\"];\nconst CHAT_MAX_FILE_SIZE = 10 * 1024 * 1024;\n\nexport async function POST(request: NextRequest) {\n  const authResult = await requireAuth();\n  if (!authResult.success) {\n    return authResult.error;\n  }\n\n  try {\n    const formData = await request.formData();\n    const file = formData.get(\"file\") as File | null;\n    const messageId = formData.get(\"messageId\") as string | null;\n    const projectId = formData.get(\"projectId\") as string | null;\n\n    if (!file) {\n      return NextResponse.json(\n        { error: \"Fil er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    if (!messageId || !projectId) {\n      return NextResponse.json(\n        { error: \"Meldings-ID og prosjekt-ID er p√•krevd\" },\n        { status: 400 }\n      );\n    }\n\n    const accessCheck = await requireProjectAccess(projectId);\n    if (!accessCheck.success) {\n      return accessCheck.error;\n    }\n\n    const message = await prisma.chatMessage.findFirst({\n      where: {\n        id: messageId,\n        senderId: authResult.user.id,\n        room: {\n          projectId,\n        },\n      },\n    });\n\n    if (!message) {\n      return NextResponse.json(\n        { error: \"Melding ikke funnet eller du har ikke tilgang\" },\n        { status: 404 }\n      );\n    }\n\n    const ext = file.name.split(\".\").pop()?.toLowerCase();\n    if (!ext || !CHAT_ALLOWED_EXTENSIONS.includes(`.${ext}`)) {\n      return NextResponse.json(\n        { error: \"Filtypen er ikke tillatt\" },\n        { status: 400 }\n      );\n    }\n\n    if (file.size > CHAT_MAX_FILE_SIZE) {\n      return NextResponse.json(\n        { error: \"Filen er for stor. Maks st√∏rrelse er 10MB\" },\n        { status: 400 }\n      );\n    }\n\n    const buffer = Buffer.from(await file.arrayBuffer());\n\n    const saveResult = await saveFile(projectId, file.name, buffer);\n    if (!saveResult.success) {\n      return NextResponse.json(\n        { error: saveResult.error },\n        { status: 500 }\n      );\n    }\n\n    const attachment = await prisma.chatAttachment.create({\n      data: {\n        messageId,\n        fileName: file.name,\n        fileUrl: saveResult.path,\n        fileType: file.type,\n        fileSize: file.size,\n      },\n    });\n\n    return NextResponse.json({ attachment }, { status: 201 });\n  } catch (error) {\n    console.error(\"Failed to upload attachment:\", error);\n    return NextResponse.json(\n      { error: \"Kunne ikke laste opp fil\" },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2729,"size_tokens":null}},"version":2}