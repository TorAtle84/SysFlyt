{% extends 'base.html' %}
{% block title %}Kalender{% endblock %}

{% block head_extra %}
  {{ super() }}
  {# Bruk lokal CSS for å unngå CDN/MIME-strul #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fullcalendar.min.css') }}">
  <style>
    #calendar { width: 100%; min-height: 600px; margin: 0 auto; }
    .fc { width: 100%; }
    .fc .fc-toolbar-title { white-space: nowrap; }
    .fc-daygrid-day, .fc-daygrid-day-frame { border: 1px solid #848383 !important; }
    .fc .fc-day-today { background-color: #fff9e6 !important; }
    .filter-row .form-label { margin-bottom: 0.25rem; }
    .filter-row .form-select, .filter-row .btn { width: 100%; }
    .btn-fit-height { height: calc(2.25rem + 2px); line-height: 1.5; padding: 0.375rem 0.75rem; }

	.fc .fc-daygrid-week-number {
	  width: 3.8rem;
	  text-align: center;
	  background: #ffffff;
	  font-weight: 800;
	  border-right: 1px solid #dee2e6;
	  color: #4682b4;
	}
  </style>
  <script>
    // Gjør backend-lister tilgjengelig for init
    window.alleTeknikere     = {{ teknikere|default([])|tojson }};
    window.alleStatusverdier = {{ statusverdier|default([])|tojson }};
  </script>
{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="bi bi-calendar3"></i> Kalender for planlegging</h1>

<div class="row g-3 mb-4 align-items-end filter-row"> 
  <div class="col-md-3"> 
    <label for="filterLokasjon" class="form-label">Filtrer lokasjon:</label>
    <select id="filterLokasjon" class="form-select">
      <option value="">Alle</option>
      {% for loc in lokasjoner %}
        <option value="{{ loc }}" {% if selected_lokasjon == loc %}selected{% endif %}>{{ loc }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3"> 
    <label for="filterFag" class="form-label">Filtrer fag:</label>
    <select id="filterFag" class="form-select">
      <option value="">Alle</option>
      {% for f in fag %}
        <option value="{{ f }}" {% if selected_fag == f %}selected{% endif %}>{{ f }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label d-block">&nbsp;</label>
    <a href="{{ url_for('oppgaver.ny_oppgave') }}" class="btn btn-primary w-100 btn-fit-height">
      <i class="bi bi-plus-circle"></i> Ny oppgave
    </a>
  </div>
  <div class="col-md-3">
    <label for="downloadIcsBtn" class="form-label">ICS-eksport:</label>
    <button id="downloadIcsBtn" class="btn btn-success btn-fit-height">
      <i class="bi bi-download"></i> Last ned ICS
    </button>
  </div>
</div>

<div class="row"><div class="col-12"><div id="calendar" class="mb-5"></div></div></div>

{# Oppgave-modal #}
<div class="modal fade" id="oppgaveModal" tabindex="-1" aria-labelledby="oppgaveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="oppgaveModalLabel">Oppgave</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="modalTaskId">
      <div class="mb-3">
        <label for="modalTitle" class="form-label">Tittel / Ordrenummer</label>
        <div class="input-group">
          <input type="text" id="modalTitle" class="form-control">
          <input type="text" id="modalOrderNumber" class="form-control" placeholder="Ordrenr..." readonly>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="modalLokasjon" class="form-label">Lokasjon</label>
          <input type="text" id="modalLokasjon" class="form-control">
        </div>
        <div class="col-md-6">
          <label for="modalPlassering" class="form-label">Plassering</label>
          <input type="text" id="modalPlassering" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="modalStartDato" class="form-label">Startdato</label>
          <input type="date" id="modalStartDato" class="form-control">
        </div>
        <div class="col-md-6 mb-3">
          <label for="modalStartTid" class="form-label">Starttid</label>
          <input type="time" id="modalStartTid" class="form-control">
        </div>
        <div class="col-md-6 mb-3">
          <label for="modalEndDato" class="form-label">Sluttdato</label>
          <input type="date" id="modalEndDato" class="form-control">
        </div>
        <div class="col-md-6 mb-3">
          <label for="modalEndTid" class="form-label">Sluttid</label>
          <input type="time" id="modalEndTid" class="form-control">
        </div>
      </div>
      <div class="mb-3">
        <label for="modalTekniker" class="form-label">Tekniker</label>
        <select id="modalTekniker" class="form-select"></select>
      </div>
      <div class="mb-3">
        <label for="modalStatus" class="form-label">Status</label>
        <select id="modalStatus" class="form-select"></select>
      </div>
      <div class="mb-3">
        <label for="modalKommentarProsjektleder" class="form-label">Kommentar (prosjektleder)</label>
        <textarea id="modalKommentarProsjektleder" class="form-control"></textarea>
      </div>
      <div class="mb-3">
        <label for="modalKommentarTekniker" class="form-label">Kommentar (tekniker)</label>
        <textarea id="modalKommentarTekniker" class="form-control"></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Vedlegg (IKKE I BRUK / UTVIKLES)</label>
        <ul id="vedleggListe" class="list-group"></ul>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" id="btnLagreAlle" class="btn btn-primary">Lagre</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
    </div>
  </div></div>
</div>

{# ICS-modal #}
<div class="modal fade" id="icsModal" tabindex="-1" aria-labelledby="icsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="icsModalLabel">Velg oppgaver for nedlasting</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
    </div>
    <div class="modal-body">
      <form id="icsForm"><div id="icsTaskList" class="list-group"></div></form>
    </div>
    <div class="modal-footer">
      <button id="downloadIcsConfirmBtn" class="btn btn-primary">Last ned valgte ICS-filer</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
    </div>
  </div></div>
</div>

{# Revisjons-modal (valgfritt) #}
<div class="modal fade" id="revisionsModal" tabindex="-1" aria-labelledby="revisionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="revisionsModalLabel">Revisjoner for: <span id="revisionModalTaskTitle"></span></h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="currentRevisionTaskId">
      <div id="revisionsList" class="list-group">
        <div class="alert alert-info text-center mt-3" id="noRevisionsMessage" style="display: none;">
          Ingen tidligere revisjoner funnet for denne oppgaven.
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" id="selectRevisionsBtn" class="btn btn-primary">Velg revisjoner</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
    </div>
  </div></div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  {# 1) FullCalendar (lokal bundle). IKKE last FullCalendar i base.html #}
  <script src="{{ url_for('static', filename='js/fullcalendar.min.js') }}"></script>

  {# 2) JSZip (for ZIP med én .ics pr oppgave) — last før ics-export.js #}
  <!-- Bruk CDN ... -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <!-- ...eller legg inn lokalt og bruk: 
  <script src="{{ url_for('static', filename='js/vendor/jszip.min.js') }}"></script> 
  -->

  {# 3) Globale hjelpere (ikke-ESM) #}
  <script src="{{ url_for('static', filename='js/calendar/modal-handlers.js') }}"></script>
  <script src="{{ url_for('static', filename='js/calendar/ics-export.js') }}"></script>

  {# 4) Init (global, ikke-ESM) #}
  <script src="{{ url_for('static', filename='js/calendar/calendar-init.js') }}"></script>
  
  <script>
    window.currentUser = {
      email: "{{ current_user.email or '' }}",
      name: "{{ (current_user.first_name ~ ' ' ~ current_user.last_name)|trim }}"
    };
  </script>

{% endblock %}
