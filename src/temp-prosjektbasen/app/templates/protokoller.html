{% extends 'base.html' %}

{% block title %}Protokollverktøy{% endblock %}

{% block content %}

<style>
    .app-card {
        background-color: #dde7e7;
        border: 1px solid #c0d3e0;
        border-radius: 0.75rem;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
		position: relative;
		z-index: 1;
    }
    .main-content-area { width: 100%; padding: 0 2.5%; box-sizing: border-box; }
    .main-content-area table { width: 100%; table-layout: auto; word-break: break-word; }
    .main-content-area table td { vertical-align: top; }
    .tab-pane { padding: 1rem; }

    .segment {
        display: inline-block; margin: 0 5px; padding: 0.6rem 1.2rem;
        border-radius: 15px; cursor: pointer; font-weight: 600; user-select: none; transition: 0.2s;
    }
    .segment:hover { filter: brightness(1.1); }
    .segment.selected { outline: 3px solid black; }

    .prefix { background: #6c757d; color: #fff; }
    .system { background: #17a2b8; color: #fff; }
    .lopenr, .komponent { background: #ffc107; color: #000; }
    .byggnr { background: #28a745; color: #fff; }
    .typekode { background: #6f42c1; color: #fff; }

    #system-kriterier .sys-btn {
        display: inline-block; margin: 0 5px; padding: 8px 12px;
        border: 2px solid #ccc; border-radius: 6px; cursor: pointer; user-select: none;
    }
    #system-kriterier .sys-btn.selected { background: #6f42c1; color: #fff; border-color: #333; }

    .nav-tabs {
        border-bottom: 1px solid #dee2e6; background-color: #f8f9fa;
        border-radius: .25rem .25rem 0 0; padding-top: .5rem; padding-left: .5rem;
    }
    .nav-tabs .nav-link {
        border: 1px solid transparent; border-top-left-radius: .25rem; border-top-right-radius: .25rem;
        color: #495057; margin-bottom: -1px; background-color: #e9ecef; transition: background-color .2s, border-color .2s;
    }
    .nav-tabs .nav-link:hover { border-color: #e9ecef #e9ecef #dee2e6; background-color: #f1f3f5; }
    .nav-tabs .nav-item.show .nav-link, .nav-tabs .nav-link.active {
        color: #495057; background-color: #fff; border-color: #dee2e6 #dee2e6 #fff;
    }
    .tab-pane {
        padding-top: 1rem; border: 1px solid #dee2e6; border-top: none; background-color: #fff;
        padding: 1rem; border-radius: 0 0 .25rem .25rem;
    }

    #message-box {
        display: none; position: sticky; top: 0; z-index: 1030;
    }
	
	/* Sikre at knapper kan klikkes, selv om noe skulle overlappe */
	.segment,
	#system-kriterier .sys-btn {
	  position: relative;
	  z-index: 2;
	  pointer-events: auto;
	}

	/* Tilgjengelighet – tydelig fokus for tastatur */
	.segment:focus,
	#system-kriterier .sys-btn:focus {
	  outline: 3px solid #000;
	}
	
	.section-row .section-cell {
	  font-weight: 700;
	  text-align: center;
	  background: #eef5ff;
	  padding: 8px 6px;
	  border-top: 2px solid #cfe1ff;
	  border-bottom: 2px solid #cfe1ff;
	}

	.rekkefolge-cell {
	  width: 100px;
	  text-align: center;
	}
	.rekkefolge-controls {
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  gap: 6px;
	}
	.rekkefolge-controls button {
	  border: 1px solid #cfd4dc;
	  background: #f7f7f7;
	  padding: 2px 6px;
	  cursor: pointer;
	}
	.rekkefolge-controls button:active {
	  transform: translateY(1px);
	}
	.order-index {
	  min-width: 2ch;
	  text-align: center;
	  font-variant-numeric: tabular-nums;
	}

    /* Sikre bryting i alle tabeller, inkl. dynamiske */
    table.table td, table.table th { white-space: normal; word-break: break-word; }
    textarea.autoarea { width: 100%; min-height: 2.4rem; overflow: hidden; resize: none; }
</style>

<div class="main-content-area my-4">
  <div id="message-box" class="mb-3"></div>

  <div class="app-card">
    <h2 class="mb-4"><i class="bi bi-file-earmark-text"></i> Protokollverktøy</h2>

    <!-- Formatbygger -->
    <div id="format-segmenter" class="mb-3">
		<span class="segment byggnr" data-placeholder="{byggnr}" role="button" tabindex="0">+260801A</span>
		<span class="segment system" data-placeholder="{system}" role="button" tabindex="0">=5630.0102</span>
		<span class="segment komponent" data-placeholder="{komponent}" role="button" tabindex="0">-SQZ5004</span>
		<span class="segment typekode" data-placeholder="{typekode}" role="button" tabindex="0">%SQZ.0001</span>
    </div>

    <textarea id="format-input" class="form-control mb-2" placeholder="Klikk segmenter for å bygge formatet" readonly></textarea>
    <small class="text-muted d-block mb-3">
        Bruk <code>{byggnr}</code> for «+...», <code>{system}</code> for «=...», <code>{komponent}</code> for «-...» og <code>{typekode}</code> for «%...».
    </small>

    <div class="mb-4">
      <label class="form-label fw-semibold">Egendefinerte segmentmønstre (overstyrer når utfylt)</label>
      <div class="row g-2 g-md-3">
        <div class="col-12 col-sm-6 col-lg-3">
          <label for="custom-format-byggnr" class="form-label mb-1"><code>{byggnr}</code></label>
          <input id="custom-format-byggnr" type="text" class="form-control form-control-sm" placeholder="+260801A">
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <label for="custom-format-system" class="form-label mb-1"><code>{system}</code></label>
          <input id="custom-format-system" type="text" class="form-control form-control-sm" placeholder="=5630.0102">
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <label for="custom-format-komponent" class="form-label mb-1"><code>{komponent}</code></label>
          <input id="custom-format-komponent" type="text" class="form-control form-control-sm" placeholder="-SQZ5004">
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <label for="custom-format-typekode" class="form-label mb-1"><code>{typekode}</code></label>
          <input id="custom-format-typekode" type="text" class="form-control form-control-sm" placeholder="%SQZ.0001">
        </div>
      </div>
      <small class="text-muted d-block mt-2">
        Fyll kun inn segmentene du vil låse til. Felt som står tomme følger formatbyggeren.
      </small>
    </div>

    <hr>

    <!-- Systemkriterier -->
    <label for="system-kriterier" class="form-label">Systemkriterier:</label>
    <div id="system-kriterier" class="mb-3">
        {% for i in range(1, 10) %}
        <span class="sys-btn" data-val="{{ i }}">{{ i }}</span>
        {% endfor %}
        <button id="tfm-popup-btn" class="btn btn-secondary ms-2" style="display:none;">TFM</button>
    </div>

    <!-- Funksjon og opplasting -->
    <label for="funksjonsvalg" class="form-label">Velg funksjon:</label>
    <select id="funksjonsvalg" class="form-select mb-3 w-100">
        <option value="" selected disabled>Velg funksjon</option>
        <option value="MC">MC-Dokumentasjon</option>
        <option value="FUNKSJONSTEST">Funksjonstestprotokoll</option>
        <option value="INNREGULERING">Innreguleringsprotokoll (ventilasjon)</option>
    </select>

    <label id="fileUploadLabel" class="form-label">Last opp dokumenter:</label>
    <input id="filopplaster" type="file" class="form-control mb-3" multiple accept=".pdf,.docx,.xlsx,.txt">

    <!-- Handlingsknapper -->
    <div class="row mb-3">
        <div class="col-md-6">
            <button id="generate-data-btn" class="btn btn-primary w-100">Generer underlag</button>
        </div>
        <div class="col-md-6">
            <button id="download-protocol-btn" class="btn btn-success w-100" disabled>Last ned protokoll</button>
        </div>
    </div>

    <div id="status-text" class="text-muted mb-3">Status: Klar</div>

    <!-- Filfilter -->
    <div id="fileFilterContainer" class="mb-3"></div>

    <!-- Toppverktøy for resultater -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Resultat:</h5>
        <button id="clear-table-btn" class="btn btn-sm btn-outline-danger">Tøm tabell</button>
    </div>

    <!-- Dynamisk systemfilter (brukes særlig for Funksjonstest) -->
    <div id="system-filter-container" class="mb-3" style="display: none;"></div>

    <!-- Faner og faneinnhold -->
    <ul id="systemTabs" class="nav nav-tabs"></ul>
    <div id="systemTabContent" class="tab-content"></div>

    <!-- Tabellvisning (brukes for MC default header – JS bytter ved behov) -->
    <table id="protocol-table" class="table table-bordered">
        <thead id="table-head">
            <tr>
                <th>Montasjestatus</th>
                <th>Kablet og koblet</th>
                <th>Merket</th>
                <th>Komponentnavn</th>
                <th>Beskrivelse</th>
                <th>Tilordnet til</th>
                <th>Utført av</th>
                <th>Dato utført</th>
                <th>Kommentar</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <tr>
                <td>✔️Utført</td>
                <td>✔️Utført</td>
                <td>✔️Utført</td>
                <td>+100=3601.0001-JPA4001</td>
                <td>Gjør dette:</td>
                <td>Dette skal hende:</td>
                <td>Per T. Ansvar</td>
                <td>Dato</td>
                <td>...</td>
            </tr>
        </tbody>
    </table>
  </div>
</div>

<!-- TFM Modal -->
<div class="modal fade" id="tfmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">TFM Komponentfilter</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
    </div>
    <div class="modal-body">
      <table id="tfmTable" class="table table-bordered">
        <thead><tr><th>TFM-kode</th><th>Beskrivelse</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button id="lagre-tfm-btn" class="btn btn-primary">Lagre valg</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
    </div>
  </div></div>
</div>

<!-- System-prefiks modal -->
<div id="filterModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 id="modalTitle" class="modal-title"></h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
    </div>
    <div class="modal-body">
      <div id="modalCheckboxes"></div>
    </div>
    <div class="modal-footer">
      <button id="modalConfirm" class="btn btn-primary">Bekreft</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
    </div>
  </div></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Last i modul-rekkefølge for å bevare avhengigheter -->
<script src="/static/js/protokoller.core.js" type="module"></script>
<script src="/static/js/protokoller.tables.js" type="module"></script>
<script src="/static/js/protokoller.ui.js" type="module"></script>
{% endblock %}
